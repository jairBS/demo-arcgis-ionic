"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7557],{29430:(ut,Le,w)=>{w.d(Le,{$:()=>H,IB:()=>$,N2:()=>V,RH:()=>K,Ws:()=>ae,ZD:()=>Y});var Q=w(68677);function $(m){return"r"in m&&"g"in m&&"b"in m}function Fe(m){return"h"in m&&"s"in m&&"v"in m}function me(m){return"l"in m&&"a"in m&&"b"in m}function Ce(m){return"l"in m&&"c"in m&&"h"in m}w(53781),w(89141);const Oe=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],Ue=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function ye(m,z){const D=[];let G,W;if(m[0].length!==z.length)throw new Error("dimensions do not match");const j=m.length,ee=m[0].length;let Pe=0;for(G=0;G<j;G++){for(Pe=0,W=0;W<ee;W++)Pe+=m[G][W]*z[W];D.push(Pe)}return D}function pe(m){const z=[m.r/255,m.g/255,m.b/255].map(G=>G<=.04045?G/12.92:((G+.055)/1.055)**2.4),D=ye(Oe,z);return{x:100*D[0],y:100*D[1],z:100*D[2]}}function Te(m){const z=ye(Ue,[m.x/100,m.y/100,m.z/100]).map(D=>Math.min(1,Math.max(D<=.0031308?12.92*D:1.055*D**.4166666666666667-.055,0)));return{r:Math.round(255*z[0]),g:Math.round(255*z[1]),b:Math.round(255*z[2])}}function ge(m){const z=[m.x/95.047,m.y/100,m.z/108.883].map(D=>D>.008856451679035631?D**.3333333333333333:7.787037037037035*D+.13793103448275862);return{l:116*z[1]-16,a:500*(z[0]-z[1]),b:200*(z[1]-z[2])}}function C(m){const z=m.l,D=[(z+16)/116+m.a/500,(z+16)/116,(z+16)/116-m.b/200].map(G=>G>6/29?G**3:3*(6/29)**2*(G-4/29));return{x:95.047*D[0],y:100*D[1],z:108.883*D[2]}}function H(m){return $(m)?m:Ce(m)?function M(m){return Te(C(function v(m){const D=m.c,G=m.h;return{l:m.l,a:D*Math.cos(G),b:D*Math.sin(G)}}(m)))}(m):me(m)?function f(m){return Te(C(m))}(m):function ze(m){return"x"in m&&"y"in m&&"z"in m}(m)?Te(m):Fe(m)?function L(m){const z=(m.h+360)%360/60,G=m.v/100*255,W=G*(m.s/100),j=W*(1-Math.abs(z%2-1));let ee;switch(Math.floor(z)){case 0:ee={r:W,g:j,b:0};break;case 1:ee={r:j,g:W,b:0};break;case 2:ee={r:0,g:W,b:j};break;case 3:ee={r:0,g:j,b:W};break;case 4:ee={r:j,g:0,b:W};break;case 5:case 6:ee={r:W,g:0,b:j};break;default:ee={r:0,g:0,b:0}}return ee.r=Math.round(ee.r+G-W),ee.g=Math.round(ee.g+G-W),ee.b=Math.round(ee.b+G-W),ee}(m):m}function V(m){return Fe(m)?m:function N(m){const z=m.r,D=m.g,G=m.b,W=Math.max(z,D,G),j=W-Math.min(z,D,G);let ee=W,Pe=0===j?0:W===z?(D-G)/j%6:W===D?(G-z)/j+2:(z-D)/j+4,et=0===j?0:j/ee;return Pe<0&&(Pe+=6),Pe*=60,et*=100,ee*=100/255,{h:Pe,s:et,v:ee}}(H(m))}function Y(m){return me(m)?m:function S(m){return ge(pe(m))}(H(m))}function K(m){return Ce(m)?m:function T(m){return function A(m){const z=m.l,D=m.a,G=m.b,W=Math.sqrt(D*D+G*G);let j=Math.atan2(G,D);return j=j>0?j:j+2*Math.PI,{l:z,c:W,h:j}}(ge(pe(m)))}(H(m))}function ae(m,z){const{r:D,g:G,b:W}=null!=z&&z.ignoreAlpha?m:function X(m){let{r:z,g:D,b:G,a:W}=m;return W<1&&(z=Math.round(W*z+255*(1-W)),D=Math.round(W*D+255*(1-W)),G=Math.round(W*G+255*(1-W))),new Q.A({r:z,g:D,b:G})}(m);return.2126*D+.7152*G+.0722*W}var ce,m;(m=ce||(ce={}))[m.Low=160]="Low",m[m.High=225]="High"},1684:(ut,Le,w)=>{w.d(Le,{$:()=>C});var Q=w(10467),ve=w(68677),de=w(29430),$=w(77806),Fe=w(48218),me=w(32117),Ce=w(5922),ze=w(35150),Oe=w(721);function Ue(A,v,S,f,T){if(null==A)return null;const M=A.referencesGeometry()&&T?function pe(A,v,S){const{transform:f,hasZ:T,hasM:M}=S;ye.has(v)||ye.set(v,function Te(A){const v={};switch(A){case"esriGeometryPoint":return(S,f,T,M)=>(0,Oe.Tr)(f,v,S,T,M);case"esriGeometryPolygon":return(S,f,T,M)=>(0,Oe.$X)(f,v,S,T,M);case"esriGeometryPolyline":return(S,f,T,M)=>(0,Oe.P5)(f,v,S,T,M);case"esriGeometryMultipoint":return(S,f,T,M)=>(0,Oe.SW)(f,v,S,T,M);default:return ze.A.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Ce.A("mapview-arcade",`Unable to handle geometryType: ${A}`)),S=>S}}(v));const N=ye.get(v)(A.geometry,f,T,M);return{...A,geometry:N}}(v,f,T):v,N=A.repurposeFeature(M);try{return A.evaluate({...S,$feature:N},A.services)}catch(L){return ze.A.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",L),null}}const ye=new Map,ge=A=>{if(!A)return[0,0,0,0];const{r:v,g:S,b:f,a:T}=A;return[v,S,f,255*T]};class C{static findApplicableOverrides(v,S,f){if(v&&S){if(v.primitiveName){let T=!1;for(const M of f)if(M.primitiveName===v.primitiveName){T=!0;break}if(!T)for(const M of S)M.primitiveName===v.primitiveName&&f.push(M)}switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(v.effects)for(const T of v.effects)C.findApplicableOverrides(T,S,f);if(v.symbolLayers)for(const T of v.symbolLayers)C.findApplicableOverrides(T,S,f);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(v.effects)for(const T of v.effects)C.findApplicableOverrides(T,S,f);if(v.markerPlacement&&C.findApplicableOverrides(v.markerPlacement,S,f),"CIMVectorMarker"===v.type){if(v.markerGraphics)for(const T of v.markerGraphics)C.findApplicableOverrides(T,S,f),C.findApplicableOverrides(T.symbol,S,f)}else"CIMCharacterMarker"===v.type?C.findApplicableOverrides(v.symbol,S,f):"CIMHatchFill"===v.type?C.findApplicableOverrides(v.lineSymbol,S,f):"CIMPictureMarker"===v.type&&C.findApplicableOverrides(v.animatedSymbolProperties,S,f)}}}static findEffectOverrides(v,S){if(!v)return null;if("CIMGeometricEffectDashes"===v.type&&(0,me.K3)(v),!S||!v.primitiveName)return{type:"cim-effect-info",effect:v,overrides:[]};const f=v.primitiveName,T=[];for(const M of S)M.primitiveName===f&&T.push({...M,propertyName:(0,me.YF)(M.propertyName)});return{type:"cim-effect-info",effect:v,overrides:T}}static resolveSymbolOverrides(v,S,f,T,M,N,L){return(0,Q.A)(function*(){if(null==v||!v.symbol)return null;let{symbol:H,primitiveOverrides:V}=v;const Y=!!V;if(!Y&&!T)return H;H=(0,$.o8)(H),V=(0,$.o8)(V);let K=!0;if(S||(S={attributes:{}},K=!1),Y){if(K||(V=V.filter(J=>{var X;return!(null!==(X=J.valueExpressionInfo)&&void 0!==X&&X.expression.includes("$feature"))})),L||(V=V.filter(J=>{var X;return!(null!==(X=J.valueExpressionInfo)&&void 0!==X&&X.expression.includes("$view"))})),V.length>0){const J={spatialReference:f,fields:(0,me.O2)(S.attributes),geometryType:M};yield C.createRenderExpressions(V,J),C.evaluateOverrides(V,S,null!=M?M:"esriGeometryPoint",N,L)}C.applyOverrides(H,V)}return T&&C.applyDictionaryTextOverrides(H,S,T,null),H})()}static createRenderExpressions(v,S){return(0,Q.A)(function*(){const f=[];for(const T of v){const M=T.valueExpressionInfo;if(!M||C._expressionToRenderExpression.has(M.expression))continue;const N=(0,Fe.Ad)(M.expression,S.spatialReference,S.fields);f.push(N),N.then(L=>C._expressionToRenderExpression.set(M.expression,L))}f.length>0&&(yield Promise.all(f))})()}static evaluateOverrides(v,S,f,T,M){const N={$view:{scale:null==M?void 0:M.scale}};for(const L of v){L.value&&"object"==typeof L.value&&(0,de.IB)(L.value)&&("Color"===L.propertyName||"StrokeColor"===L.propertyName)&&(L.value=ge(L.value));const H=L.valueExpressionInfo;if(!H)continue;const V=C._expressionToRenderExpression.get(H.expression);V&&(L.value=Ue(V,S,N,f,T))}}static applyDictionaryTextOverrides(v,S,f,T,M="Normal"){if(null!=v&&v.type)switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":case"CIMTextSymbol":{const N=v.symbolLayers;if(!N)return;for(const L of N)L&&"CIMVectorMarker"===L.type&&C.applyDictionaryTextOverrides(L,S,f,T,"CIMTextSymbol"===v.type?v.textCase:M)}break;case"CIMVectorMarker":{const N=v.markerGraphics;if(!N)return;for(const L of N)L&&C.applyDictionaryTextOverrides(L,S,f,T)}break;case"CIMMarkerGraphic":{const N=v.textString;if(N&&N.includes("[")){const L=(0,me.gQ)(N,f);v.textString=(0,me.FM)(S,L,T,M)}}}}static applyOverrides(v,S,f,T){if(v.primitiveName)for(const M of S)if(M.primitiveName===v.primitiveName){const N=(0,me.YF)(M.propertyName);if(T&&T.push({cim:v,nocapPropertyName:N,value:v[N]}),f){let L=!1;for(const H of f)H.primitiveName===v.primitiveName&&(L=!0);L||f.push(M)}null!=M.value&&(v[N]=M.value)}switch(v.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(v.effects)for(const M of v.effects)C.applyOverrides(M,S,f,T);if(v.symbolLayers)for(const M of v.symbolLayers)C.applyOverrides(M,S,f,T);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(v.effects)for(const M of v.effects)C.applyOverrides(M,S,f,T);if("CIMVectorMarker"===v.type&&v.markerGraphics)for(const M of v.markerGraphics)C.applyOverrides(M,S,f,T),C.applyOverrides(M.symbol,S,f,T)}}static restoreOverrides(v){for(const S of v)S.cim[S.nocapPropertyName]=S.value}static buildOverrideKey(v){let S="";for(const f of v)void 0!==f.value&&(S+=`${f.primitiveName}${f.propertyName}${JSON.stringify(f.value)}`);return S}static toValue(v,S){if("DashTemplate"===v)return S.split(" ").map(f=>Number(f));if("Color"===v){const f=new ve.A(S).toRgba();return f[3]*=255,f}return S}}C._expressionToRenderExpression=new Map},54935:(ut,Le,w)=>{w.d(Le,{Fj:()=>Ue,Z7:()=>Oe,ce:()=>ye,eR:()=>Fe});var Q=w(86468),ve=w(61320),de=w(9792),$=w(47669);function Fe(C){switch(C.type){case"CIMPointSymbol":{const v=C.symbolLayers;if(!v||1!==v.length)return null;const S=v[0];return"CIMVectorMarker"!==S.type?null:Fe(S)}case"CIMVectorMarker":{var A;const v=C.markerGraphics;if(!v||1!==v.length)return null;const S=v[0];if(!S)return null;const f=S.geometry;if(!f)return null;const T=S.symbol;return!T||"CIMPolygonSymbol"!==T.type&&"CIMLineSymbol"!==T.type||null!==(A=T.symbolLayers)&&void 0!==A&&A.some(M=>!!M.effects)?null:{type:"sdf",geom:f,asFill:"CIMPolygonSymbol"===T.type}}}}function ze(C){let A=1/0,v=-1/0,S=1/0,f=-1/0;for(const T of C)for(const M of T)M[0]<A&&(A=M[0]),M[0]>v&&(v=M[0]),M[1]<S&&(S=M[1]),M[1]>f&&(f=M[1]);return[A,S,v,f]}function Oe(C){return C?C.rings?ze(C.rings):C.paths?ze(C.paths):(0,ve.ZC)(C)?[C.xmin,C.ymin,C.xmax,C.ymax]:null:null}function Ue(C,A,v,S,f){const[T,M,N,L]=C;if(N<T||L<M)return[0,0,0,1];const H=N-T,V=L-M,K=$.hM,J=Math.floor(.5*(64-K)),X=(128-2*(J+K))/Math.max(H,V),ae=Math.round(H*X)+2*J,ce=Math.round(V*X)+2*J;let _e=1;A&&(_e=ce/X/(A.ymax-A.ymin));let ie=0,re=0,Z=1;S&&(f?A&&v&&A.ymax-A.ymin>0&&(Z=(A.xmax-A.xmin)/(A.ymax-A.ymin),ie=S.x/(v*Z),re=S.y/v):(ie=S.x,re=S.y)),A&&(ie=.5*(A.xmax+A.xmin)+ie*(A.xmax-A.xmin),re=.5*(A.ymax+A.ymin)+re*(A.ymax-A.ymin)),ie-=T,re-=M,ie*=X,re*=X,ie+=J,re+=J;let Ee=ie/ae-.5,Be=re/ce-.5;return f&&v&&(Ee*=v*Z,Be*=v),[_e,Ee,Be,Z]}function ye(C){const A=function me(C){return C?C.rings?C.rings:C.paths?C.paths:void 0!==C.xmin&&void 0!==C.ymin&&void 0!==C.xmax&&void 0!==C.ymax?[[[C.xmin,C.ymin],[C.xmin,C.ymax],[C.xmax,C.ymax],[C.xmax,C.ymin],[C.xmin,C.ymin]]]:null:null}(C.geom),v=function Ce(C){let A=1/0,v=-1/0,S=1/0,f=-1/0;for(const T of C)for(const M of T)M[0]<A&&(A=M[0]),M[0]>v&&(v=M[0]),M[1]<S&&(S=M[1]),M[1]>f&&(f=M[1]);return new de.A(A,S,v-A,f-S)}(A),f=$.hM,T=Math.floor(.5*(64-f)),M=(128-2*(T+f))/Math.max(v.width,v.height),N=Math.round(v.width*M)+2*T,L=Math.round(v.height*M)+2*T,H=[];for(const Y of A)if(Y&&Y.length>1){const K=[];for(const J of Y){let[X,ae]=J;X-=v.x,ae-=v.y,X*=M,ae*=M,X+=T-.5,ae+=T-.5,K.push(C.asFill?[X,ae]:[Math.round(X),Math.round(ae)])}if(C.asFill){const J=K.length-1;K[0][0]===K[J][0]&&K[0][1]===K[J][1]||K.push(K[0])}H.push(K)}const V=function pe(C,A,v,S){const f=A*v,T=new Array(f),M=S*S+1;for(let N=0;N<f;++N)T[N]=M;for(const N of C){const L=N.length;for(let H=1;H<L;++H){const V=N[H-1],Y=N[H];let K,J,X,ae;V[0]<Y[0]?(K=V[0],J=Y[0]):(K=Y[0],J=V[0]),V[1]<Y[1]?(X=V[1],ae=Y[1]):(X=Y[1],ae=V[1]);let ce=Math.floor(K)-S,_e=Math.floor(J)+S,ie=Math.floor(X)-S,re=Math.floor(ae)+S;ce<0&&(ce=0),_e>A&&(_e=A),ie<0&&(ie=0),re>v&&(re=v);const Z=Y[0]-V[0],Ee=Y[1]-V[1],Be=Z*Z+Ee*Ee;for(let Ie=ce;Ie<_e;Ie++)for(let te=ie;te<re;te++){let De,m,z=(Ie-V[0])*Z+(te-V[1])*Ee;z<0?(De=V[0],m=V[1]):z>Be?(De=Y[0],m=Y[1]):(z/=Be,De=V[0]+z*Z,m=V[1]+z*Ee);const D=(Ie-De)*(Ie-De)+(te-m)*(te-m),G=(v-te-1)*A+Ie;D<T[G]&&(T[G]=D)}}}for(let N=0;N<f;++N)T[N]=Math.sqrt(T[N]);return T}(H,N,L,T);return C.asFill&&function Te(C,A,v,S,f){for(const T of C){const M=T.length;for(let N=1;N<M;++N){const L=T[N-1],H=T[N];let V,Y,K,J;L[0]<H[0]?(V=L[0],Y=H[0]):(V=H[0],Y=L[0]),L[1]<H[1]?(K=L[1],J=H[1]):(K=H[1],J=L[1]);let X=Math.floor(V),ae=Math.floor(Y)+1,ce=Math.floor(K),_e=Math.floor(J)+1;X<S&&(X=S),ae>A-S&&(ae=A-S),ce<S&&(ce=S),_e>v-S&&(_e=v-S);for(let ie=ce;ie<_e;++ie){if(L[1]>ie==H[1]>ie)continue;const re=(v-ie-1)*A;for(let Z=X;Z<ae;++Z)Z<(H[0]-L[0])*(ie-L[1])/(H[1]-L[1])+L[0]&&(f[re+Z]=-f[re+Z]);for(let Z=S;Z<X;++Z)f[re+Z]=-f[re+Z]}}}}(H,N,L,T,V),[ge(V,T),N,L]}function ge(C,A){const v=2*A,S=C.length,f=new Uint8Array(4*S);for(let T=0;T<S;++T)(0,Q.U)(.5-C[T]/v,f,4*T);return f}},27557:(ut,Le,w)=>{w.r(Le),w.d(Le,{GraphicContainer:()=>Mr.A,GraphicsView2D:()=>xr.A,LabelManager:()=>br.C,MagnifierView2D:()=>Er,MapViewNavigation:()=>wr.A,Stage:()=>yr});var Q=w(10467),ve=w(5922),de=w(3248),$=w(11432),Fe=w(3804),me=w(54029),Ce=w(12273),ze=w(29430),Oe=w(98894),Ue=w(77806),ye=w(35150),pe=w(67685),Te=w(1119),ge=w(26747),C=w(46988),A=w(65374),v=w(1684),S=w(54935),f=w(32117),T=w(10223),M=w(47669);function L(g){const e=g.markerPlacement;return e&&e.angleToLine?A.C1.MAP:A.C1.SCREEN}class H{constructor(e){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],e&&(this._resourceManager=e)}analyzeSymbolReference(e,i,s){if(this._cimLayers=null!=s?s:[],!e)return this._cimLayers;if(this._reset(),e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides;for(const a of this._primitiveOverrides){const l=a.valueExpressionInfo;if(l)this._setPoMap(a.primitiveName,a.propertyName,l);else if(null!=a.value){let o=a.value;a.propertyName.includes("Color")&&((0,ze.IB)(o)&&(o=(0,f.G9)(o)),o=(0,f.e6)(o)),this._setPoMap(a.primitiveName,a.propertyName,o)}}}return this._analyzeSymbol(e.symbol,i),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(e,i){switch(null==e?void 0:e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,i)}}_analyzeMultiLayerSymbol(e,i){var s;const a=null==e?void 0:e.symbolLayers;if(!a)return;const l=e.effects;let o=A.C1.SCREEN;const h=null!==(s=(0,f.YC)(e))&&void 0!==s?s:0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(o=A.C1.MAP);const d="CIMPolygonSymbol"===e.type;let u=a.length;for(;u--;){const p=a[u];if(!p||!1===p.enable)continue;let _;null!=l&&l.length&&(_=[...l]);const b=p.effects;null!=b&&b.length&&(l?_.push(...b):_=[...b]);let y=null;if(_){y=[];for(const P of _){const O=v.$.findEffectOverrides(P,this._primitiveOverrides);O&&y.push(O)}}switch(v.$.findApplicableOverrides(p,this._primitiveOverrides,[]),p.type){case"CIMSolidFill":this._analyzeSolidFill(p,y);break;case"CIMPictureFill":this._analyzePictureFill(p,y);break;case"CIMHatchFill":this._analyzeHatchFill(p,y);break;case"CIMGradientFill":this._analyzeGradientFill(p,y);break;case"CIMSolidStroke":this._analyzeSolidStroke(p,y,d,h);break;case"CIMPictureStroke":this._analyzePictureStroke(p,y,d,h);break;case"CIMGradientStroke":this._analyzeGradientStroke(p,y,d,h);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==e.type&&"CIMPolygonSymbol"!==e.type||(o=L(p));const P=[],O=p.primitiveName;O&&P.push(O);const F=d&&(0,f.zr)(p.markerPlacement);this._analyzeMarker(p,y,null,P,o,h,i,[],!1,F);break}default:ye.A.getLogger("esri.symbols.cim.cimAnalyzer").error("Cannot analyze CIM layer",p.type)}}}_analyzeSolidFill(e,i){const{primitiveName:s,type:a}=e,l=(0,f.e6)(e.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,color:this._getValueOrOverrideExpression(a,s,"Color",l),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:i,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(e,i){const{primitiveName:s,type:a}=e,l=(0,f.Ny)(e),o=(0,f._W)(e.height,C.D.CIMPictureFill.height);let h=(0,f._W)(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const u=e.width;let p=1;const _=this._resourceManager.getResource(e.url);null!=_&&(p=_.width/_.height),h/=p*(o/u)}const d={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(s,a)};this._cimLayers.push({type:"fill",spriteRasterizationParam:d,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(a,s,"TintColor",l),height:this._getValueOrOverrideExpression(a,s,"Height",o),scaleX:this._getValueOrOverrideExpression(a,s,"ScaleX",h),angle:this._getValueOrOverrideExpression(a,s,"Rotation",(0,f._W)(e.rotation)),offsetX:this._getValueOrOverrideExpression(a,s,"OffsetX",(0,f._W)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(a,s,"OffsetY",(0,f._W)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(e,i){var s;const{primitiveName:a,type:l}=e,o=this._analyzeMaterialOverrides(a,["Rotation","OffsetX","OffsetY"]),h=this._normalizePrimitiveOverrideProps(o);let d=[255,255,255,1],u=!1;if(null!==(s=e.lineSymbol)&&void 0!==s&&s.symbolLayers)for(const P of e.lineSymbol.symbolLayers){var p,_,b,y;if("CIMSolidStroke"!==P.type)continue;const O=null!==(p=P.primitiveName)&&void 0!==p?p:a;u||!O||P.colorLocked||null==(null===(_=this._poMap[O])||void 0===_?void 0:_.Color)&&null==(null===(b=this._poMap[O])||void 0===b?void 0:b.StrokeColor)||(d=(0,f.e6)(P.color),d=null!==(y=this._maybeGetValueOrOverrideExpression(O,"StrokeColor"))&&void 0!==y?y:this._getValueOrOverrideExpression(l,O,"Color",d),u=!0);const F=this._maybeGetValueOrOverrideExpression(O,"StrokeWidth");if(F){let R=null,I=null;"number"==typeof F?R=F:I=F.valueExpressionInfo;let k=h.find(U=>"strokeWidth"===U.propertyName);k?k.propertyName="width":(k={type:"CIMPrimitiveOverride",primitiveName:O,propertyName:"width",valueExpressionInfo:I,value:R,defaultValue:(0,f.iA)(l,"width")},h.push(k))}}this._cimLayers.push({type:"fill",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:e,overrides:h},colorLocked:!!e.colorLocked,effects:i,color:d,height:this._getValueOrOverrideExpression(l,a,"Separation",(0,f._W)(e.separation,C.D.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(l,a,"Rotation",(0,f._W)(e.rotation)),offsetX:this._getValueOrOverrideExpression(l,a,"OffsetX",(0,f._W)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(l,a,"OffsetY",(0,f._W)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!u})}_analyzeGradientFill(e,i){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,effects:i,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(e,i,s,a){const{primitiveName:l,type:o}=e,h=(0,f.e6)(e.color),d=(0,f._W)(e.width,C.D.CIMSolidStroke.width),u=(0,f.GV)(e.capStyle,C.D.CIMSolidStroke.capstyle),p=(0,f.GV)(e.joinStyle,C.D.CIMSolidStroke.joinstyle),_=e.miterLimit;let b,y,E=[];if(this._analyzePrimitiveOverrides(l,i,null,null)&&(E=this._getPrimitiveMaterialOverrides(l,o)),i&&i instanceof Array&&i.length>0){const O=i[i.length-1].effect;O&&"CIMGeometricEffectDashes"===O.type&&"NoConstraint"===O.lineDashEnding&&null===O.offsetAlongLine&&(b=O.dashTemplate,y=O.scaleDash,(i=[...i]).pop())}this._cimLayers.push({type:"line",spriteRasterizationParam:void 0!==b?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:b,capStyle:u},overrides:E}:null,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(o,l,"Color",h),width:this._getValueOrOverrideExpression(o,l,"Width",d),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",u),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",p),miterLimit:_&&this._getValueOrOverrideExpression(o,l,"MiterLimit",_),referenceWidth:a,zOrder:V(e.name),dashTemplate:b,scaleDash:y,sampleAlphaOnly:!0})}_analyzePictureStroke(e,i,s,a){const{primitiveName:l,type:o}=e,h=(0,f.Ny)(e),d=(0,f._W)(e.width,C.D.CIMPictureStroke.width),u=(0,f.GV)(e.capStyle,C.D.CIMPictureStroke.capstyle),p=(0,f.GV)(e.joinStyle,C.D.CIMPictureStroke.joinstyle),_=e.miterLimit,b={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(l,o)};this._cimLayers.push({type:"line",spriteRasterizationParam:b,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:this._getValueOrOverrideExpression(o,l,"TintColor",h),width:this._getValueOrOverrideExpression(o,l,"Width",d),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",u),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",p),miterLimit:_&&this._getValueOrOverrideExpression(o,l,"MiterLimit",_),referenceWidth:a,zOrder:V(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,i,s,a){const{primitiveName:l,type:o}=e,h=(0,f._W)(e.width,C.D.CIMSolidStroke.width),d=(0,f.GV)(e.capStyle,C.D.CIMGradientStroke.capstyle),u=(0,f.GV)(e.joinStyle,C.D.CIMGradientStroke.joinstyle),p=e.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:s,colorLocked:!!e.colorLocked,effects:i,color:[128,128,128,1],width:this._getValueOrOverrideExpression(o,l,"Width",h),cap:this._getValueOrOverrideExpression(o,l,"CapStyle",d),join:this._getValueOrOverrideExpression(o,l,"JoinStyle",u),miterLimit:p&&this._getValueOrOverrideExpression(o,l,"MiterLimit",p),referenceWidth:a,zOrder:V(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,i,s,a,l,o,h,d,u=!1,p=!1){if(u||(u=!!e.colorLocked),this._analyzeMarkerInsidePolygon(e,i,u))return;const _=(0,f._W)(e.size,C.D.CIMVectorMarker.size),b=(0,f._W)(e.rotation),y=(0,f._W)(e.offsetX),E=(0,f._W)(e.offsetY),{primitiveName:P,type:O}=e,F=this._getValueOrOverrideExpression(O,P,"Size",_),R=this._getValueOrOverrideExpression(O,P,"Rotation",b),I=this._getValueOrOverrideExpression(O,P,"OffsetX",y),k=this._getValueOrOverrideExpression(O,P,"OffsetY",E);switch(e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,i,s,a,l,o,F,R,I,k,d,u,p);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,i,s,a,l,o,F,R,I,k,d,h,u,p)}}_analyzeMarkerInsidePolygon(e,i,s){const{markerPlacement:a,type:l}=e;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;if("CIMVectorMarker"===l||"CIMPictureMarker"===l){const b=e.primitiveName;if(b&&this._analyzePrimitiveOverrides([b],i,null,null))return!1;const y=a.primitiveName;if(y&&this._analyzePrimitiveOverrides([y],i,null,null))return!1;if("CIMVectorMarker"===l){const{markerGraphics:E}=e;if(E)for(const P of E){const{symbol:O}=P;if("CIMPolygonSymbol"===(null==O?void 0:O.type)&&O.symbolLayers){const{symbolLayers:F}=O;for(const R of F)if("CIMSolidStroke"===R.type)return!1}}}else{const{animatedSymbolProperties:E}=e;if(E)return!1}}const o=Math.abs(a.stepX),h=Math.abs(a.stepY);if(0===o||0===h)return!0;let d,u;if("Random"===a.gridType){const b=(0,pe.PN)(M.yv),y=Math.max(Math.floor(b/o),1);d=h*Math.max(Math.floor(b/h),1),u=y*o/d}else a.shiftOddRows?(d=2*h,u=o/h*.5):(d=h,u=o/h);const p=(0,f.Ny)(e);return this._cimLayers.push({type:"fill",spriteRasterizationParam:"CIMCharacterMarker"===e.type?null:{type:"sprite-rasterization-param",resource:e,overrides:[]},colorLocked:s,effects:i,color:p,height:d,scaleX:u,angle:a.gridAngle,offsetX:(0,f._W)(a.offsetX),offsetY:(0,f._W)(a.offsetY),applyRandomOffset:"Random"===a.gridType,sampleAlphaOnly:"CIMPictureMarker"!==e.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,i,s,a,l,o,h,d,u,p,_,b,y){var E,P,O,F,R,I,k,U,B;const{primitiveName:se,type:q}=e;let ue=(0,f._W)(e.scaleX,1);const fe=(0,f.Ny)(e);s||(s=this._createMarkerPlacementOverrideExpression(e.markerPlacement));const oe=this._createAnimatedSymbolPropertiesOverrideExpression(e.animatedSymbolProperties),ne=null!==(E=e.anchorPoint)&&void 0!==E?E:{x:0,y:0};if("width"in e&&"number"==typeof e.width){const Ne=e.width;let Se=1;const Ae=this._resourceManager.getResource(e.url);null!=Ae&&(Se=Ae.width/Ae.height),ue/=Se*((0,f._W)(e.size)/Ne)}const Me=[...a];let we;e.primitiveName&&Me.push(e.primitiveName),e.animatedSymbolProperties||oe?we={type:"animated",url:e.url,urlHash:"H"+(0,Te.Wm)(e.url),playAnimation:null===(P=e.animatedSymbolProperties)||void 0===P?void 0:P.playAnimation,reverseAnimation:null===(O=e.animatedSymbolProperties)||void 0===O?void 0:O.reverseAnimation,randomizeStartTime:null===(F=e.animatedSymbolProperties)||void 0===F?void 0:F.randomizeStartTime,randomizeStartSeed:null===(R=e.animatedSymbolProperties)||void 0===R?void 0:R.randomizeStartSeed,startTimeOffset:null===(I=e.animatedSymbolProperties)||void 0===I?void 0:I.startTimeOffset,duration:null===(k=e.animatedSymbolProperties)||void 0===k?void 0:k.duration,repeatType:null===(U=e.animatedSymbolProperties)||void 0===U?void 0:U.repeatType,repeatDelay:null===(B=e.animatedSymbolProperties)||void 0===B?void 0:B.repeatDelay}:(we=(0,Ue.o8)(e),we.markerPlacement=null);const he={type:"sprite-rasterization-param",resource:we,overrides:this._getMaterialOverrides(Me,q)};oe&&he.overrides.push(...oe.overrides),this._cimLayers.push({type:"marker",spriteRasterizationParam:he,colorLocked:b,effects:i,scaleSymbolsProportionally:!1,alignment:l,size:h,scaleX:this._getValueOrOverrideExpression(q,se,"ScaleX",ue),rotation:d,offsetX:u,offsetY:p,transform:{type:"cim-marker-transform-param",params:_},color:this._getValueOrOverrideExpression(q,se,"TintColor",fe),anchorPoint:{x:ne.x,y:ne.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:o,sizeRatio:1,isOutline:y,markerPlacement:s,animatedSymbolProperties:oe})}_analyzeVectorMarker(e,i,s,a,l,o,h,d,u,p,_,b,y,E){var P,O,F;const R=e.markerGraphics;if(!R)return;const I=e.frame;let k=0;if(k=I?I.ymax-I.ymin:o,k){const U={offsetX:u,offsetY:p,rotation:d,size:h,frameHeight:k,rotateClockWise:!!e.rotateClockwise};_=[..._,U]}s||(s=this._createMarkerPlacementOverrideExpression(e.markerPlacement));for(const U of R)if(U){const B=U.symbol;if(!B)continue;const se=U.primitiveName;let q;if(se&&a.push(se),("CIMPointSymbol"===B.type||"CIMTextSymbol"===B.type)&&I){let ue=0,fe=0;const oe=U.geometry;"x"in oe&&"y"in oe&&(ue+=oe.x-.5*(I.xmin+I.xmax),fe+=oe.y-.5*(I.ymin+I.ymax));const ne=e.anchorPoint;ne&&("Absolute"===e.anchorPointUnits?(ue-=ne.x,fe-=ne.y):I&&(ue-=(I.xmax-I.xmin)*ne.x,fe-=(I.ymax-I.ymin)*ne.y));const Me={offsetX:ue,offsetY:fe,rotation:0,size:0,frameHeight:0,rotateClockWise:!1};q=[..._,Me]}switch(B.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":b||J(B)?this._analyzeMultiLayerGraphicNonSDF(e,i,s,null,U,a,l,o,null!==(P=q)&&void 0!==P?P:_,k,y,E):this._analyzeMultiLayerGraphic(e,i,s,null,U,a,l,o,null!==(O=q)&&void 0!==O?O:_,k,y,E);break;case"CIMTextSymbol":this._analyzeTextGraphic(i,s,U,a,l,o,null!==(F=q)&&void 0!==F?F:_,y)}se&&a.pop()}}_analyzeMultiLayerGraphic(e,i,s,a,l,o,h,d,u,p,_,b){const y=l.symbol,E=y.symbolLayers;if(!E)return;let P=E.length;if(K(E))return void this._analyzeCompositeMarkerGraphic(e,i,s,a,l,E,h,d,u,p,_,b);const O=this._resourceManager.geometryEngine,F=T.V.applyEffects(y.effects,l.geometry,O);if(F)for(;P--;){const B=E[P];if(!B||!1===B.enable)continue;const se=B.primitiveName;switch(se&&o.push(se),B.type){case"CIMSolidFill":case"CIMSolidStroke":{var R,I,k,U;const q=T.V.applyEffects(B.effects,F,O),ue=(0,S.Z7)(q);if(!ue)continue;const fe="Relative"!==e.anchorPointUnits,[oe,ne,Me,we]=(0,S.Fj)(ue,e.frame,e.size,e.anchorPoint,fe),he="CIMSolidFill"===B.type,Ne={type:"sdf",geom:q,asFill:he},{path:Se}=B,Ae=he?(0,f.e6)((0,f.pM)(B)):null==Se?(0,f.e6)((0,f._1)(B)):[0,0,0,0],ot=he?[0,0,0,0]:(0,f.e6)((0,f._1)(B)),Qe=null!==(R=(0,f.xo)(B))&&void 0!==R?R:0;if(!he&&!Qe)break;const $e=l.primitiveName;let Ze=null;he&&!B.colorLocked&&(Ze=this._maybeGetValueOrOverrideExpression($e,"FillColor"));let lt=null;he||B.colorLocked||(lt=this._maybeGetValueOrOverrideExpression($e,"StrokeColor"));const ht=null!==(I=Ze)&&void 0!==I?I:this._getValueOrOverrideExpression(B.type,se,"Color",Ae),Mt=null!==(k=lt)&&void 0!==k?k:this._getValueOrOverrideExpression(B.type,se,"Color",ot),je=null!==(U=this._maybeGetValueOrOverrideExpression($e,"StrokeWidth"))&&void 0!==U?U:this._getValueOrOverrideExpression(B.type,se,"Width",Qe);this._cimLayers.push({type:"marker",spriteRasterizationParam:Se?{type:"sprite-rasterization-param",resource:{type:"path",path:Se,asFill:he},overrides:[]}:{type:"sprite-rasterization-param",resource:Ne,overrides:[]},colorLocked:!!B.colorLocked||!!_,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:ne,y:Me},isAbsoluteAnchorPoint:fe,size:p,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:u},frameHeight:p,widthRatio:we,rotateClockwise:!1,referenceSize:d,sizeRatio:oe,color:ht,outlineColor:Mt,outlineWidth:je,isOutline:b,markerPlacement:s,animatedSymbolProperties:a});break}case"CIMPictureMarker":case"CIMVectorMarker":B.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,h,d,u,p,!!B.colorLocked||!!_,b):this._analyzeMarker(B,i,s,o,h,d,!1,u,_,b);break;default:this._analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,h,d,u,p,!!B.colorLocked||!!_,b)}se&&o.pop()}}_analyzeTextGraphic(e,i,s,a,l,o,h,d){var u,p,_,b,y;v.$.findApplicableOverrides(s,this._primitiveOverrides,[]);const P=s.geometry;if(!("x"in P)||!("y"in P))return;const O=s.symbol,F=(0,f.DW)(O),R=(0,f._d)(O.fontStyleName),I=(0,Oe.af)(O.fontFamilyName);O.font={family:I,decoration:F,...R};const k=(0,f._W)(O.height,C.D.CIMTextSymbol.height),U=(0,f._W)(O.angle),B=(0,f._W)(O.offsetX),se=(0,f._W)(O.offsetY),q=(0,f.e6)((0,f.pM)(O));let ue=(0,f.e6)((0,f._1)(O)),fe=null!==(u=(0,f.xo)(O))&&void 0!==u?u:0;fe||(ue=(0,f.e6)((0,f.pM)(O.haloSymbol)),fe=(0,f._W)(O.haloSize));let oe=!1;if(null!==(p=O.symbol)&&void 0!==p&&p.symbolLayers)for(const je of O.symbol.symbolLayers)null!=(0,f.e6)((0,f.pM)(je))&&(oe=!!je.colorLocked);const ne=s.primitiveName;let Me=null;oe||(Me=this._maybeGetValueOrOverrideExpression(ne,"FillColor"));const we=this._maybeGetValueOrOverrideExpression(ne,"TextSize"),he=this._maybeGetValueOrOverrideExpression(ne,"TextAngle"),Ne=this._maybeGetValueOrOverrideExpression(ne,"TextOffsetX"),Se=this._maybeGetValueOrOverrideExpression(ne,"TextOffsetY");let Ae=null,ot=null,Qe=0;if(O.callout&&"CIMBackgroundCallout"===O.callout.type){const je=O.callout;if(je.backgroundSymbol){const ct=je.backgroundSymbol.symbolLayers;if(ct)for(const qe of ct)"CIMSolidFill"===qe.type?Ae=(0,f.e6)(qe.color):"CIMSolidStroke"===qe.type&&(ot=(0,f.e6)(qe.color),Qe=(0,f._W)(qe.width,C.D.CIMSolidStroke.width))}}const $e=this._getValueOrOverrideExpression(O.type,s.primitiveName,"TextString",null!==(_=s.textString)&&void 0!==_?_:"");if(null==$e)return;const{fontStyleName:Ze}=O,lt=I+(Ze?"-"+Ze.toLowerCase():"-regular"),ht=this._getMaterialOverrides(a,O.type);ht.push(...this._getPrimitiveMaterialOverrides(s.primitiveName,O.type));const Mt={type:"text-rasterization-param",resource:{type:"text",textString:null!==(b=s.textString)&&void 0!==b?b:"",font:O.font,symbol:O,primitiveName:s.primitiveName},overrides:ht};this._cimLayers.push({type:"text",lineWidth:null,textRasterizationParam:Mt,colorLocked:!!d||!!oe,effects:e,alignment:l,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:lt,decoration:F,weight:R.weight,style:R.style,size:null!=we?we:k,angle:null!=he?he:U,offsetX:null!=Ne?Ne:B,offsetY:null!=Se?Se:se,transform:{type:"cim-marker-transform-param",params:h},horizontalAlignment:(0,f.Bu)(O.horizontalAlignment),verticalAlignment:(0,f.Nl)(O.verticalAlignment),text:$e,color:null!==(y=Me)&&void 0!==y?y:this._getValueOrOverrideExpression(O.type,s.primitiveName,"Color",q),outlineColor:ue,outlineSize:fe,backgroundColor:Ae,borderLineColor:ot,borderLineWidth:Qe,referenceSize:o,sizeRatio:1,markerPlacement:i})}_analyzeMultiLayerGraphicNonSDF(e,i,s,a,l,o,h,d,u,p,_,b){const y=this._buildSimpleMarker(e,l),P=this._analyzeMaterialOverrides(e.primitiveName,["Rotation","OffsetX","OffsetY"]),O=this._normalizePrimitiveOverrideProps(P),[F,R,I]=ge.wp.getTextureAnchor(y,this._resourceManager),k=this._getMaterialOverrides(o,e.type);k.push(...O);const U={type:"sprite-rasterization-param",resource:{...y,avoidSDFRasterization:!0},overrides:k};this._cimLayers.push({type:"marker",spriteRasterizationParam:U,colorLocked:_,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:F,y:R},isAbsoluteAnchorPoint:!1,size:p,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:u},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:p,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:d,sizeRatio:I/(0,pe.Lz)(e.size),isOutline:b,markerPlacement:s,animatedSymbolProperties:a})}_createMarkerPlacementOverrideExpression(e){if(!e)return null;const i=[];return v.$.findApplicableOverrides(e,this._primitiveOverrides,i),{type:"cim-marker-placement-info",placement:e,overrides:X(i)}}_createAnimatedSymbolPropertiesOverrideExpression(e){if(!e)return null;const i=[];return v.$.findApplicableOverrides(e,this._primitiveOverrides,i),{type:"cim-animation-info",animation:e,overrides:X(i)}}_buildSimpleMarker(e,i){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[i],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}_analyzeCompositeMarkerGraphic(e,i,s,a,l,o,h,d,u,p,_,b){var y,E,P;const O=l.geometry,F=o[0],R=o[1],I=(0,S.Z7)(O);if(!I)return;const k="Relative"!==e.anchorPointUnits,[U,B,se,q]=(0,S.Fj)(I,e.frame,e.size,e.anchorPoint,k),{path:ue}=R,fe=R.primitiveName,oe=F.primitiveName,ne=l.primitiveName;let Me=null;R.colorLocked||_||(Me=this._maybeGetValueOrOverrideExpression(ne,"FillColor"));const we=null!==(y=Me)&&void 0!==y?y:this._getValueOrOverrideExpression(R.type,fe,"Color",(0,f.e6)(R.color));let he=null;F.colorLocked||_||(he=this._maybeGetValueOrOverrideExpression(ne,"StrokeColor"));const Ne=null!==(E=he)&&void 0!==E?E:this._getValueOrOverrideExpression(F.type,oe,"Color",(0,f.e6)(F.color)),Se=null!==(P=this._maybeGetValueOrOverrideExpression(ne,"StrokeWidth"))&&void 0!==P?P:this._getValueOrOverrideExpression(F.type,oe,"Width",(0,f._W)(F.width,C.D.CIMSolidStroke.width));this._cimLayers.push({type:"marker",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:ue?{type:"path",path:ue,asFill:!0}:{type:"sdf",geom:O,asFill:!0},overrides:[]},colorLocked:_,effects:i,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:B,y:se},isAbsoluteAnchorPoint:k,size:p,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:u},frameHeight:p,widthRatio:q,rotateClockwise:!1,referenceSize:d,sizeRatio:U,color:we,outlineColor:Ne,outlineWidth:Se,isOutline:b,markerPlacement:s,animatedSymbolProperties:a})}_setPoMap(e,i,s){let a;this._poMap[e]?a=this._poMap[e]:(a={},this._poMap[e]=a),a[i]=s}_maybeGetValueOrOverrideExpression(e,i,s){return this._getValueOrOverrideExpression("",e,i,s,!1)}_getValueOrOverrideExpression(e,i,s,a,l=!0){if(l&&!(0,f.ZO)(a)&&(a=(0,f.iA)(e,s.toLowerCase())),null==i)return a;const o=this._poMap[i];if(null==o)return a;const h=o[s];return"string"==typeof h||"number"==typeof h||Array.isArray(h)?h:h?{valueExpressionInfo:h,defaultValue:a}:a}_analyzePrimitiveOverrides(e,i,s,a){if(null==e)return!1;"string"==typeof e&&(e=[e]);for(const l of this._primitiveOverrides)if(e.includes(l.primitiveName)&&l.valueExpressionInfo)return!0;if(null!=i)for(const l of i)if((null==l?void 0:l.overrides.length)>0)return!0;if(null!=s)for(const l of s)if((null==l?void 0:l.overrides.length)>0)return!0;if(null!=a)for(const l of a)if((null==l?void 0:l.overrides.length)>0)return!0;return!1}_getMaterialOverrides(e,i){if(!e)return[];const s=[];for(const a of e)s.push(...this._getPrimitiveMaterialOverrides(a,i));return s}_getPrimitiveMaterialOverrides(e,i){if(!e)return[];const s=this._normalizePrimitiveOverrideProps(this._primitiveOverrides.filter(a=>a.primitiveName===e));return s.forEach(a=>a.defaultValue=(0,f.iA)(i,a.propertyName.toLowerCase())),s}_analyzeMaterialOverrides(e,i){return this._primitiveOverrides.filter(s=>s.primitiveName!==e||!i.includes(s.propertyName))}_normalizePrimitiveOverrideProps(e){return e.map(i=>({...i,propertyName:(0,f.YF)(i.propertyName)}))}}function V(g){if(g&&0===g.indexOf("Level_")){const e=parseInt(g.substr(6),10);if(!isNaN(e))return e}return 0}const K=g=>g&&2===g.length&&g[0].enable&&g[1].enable&&"CIMSolidStroke"===g[0].type&&"CIMSolidFill"===g[1].type&&null==g[0].path&&null==g[1].path&&!g[0].effects&&!g[1].effects;function J(g){const e=g.symbolLayers;if(!e||2!==e.length)return!1;const i=e.find(a=>{var l;return null===(l=a.effects)||void 0===l?void 0:l.find(o=>"CIMGeometricEffectDashes"===o.type&&null!=o.dashTemplate)}),s=e.find(a=>{var l;return null===(l=a.effects)||void 0===l?void 0:l.find(o=>"CIMGeometricEffectAddControlPoints"===o.type)});return!!i||!!s}function X(g){return(0,Ue.o8)(g).map(e=>({...e,propertyName:(0,f.YF)(e.propertyName)}))}var ae=w(88766),ce=w(42425),_e=w(40611),ie=w(17715),re=w(69287),Z=w(76329),Ee=w(44999),Be=w(61189);class Ie{constructor(e){this.events=new ce.A,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const i={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};e.appendChild(this._canvas);let s=(0,Be.q)(this._canvas,i);s||(s=(0,Be.q)(this._canvas,{...i,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=s,this._handles=(0,ie.vE)([(0,_e.on)(this._canvas,"webglcontextlost",a=>this.events.emit("webgl-context-lost",a))])}destroy(){var e;null!==(e=this._canvas.parentNode)&&void 0!==e&&e.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(e,i){if(this._hasMajorPerformanceCaveat||(0,de.A)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,de.A)("esri-performance-mode-frames-between-render")&&(i(),this._lastRenderViewState=e.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[s,a,l,o,h,d]=this._computeViewTransform(this._lastRenderViewState,e.state);this._canvas.style.transform=`matrix(${s}, ${a}, ${l}, ${o}, ${h}, ${d})`}}else i()}resize(e){const i=this._canvas,s=i.style,{state:{size:a},pixelRatio:l}=e,o=a[0],h=a[1],d=Math.round(o*l),u=Math.round(h*l);i.width===d&&i.height===u||(i.width=d,i.height=u),s.width=o+"px",s.height=h+"px"}_computeViewTransform(e,i){const[s,a]=e.center,[l,o]=i.center,[h,d]=e.toScreen([0,0],l,o),[u,p]=e.toScreen([0,0],s,a),_=u-h,b=p-d,y=e.scale/i.scale,E=i.rotation-e.rotation,P=(0,Ee.vt)();return(0,Z.D_)(P),(0,Z.hs)(P,P,[y,y]),(0,Z.e$)(P,P,(0,re.kU)(E)),(0,Z.Tl)(P,P,[_,b]),P}}var te=w(69473),De=w(12173),m=w(20904);const z={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}},W=new(w(87805).Z)(function G(g){let e=z;return g.split("/").forEach(i=>{e&&(e=e[i])}),e});function j(g){return W.resolveIncludes(g)}var ee=w(37488);const Pe=g=>(0,ee.I)({PATTERN:g.pattern}),et={shaders:g=>({vertexShader:Pe(g)+j("background/background.vert"),fragmentShader:Pe(g)+j("background/background.frag")})},Yt={shaders:g=>({vertexShader:j("circle/circle.vert"),fragmentShader:j("circle/circle.frag")})},wt=g=>(0,ee.I)({PATTERN:g.pattern}),Kt={shaders:g=>({vertexShader:wt(g)+j("fill/fill.vert"),fragmentShader:wt(g)+j("fill/fill.frag")})},Jt={shaders:g=>({vertexShader:j("outline/outline.vert"),fragmentShader:j("outline/outline.frag")})},St=g=>(0,ee.I)({SDF:g.sdf}),Qt={shaders:g=>({vertexShader:St(g)+j("icon/icon.vert"),fragmentShader:St(g)+j("icon/icon.frag")})},Ot=g=>(0,ee.I)({PATTERN:g.pattern,SDF:g.sdf}),Zt={shaders:g=>({vertexShader:Ot(g)+j("line/line.vert"),fragmentShader:Ot(g)+j("line/line.frag")})},qt={shaders:g=>({vertexShader:j("text/text.vert"),fragmentShader:j("text/text.frag")})};class ei{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,i,s){const a=i.key<<3|this._getMaterialOptionsValue(i.type,s);if(this._programByKey.has(a))return this._programByKey.get(a);const l=this._getProgramTemplate(i.type),{shaders:o}=l,{vertexShader:h,fragmentShader:d}=o(s),u=i.getShaderHeader(),p=i.getShaderMain(),_=h.replace("#pragma header",u).replace("#pragma main",p),b=e.programCache.acquire(_,d,i.getAttributeLocations());return this._programByKey.set(a,b),b}_getMaterialOptionsValue(e,i){switch(e){case m.kh.BACKGROUND:case m.kh.FILL:return(i.pattern?1:0)<<1;case m.kh.OUTLINE:return 0;case m.kh.LINE:return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1;case m.kh.ICON:return(i.sdf?1:0)<<1;default:return 0}}_getProgramTemplate(e){switch(e){case m.kh.BACKGROUND:return et;case m.kh.CIRCLE:return Yt;case m.kh.FILL:return Kt;case m.kh.ICON:return Qt;case m.kh.LINE:return Zt;case m.kh.OUTLINE:return Jt;case m.kh.TEXT:return qt;default:return null}}}var Pt=w(9599),Ct=w(6115),dt=w(32788),x=w(50915),tt=w(80831),pt=w(45513);class Tt{constructor(){this._initialized=!1}dispose(){this._program=(0,$.WD)(this._program),this._vertexArrayObject=(0,$.WD)(this._vertexArrayObject)}render(e,i,s,a){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),i.setSamplingMode(s),e.bindTexture(i,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",a),e.drawArrays(x.WR.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const i=(0,tt.r)(e,Ct.J);if(!i)return!1;const s=new Int8Array(16);s[0]=-1,s[1]=-1,s[2]=0,s[3]=0,s[4]=1,s[5]=-1,s[6]=1,s[7]=0,s[8]=-1,s[9]=1,s[10]=0,s[11]=1,s[12]=1,s[13]=1,s[14]=1,s[15]=1;const l=new pt.Z(e,Ct.J.attributes,Pt.oI,{geometry:dt.g.createVertex(e,x._U.STATIC_DRAW,s)});return this._program=i,this._vertexArrayObject=l,this._initialized=!0,!0}}var ti=w(3276);class ii{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getProgram(e,i=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(i);if(this._programByKey.has(s))return this._programByKey.get(s);const a={...i.map(p=>"string"==typeof p?{name:p,value:!0}:p).reduce((p,_)=>({...p,[_.name]:_.value}),{})},{vsPath:l,fsPath:o,attributes:h}=e,d=(0,ti.p)(l,o,h,a),u=this._rctx.programCache.acquire(d.shaders.vertexShader,d.shaders.fragmentShader,d.attributes);if(!u)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,u),u}}var ri=w(23098),Xe=w(89563),si=w(47139),Re=w(56492),ai=w(96128),Et=w(28685),ni=w(9792);class li{constructor(e){this._resourceManager=e,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(e,i){switch(e.type){case"dash":{const s=e.dashTemplate,a=e.capStyle,[l,o,h]=(0,Et.k)(s,a);return{size:[o,h],image:new Uint32Array(l.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[s,a,l,o]=(0,Et.c)(this._canvas,e,i);return{size:[a,l],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:o}}case"sdf":return this._rasterizeSDFInfo(e);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(e,i)}}_rasterizeCIMJSONResource(e,i){switch(e.type){case"CIMHatchFill":{const a=ge.wp.fromCIMHatchFill(e,i);return this._rasterizeCIMVectorMarker(a)}case"CIMPictureMarker":{const a=ge.wp.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(a)}case"CIMVectorMarker":{var s;if("CIMMarkerPlacementInsidePolygon"===(null===(s=e.markerPlacement)||void 0===s?void 0:s.type)){const l=ge.wp.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(l)}const a=(0,S.eR)(e);return a&&!e.avoidSDFRasterization?this._rasterizeSDFInfo(a):this._rasterizeCIMVectorMarker(e,!1)}}}_rasterizeSDFInfo(e){if(!e)return null;const[i,s,a]=(0,S.ce)(e);return i?{size:[s,a],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}_rasterizeCIMVectorMarker(e,i=!0){const s=i?ni.A.fromExtent(e.frame):null,[a,l,o,h,d]=ge.wp.rasterize(this._canvas,e,s,this._resourceManager);return a?{size:[l,o],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!1,anchorX:h,anchorY:d}:null}rasterizeImageResource(e,i,s,a){this._canvas.width=e,this._canvas.height=i;const l=this._canvas.getContext("2d",{willReadFrequently:!0});s instanceof ImageData?l.putImageData(s,0,0):(s.setAttribute("width",`${e}px`),s.setAttribute("height",`${i}px`),l.drawImage(s,0,0,e,i));const o=l.getImageData(0,0,e,i),h=new Uint8Array(o.data);if(a)for(const y of a)if(y&&y.oldColor&&4===y.oldColor.length&&y.newColor&&4===y.newColor.length){const[E,P,O,F]=y.oldColor,[R,I,k,U]=y.newColor;if(E===R&&P===I&&O===k&&F===U)continue;for(let B=0;B<h.length;B+=4)E===h[B]&&P===h[B+1]&&O===h[B+2]&&F===h[B+3]&&(h[B]=R,h[B+1]=I,h[B+2]=k,h[B+3]=U)}let d;for(let y=0;y<h.length;y+=4)d=h[y+3]/255,h[y]=h[y]*d,h[y+1]=h[y+1]*d,h[y+2]=h[y+2]*d;let u=h,p=e,_=i;const b=512;if(p>=b||_>=b){const y=p/_;y>1?(p=b,_=Math.round(b/y)):(_=b,p=Math.round(b*y)),u=new Uint8Array(4*p*_);const E=new Uint8ClampedArray(u.buffer);(0,f.Go)(h,e,i,E,p,_,!1)}return{size:[p,_],image:new Uint32Array(u.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var be=w(68973);class it{constructor(e,i){this._width=0,this._height=0,this._free=[],this._width=e,this._height=i,this._free.push(new be.A(0,0,e,i))}get width(){return this._width}get height(){return this._height}allocate(e,i){if(e>this._width||i>this._height)return new be.A;let s=null,a=-1;for(let l=0;l<this._free.length;++l){const o=this._free[l];e<=o.width&&i<=o.height&&(null===s||o.y<=s.y&&o.x<=s.x)&&(s=o,a=l)}return null===s?new be.A:(this._free.splice(a,1),s.width<s.height?(s.width>e&&this._free.push(new be.A(s.x+e,s.y,s.width-e,i)),s.height>i&&this._free.push(new be.A(s.x,s.y+i,s.width,s.height-i))):(s.width>e&&this._free.push(new be.A(s.x+e,s.y,s.width-e,s.height)),s.height>i&&this._free.push(new be.A(s.x,s.y+i,e,s.height-i))),new be.A(s.x,s.y,e,i))}release(e){for(let i=0;i<this._free.length;++i){const s=this._free[i];if(s.y===e.y&&s.height===e.height&&s.x+s.width===e.x)s.width+=e.width;else if(s.x===e.x&&s.width===e.width&&s.y+s.height===e.y)s.height+=e.height;else if(e.y===s.y&&e.height===s.height&&e.x+e.width===s.x)s.x=e.x,s.width+=e.width;else{if(e.x!==s.x||e.width!==s.width||e.y+e.height!==s.y)continue;s.y=e.y,s.height+=e.height}this._free.splice(i,1),this.release(e)}this._free.push(e)}}var ke=w(26136),le=w(4931);const ci=g=>Math.floor(g/256);class fi{constructor(e,i,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=e,this.height=i,this._glyphSource=s,this._binPack=new it(e-4,i-4),this._glyphData.push(new Uint8Array(e*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const e=[117,149,181,207,207,181,149,117],i=[],s=[];for(let o=0;o<e.length;o++){const h=e[o];for(let d=0;d<11;d++){const u=o>=3&&o<5&&d>=3&&d<8?255:0;i.push(h),s.push(u)}}const a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)},l={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(s)};this._recordGlyph(a),this._recordGlyph(l)}getTexture(e,i){if(!this._textures[i]){const s=new le.R;s.pixelFormat=x.Ab.ALPHA,s.wrapMode=x.pF.CLAMP_TO_EDGE,s.width=this.width,s.height=this.height,this._textures[i]=new ke.g(e,s,new Uint8Array(this.width*this.height))}return this._dirties[i]&&(this._textures[i].setData(this._glyphData[i]),this._dirties[i]=!1),this._textures[i]}getGlyphItems(e,i,s){var a=this;return(0,Q.A)(function*(){const l=a._getGlyphCache(e);return yield a._fetchRanges(e,i,s),i.map(o=>a._getMosaicItem(l,e,o))})()}bind(e,i,s,a){const l=this.getTexture(e,s);l.setSamplingMode(i),e.bindTexture(l,a)}preloadASCIIGlyphCache(e){const i=this._preloadCache[e];if(null!=i)return i;const s=this._glyphSource.preloadASCIIRange(e).then(()=>{const a=this._getGlyphCache(e);for(let l=0;l<256;l++)this._getMosaicItem(a,e,l)});return this._preloadCache[e]=s,s}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,i,s){var a=this;return(0,Q.A)(function*(){const l=function ui(g){const e=new Set;for(const i of g)e.add(ci(i));return e}(i),o=[];l.forEach(h=>{o.push(a._fetchRange(e,h,s))}),yield Promise.all(o)})()}_fetchRange(e,i,s){var a=this;return(0,Q.A)(function*(){if(!(i>256))return function di(g,e,i){return g.has(e)||g.set(e,i().then(()=>{g.delete(e)}).catch(s=>{g.delete(e),(0,Re.jH)(s)})),g.get(e)}(a._rangePromises,e+i,()=>a._glyphSource.getRange(e,i,s))})()}_getMosaicItem(e,i,s){if(!e[s]){const a=this._glyphSource.getGlyph(i,s);if(null==a||!a.metrics)return g=s,{rect:new be.A(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:g,sdf:!0};const l=this._recordGlyph(a);e[s]={rect:l,page:this._currentPage,metrics:a.metrics,code:s,sdf:!0},this._invalidate()}var g;return e[s]}_recordGlyph(e){const i=e.metrics;let s;if(0===i.width)s=new be.A(0,0,0,0);else{const l=i.width+6,o=i.height+6;s=this._binPack.allocate(l,o),s.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new it(this.width-4,this.height-4),s=this._binPack.allocate(l,o));const h=this._glyphData[this._currentPage],d=e.bitmap;let u,p;if(d)for(let _=0;_<o;_++){u=l*_,p=this.width*(s.y+_)+s.x;for(let b=0;b<l;b++)h[p+b]=d[u+b]}(0,de.A)("esri-glyph-debug")&&this._showDebugPage(h)}return s}_showDebugPage(e){const i=document.createElement("canvas"),s=i.getContext("2d"),a=new ImageData(this.width,this.height),l=a.data;i.width=this.width,i.height=this.height,i.style.border="1px solid black";for(let o=0;o<e.length;++o)l[4*o]=e[o],l[4*o+1]=0,l[4*o+2]=0,l[4*o+3]=255;s.putImageData(a,0,0),document.body.appendChild(i)}}var Rt=w(55912);class At{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const i=e.getMessage();for(;i.next();)switch(i.tag()){case 3:{const s=i.getMessage();let a,l,o,h,d,u,p;for(;s.next();)switch(s.tag()){case 1:a=s.getUInt32();break;case 2:l=s.getBytes();break;case 3:o=s.getUInt32();break;case 4:h=s.getUInt32();break;case 5:d=s.getSInt32();break;case 6:u=s.getSInt32();break;case 7:p=s.getUInt32();break;default:s.skip()}s.release(),a&&(this._metrics[a]={width:o,height:h,left:d,top:u,advance:p},this._bitmaps[a]=l);break}default:i.skip()}i.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class mi{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,i){this._ranges[e]=i}}class gi{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,i,s){const a=this._getFontStack(e);if(a.getRange(i))return Promise.resolve();const l=256*i,o=l+255,h=this._baseURL.replace("{fontstack}",e).replace("{range}",l+"-"+o);return(0,Xe.A)(h,{responseType:"array-buffer",...s}).then(d=>{a.addRange(i,new At(new Rt.A(new Uint8Array(d.data),new DataView(d.data))))})}preloadASCIIRange(e){var i=this;return(0,Q.A)(function*(){const s=i._getFontStack(e),o=i._baseURL.replace("{fontstack}",e).replace("{range}","0-255"),h=yield(0,Xe.A)(o,{responseType:"array-buffer"}),d=new At(new Rt.A(new Uint8Array(h.data),new DataView(h.data)));for(let u=0;u<=255;u++)s.getRange(u)||s.addRange(u,d)})()}getGlyph(e,i){const s=this._getFontStack(e);if(!s)return;const a=Math.floor(i/256),l=s.getRange(a);return l?{metrics:l.getMetrics(i),bitmap:l.getBitmap(i)}:void 0}_getFontStack(e){let i=this._glyphInfo[e];return i||(i=this._glyphInfo[e]=new mi),i}}var _i=w(86468);const Ye=1e20;class vi{constructor(e){this._svg=null,this.size=e;const i=document.createElement("canvas");i.width=i.height=e,this._context=i.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,i,s,a=31){this._initSVG();const l=this.createSVGString(e,i);return new Promise((o,h)=>{const d=new Image;d.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(l),d.onload=()=>{d.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(d,0,0,this.size,this.size);const p=this._context.getImageData(0,0,this.size,this.size),_=new Uint8Array(this.size*this.size*4);for(let b=0;b<this.size*this.size;b++){const y=p.data[4*b+3]/255;this._gridOuter[b]=1===y?0:0===y?Ye:Math.max(0,.5-y)**2,this._gridInner[b]=1===y?Ye:0===y?0:Math.max(0,y-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let b=0;b<this.size*this.size;b++)(0,_i.U)(.5-(this._gridOuter[b]-this._gridInner[b])/(2*a),_,4*b);o(_)};const u=null==s?void 0:s.signal;u&&(0,Re.u7)(u,()=>h((0,Re.NK)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}return this._svg}createSVGString(e,i){const s=this._initSVG(),a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",e),s.appendChild(a);const l=a.getBBox(),o=l.width/l.height,h=this.size/2;let d,u,p;o>1?(d=h/l.width,u=this.size/4,p=h-h*(1/o)/2):(d=h/l.height,u=h-h*o/2,p=this.size/4),a.setAttribute("style",`transform: matrix(${d}, 0, 0, ${d}, ${-l.x*d+u}, ${-l.y*d+p})`),a.setAttribute("stroke-width",""+.5/d);const y=`<svg style="fill:${i?"red":"none"}; stroke:${i?"none":"red"}" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${s.innerHTML}</svg>`;return s.removeChild(a),y}_edt(e,i,s){const a=this._f,l=this._d,o=this._v,h=this._z;for(let d=0;d<i;d++){for(let u=0;u<s;u++)a[u]=e[u*i+d];this._edt1d(a,l,o,h,s);for(let u=0;u<s;u++)e[u*i+d]=l[u]}for(let d=0;d<s;d++){for(let u=0;u<i;u++)a[u]=e[d*i+u];this._edt1d(a,l,o,h,i);for(let u=0;u<i;u++)e[d*i+u]=Math.sqrt(l[u])}}_edt1d(e,i,s,a,l){s[0]=0,a[0]=-Ye,a[1]=+Ye;for(let o=1,h=0;o<l;o++){let d=(e[o]+o*o-(e[s[h]]+s[h]*s[h]))/(2*o-2*s[h]);for(;d<=a[h];)h--,d=(e[o]+o*o-(e[s[h]]+s[h]*s[h]))/(2*o-2*s[h]);h++,s[h]=o,a[h]=d,a[h+1]=+Ye}for(let o=0,h=0;o<l;o++){for(;a[h+1]<o;)h++;i[o]=(o-s[h])*(o-s[h])+e[s[h]]}}}var Ft=w(31250);function Ve(g){return g&&"static"===g.type}class ft{constructor(e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new it(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),l=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*l)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,i,s,a,l,o,h=1){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let d,u,p;if(Ve(s)?[d,u,p]=this._allocateImage(i[0],i[1]):(d=new be.A(0,0,i[0],i[1]),u=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:s,size:[i[0]+2*M.hM,i[1]+2*M.hM],dirty:!0,texture:void 0})),d.width<=0||d.height<=0)return null;const _={type:"sprite",rect:d,width:i[0],height:i[1],sdf:l,simplePattern:o,rasterizationScale:h,page:u};return this._mosaicRects.set(e,_),Ve(s)&&((0,de.A)("esri-mosaic-debug")&&this._showDebugSprite(i,s.data),this._copy({rect:d,spriteSize:i,spriteData:s.data,page:u,pageSize:p,repeat:a,sdf:l})),_}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getMosaicItemPosition(e){const i=this.getSpriteItem(e),s=null==i?void 0:i.rect;if(!s)return null;s.width=i.width,s.height=i.height;const o=M.hM,h=this._mosaicPages[i.page].size;return{size:[i.width,i.height],tl:[(s.x+o)/h[0],(s.y+o)/h[1]],br:[(s.x+o+i.width)/h[0],(s.y+o+i.height)/h[1]],page:i.page}}bind(e,i,s=0,a=0){const l=this._mosaicPages[s],o=l.mosaicsData;let h=l.texture;h||(h=zt(e,l.size),l.texture=h),h.setSamplingMode(i),Ve(o)?(e.bindTexture(h,a),l.dirty&&(h.setData(new Uint8Array(o.data.buffer)),h.generateMipmap(),(0,de.A)("esri-mosaic-debug")&&this._showDebugPage(s))):(o.data.loadFrame(h),e.bindTexture(h,a),h.generateMipmap()),l.dirty=!1}getTexture(e,i=0){const s=this._mosaicPages[i],a=s.mosaicsData;let l=s.texture;return l||(l=zt(e,s.size),s.texture=l),Ve(a)?s.dirty&&(l.setData(new Uint8Array(a.data.buffer)),l.generateMipmap(),(0,de.A)("esri-mosaic-debug")&&this._showDebugPage(i)):(a.data.loadFrame(l),l.generateMipmap()),s.dirty=!1,l}dispose(){this._binPack=null;for(const e of this._mosaicPages){const i=e.texture;i&&i.dispose();const s=e.mosaicsData;Ve(s)||s.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(e,i,s,a,l,o,h,d,u,p,_){let b=a*i+s,y=d*o+h;if(_){y-=o;for(let E=-1;E<=p;E++,b=((E+p)%p+a)*i+s,y+=o)for(let P=-1;P<=u;P++)l[y+P]=e[b+(P+u)%u]}else for(let E=0;E<p;E++){for(let P=0;P<u;P++)l[y+P]=e[b+P];b+=i,y+=o}}_copy(e){if(e.page>=this._mosaicPages.length)return;const i=this._mosaicPages[e.page],s=i.mosaicsData;if(!Ve(i.mosaicsData))throw new ve.A("mapview-invalid-resource","unsuitable data type!");const a=e.spriteData,l=s.data;l&&a||console.error("Source or target images are uninitialized!"),ft._copyBits(a,e.spriteSize[0],0,0,l,e.pageSize[0],e.rect.x+M.hM,e.rect.y+M.hM,e.spriteSize[0],e.spriteSize[1],e.repeat),i.dirty=!0}_allocateImage(e,i){e+=2*M.hM,i+=2*M.hM;const s=Math.max(e,i);if(this._maxItemSize&&this._maxItemSize<s){const l=2**Math.ceil((0,Ft.p6)(e)),o=2**Math.ceil((0,Ft.p6)(i)),h=new be.A(0,0,e,i);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(l*o)},size:[l,o],dirty:!0,texture:void 0}),[h,this._mosaicPages.length-1,[l,o]]}const a=this._binPack.allocate(e,i);if(a.width<=0){const l=this._mosaicPages[this._currentPage];return!l.dirty&&Ve(l.mosaicsData)&&(l.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new it(this._pageWidth,this._pageHeight),this._allocateImage(e,i)}return[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([e,i],s){const a=document.createElement("canvas");a.width=e,a.height=i,a.setAttribute("style",`position: absolute; top: ${4+204*yi++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const l=a.getContext("2d"),o=new ImageData(e,i);o.data.set(new Uint8Array(s.buffer)),l.putImageData(o,0,0),document.body.appendChild(a)}_showDebugPage(e){var i;const s=this._mosaicPages[e],{size:[a,l],mosaicsData:o}=s;if(!Ve(o))return void console.error("Could not show sprite mosaic debug for non-static resource");const h=`mosaicDebugPage${e}`,d=null!==(i=document.getElementById(h))&&void 0!==i?i:document.createElement("canvas");d.id=h,d.width=a,d.height=l,d.setAttribute("style",`position: absolute; top: ${4+204*e}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const u=d.getContext("2d"),p=new ImageData(a,l);p.data.set(new Uint8Array(o.data.buffer)),u.putImageData(p,0,0),document.body.appendChild(d)}}let yi=0;function zt(g,e){const i=new le.R;return i.width=e[0],i.height=e[1],i.wrapMode=x.pF.CLAMP_TO_EDGE,new ke.g(g,i,null)}var mt=w(24370),bi=w(70418);class xi{constructor(e,i,s,a){this._animation=e,this._frameData=null,this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=(0,bi.ZH)(this._animation,s,a,o=>{this._frameData=o,i.requestRender()})}destroy(){this._playHandle.remove()}loadFrame(e){const i=this._frameData;null!=i&&(e.updateData(0,M.hM,M.hM,"width"in i?i.width:i.codedWidth,"height"in i?i.height:i.codedHeight,i),this._frameData=null)}}var Mi=w(56330);const Bt="arial-unicode-ms-regular",We=(g,e,i)=>ye.A.getLogger("esri.views.2d.engine.webgl.TextureManager").error(new ve.A(g,e,i));class gt{static fromMosaic(e,i){return new gt(e,i.page,i.sdf)}constructor(e,i,s){this.mosaicType=e,this.page=i,this.sdf=s}}class Oi{constructor(e){var i;this._requestRender=e,this._resourceManager=new ai.A,this._invalidFontsMap=new Map,this._sdfConverter=new vi(M._j),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Mi.e({concurrency:10,process:(i=(0,Q.A)(function*(s,a){(0,Re.Te)(a);try{return yield(0,Xe.A)(s,{responseType:"image",signal:a})}catch(l){throw(0,Re.zf)(l)?l:new ve.A("mapview-invalid-resource",`Could not fetch requested resource at ${s}`,l)}}),function(a,l){return i.apply(this,arguments)})}),this._spriteMosaic=new ft(2048,2048,500),this._glyphSource=new gi(`${ri.A.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new fi(1024,1024,this._glyphSource),this._rasterizer=new li(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}rasterizeItem(e,i){var s=this;return(0,Q.A)(function*(){if(null==e)return We("mapview-null-resource","Unable to rasterize null resource"),null;if("cim-rasterization-info"!==e.type)return We("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:a}=e;if("text"===a.type){const o=yield s._rasterizeText(a,i);for(const h of o.glyphs)s._setTextureBinding(te.Be.GLYPH,h);return o}const l=yield s._rasterizeSprite(a,i);return l&&s._setTextureBinding(te.Be.SPRITE,l),l})()}getMosaicInfo(e,i,s=!1){const a=this._getTextureBindingInfo(e,i,s);return a?{size:a.size,texture:{texture:a.texture,unit:"sprite"===a.type?M.Pq:M.ue}}:(We("mapview-invalid-resource",`Unable to find resource for ${i}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(e,i,s){const a=this._bindingInfos[i-1],l=a.page,o=s?x.Cj.LINEAR_MIPMAP_LINEAR:x.Cj.LINEAR;switch(a.mosaicType){case te.Be.SPRITE:{const h=[this.sprites.getWidth(l),this.sprites.getHeight(l)],d=this._spriteMosaic.getTexture(e,l);return d.setSamplingMode(o),{type:"sprite",texture:d,size:h}}case te.Be.GLYPH:{const h=[this.glyphs.width,this.glyphs.height],d=this._glyphMosaic.getTexture(e,l);return this._glyphMosaic.bind(e,o,l,M.ue),d.setSamplingMode(o),{type:"glyph",texture:d,size:h}}default:return We("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`),null}}_hashMosaic(e,i){return 1|e<<1|(i.sdf?1:0)<<2|i.page<<3}_setTextureBinding(e,i){const s=this._hashMosaic(e,i);if(!this._hashToBindingIndex.has(s)){const a=gt.fromMosaic(e,i);this._hashToBindingIndex.set(s,this._bindingInfos.length+1),this._bindingInfos.push(a)}i.textureBinding=this._hashToBindingIndex.get(s)}_rasterizeText(e,i){var s=this;return(0,Q.A)(function*(){const{font:a,textString:l}=e,o=(0,Oe.rK)(a),h=s._invalidFontsMap.has(o),[d,u]=(0,si.y)(l),p=(0,mt.bX)(d);try{const _=h?Bt:o;return(0,de.A)("esri-2d-stabilize-glyphs")&&(yield s._glyphMosaic.preloadASCIIGlyphCache(_)),{type:"glyphs",glyphs:yield s._glyphMosaic.getGlyphItems(_,p,i),isRightToLeft:u}}catch{return We("mapview-invalid-resource",`Couldn't find font ${o}. Falling back to Arial Unicode MS Regular`),s._invalidFontsMap.set(o,!0),{type:"glyphs",glyphs:yield s._glyphMosaic.getGlyphItems(Bt,p,i),isRightToLeft:u}}})()}_hashSpriteResource(e){switch(e.type){case"path":return`path:${e.path}.${e.asFill?1:0}`;case"CIMPictureMarker":return`${e.type}:${e.url}:${e.size}`;case"CIMPictureFill":return`${e.type}:${e.url}:${e.height}`;case"CIMPictureStroke":return`${e.type}:${e.url}:${e.width}`;case"dash":return`dash:${e.capStyle}.${e.dashTemplate.join("")}`;case"sdf":return`sdf:${JSON.stringify(e.geom)}.${e.asFill?1:0}`;case"fill-style":return`fill_style:${e.style}`;case"animated":return JSON.stringify((0,mt.IF)(e));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(e)}}_rasterizeSprite(e,i){var s=this;return(0,Q.A)(function*(){var a;if(!e)return null;const l=(0,Te.Wm)(s._hashSpriteResource(e));if(s._spriteMosaic.has(l))return s._spriteMosaic.getSpriteItem(l);if("url"in e&&e.url||"CIMPictureFill"===e.type||"CIMPictureStroke"===e.type||"CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type){const o=[];ge.wp.fetchResources({type:"CIMPointSymbol",symbolLayers:[e]},s._resourceManager,o),o.length>0&&(yield Promise.all(o))}switch(e.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===(null===(a=e.markerPlacement)||void 0===a?void 0:a.type)?s._rasterizeJSONResource(l,e):s._handleAsyncResource(l,e,i);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return s._handleAsyncResource(l,e,i);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return s._rasterizeJSONResource(l,e)}})()}_rasterizeJSONResource(e,i){const s=this._rasterizer.rasterizeJSONResource(i,function Si(g){switch(g.type){case"fill-style":case"CIMHatchFill":return M.nW}return 1}(i));if(s){const{size:a,image:l,sdf:o,simplePattern:h,rasterizationScale:d}=s;return this._addItemToMosaic(e,a,{type:"static",data:l},rt(i),o,h,d)}return null}_handleAsyncResource(e,i,s){var a=this;return(0,Q.A)(function*(){if(a._ongoingRasterizations.has(e))return a._ongoingRasterizations.get(e);let l;return l="path"===i.type?a._handleSVG(i,e,s):a._handleImage(i,e,s),a._ongoingRasterizations.set(e,l),l.finally(()=>a._ongoingRasterizations.delete(e)),l})()}_handleSVG(e,i,s){var a=this;return(0,Q.A)(function*(){const l=[M._j,M._j],{asFill:o}=e,h=yield a._sdfConverter.draw(e.path,o,s);return a._addItemToMosaic(i,l,{type:"static",data:new Uint32Array(h.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,i,s){var a=this;return(0,Q.A)(function*(){const o=a.resourceManager.getResource(e.url);if(null==o)return null;const{width:h,height:d}=o;if(o instanceof HTMLImageElement){if("animated"===e.type)return We("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const y="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:E,sdf:P,image:O}=a._rasterizer.rasterizeImageResource(h,d,o,y);return a._addItemToMosaic(i,E,{type:"static",data:O},rt(e),P,!1)}let u,p,_;"animated"===e.type?(u=!1,p={playAnimation:e.playAnimation,reverseAnimation:e.reverseAnimation,randomizeStartTime:e.randomizeStartTime,randomizeStartSeed:e.randomizeStartSeed,startTimeOffset:e.startTimeOffset,duration:e.duration,repeatType:e.repeatType,repeatDelay:e.repeatDelay},_=e.startGroup||0):(u=rt(e),p={},_=0);const b=new xi(o,a._requestRender,p,_);return a._addItemToMosaic(i,[b.width,b.height],{type:"animated",data:b},u,!1,!1)})()}_handleImage(e,i,s){var a=this;return(0,Q.A)(function*(){const l=e.url;if(Ci(l)||Ei(l))return a._handleGIFOrPNG(e,i,s);if("animated"===e.type)return We("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let h;const d=a.resourceManager.getResource(l);if(null!=d&&d instanceof HTMLImageElement)h=d;else{const{data:P}=yield a._imageRequestQueue.push(l,{...s});h=P}if((0,mt.UE)(l))if("width"in e&&"height"in e)h.width=(0,pe.Lz)(e.width),h.height=(0,pe.Lz)(e.height);else if("cim"in e){var o;const P=e;h.width=(0,pe.Lz)(null!==(o=P.width)&&void 0!==o?o:P.scaleX*P.size),h.height=(0,pe.Lz)(P.size)}if(!h.width||!h.height)return null;const u=h.width,p=h.height,_="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:b,sdf:y,image:E}=a._rasterizer.rasterizeImageResource(u,p,h,_);return a._addItemToMosaic(i,b,{type:"static",data:E},rt(e),y,!1)}catch(h){throw(0,Re.zf)(h)?h:new ve.A("mapview-invalid-resource",`Could not fetch requested resource at ${l}. ${h.message}`)}})()}_addItemToMosaic(e,i,s,a,l,o,h){return this._spriteMosaic.addSpriteItem(e,i,s,a,l,o,h)}}function rt(g){switch(g.type){case"CIMVectorMarker":case"CIMPictureMarker":return Ri(g);default:return!0}}const Ci=g=>g&&(g.includes(".gif")||(g=>null!=g&&g.startsWith("data:image/gif"))(g)),Ei=g=>g&&(g.includes(".png")||(g=>null!=g&&g.startsWith("data:image/png"))(g)),Ri=g=>g&&"markerPlacement"in g&&g.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===g.markerPlacement.type;class Ai{constructor(e){this._queue=[],this._refreshable=e}destroy(){this._queue=[]}enqueueTextureUpdate(e,i){const s=(0,Re.Tw)(),a=e,l=M.Qb,o=Math.ceil(a.height/l);(0,Re.Te)(i);for(let h=0;h<o;h++){const u=h===o-1;this._queue.push({type:"chunk",request:e,resolver:s,chunk:h,chunkOffset:h*l,destHeight:u?a.height-l*h:l,chunkIsLast:u,options:i})}return(0,Re.NY)(i,h=>s.reject(h)),s.promise}upload(){let e=0;for(;this._queue.length;){const i=performance.now(),s=this._queue.shift();if(s){if(null!=s.options.signal&&s.options.signal.aborted)continue;switch(s.type){case"chunk":this._uploadChunk(s);break;case"no-chunk":this._uploadNoChunk(s)}const a=performance.now()-i;if(e+=a,e+a>=M.r1)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(e){const{request:i,resolver:s,chunkOffset:a,chunkIsLast:l,destHeight:o}=e,{data:h,texture:d,width:u}=i;null!=h&&(d.updateData(0,0,a,u,o,h,a),l&&s.resolve())}_uploadNoChunk(e){const{request:i,resolver:s}=e,{data:a,texture:l}=i;l.setData(a),s.resolve()}}var Ge=w(91837),Fi=w(85952),Ke=w(31610),zi=w(45475),_t=w(28714),vt=w(25866),Bi=w(64559);const Ii=(0,zi.fA)(-.5,-.5);class Di{constructor(){this._centerNdc=(0,vt.vt)(),this._pxToNdc=(0,vt.vt)(),this._worldDimensionsPx=(0,vt.vt)(),this._mat3=(0,Ce.vt)(),this._initialized=!1}dispose(){this._program=(0,$.WD)(this._program),this._quad=(0,$.WD)(this._quad)}render(e,i,s){const{context:a}=e,l=this._updateGeometry(e,s);if(null!=i){const{r:o,g:h,b:d,a:u}=i;a.setClearColor(u*o/255,u*h/255,u*d/255,u)}else a.setClearColor(0,0,0,0);if(a.setStencilFunction(x.MT.ALWAYS,0,255),a.setStencilWriteMask(255),!l)return a.setClearStencil(1),void a.clear(a.gl.STENCIL_BUFFER_BIT|a.gl.COLOR_BUFFER_BIT);a.setClearStencil(0),a.clear(a.gl.STENCIL_BUFFER_BIT|a.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(a),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setBlendingEnabled(!1),a.setStencilOp(x.eA.KEEP,x.eA.KEEP,x.eA.REPLACE),a.setStencilFunction(x.MT.ALWAYS,1,255),a.setStencilTestEnabled(!0),a.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(e){if(this._initialized)return;const i=(0,tt.r)(e,Bi.P);i&&(this._program=i,this._quad=new Ge.A(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,i){const{state:s,pixelRatio:a}=e,{size:l,rotation:o}=s,h=Math.round(l[0]*a),d=Math.round(l[1]*a);if(!s.spatialReference.isWrappable)return!1;const u=(0,Fi.DF)(o),p=Math.abs(Math.cos(u)),_=Math.abs(Math.sin(u)),b=Math.round(h*p+d*_),y=Math.round(s.worldScreenWidth);if(b<=y)return!1;const O=(i.left-i.right)*a/h,F=(i.bottom-i.top)*a/d;(0,_t.s)(this._worldDimensionsPx,y*a,h*_+d*p,1),(0,_t.s)(this._pxToNdc,2/h,-2/d,1),(0,_t.s)(this._centerNdc,O,F,1);const R=this._mat3;return(0,Ke.kN)(R,this._centerNdc),(0,Ke.hs)(R,R,this._pxToNdc),0!==o&&(0,Ke.e$)(R,R,u),(0,Ke.hs)(R,R,this._worldDimensionsPx),(0,Ke.Tl)(R,R,Ii),!0}}class Je{constructor(){this.name=this.constructor.name}createOptions(e,i){return null}}class ki extends Je{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,i){if(null==i||!i.size)return;const{context:s,renderingOptions:a}=e;this._quad||(this._quad=new Ge.A(s,[0,0,1,0,0,1,1,1]));const l=s.getBoundFramebufferObject(),{x:o,y:h,width:d,height:u}=s.getViewport(),p=i.getBlock(M.dV.Animation);if(null==p)return;const _=i.getUniforms(s);s.setViewport(0,0,i.size,i.size);const b=_.filterFlags,y=_.animation,E=(0,de.A)("featurelayer-animation-enabled")?a.labelsAnimationTime:1,P=p.getFBO(s,1);s.unbindTexture(P.colorTexture),this._computeDelta(e,P,y,b,E);const O=p.getFBO(s);s.unbindTexture(O.colorTexture),this._updateAnimationState(e,P,O),s.bindFramebuffer(l),s.setViewport(o,h,d,u)}_computeDelta(e,i,s,a,l){const{context:o,painter:h,displayLevel:d}=e,u=h.materialManager.getProgram(this._desc,["delta"]);if(o.bindFramebuffer(i),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.clear(o.gl.COLOR_BUFFER_BIT),o.useProgram(u),!("type"in a.texture)||!("type"in s.texture))throw new Error("InternalError: Expected to find texture");o.bindTexture(a.texture,a.unit),o.bindTexture(s.texture,s.unit),u.setUniform1i("u_maskTexture",a.unit),u.setUniform1i("u_sourceTexture",s.unit),u.setUniform1f("u_timeDelta",e.deltaTime),u.setUniform1f("u_animationTime",l),u.setUniform1f("u_zoomLevel",Math.round(10*d)),this._quad.draw()}_updateAnimationState(e,i,s){const{context:a,painter:l}=e,o=l.materialManager.getProgram(this._desc,["update"]);a.bindTexture(i.colorTexture,1),a.useProgram(o),o.setUniform1i("u_sourceTexture",1),a.bindFramebuffer(s),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.clear(a.gl.COLOR_BUFFER_BIT),this._quad.draw()}}var It=w(73539);const Dt=g=>`#define ${(g=>g.replace("-","_").toUpperCase())(g)}\n`;function kt(g){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Dt(g)+(0,It.Q)("blend/blend.vert"),fragmentShader:Dt(g)+(0,It.Q)("blend/blend.frag")}}}const Nt=()=>ye.A.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Li{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=(0,$.WD)(this._backBufferTexture),this._quad=(0,$.WD)(this._quad)}draw(e,i,s,a,l){const{context:o,drawPhase:h}=e;if(this._setupShader(o),a&&"normal"!==a&&h!==te.S5.LABEL)return void this._drawBlended(e,i,s,a,l);const d=kt("normal"),u=o.programCache.acquire(d.shaders.vertexShader,d.shaders.fragmentShader,d.attributes);if(!u)return void Nt().error(new ve.A("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));o.useProgram(u),i.setSamplingMode(s),o.bindTexture(i,0),u.setUniform1i("u_layerTexture",0),u.setUniform1f("u_opacity",l),o.setBlendingEnabled(!0),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA);const p=this._quad;p.draw(),p.unbind(),u.dispose()}_drawBlended(e,i,s,a,l){const{context:o,state:h,pixelRatio:d,inFadeTransition:u}=e,{size:p}=h,_=o.getBoundFramebufferObject();let b,y;null!=_?(b=_.width,y=_.height):(b=Math.round(d*p[0]),y=Math.round(d*p[1])),this._createOrResizeTexture(e,b,y);const E=this._backBufferTexture;_.copyToTexture(0,0,b,y,0,0,E),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const P=kt(a),O=o.programCache.acquire(P.shaders.vertexShader,P.shaders.fragmentShader,P.attributes);if(!O)return void Nt().error(new ve.A("mapview-BlendEffect",`Error creating shader program for blend mode ${a}`));o.useProgram(O),E.setSamplingMode(s),o.bindTexture(E,0),O.setUniform1i("u_backbufferTexture",0),i.setSamplingMode(s),o.bindTexture(i,1),O.setUniform1i("u_layerTexture",1),O.setUniform1f("u_opacity",l),O.setUniform1f("u_inFadeOpacity",u?1:0),o.setBlendFunction(x.dn.ONE,x.dn.ZERO);const F=this._quad;F.draw(),F.unbind(),O.dispose(),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new Ge.A(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,i,s){const{context:a}=e;if(null===this._backBufferTexture||i!==this._size[0]||s!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(i,s);else{const l=new le.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.width=i,l.height=s,this._backBufferTexture=new ke.g(a,l)}this._size[0]=i,this._size[1]=s}}}class Lt extends Je{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:i}){this._prev=e.getBoundFramebufferObject();const s=i.getFbos().effect0;e.bindFramebuffer(s),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,i){const{context:s,painter:a}=e,l=a.getPostProcessingEffects(i),o=s.getBoundFramebufferObject();for(const{postProcessingEffect:h,effect:d}of l)h.draw(e,o,d);s.bindFramebuffer(this._prev),s.setStencilTestEnabled(!1),a.blitTexture(s,o.colorTexture,x.Cj.NEAREST),s.setStencilTestEnabled(!0)}}var st=w(22049),Ut=w(63367),Vt=w(30454);class Ui{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,i){e.bindTexture(i,M.vd),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",st.HQ),e.bindVAO(this._resources.quadVAO),e.drawArrays(x.WR.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,i){e.bindTexture(i,M.vd),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",st.XK),e.bindVAO(this._resources.quadVAO),e.drawArrays(x.WR.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,i,s){e.bindTexture(i,M.vd),e.useProgram(this._resources.highlightProgram),s.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),e.drawArrays(x.WR.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,i,s){this._width=i,this._height=s;const a=dt.g.createVertex(e,x._U.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),l=new pt.Z(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Vt._("a_position",2,x.pe.BYTE,0,4),new Vt._("a_texcoord",2,x.pe.UNSIGNED_BYTE,2,4)]},{geometry:a}),o=(0,tt.r)(e,Ut.Z),h=(0,tt.r)(e,Ut.G);e.useProgram(o),o.setUniform1i("u_texture",M.vd),o.setUniform1i("u_shade",M.CR),o.setUniform1f("u_sigma",st.aY),e.useProgram(h),h.setUniform1i("u_texture",M.vd),h.setUniform1f("u_sigma",st.aY),this._resources={quadGeometry:a,quadVAO:l,highlightProgram:o,blurProgram:h}}setup(e,i,s){this._resources?(this._width=i,this._height=s):this._initialize(e,i,s)}}var xe=w(79061),yt=w(49950);function Gt(g,e,i){const s=new le.R(e,i);return s.wrapMode=x.pF.CLAMP_TO_EDGE,new xe.H(g,s,new yt.q(x.yQ.STENCIL_INDEX8,e,i))}class Vi{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,i,s){this._width=i,this._height=s;const a=Gt(e,i,s),l=Gt(e,i,s);this._resources={sharedBlur1Fbo:a,sharedBlur2Fbo:l}}setup(e,i,s){!this._resources||this._width===i&&this._height===s||this.dispose(),this._resources||this._initialize(e,i,s)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Gi extends Je{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new Ui,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new Vi,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Tt}dispose(){var e,i;null!==(e=this._hlSurfaces)&&void 0!==e&&e.dispose(),null!==(i=this._hlRenderer)&&void 0!==i&&i.dispose(),this._boundFBO=null}bind(e){const{context:i,painter:s}=e,{width:a,height:l}=i.getViewport(),o=s.getFbos().effect0;this.setup(e,a,l),i.bindFramebuffer(o),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},i,s){this._width=i,this._height=s;const a=i%4,l=s%4;s+=l<2?-l:4-l,this._adjustedWidth=i+=a<2?-a:4-a,this._adjustedHeight=s,this._boundFBO=e.getBoundFramebufferObject();const o=Math.round(1*i),h=Math.round(1*s);this._hlRenderer.setup(e,o,h),this._hlSurfaces.setup(e,o,h)}draw(e){const{context:i,passOptions:s}=e,a=s.activeGradient,l=i.getBoundFramebufferObject();i.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),i.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),i.setStencilTestEnabled(!1),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(i,l.colorTexture,x.Cj.NEAREST,1),i.setStencilTestEnabled(!1),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!0),i.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(i,this._hlSurfaces.sharedBlur1Tex),i.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(i,this._hlSurfaces.sharedBlur2Tex),i.bindFramebuffer(this._boundFBO),i.setBlendingEnabled(!0),i.setColorMask(!0,!0,!0,!0),i.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(i,this._hlSurfaces.sharedBlur1Tex,a),this._boundFBO=null}}class Wi extends Je{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:e},i,s=M.c5){if(!i.length)return null;const a=i.shift(),l=a.x,o=a.y;return this._outstanding=a,{type:"hittest",distance:s*e,smallSymbolDistance:0,smallSymbolSizeThreshold:3,position:[l,o]}}bind(e){const{context:i,attributeView:s}=e;if(!s.size)return;const a=s.getBlock(M.dV.GPGPU);if(null==a)return;const l=a.getFBO(i);i.setViewport(0,0,s.size,s.size),i.bindFramebuffer(l),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(e){if(null==this._outstanding)return;const i=this._outstanding;this._outstanding=null,this._resolve(e,i.resolvers)}_resolve(e,i){return(0,Q.A)(function*(){const{context:s,attributeView:a}=e,l=a.getBlock(M.dV.GPGPU);if(null==l)return void i.forEach(u=>u.resolve([]));const o=l.getFBO(s),h=new Uint8Array(o.width*o.height*4);try{yield o.readPixelsAsync(0,0,o.width,o.height,x.Ab.RGBA,x.ld.UNSIGNED_BYTE,h)}catch{return void i.forEach(p=>p.resolve([]))}const d=[];for(let u=0;u<h.length;u+=4)h[u]&&d.push(u/4);i.forEach(u=>u.resolve(d))})()}}class Hi extends Je{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0,this._boundFBO=null}dispose(){null!=this._fbo&&this._fbo.dispose()}bind({context:e,painter:i}){this._boundFBO=e.getBoundFramebufferObject();const s=i.getFbos().effect0;e.bindFramebuffer(s),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw(e,i,s=2*M.c5){this._resolve(e,i,s)}_resolve({context:e,state:i,pixelRatio:s},a,l){var o=this;return(0,Q.A)(function*(){const h=e.getBoundFramebufferObject(),d=i.size[1]*s,u=Math.round(l*s),p=u/2,_=u/2;o._ensureBuffer(u),a.forEach(function(){var b=(0,Q.A)(function*(y,E){const P=new Map,O=Math.floor(E.x*s-u/2),F=Math.floor(d-E.y*s-u/2);yield h.readPixelsAsync(O,F,u,u,x.Ab.RGBA,x.ld.UNSIGNED_BYTE,o._buf);for(let I=0;I<o._buf32.length;I++){const k=o._buf32[I];if(4294967295!==k&&0!==k){const U=I%u,B=u-Math.floor(I/u),se=(p-U)*(p-U)+(_-B)*(_-B),q=P.has(k)?P.get(k):4294967295;P.set(k,Math.min(se,q))}}const R=Array.from(P).sort((I,k)=>I[1]-k[1]).map(I=>I[0]);y.resolve(R),a.delete(E)});return function(y,E){return b.apply(this,arguments)}}())})()}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const ji=[1,0],$i=[0,1],Xi=[1,.8,.6,.4,.2],Yi=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Ki{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=(0,$.WD)(this._quad),this._intensityFBO=(0,$.WD)(this._intensityFBO),this._compositeFBO=(0,$.WD)(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,i,s){const{width:a,height:l}=i,{context:o,painter:h}=e,{materialManager:d}=h,u=o.gl,p=this._programDesc,{strength:_,radius:b,threshold:y}=s;this._quad||(this._quad=new Ge.A(o,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,a,l),o.setStencilTestEnabled(!1),o.setBlendingEnabled(!0),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),o.setStencilWriteMask(0);const E=this._quad;E.bind(),o.bindFramebuffer(this._intensityFBO);const P=d.getProgram(p.luminosityHighPass);o.useProgram(P),o.bindTexture(i.colorTexture,0),P.setUniform1i("u_texture",0),P.setUniform3fv("u_defaultColor",[0,0,0]),P.setUniform1f("u_defaultOpacity",0),P.setUniform1f("u_luminosityThreshold",y),P.setUniform1f("u_smoothWidth",.01);const O=[Math.round(a/2),Math.round(l/2)];o.setViewport(0,0,O[0],O[1]),o.setClearColor(0,0,0,0),o.clear(u.COLOR_BUFFER_BIT),E.draw(),o.setBlendingEnabled(!1);let F=this._intensityFBO.colorTexture;for(let k=0;k<this._nMips;k++){const U=d.getProgram(p.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[k]}]);o.useProgram(U),o.bindTexture(F,k+1),U.setUniform1i("u_colorTexture",k+1),U.setUniform2fv("u_texSize",O),U.setUniform2fv("u_direction",ji),o.setViewport(0,0,O[0],O[1]);const B=this._mipsFBOs[k];o.bindFramebuffer(B.horizontal),E.draw(),F=B.horizontal.colorTexture,o.bindFramebuffer(B.vertical),o.bindTexture(F,k+1),U.setUniform2fv("u_direction",$i),E.draw(),F=B.vertical.colorTexture,O[0]=Math.round(O[0]/2),O[1]=Math.round(O[1]/2)}o.setViewport(0,0,a,l);const R=d.getProgram(p.composite,[{name:"nummips",value:5}]);o.bindFramebuffer(this._compositeFBO),o.useProgram(R),R.setUniform1f("u_bloomStrength",_),R.setUniform1f("u_bloomRadius",b),R.setUniform1fv("u_bloomFactors",Xi),R.setUniform3fv("u_bloomTintColors",Yi),o.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),R.setUniform1i("u_blurTexture1",1),o.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),R.setUniform1i("u_blurTexture2",2),o.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),R.setUniform1i("u_blurTexture3",3),o.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),R.setUniform1i("u_blurTexture4",4),o.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),R.setUniform1i("u_blurTexture5",5),E.draw(),o.bindFramebuffer(i),o.setBlendingEnabled(!0);const I=d.getProgram(p.blit);o.useProgram(I),o.bindTexture(this._compositeFBO.colorTexture,6),I.setUniform1i("u_texture",6),o.setBlendFunction(x.dn.ONE,x.dn.ONE),E.draw(),E.unbind(),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0)}_createOrResizeResources(e,i,s){const{context:a}=e;if(this._compositeFBO&&this._size[0]===i&&this._size[1]===s)return;this._size[0]=i,this._size[1]=s;const l=[Math.round(i/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(i,s);else{const o=new le.R(i,s);o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,this._compositeFBO=new xe.H(a,o)}if(this._intensityFBO)this._intensityFBO.resize(l[0],l[1]);else{const o=new le.R(l[0],l[1]);o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,this._intensityFBO=new xe.H(a,o)}for(let o=0;o<this._nMips;o++){if(this._mipsFBOs[o])this._mipsFBOs[o].horizontal.resize(l[0],l[1]),this._mipsFBOs[o].vertical.resize(l[0],l[1]);else{const h=new le.R(l[0],l[1]);h.internalFormat=x.Ab.RGBA,h.wrapMode=x.pF.CLAMP_TO_EDGE,this._mipsFBOs[o]={horizontal:new xe.H(a,h),vertical:new xe.H(a,h)}}l[0]=Math.round(l[0]/2),l[1]=Math.round(l[1]/2)}}}const Ji=[1,0],Qi=[0,1];class Zi{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,i,s){const{context:a}=e,{type:l,radius:o}=s;if(0===o)return;this._createOrResizeResources(e),this._quad||(this._quad=new Ge.A(a,[-1,-1,1,-1,-1,1,1,1]));const h=this._quad;h.bind(),"blur"===l?this._gaussianBlur(e,i,o):this._radialBlur(e,i),h.unbind()}_gaussianBlur(e,i,s){const{context:a,state:l,painter:o,pixelRatio:h}=e,{size:d}=l,{materialManager:u}=o,p=this._programDesc,_=this._quad,b=[Math.round(h*d[0]),Math.round(h*d[1])],y=this._blurFBO,E=u.getProgram(p.gaussianBlur,[{name:"radius",value:Math.ceil(s)}]);a.useProgram(E),a.setBlendingEnabled(!1),a.bindFramebuffer(y),a.bindTexture(i.colorTexture,4),E.setUniform1i("u_colorTexture",4),E.setUniform2fv("u_texSize",b),E.setUniform2fv("u_direction",Ji),E.setUniform1f("u_sigma",s),_.draw(),a.bindFramebuffer(i),a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.bindTexture(null==y?void 0:y.colorTexture,5),E.setUniform1i("u_colorTexture",5),E.setUniform2fv("u_direction",Qi),_.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_radialBlur(e,i){const{context:s,painter:a}=e,{materialManager:l}=a,o=this._programDesc,h=this._quad,d=this._blurFBO;s.bindFramebuffer(d);const u=l.getProgram(o.radialBlur);s.useProgram(u),s.setBlendingEnabled(!1),s.bindTexture(i.colorTexture,4),u.setUniform1i("u_colorTexture",4),h.draw(),s.bindFramebuffer(i),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setBlendingEnabled(!0);const p=l.getProgram(o.blit);s.useProgram(p),s.bindTexture(null==d?void 0:d.colorTexture,5),p.setUniform1i("u_texture",5),s.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),h.draw()}_createOrResizeResources(e){const{context:i,state:s,pixelRatio:a}=e,{size:l}=s,o=Math.round(a*l[0]),h=Math.round(a*l[1]);if(!this._blurFBO||this._size[0]!==o||this._size[1]!==h)if(this._size[0]=o,this._size[1]=h,this._blurFBO)this._blurFBO.resize(o,h);else{const d=new le.R(o,h);d.internalFormat=x.Ab.RGBA,d.wrapMode=x.pF.CLAMP_TO_EDGE,this._blurFBO=new xe.H(i,d)}}}class qi{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=(0,$.WD)(this._layerFBOTexture)}draw(e,i,s){const{width:a,height:l}=i;this._createOrResizeResources(e,a,l);const{context:o,painter:h}=e,{materialManager:d}=h,u=this._programDesc,p=this._quad,_=s.colorMatrix;p.bind();const b=this._layerFBOTexture;o.bindFramebuffer(i),i.copyToTexture(0,0,a,l,0,0,b),o.setBlendingEnabled(!1),o.setStencilTestEnabled(!1);const y=d.getProgram(u);o.useProgram(y),o.bindTexture(b,2),y.setUniformMatrix4fv("u_coefficients",_),y.setUniform1i("u_colorTexture",2),p.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),o.setStencilTestEnabled(!0),p.unbind()}_createOrResizeResources(e,i,s){const{context:a}=e;if(!this._layerFBOTexture||this._size[0]!==i||this._size[1]!==s){if(this._size[0]=i,this._size[1]=s,this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const l=new le.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.width=i,l.height=s,this._layerFBOTexture=new ke.g(a,l)}this._quad||(this._quad=new Ge.A(a,[-1,-1,1,-1,-1,1,1,1]))}}}const er=[1,0],tr=[0,1];class ir{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=(0,$.WD)(this._layerFBOTexture),this._horizontalBlurFBO=(0,$.WD)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,$.WD)(this._verticalBlurFBO)}draw(e,i,s){const{context:a,state:l,painter:o}=e,{materialManager:h}=o,d=this._programDesc,u=i.width,p=i.height,_=[Math.round(u),Math.round(p)],{blurRadius:b,offsetX:y,offsetY:E,color:P}=s,O=[(0,pe.Lz)(y),(0,pe.Lz)(E)];this._createOrResizeResources(e,u,p,_);const F=this._horizontalBlurFBO,R=this._verticalBlurFBO;a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1);const I=this._layerFBOTexture;i.copyToTexture(0,0,u,p,0,0,I),this._quad||(this._quad=new Ge.A(a,[-1,-1,1,-1,-1,1,1,1])),a.setViewport(0,0,_[0],_[1]);const k=this._quad;k.bind(),a.setBlendingEnabled(!1);const U=h.getProgram(d.blur,[{name:"radius",value:Math.ceil(b)}]);a.useProgram(U),a.bindFramebuffer(F),a.bindTexture(i.colorTexture,4),U.setUniform1i("u_colorTexture",4),U.setUniform2fv("u_texSize",_),U.setUniform2fv("u_direction",er),U.setUniform1f("u_sigma",b),k.draw(),a.bindFramebuffer(R),a.bindTexture(null==F?void 0:F.colorTexture,5),U.setUniform1i("u_colorTexture",5),U.setUniform2fv("u_direction",tr),k.draw(),a.bindFramebuffer(i),a.setViewport(0,0,u,p);const B=h.getProgram(d.composite);a.useProgram(B),a.bindTexture(null==R?void 0:R.colorTexture,2),B.setUniform1i("u_blurTexture",2),a.bindTexture(I,3),B.setUniform1i("u_layerFBOTexture",3),B.setUniform4fv("u_shadowColor",[P[3]*(P[0]/255),P[3]*(P[1]/255),P[3]*(P[2]/255),P[3]]),B.setUniformMatrix3fv("u_displayViewMat3",l.displayMat3),B.setUniform2fv("u_shadowOffset",O),k.draw(),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!0),a.setBlendFunction(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),k.unbind()}_createOrResizeResources(e,i,s,a){const{context:l}=e;if(!this._horizontalBlurFBO||this._size[0]!==i||this._size[1]!==s){if(this._size[0]=i,this._size[1]=s,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(a[0],a[1]);else{const o=new le.R(a[0],a[1]);o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,this._horizontalBlurFBO=new xe.H(l,o)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(a[0],a[1]);else{const o=new le.R(a[0],a[1]);o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,this._verticalBlurFBO=new xe.H(l,o)}if(this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const o=new le.R;o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,o.width=i,o.height=s,this._layerFBOTexture=new ke.g(l,o)}}}}class rr{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=(0,$.WD)(this._layerFBOTexture)}draw(e,i,s){const{width:a,height:l}=i;this._createOrResizeResources(e,a,l);const{context:o,painter:h}=e,{amount:d}=s,u=o.gl,p=this._layerFBOTexture;o.bindFramebuffer(i),i.copyToTexture(0,0,a,l,0,0,p),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!1),o.setDepthTestEnabled(!1),o.setClearColor(0,0,0,0),o.clear(u.COLOR_BUFFER_BIT),h.blitTexture(o,p,x.Cj.NEAREST,d)}_createOrResizeResources(e,i,s){const{context:a}=e;if(!this._layerFBOTexture||this._size[0]!==i||this._size[1]!==s)if(this._size[0]=i,this._size[1]=s,this._layerFBOTexture)this._layerFBOTexture.resize(i,s);else{const l=new le.R;l.internalFormat=x.Ab.RGBA,l.wrapMode=x.pF.CLAMP_TO_EDGE,l.samplingMode=x.Cj.NEAREST,l.width=i,l.height=s,this._layerFBOTexture=new ke.g(a,l)}}}function sr(g){switch(g){case"bloom":case"blur":case"opacity":case"drop-shadow":return g;default:return"colorize"}}const ar={colorize:()=>new qi,blur:()=>new Zi,bloom:()=>new Ki,opacity:()=>new rr,"drop-shadow":()=>new ir};class nr{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const i=[];for(const s of e){const a=sr(s.type);let l=this._effectMap.get(a);l||(l=ar[a](),this._effectMap.set(a,l)),i.push({postProcessingEffect:l,effect:s})}return i}}var or=w(89952);class lr{constructor(e,i){var s;this.brushes=e,this.name=i.name,this.drawPhase=i.drawPhase||te.S5.MAP,this._targetFn=i.target,this.effects=i.effects||[],this.enableDefaultDraw=null!==(s=i.enableDefaultDraw)&&void 0!==s?s:()=>!0,this.forceDrawByDisplayOrder=!!i.forceDrawByDisplayOrder}render(e){const{context:i,profiler:s}=e,a=this._targetFn(),l=this.drawPhase&e.drawPhase;if(s.recordPassStart(this.name),l){this.enableDefaultDraw()&&this._doRender(e,a),s.recordPassEnd();for(const h of this.effects){var o;if(!h.enable())continue;const d=h.apply,u=null===(o=h.args)||void 0===o?void 0:o.call(h),p=i.getViewport(),_=i.getBoundFramebufferObject(),b=e.passOptions;this._bindEffect(e,d,u),this._doRender(e,a,d.defines),this._drawAndUnbindEffect(e,d,p,_,b,u)}}}_doRender(e,i,s){if(null==i)return;const{profiler:a,context:l}=e;for(const o of this.brushes){if(a.recordBrushStart(o.name),null!=o.brushEffect){const h=l.getViewport(),d=l.getBoundFramebufferObject(),u=e.passOptions;this._bindEffect(e,o.brushEffect),this._drawWithBrush(o,e,i,s),this._drawAndUnbindEffect(e,o.brushEffect,h,d,u)}else this._drawWithBrush(o,e,i,s);a.recordBrushEnd()}}_drawWithBrush(e,i,s,a){(0,or.Xj)(s)?(e.prepareState(i,a),e.drawMany(i,s,a)):s.visible&&(e.prepareState(i,a),e.draw(i,s,a))}_bindEffect(e,i,s){const{profiler:a}=e;a.recordPassStart(this.name+"."+i.name),i.bind(e,s);const l=i.createOptions(e,s);e.passOptions=l}_drawAndUnbindEffect(e,i,s,a,l,o){const{profiler:h,context:d}=e;e.passOptions=l,h.recordBrushStart(i.name),i.draw(e,o),i.unbind(e,o),d.bindFramebuffer(a);const{x:u,y:p,width:_,height:b}=s;d.setViewport(u,p,_,b),h.recordBrushEnd(),h.recordPassEnd()}}class Wt{constructor(){this._programCache=new Map}destroy(){for(const e of this._programCache.values())e.destroy();this._programCache.clear()}getProgram(e,i,s,a,l){const o=e.getShaderKey(i,s,a,l);let h=this._programCache.get(o);return h||(h=e.getProgram(i,s,a,l),this._programCache.set(o,h)),h}}var hr=w(17107);class cr{constructor(e,i){this.context=e,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new Tt,this._worldExtentRenderer=new Di,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new ei,this._blendEffect=new Li,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new Gi,hittest:new Wi,hittestVTL:new Hi,integrate:new ki,insideEffect:new Lt("inside"),outsideEffect:new Lt("outside")},this._programCache=new Wt,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new ii(e),this.textureManager=new Oi(i),this.textureUploadManager=new Ai(i),this._effectsManager=new nr,this._quadMesh=new Ge.A(e,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,$.WD)(this._blitRenderer),this._worldExtentRenderer=(0,$.WD)(this._worldExtentRenderer),this._quadMesh.dispose(),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos){let e;for(e in this._fbos)this._fbos[e]&&this._fbos[e].dispose()}for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects){let e;for(e in this.effects)this.effects[e]&&this.effects[e].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,$.WD)(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new Wt}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(e,i){let s;if(this._fboPool.length>0)s=this._fboPool.pop();else{const a=new le.R(e,i);a.samplingMode=x.Cj.NEAREST,a.wrapMode=x.pF.CLAMP_TO_EDGE,s=new xe.H(this.context,a,this._stencilBuf)}return s.width===e&&s.height===i||s.resize(e,i),s}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(e,i,s){const{context:a}=e;this._worldExtentRenderer.render(e,i,s);const{width:l,height:o}=a.getViewport();if(this.updateFBOs(l,o),this._prevFBO=a.getBoundFramebufferObject(),a.bindFramebuffer(this.getFbos().output),a.setColorMask(!0,!0,!0,!0),null!=i){const{r:h,g:d,b:u,a:p}=i;a.setClearColor(p*h/255,p*d/255,p*u/255,p)}else a.setClearColor(0,0,0,0);a.setDepthWriteEnabled(!0),a.setClearDepth(1),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT),a.setDepthWriteEnabled(!1)}afterRenderPhases(e){const{context:i}=e;i.bindFramebuffer(this._prevFBO),i.setStencilFunction(x.MT.EQUAL,1,255),i.setStencilTestEnabled(!0),i.setDepthTestEnabled(!1),this.blitTexture(i,this.getFbos().output.colorTexture,x.Cj.NEAREST)}beforeRenderLayer(e,i,s){const{context:a,blendMode:l,effects:o,drawPhase:h,requireFBO:d}=e;if(d||Ht(h,l,o,s)){const u=a.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(u);const{width:p,height:_}=a.getViewport(),b=this.acquireFbo(p,_);a.bindFramebuffer(b),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.setDepthWriteEnabled(!0),a.setClearDepth(1),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT),a.setDepthWriteEnabled(!1)}a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setClearStencil(i),a.setStencilWriteMask(255),a.clear(a.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(e,i){const{context:s,blendMode:a,effects:l,requireFBO:o,drawPhase:h}=e;if(o||Ht(h,a,l,i)){const d=s.getBoundFramebufferObject();null!=l&&l.length>0&&h===te.S5.MAP&&(s.setColorMask(!0,!0,!0,!0),this._applyEffects(e,l,d)),s.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),s.setStencilTestEnabled(!1),s.setStencilWriteMask(0),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),s.setColorMask(!0,!0,!0,!0),this._blendEffect.draw(e,d.colorTexture,x.Cj.NEAREST,null==a||h===te.S5.HIGHLIGHT?"normal":a,i),this.releaseFbo(d)}}renderObject(e,i,s,a){const l=De.d[s];if(!l)return;let o=this._brushCache.get(l);void 0===o&&(o=new l,this._brushCache.set(l,o)),o.prepareState(e),o.draw(e,i,a)}renderObjects(e,i,s,a){const l=De.d[s];if(!l)return;let o=this._brushCache.get(l);void 0===o&&(o=new l,this._brushCache.set(l,o)),o.drawMany(e,i,a)}registerRenderPass(e){const i=e.brushes.map(s=>(this._brushCache.has(s)||this._brushCache.set(s,new s),this._brushCache.get(s)));return new lr(i,e)}blitTexture(e,i,s,a=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,i,s,a),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}updateFBOs(e,i){if(e!==this._lastWidth||i!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=i,this._fbos){let l;for(l in this._fbos)this._fbos[l].resize(e,i);return}const s=new le.R(e,i);s.samplingMode=x.Cj.NEAREST,s.wrapMode=x.pF.CLAMP_TO_EDGE;const a=new yt.q(x.yQ.DEPTH_STENCIL,e,i);this._stencilBuf=new hr.l(this.context,a),this._fbos={output:new xe.H(this.context,s,this._stencilBuf),effect0:new xe.H(this.context,s,this._stencilBuf)}}}_applyEffects(e,i,s){const{context:a}=e,l=this._effectsManager.getPostProcessingEffects(i);for(const{postProcessingEffect:o,effect:h}of l)a.bindFramebuffer(s),o.draw(e,s,h);this._currentPipelineStateNeedsUpdate=!0}setShader(e){var i;this._shaderState.shader=e.shader,this._shaderState.uniforms=e.uniforms,this._shaderState.defines=e.defines,this._shaderState.optionalAttributes=e.optionalAttributes,this._shaderState.useComputeBuffer=null!==(i=e.useComputeBuffer)&&void 0!==i&&i}setPipelineState(e){e!==this._currentPipelineState&&(this._currentPipelineState=e,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(e,i){const{instance:s}=i,a=s.instanceId,{shader:l,uniforms:o,defines:h,optionalAttributes:d,useComputeBuffer:u}=this._shaderState,p=i.target.getMesh(a),_={useComputeBuffer:u,locationInfo:l.locationInfo,computeAttributeMap:l.computeAttributes},b=p.getLayout(_);if(null==b)return null;const{primitive:y,count:E,offset:P}=p.getDrawArgs(x.WR.TRIANGLES,i.count,i.start*Uint32Array.BYTES_PER_ELEMENT,u),O=this._programCache.getProgram(l,b,o,null!=h?h:{},null!=d?d:{});O.setUniforms(o),O.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,i.target);const F=p.getVAO(e,l.locationInfo,_);return e.bindVAO(F),e.drawElements(y,E,x.pe.UNSIGNED_INT,P),e.bindVAO(null),O.cleanupTemporaryTextures(),{vertexShader:O.vertexShader,fragmentShader:O.fragmentShader}}submitDrawQuad(e){const{shader:i,uniforms:s,defines:a,optionalAttributes:l}=this._shaderState,o=this._programCache.getProgram(i,this._quadMesh.layout,s,null!=a?a:{},null!=l?l:{});o.setUniforms(s),o.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,null),this._quadMesh.draw(),e.bindVAO(null),o.cleanupTemporaryTextures()}submitDrawMesh(e,i,s){const{shader:a,uniforms:l,defines:o,optionalAttributes:h}=this._shaderState,d=this._programCache.getProgram(a,i.layout,l,null!=o?o:{},null!=h?h:{});if(d.setUniforms(l),d.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,null),s)for(const u of s)i.bind(e,u),i.draw(e);else for(let u=0;u<i.parts.length;u++)i.bind(e,u),i.draw(e);i.unbind(e),d.cleanupTemporaryTextures()}updatePipelineState(e){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(e))}_updatePipelineState(e){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:i,depth:s,stencil:a}=this._currentPipelineState;if(i){const{blendMode:l,write:o}=i;switch(e.setColorMask(...o),e.setBlendingEnabled(!0),e.setBlendEquation(x.Tb.ADD),l){case"composite":e.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA);break;case"additive":e.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE,x.dn.ONE,x.dn.ONE);break;case"custom":{const{blendParameters:h}=i,{dstAlpha:d,dstRGB:u,srcAlpha:p,srcRGB:_}=h;e.setBlendFunctionSeparate(_,u,p,d);break}case"delete":e.setBlendEquation(x.Tb.REVERSE_SUBTRACT),e.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA)}}if(s){const{test:l,write:o}=s;o?(e.setDepthWriteEnabled(!0),e.setDepthRange(o.zNear,o.zFar)):e.setDepthWriteEnabled(!1),l?(e.setDepthTestEnabled(!0),e.setDepthFunction(l)):e.setDepthTestEnabled(!1)}else e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1);if(a){const{test:l,write:o}=a;if(l){const{compare:h,mask:d,op:u,ref:p}=l;e.setStencilTestEnabled(!0),"function"!=typeof p&&e.setStencilFunctionSeparate(x.Y7.FRONT_AND_BACK,h,p,d),e.setStencilOpSeparate(x.Y7.FRONT_AND_BACK,u.fail,u.zFail,u.zPass)}else e.setStencilTestEnabled(!1);if(o){const{mask:h}=o;e.setStencilWriteMask(h)}else e.setStencilWriteMask(0)}else e.setStencilTestEnabled(!1),e.setStencilWriteMask(0)}_updateStencilRef(e,i){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:s}=this._currentPipelineState;if(s){const{test:a}=s;if(a){const{compare:l,mask:o,ref:h}=a;"function"==typeof h&&e.setStencilFunctionSeparate(x.Y7.FRONT_AND_BACK,l,h(i),o)}}}}function Ht(g,e,i,s){return g!==te.S5.LABEL_ALPHA&&g!==te.S5.LABEL&&g!==te.S5.HIGHLIGHT&&(1!==s||null!=e&&"normal"!==e||null!=i&&i.length>0)}var ur=w(55900),dr=w(38730);class pr{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const i=[];for(const s of this._candidateTiles)e>0?(s.reshuffle(),e--):i.push(s);this._candidateTiles=i}}var jt=w(28291),fr=w(56551),mr=w(14989),gr=w(42835),_r=w(48116);class yr extends ae.m{constructor(e,i){var s;super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=(0,me.v)(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new pr,this._canvas=new Ie(e),this.context=new gr.e(this._canvas.gl,null!==(s=i.contextOptions)&&void 0!==s?s:{}),this.painter=new cr(this.context,this),this._cimAnalyzer=new H(this.painter.textureManager.resourceManager),(0,de.A)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput));const a=()=>this._highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:i.timeline||new fr.K,renderingOptions:i.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new dr.U(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return a()},reshuffleManager:this._reshuffleManager,backgroundColor:i.backgroundColor},this._taskHandle=(0,Fe.mg)({render:l=>this.renderFrame(l)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",l=>this.emit("webgl-error",{error:new ve.A("webgl-context-lost",l.statusMessage)})),this._bufferPool=new ur.o,(0,jt.Wn)()}destroy(){var e;(0,jt.n_)(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,$.xt)(this._taskHandle),this._lostWebGLContextHandle=(0,$.xt)(this._lostWebGLContextHandle),this._canvas.destroy(),null!==(e=this._debugOutput)&&void 0!==e&&null!==(e=e.parentNode)&&void 0!==e&&e.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(e){this._renderParameters.backgroundColor=e,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:(0,Ce.vt)()}}renderChildren(e){for(const i of this.children)i.beforeRender(e);this._reshuffleManager.reshuffle(M.O5),this._canvas.render(e,()=>this._renderChildren(this.children,e));for(const i of this.children)i.afterRender(e)}_renderChildren(e,i){const s=this.context;this.painter.textureUploadManager.upload(),s.resetInfo(),i.profiler.recordStart("drawLayers"),i.dataUploadCounter=0,this.painter.beforeRenderPhases(i,i.backgroundColor,this.state.padding),i.drawPhase=te.S5.MAP;for(const a of e)a.processRender(i);if(this.children.some(a=>a.hasHighlight)){i.drawPhase=te.S5.HIGHLIGHT;for(const a of e)a.processRender(i)}if(this.children.some(a=>a.hasLabels)){i.drawPhase=te.S5.LABEL;for(const a of e)a.processRender(i)}if((0,de.A)("esri-tiles-debug")){i.drawPhase=te.S5.DEBUG;for(const a of e)a.processRender(i)}this.painter.afterRenderPhases(i),i.profiler.recordEnd("drawLayers"),s.logInfo()}doRender(e){const i=this.context,{state:s,pixelRatio:a}=e;this._canvas.resize(e),i.setViewport(0,0,a*s.size[0],a*s.size[1]),i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),this.renderChildren(e)}takeScreenshot(e,i,s,a){var l=this;return(0,Q.A)(function*(){const o=Math.round(l.state.size[0]*e.resolutionScale),h=Math.round(l.state.size[1]*e.resolutionScale),d=e.resolutionScale,u=l.context,p=l._state.clone();if(null!=a){const I=p.viewpoint;p.viewpoint.rotation=a,p.viewpoint=I}const _={...l._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:p,pixelRatio:d,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:s},b=new le.R(o,h);b.wrapMode=x.pF.CLAMP_TO_EDGE,b.internalFormat=x.H0.RGBA8,b.isImmutable=!0;const y=new xe.H(u,b,new yt.q(x.yQ.DEPTH_STENCIL,o,h)),E=u.getBoundFramebufferObject(),P=u.getViewport();u.bindFramebuffer(y),u.setViewport(0,0,o,h),l._renderChildren(null!=i?i:l.children,_);const O=l._readbackScreenshot(y,{...e.cropArea,y:h-(e.cropArea.y+e.cropArea.height)});u.bindFramebuffer(E),u.setViewport(P.x,P.y,P.width,P.height),l.requestRender();const F=yield O;let R;return 1===e.outputScale?R=F:(R=new ImageData(Math.round(F.width*e.outputScale),Math.round(F.height*e.outputScale)),(0,mr.Go)(F,R,!0)),y.dispose(),R})()}_readbackScreenshot(e,i){return(0,Q.A)(function*(){const s=(0,_r.xR)(i.width,i.height,document.createElement("canvas"));return yield e.readPixelsAsync(i.x,i.y,i.width,i.height,x.Ab.RGBA,x.ld.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),s})()}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const i of e)i.processDetach()}}}var br=w(67399),xr=w(80745),Mr=w(57052),wr=w(18800),Sr=w(89447),Or=w(86807),nt=w(48900),Pr=w(45272),Cr=w(63888),$t=w(43431),Xt=w(96797);function xt(){return(xt=(0,Q.A)(function*(g){const e=w.e(2205).then(w.bind(w,32205)),i=w.e(1655).then(w.bind(w,94036)),s=(0,Xt.D)((yield e).default,{signal:g}),a=(0,Xt.D)((yield i).default,{signal:g}),l={mask:yield s,overlay:yield a};return(0,Re.Te)(g),l})).apply(this,arguments)}class Er extends Cr.q{constructor(){super(),this._handles=new Or.A,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles=(0,$.pR)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,$.DC)(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){this._backgroundColor=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,nt.wB)(()=>e.version,()=>{this.visible=e.visible&&null!=e.position&&e.size>0,this.requestRender()},nt.Vh),(0,nt.wB)(()=>[e.maskUrl,e.overlayUrl],()=>this._reloadResources()),(0,nt.wB)(()=>e.size,()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{displayViewScreenMat3:(0,Ce.vt)()}}doRender(e){const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==te.S5.MAP||!this._canRender())return;this._updateResources(e);const s=this._magnifier;if(null==s.position)return;const a=e.pixelRatio,l=s.size*a,h=Math.ceil(1/s.factor*l);this._readbackTexture.resize(h,h);const{size:d}=e.state,u=a*d[0],p=a*d[1],_=.5*h,b=.5*h,y=(0,re.qE)(a*s.position.x,_,u-_-1),E=(0,re.qE)(p-a*s.position.y,b,p-b-1);i.setBlendingEnabled(!0);const P=y-_,O=E-b,F=this._readbackTexture;i.bindTexture(F,0),i.gl.copyTexImage2D(F.descriptor.target,0,F.descriptor.pixelFormat,P,O,h,h,0);const R=this.backgroundColor,I=R?[R.a*R.r/255,R.a*R.g/255,R.a*R.b/255,R.a]:[1,1,1,1],k=(y+s.offset.x*a)/u*2-1,U=(E-s.offset.y*a)/p*2-1,B=l/u*2,se=l/p*2,q=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(q),q.setUniform4fv("u_background",I),q.setUniform1i("u_readbackTexture",0),q.setUniform1i("u_overlayTexture",6),q.setUniform1i("u_maskTexture",7),q.setUniform4f("u_drawPos",k,U,B,se),q.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),q.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(x.WR.TRIANGLE_STRIP,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const i=null!=this._magnifier?this._magnifier.maskUrl:null,s=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,Sr.UT)(function(){var a=(0,Q.A)(function*(l){const o=null==i||null==s?function Tr(g){return xt.apply(this,arguments)}(l):null,h=null!=i?(0,Xe.A)(i,{responseType:"image",signal:l}).then(_=>_.data):o.then(_=>_.mask),d=null!=s?(0,Xe.A)(s,{responseType:"image",signal:l}).then(_=>_.data):o.then(_=>_.overlay),[u,p]=yield Promise.all([h,d]);e.mask=u,e.overlay=p,e._disposeRenderResources(),e.requestRender()});return function(l){return a.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,$.WD)(this._readbackTexture),this._overlayTexture=(0,$.WD)(this._overlayTexture),this._maskTexture=(0,$.WD)(this._maskTexture),this._vertexArrayObject=(0,$.WD)(this._vertexArrayObject),this._program=(0,$.WD)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const i=e.context;this._resourcePixelRatio=e.pixelRatio;const s=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,$t.h)(i);const a=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new pt.Z(i,$t.j.attributes,Pt.VS,{geometry:dt.g.createVertex(i,x._U.STATIC_DRAW,a)}),this.overlay.width=s,this.overlay.height=s;const o=new le.R;o.internalFormat=x.Ab.RGBA,o.wrapMode=x.pF.CLAMP_TO_EDGE,o.samplingMode=x.Cj.NEAREST,o.flipped=!0,o.preMultiplyAlpha=!(0,Pr.XJ)(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new ke.g(i,o,this.overlay),this.mask.width=s,this.mask.height=s,o.pixelFormat=o.internalFormat=x.Ab.ALPHA,this._maskTexture=new ke.g(i,o,this.mask);const h=1/this._magnifier.factor;o.pixelFormat=o.internalFormat=x.Ab.RGBA,o.width=o.height=Math.ceil(h*s),o.samplingMode=x.Cj.LINEAR,o.flipped=!1,this._readbackTexture=new ke.g(i,o)}}}}]);