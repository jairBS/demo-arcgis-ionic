"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4788],{33087:(lt,X,m)=>{m.d(X,{q:()=>W});var T=m(60611);class W{constructor(O,V){this._storage=new T.F,this.id="",this.name="",this.size=0,this._storage.maxSize=O,this._storage.register(this),V&&this._storage.registerRemoveFunc("",V)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(O,V,$=1){this._storage.put(this,O,V,$,1)}pop(O){return this._storage.pop(this,O)}get(O){return this._storage.get(this,O)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(O){this._storage.maxSize=O}resetHitRate(){}}},60611:(lt,X,m)=>{m.d(X,{F:()=>$,Mn:()=>V});var O,f,T=m(12438);(f=O||(O={}))[f.ALL=0]="ALL",f[f.SOME=1]="SOME";class V{constructor(_,o,l){this.name=_,this._storage=o,this.id=tt+++":",this.size=0,this.maxSize=-1,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),l&&(this._storage.registerRemoveFunc(this.id,l),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(_){return this._storage.getSize(this,_)}resetHitRate(){this._hit=this._miss=0}put(_,o,l,y=0){this._storage.put(this,_,o,l,y)}pop(_){const o=this._storage.pop(this,_);return void 0===o?++this._miss:++this._hit,o}get(_){const o=this._storage.get(this,_);return void 0===o?++this._miss:++this._hit,o}peek(_){return this._storage.peek(this,_)}updateSize(_,o,l){this._storage.updateSize(this,_,o,l)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}}class ${get size(){return this._size}constructor(_=10485760){this._maxSize=_,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new T.A,this._users=new T.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(_){this._users.push(_)}deregister(_){this._users.removeUnordered(_)}registerRemoveFunc(_,o){this._removeFuncs.push([_,o])}deregisterRemoveFunc(_){this._removeFuncs.filterInPlace(o=>o[0]!==_)}get maxSize(){return this._maxSize}set maxSize(_){this._maxSize=Math.max(_,-1),this._checkSize()}getSize(_,o){var l;const y=this._db.get(_.id+o);return null!==(l=null==y?void 0:y.size)&&void 0!==l?l:0}put(_,o,l,y,x){const g=this._db.get(o=_.id+o);if(g&&(this._size-=g.size,_.size-=g.size,this._db.delete(o),g.entry!==l&&this._notifyRemove(o,g.entry,g.size,O.ALL)),y>this._maxSize)return void this._notifyRemove(o,l,y,O.ALL);if(void 0===l)return void console.warn("Refusing to cache undefined entry ");if(!y||y<0)return console.warn(`Refusing to cache entry with size ${y} for key ${o}`),void this._notifyRemove(o,l,0,O.ALL);const M=1+Math.max(x,-4)- -3;this._db.set(o,new U(l,y,M)),this._size+=y,_.size+=y,this._checkSize()}updateSize(_,o,l,y){const x=this._db.get(o=_.id+o);if(x&&x.entry===l){for(this._size-=x.size,_.size-=x.size;y>this._maxSize;){const g=this._notifyRemove(o,l,y,O.SOME);if(!(null!=g&&g>0))return void this._db.delete(o);y=g}x.size=y,this._size+=y,_.size+=y,this._checkSize()}}pop(_,o){const l=this._db.get(o=_.id+o);if(l)return this._size-=l.size,_.size-=l.size,this._db.delete(o),++this._hit,l.entry;++this._miss}get(_,o){const l=this._db.get(o=_.id+o);if(void 0!==l)return this._db.delete(o),l.lives=l.lifetime,this._db.set(o,l),++this._hit,l.entry;++this._miss}peek(_,o){const l=this._db.get(_.id+o);return l?++this._hit:++this._miss,null==l?void 0:l.entry}get performanceInfo(){const _={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},o={},l=new Array;this._db.forEach((g,M)=>{const D=g.lifetime;l[D]=(l[D]||0)+g.size,this._users.forAll(b=>{const{id:A,name:j}=b;M.startsWith(A)&&(o[j]=(o[j]||0)+g.size)})});const y={};this._users.forAll(g=>{const M=g.name;"hitRate"in g&&"number"==typeof g.hitRate&&!isNaN(g.hitRate)&&g.hitRate>0?(o[M]=o[M]||0,y[M]=Math.round(100*g.hitRate)+"%"):y[M]="0%"});const x=Object.keys(o);x.sort((g,M)=>o[M]-o[g]),x.forEach(g=>_[g]=Math.round(o[g]/2**20)+"MB / "+y[g]);for(let g=l.length-1;g>=0;--g){const M=l[g];M&&(_["Priority "+(g+-3-1)]=Math.round(M/this._size*100)+"%")}return _}resetStats(){this._hit=this._miss=0,this._users.forAll(_=>_.resetHitRate())}clear(_){const o=_.id;this._db.forEach((l,y)=>{y.startsWith(o)&&(this._size-=l.size,this._db.delete(y),this._notifyRemove(y,l.entry,l.size,O.ALL))}),_.size=0}clearAll(){this._db.forEach((_,o)=>this._notifyRemove(o,_.entry,_.size,O.ALL)),this._users.forAll(_=>_.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(_,o,l,y){let x;return this._removeFuncs.some(g=>{if(_.startsWith(g[0])){const M=g[1](o,y,l);return"number"==typeof M&&(x=M),!0}return!1}),x}_checkSize(){this._users.forAll(_=>this._checkSizeLimits(_)),this._checkSizeLimits()}_checkSizeLimits(_){const o=null!=_?_:this;if(o.maxSize<0||o.size<=o.maxSize)return;const l=null==_?void 0:_.id;let y=!0;for(;y;){y=!1;for(const[x,g]of this._db)if(0===g.lifetime&&(!l||x.startsWith(l))){if(this._purgeItem(x,g,_),o.size<=.9*o.maxSize)return;y||(y=this._db.has(x))}}for(const[x,g]of this._db)if((!l||x.startsWith(l))&&(this._purgeItem(x,g,_),o.size<=.9*o.maxSize))return}_purgeItem(_,o,l=this._users.find(y=>_.startsWith(y.id))){if(this._db.delete(_),o.lives<=1){this._size-=o.size,l&&(l.size-=o.size);const y=this._notifyRemove(_,o.entry,o.size,O.SOME);null!=y&&y>0&&(this._size+=y,l&&(l.size+=y),o.lives=o.lifetime,o.size=y,this._db.set(_,o))}else--o.lives,this._db.set(_,o)}}let tt=0;class U{constructor(_,o,l){this.entry=_,this.size=o,this.lifetime=l,this.lives=l}}},48237:(lt,X,m)=>{m.d(X,{EB:()=>l,Mj:()=>o,Ui:()=>M,w2:()=>g});var T=m(98877),W=m(31178),k=m(74220);const O=new Set(["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"]);function V(b){return b instanceof T.A}function $(b){return b instanceof W.A?Object.keys(b.items):V(b)?(0,k.oY)(b).keys():b?Object.keys(b):[]}function tt(b,A){return b instanceof W.A?b.items[A]:b[A]}function f(b){return b?b.declaredClass:null}function _(b,A){const j=b.diff;if(j&&"function"==typeof j)return j(b,A);const Q=$(b),G=$(A);if(0===Q.length&&0===G.length)return;if(!Q.length||!G.length||function U(b,A){return!(!Array.isArray(b)||!Array.isArray(A))&&b.length!==A.length}(b,A))return{type:"complete",oldValue:b,newValue:A};const Y=G.filter(K=>!Q.includes(K)),L=Q.filter(K=>!G.includes(K)),R=Q.filter(K=>G.includes(K)&&tt(b,K)!==tt(A,K)).concat(Y,L).sort(),P=f(b);if(P&&O.has(P)&&R.length)return{type:"complete",oldValue:b,newValue:A};let z;const J=V(b)&&V(A);for(const K of R){const F=tt(b,K),N=tt(A,K);let st;if((J||"function"!=typeof F&&"function"!=typeof N)&&F!==N&&(null!=F||null!=N)){var et;if(j&&j[K]&&"function"==typeof j[K])st=null===(et=j[K])||void 0===et?void 0:et.call(j,F,N);else if(F instanceof Date&&N instanceof Date){if(F.getTime()===N.getTime())continue;st={type:"complete",oldValue:F,newValue:N}}else st="object"==typeof F&&"object"==typeof N&&f(F)===f(N)?_(F,N):{type:"complete",oldValue:F,newValue:N};null!=st&&(null!=z?z.diff[K]=st:z={type:"partial",diff:{[K]:st}})}}return z}function o(b,A){return l(b,A)}function l(b,A){if(null==b)return!1;const j=A.split(".");let Q=b;for(const G of j){if("complete"===Q.type)return!0;if("partial"!==Q.type)return!1;{const Y=Q.diff[G];if(!Y)return!1;Q=Y}}return!0}function g(b,A){if(!b)return!1;if("partial"===b.type){const j=Object.keys(b.diff);return 1===j.length&&j[0]===A}return!1}function M(b,A){if("function"!=typeof b&&"function"!=typeof A&&(null!=b||null!=A))return null==b||null==A||"object"==typeof b&&"object"==typeof A&&f(b)!==f(A)?{type:"complete",oldValue:b,newValue:A}:_(b,A)}},86468:(lt,X,m)=>{m.d(X,{T:()=>k,U:()=>W});var T=m(69287);function W(U,f,_=0){const o=(0,T.qE)(U,0,$);for(let l=0;l<4;l++)f[_+l]=Math.floor(256*tt(o*O[l]))}function k(U,f=0){let _=0;for(let o=0;o<4;o++)_+=U[f+o]*V[o];return _}const O=[1,256,65536,16777216],V=[1/256,1/65536,1/16777216,1/4294967296],$=k(new Uint8ClampedArray([255,255,255,255]));function tt(U){return U-Math.floor(U)}},55912:(lt,X,m)=>{m.d(X,{A:()=>tt});var k,U,T=m(3248),W=m(61591);(U=k||(k={}))[U.varint=0]="varint",U[U.fixed64=1]="fixed64",U[U.delimited=2]="delimited",U[U.fixed32=5]="fixed32",U[U.unknown=99]="unknown";const O=4294967296,V=new TextDecoder("utf-8"),$=(0,T.A)("safari")||(0,T.A)("ios")?6:(0,T.A)("ff")?12:32;class tt{constructor(f,_,o=0,l=(f?f.byteLength:0)){this._tag=0,this._dataType=k.unknown,this._init(f,_,o,l)}_init(f,_,o,l){this._data=f,this._dataView=_,this._pos=o,this._end=l}asUnsafe(){return this}clone(){return new tt(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(f){this._pos=f}nextTag(f){for(;;){if(this._pos===this._end)return!1;const _=this._decodeVarint();if(this._tag=_>>3,this._dataType=7&_,!f||f===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const f=this._decodeVarint();return this._tag=f>>3,this._dataType=7&f,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let f=4294967295;if(f=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128||(f=(f|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)||(f=(f|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)||(f=(f|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)||(f=(f|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128))return f;throw new Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){const f=this.getUInt32();return f>>>1^-(1&f)}getSInt64(){return this._decodeSVarint()}getBool(){const f=0!==this._data[this._pos];return this._skip(1),f}getEnum(){return this._decodeVarint()}getFixed64(){const f=this._dataView,_=this._pos,o=f.getUint32(_,!0)+f.getUint32(_+4,!0)*O;return this._skip(8),o}getSFixed64(){const f=this._dataView,_=this._pos,o=f.getUint32(_,!0)+f.getInt32(_+4,!0)*O;return this._skip(8),o}getDouble(){const f=this._dataView.getFloat64(this._pos,!0);return this._skip(8),f}getFixed32(){const f=this._dataView.getUint32(this._pos,!0);return this._skip(4),f}getSFixed32(){const f=this._dataView.getInt32(this._pos,!0);return this._skip(4),f}getFloat(){const f=this._dataView.getFloat32(this._pos,!0);return this._skip(4),f}getString(){const f=this._getLength(),_=this._pos,o=this._toString(this._data,_,_+f);return this._skip(f),o}getBytes(){const f=this._getLength(),_=this._pos,o=this._toBytes(this._data,_,_+f);return this._skip(f),o}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(f,_,o,l){const y=this.getMessage(),x=f(y,_,o,l);return y.release(),x}processMessage(f){const _=this.getMessage(),o=f(_);return _.release(),o}getMessage(){const f=this._getLength(),_=tt.pool.acquire();return _._init(this._data,this._dataView,this._pos,this._pos+f),this._skip(f),_}release(){tt.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case k.varint:this._decodeVarint();break;case k.fixed64:this._skip(8);break;case k.delimited:this._skip(this._getLength());break;case k.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(f){this._skip(f)}_skip(f){if(this._pos+f>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=f}_decodeVarint(){const f=this._data;let _=this._pos,o=0,l=0;if(this._end-_>=10)do{if(l=f[_++],o|=127&l,!(128&l&&(l=f[_++],o|=(127&l)<<7,128&l)&&(l=f[_++],o|=(127&l)<<14,128&l)&&(l=f[_++],o|=(127&l)<<21,128&l)&&(l=f[_++],o+=268435456*(127&l),128&l)&&(l=f[_++],o+=34359738368*(127&l),128&l)&&(l=f[_++],o+=4398046511104*(127&l),128&l)&&(l=f[_++],o+=562949953421312*(127&l),128&l)&&(l=f[_++],o+=72057594037927940*(127&l),128&l)&&(l=f[_++],o+=0x8000000000000000*(127&l),128&l)))break;throw new Error("Varint too long!")}while(0);else{let y=1;for(;_!==this._end&&(l=f[_],128&l);)++_,o+=(127&l)*y,y*=128;if(_===this._end)throw new Error("Varint overrun!");++_,o+=l*y}return this._pos=_,o}_decodeSVarint(){const f=this._data;let _,o=0,l=0;const y=1&f[this._pos];if(l=f[this._pos++],o|=127&l,!(128&l&&(l=f[this._pos++],o|=(127&l)<<7,128&l)&&(l=f[this._pos++],o|=(127&l)<<14,128&l)&&(l=f[this._pos++],o|=(127&l)<<21,128&l)&&(l=f[this._pos++],o+=268435456*(127&l),128&l)&&(l=f[this._pos++],o+=34359738368*(127&l),128&l)&&(l=f[this._pos++],o+=4398046511104*(127&l),128&l)))return y?-(o+1)/2:o/2;if(_=BigInt(o),l=f[this._pos++],_+=0x2000000000000n*BigInt(127&l),!(128&l&&(l=f[this._pos++],_+=0x100000000000000n*BigInt(127&l),128&l)&&(l=f[this._pos++],_+=0x8000000000000000n*BigInt(127&l),128&l)))return Number(y?-(_+1n)/2n:_/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==k.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(f,_,o){if((o=Math.min(this._end,o))-_>$){const x=f.subarray(_,o);return V.decode(x)}let l="",y="";for(let x=_;x<o;++x){const g=f[x];128&g?y+="%"+g.toString(16):(l+=decodeURIComponent(y)+String.fromCharCode(g),y="")}return y.length&&(l+=decodeURIComponent(y)),l}_toBytes(f,_,o){return o=Math.min(this._end,o),new Uint8Array(f.buffer,_,o-_)}}tt.pool=new W.A(tt,void 0,U=>{U._data=null,U._dataView=null})},91766:(lt,X,m)=>{var W,k,_;m.d(X,{O3:()=>$,Ox:()=>tt,bR:()=>O,dC:()=>W}),(_=W||(W={}))[_.Unknown=0]="Unknown",_[_.Point=1]="Point",_[_.LineString=2]="LineString",_[_.Polygon=3]="Polygon";class O{constructor(o,l){this.x=o,this.y=l}clone(){return new O(this.x,this.y)}equals(o,l){return o===this.x&&l===this.y}isEqual(o){return o.x===this.x&&o.y===this.y}setCoords(o,l){return this.x=o,this.y=l,this}normalize(){const o=this.x,l=this.y,y=Math.sqrt(o*o+l*l);return this.x/=y,this.y/=y,this}rightPerpendicular(){const o=this.x;return this.x=this.y,this.y=-o,this}leftPerpendicular(){const o=this.x;return this.x=-this.y,this.y=o,this}move(o,l){return this.x+=o,this.y+=l,this}assign(o){return this.x=o.x,this.y=o.y,this}assignAdd(o,l){return this.x=o.x+l.x,this.y=o.y+l.y,this}assignSub(o,l){return this.x=o.x-l.x,this.y=o.y-l.y,this}rotate(o,l){const y=this.x,x=this.y;return this.x=y*o-x*l,this.y=y*l+x*o,this}scale(o){return this.x*=o,this.y*=o,this}length(){const o=this.x,l=this.y;return Math.sqrt(o*o+l*l)}sub(o){return this.x-=o.x,this.y-=o.y,this}add(o){return this.x+=o.x,this.y+=o.y,this}static distance(o,l){const y=l.x-o.x,x=l.y-o.y;return Math.sqrt(y*y+x*x)}static add(o,l){return new O(o.x+l.x,o.y+l.y)}static sub(o,l){return new O(o.x-l.x,o.y-l.y)}}class V{constructor(o,l,y){this.ratio=o,this.x=l,this.y=y}}class ${constructor(o,l,y,x=8,g=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=x,this._pixelMargin=g,this._tileSize=512*x,this._dz=o,this._yPos=l,this._xPos=y}setPixelMargin(o){o!==this._pixelMargin&&(this._pixelMargin=o,this.setExtent(this._extent))}setExtent(o){this._extent=o,this._finalRatio=this._tileSize/o*(1<<this._dz);let l=this._pixelRatio*this._pixelMargin;l/=this._finalRatio;const y=o>>this._dz;l>y&&(l=y),this._margin=l,this._xmin=y*this._xPos-l,this._ymin=y*this._yPos-l,this._xmax=this._xmin+y+2*l,this._ymax=this._ymin+y+2*l}reset(o){this._type=o,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(o,l){this._pushLine(),this._prevIsIn=this._isIn(o,l),this._moveTo(o,l,this._prevIsIn),this._prevPt=new O(o,l),this._firstPt=new O(o,l),this._dist=0}lineTo(o,l){const y=this._isIn(o,l),x=new O(o,l),g=O.distance(this._prevPt,x);let M,D,b,A,j,Q,G,Y;if(y)this._prevIsIn?this._lineTo(o,l,!0):(M=this._prevPt,D=x,b=this._intersect(D,M),this._start=this._dist+g*(1-this._r),this._lineTo(b.x,b.y,!0),this._lineTo(D.x,D.y,!0));else if(this._prevIsIn)D=this._prevPt,M=x,b=this._intersect(D,M),this._lineTo(b.x,b.y,!0),this._lineTo(M.x,M.y,!1);else{const L=this._prevPt,R=x;if(L.x<=this._xmin&&R.x<=this._xmin||L.x>=this._xmax&&R.x>=this._xmax||L.y<=this._ymin&&R.y<=this._ymin||L.y>=this._ymax&&R.y>=this._ymax)this._lineTo(R.x,R.y,!1);else{const P=[];if((L.x<this._xmin&&R.x>this._xmin||L.x>this._xmin&&R.x<this._xmin)&&(A=(this._xmin-L.x)/(R.x-L.x),Y=L.y+A*(R.y-L.y),Y<=this._ymin?Q=!1:Y>=this._ymax?Q=!0:P.push(new V(A,this._xmin,Y))),(L.x<this._xmax&&R.x>this._xmax||L.x>this._xmax&&R.x<this._xmax)&&(A=(this._xmax-L.x)/(R.x-L.x),Y=L.y+A*(R.y-L.y),Y<=this._ymin?Q=!1:Y>=this._ymax?Q=!0:P.push(new V(A,this._xmax,Y))),(L.y<this._ymin&&R.y>this._ymin||L.y>this._ymin&&R.y<this._ymin)&&(A=(this._ymin-L.y)/(R.y-L.y),G=L.x+A*(R.x-L.x),G<=this._xmin?j=!1:G>=this._xmax?j=!0:P.push(new V(A,G,this._ymin))),(L.y<this._ymax&&R.y>this._ymax||L.y>this._ymax&&R.y<this._ymax)&&(A=(this._ymax-L.y)/(R.y-L.y),G=L.x+A*(R.x-L.x),G<=this._xmin?j=!1:G>=this._xmax?j=!0:P.push(new V(A,G,this._ymax))),0===P.length)this._lineTo(j?this._xmax:this._xmin,Q?this._ymax:this._ymin,!0);else if(P.length>1&&P[0].ratio>P[1].ratio)this._start=this._dist+g*P[1].ratio,this._lineTo(P[1].x,P[1].y,!0),this._lineTo(P[0].x,P[0].y,!0);else{this._start=this._dist+g*P[0].ratio;for(let z=0;z<P.length;z++)this._lineTo(P[z].x,P[z].y,!0)}this._lineTo(R.x,R.y,!1)}}this._dist+=g,this._prevIsIn=y,this._prevPt=x}close(){if(this._line.length>2){const o=this._firstPt,l=this._prevPt;o.x===l.x&&o.y===l.y||this.lineTo(o.x,o.y);const y=this._line;let x=y.length;for(;x>=4&&(y[0].x===y[1].x&&y[0].x===y[x-2].x||y[0].y===y[1].y&&y[0].y===y[x-2].y);)y.pop(),y[0].x=y[x-2].x,y[0].y=y[x-2].y,--x}}result(o=!0){return this._pushLine(),0===this._lines.length?null:(this._type===W.Polygon&&o&&U.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==W.LineString)throw new Error("Only valid for lines");this._pushLine();const o=this._lines,l=o.length;if(0===l)return null;const y=[];for(let x=0;x<l;x++)y.push({line:o[x],start:this._starts[x]||0});return y}_isIn(o,l){return o>=this._xmin&&o<=this._xmax&&l>=this._ymin&&l<=this._ymax}_intersect(o,l){let y,x,g;if(l.x>=this._xmin&&l.x<=this._xmax)x=l.y<=this._ymin?this._ymin:this._ymax,g=(x-o.y)/(l.y-o.y),y=o.x+g*(l.x-o.x);else if(l.y>=this._ymin&&l.y<=this._ymax)y=l.x<=this._xmin?this._xmin:this._xmax,g=(y-o.x)/(l.x-o.x),x=o.y+g*(l.y-o.y);else{x=l.y<=this._ymin?this._ymin:this._ymax,y=l.x<=this._xmin?this._xmin:this._xmax;const M=(y-o.x)/(l.x-o.x),D=(x-o.y)/(l.y-o.y);M<D?(g=M,x=o.y+M*(l.y-o.y)):(g=D,y=o.x+D*(l.x-o.x))}return this._r=g,new O(y,x)}_pushLine(){this._line&&(this._type===W.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===W.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===W.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(o,l,y){this._type!==W.Polygon?y&&(o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.push(new O(o,l))):(y||(o<this._xmin&&(o=this._xmin),o>this._xmax&&(o=this._xmax),l<this._ymin&&(l=this._ymin),l>this._ymax&&(l=this._ymax)),o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.push(new O(o,l)),this._isH=!1,this._isV=!1)}_lineTo(o,l,y){let x,g;if(this._type!==W.Polygon)if(y){if(o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(x=this._line[this._line.length-1],x.equals(o,l)))return;this._line.push(new O(o,l))}else this._line&&this._line.length>0&&this._pushLine();else if(y||(o<this._xmin&&(o=this._xmin),o>this._xmax&&(o=this._xmax),l<this._ymin&&(l=this._ymin),l>this._ymax&&(l=this._ymax)),o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){x=this._line[this._line.length-1];const M=x.x===o,D=x.y===l;if(M&&D)return;this._isH&&M||this._isV&&D?(x.x=o,x.y=l,g=this._line[this._line.length-2],g.x===o&&g.y===l?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(g=this._line[this._line.length-2],this._isH=g.x===o,this._isV=g.y===l)):(this._isH=g.x===o,this._isV=g.y===l)):(this._line.push(new O(o,l)),this._isH=M,this._isV=D)}else this._line.push(new O(o,l))}}class tt{setExtent(o){this._ratio=4096===o?1:4096/o}get validateTessellation(){return this._ratio<1}reset(o){this._lines=[],this._line=null}moveTo(o,l){this._line&&this._lines.push(this._line),this._line=[];const y=this._ratio;this._line.push(new O(o*y,l*y))}lineTo(o,l){const y=this._ratio;this._line.push(new O(o*y,l*y))}close(){const o=this._line;o&&!o[0].isEqual(o[o.length-1])&&o.push(o[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(_){_[_.sideLeft=0]="sideLeft",_[_.sideRight=1]="sideRight",_[_.sideTop=2]="sideTop",_[_.sideBottom=3]="sideBottom"}(k||(k={}));class U{static simplify(o,l,y){if(!y)return;const x=-l,g=o+l,M=-l,D=o+l,b=[],A=[],j=y.length;for(let G=0;G<j;++G){const Y=y[G];if(!Y||Y.length<2)continue;let L,R=Y[0];const P=Y.length;for(let z=1;z<P;++z)L=Y[z],R.x===L.x&&(R.x<=x&&(R.y>L.y?(b.push(G),b.push(z),b.push(k.sideLeft),b.push(-1)):(A.push(G),A.push(z),A.push(k.sideLeft),A.push(-1))),R.x>=g&&(R.y<L.y?(b.push(G),b.push(z),b.push(k.sideRight),b.push(-1)):(A.push(G),A.push(z),A.push(k.sideRight),A.push(-1)))),R.y===L.y&&(R.y<=M&&(R.x<L.x?(b.push(G),b.push(z),b.push(k.sideTop),b.push(-1)):(A.push(G),A.push(z),A.push(k.sideTop),A.push(-1))),R.y>=D&&(R.x>L.x?(b.push(G),b.push(z),b.push(k.sideBottom),b.push(-1)):(A.push(G),A.push(z),A.push(k.sideBottom),A.push(-1)))),R=L}if(0===b.length||0===A.length)return;U.fillParent(y,A,b),U.fillParent(y,b,A);const Q=[];U.calcDeltas(Q,A,b),U.calcDeltas(Q,b,A),U.addDeltas(Q,y)}static fillParent(o,l,y){const x=y.length,g=l.length;for(let M=0;M<g;M+=4){const D=l[M],b=l[M+1],A=l[M+2],j=o[D][b-1],Q=o[D][b];let G=8092,Y=-1;for(let L=0;L<x;L+=4){if(y[L+2]!==A)continue;const R=y[L],P=y[L+1],z=o[R][P-1],J=o[R][P];switch(A){case k.sideLeft:case k.sideRight:if(f(j.y,z.y,J.y)&&f(Q.y,z.y,J.y)){const et=Math.abs(J.y-z.y);et<G&&(G=et,Y=L)}break;case k.sideTop:case k.sideBottom:if(f(j.x,z.x,J.x)&&f(Q.x,z.x,J.x)){const et=Math.abs(J.x-z.x);et<G&&(G=et,Y=L)}}}l[M+3]=Y}}static calcDeltas(o,l,y){const x=l.length;for(let g=0;g<x;g+=4){const D=U.calcDelta(g,l,y,[]);o.push(l[g]),o.push(l[g+1]),o.push(l[g+2]),o.push(D)}}static calcDelta(o,l,y,x){const g=l[o+3];if(-1===g)return 0;const M=x.length;return M>1&&x[M-2]===g?0:(x.push(g),U.calcDelta(g,y,l,x)+1)}static addDeltas(o,l){const y=o.length;let x=0;for(let g=0;g<y;g+=4){const M=o[g+3];M>x&&(x=M)}for(let g=0;g<y;g+=4){const M=l[o[g]],D=o[g+1],b=x-o[g+3];switch(o[g+2]){case k.sideLeft:M[D-1].x-=b,M[D].x-=b,1===D&&(M[M.length-1].x-=b),D===M.length-1&&(M[0].x-=b);break;case k.sideRight:M[D-1].x+=b,M[D].x+=b,1===D&&(M[M.length-1].x+=b),D===M.length-1&&(M[0].x+=b);break;case k.sideTop:M[D-1].y-=b,M[D].y-=b,1===D&&(M[M.length-1].y-=b),D===M.length-1&&(M[0].y-=b);break;case k.sideBottom:M[D-1].y+=b,M[D].y+=b,1===D&&(M[M.length-1].y+=b),D===M.length-1&&(M[0].y+=b)}}}}const f=(_,o,l)=>_>=o&&_<=l||_>=l&&_<=o},40856:(lt,X,m)=>{m.d(X,{X_:()=>O,i1:()=>V,zx:()=>f});var T=m(69287),W=m(82663);const k=96;function O(l,y){const x=y||l.extent,g=l.width,M=(0,W.GA)(null==x?void 0:x.spatialReference);return x&&g?x.width/g*M*W.dy*k:0}function V(l,y){return l/((0,W.GA)(y)*W.dy*k)}function f(l,y,x){return function _(l,y){return 0===y||(0,T.Sp)(l,y)||l<y}(l,y)&&function o(l,y){return 0===y||(0,T.Sp)(l,y)||l>y}(l,x)}},84289:(lt,X,m)=>{m.d(X,{$:()=>T,s:()=>W});const T=15.5,W=1024},4139:(lt,X,m)=>{m.d(X,{GW:()=>g,IU:()=>j,Jo:()=>O,MG:()=>k,Wh:()=>_,cP:()=>L,os:()=>U,p6:()=>y,pJ:()=>V,ru:()=>G,s3:()=>Q,w4:()=>Y,wV:()=>l,yM:()=>R,z0:()=>o});var T=m(15268),W=m(91766);const k=Number.POSITIVE_INFINITY,O=Math.PI,V=2*O,$=128/O,tt=256/360,U=O/180,f=1/Math.LN2;function _(P,z){return(P%=z)>=0?P:P+z}function o(P){return _(P*$,256)}function l(P){return _(P*tt,256)}function y(P){return Math.log(P)*f}function g(P,z,J){return P*(1-J)+z*J}const D=8,b=14,A=16;function j(P){return D+Math.max((P-b)*A,0)}function Q(P,z,J){let et,K,F,N=0;for(const st of J){et=st.length;for(let ht=1;ht<et;++ht)K=st[ht-1],F=st[ht],K.y>z!=F.y>z&&((F.x-K.x)*(z-K.y)-(F.y-K.y)*(P-K.x)>0?N++:N--)}return 0!==N}function G(P,z,J,et){let K,F,N,st;const ht=et*et;for(const at of J){const pt=at.length;if(!(pt<2)){K=at[0].x,F=at[0].y;for(let _t=1;_t<pt;++_t){if(N=at[_t].x,st=at[_t].y,(0,T.Ng)(P,z,K,F,N,st)<ht)return!0;K=N,F=st}}}return!1}function Y(P,z,J,et,K,F,N){const st=Math.max(et,Math.min(z,F))-z,ht=Math.max(K,Math.min(J,N))-J;return st*st+ht*ht<=P*P}function L(P,z){if(0===z||Number.isNaN(z))return P;const J=[],et=new W.bR(0,0),K=new W.bR(0,0),F=new W.bR(0,0);for(let N=0;N<P.length;N++){const st=P[N],ht=[];for(let at=0;at<st.length;at++){const pt=st[at-1],_t=st[at],Tt=st[at+1];0===at?et.setCoords(0,0):et.assignSub(_t,pt).normalize().rightPerpendicular(),at===st.length-1?K.setCoords(0,0):K.assignSub(Tt,_t).normalize().rightPerpendicular(),F.assignAdd(et,K).normalize();const vt=F.x*K.x+F.y*K.y;0!==vt&&F.scale(1/vt),ht.push(W.bR.add(_t,F.scale(z)))}J.push(ht)}return J}function R(P,z,J,et){const K=new W.bR(P[0],P[1]);if(K.scale(et),"viewport"===z){const F=-J*(Math.PI/180),N=Math.cos(F),st=Math.sin(F);K.rotate(N,st)}return K}},68973:(lt,X,m)=>{m.d(X,{A:()=>T});class T{constructor(k=0,O=0,V=0,$=0){this.x=k,this.y=O,this.width=V,this.height=$}get isEmpty(){return this.width<=0||this.height<=0}union(k){this.x=Math.min(this.x,k.x),this.y=Math.min(this.y,k.y),this.width=Math.max(this.width,k.width),this.height=Math.max(this.height,k.height)}}},37188:(lt,X,m)=>{m.d(X,{A:()=>tt});var T=m(3248),W=m(69473),k=m(54382),O=m(89298),V=m(99065);const $=(U,f)=>U.key.level-f.key.level!=0?U.key.level-f.key.level:U.key.row-f.key.row!=0?U.key.row-f.key.row:U.key.col-f.key.col;class tt extends k.A{constructor(f){super(),this._tileInfoView=f}renderChildren(f){this.sortChildren($),this.setStencilReference(f),super.renderChildren(f)}createRenderParams(f){const{state:_}=f,o=super.createRenderParams(f);return o.requiredLevel=this._tileInfoView.getClosestInfoForScale(_.scale).level,o.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(_.scale),o}prepareRenderPasses(f){const _=super.prepareRenderPasses(f);return _.push(f.registerRenderPass({name:"stencil",brushes:[O.A],drawPhase:W.S5.DEBUG|W.S5.MAP|W.S5.HIGHLIGHT|W.S5.LABEL,target:()=>this.getStencilTarget()})),(0,T.A)("esri-tiles-debug")&&_.push(f.registerRenderPass({name:"tileInfo",brushes:[V.A],drawPhase:W.S5.DEBUG,target:()=>this.children})),_}getStencilTarget(){return this.children}setStencilReference(f){let _=1;for(const o of this.children)o.stencilRef=_++}}},29459:(lt,X,m)=>{m.d(X,{e:()=>G});var g,T=m(8189),W=m(31178),k=m(5605),O=m(5922),V=m(48900),$=m(85211),_=(m(3248),m(35150),m(40707),m(76576)),o=m(40856),l=m(88766),y=m(60746),x=m(66727);let M=g=class extends x.A{constructor(Y){super(Y),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new g({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,T._)([(0,$.MZ)({type:[Number,String],json:{write:!0}})],M.prototype,"left",void 0),(0,T._)([(0,$.MZ)({type:[Number,String],json:{write:!0}})],M.prototype,"right",void 0),(0,T._)([(0,$.MZ)({type:[Number,String],json:{write:!0}})],M.prototype,"top",void 0),(0,T._)([(0,$.MZ)({type:[Number,String],json:{write:!0}})],M.prototype,"bottom",void 0),M=g=(0,T._)([(0,_.$)("esri.views.layers.support.ClipRect")],M);const D=M;var b=m(75644);let A=class extends x.A{constructor(Y){super(Y),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,T._)([(0,$.MZ)({type:[[[Number]]],json:{write:!0}})],A.prototype,"path",void 0),A=(0,T._)([(0,_.$)("esri.views.layers.support.Path")],A);const Q=W.A.ofType({key:"type",base:null,typeMap:{rect:D,path:A,geometry:b.A}}),G=Y=>{let L=class extends Y{constructor(){super(...arguments),this.attached=!1,this.clips=new Q,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){var R,P,z,J;const et=null===(R=null===(P=this.view)||void 0===P?void 0:P.spatialReferenceLocked)||void 0===R||R;(null===(z=this.view)||void 0===z?void 0:z.spatialReference)&&et&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new O.A("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new l.m),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,V.wB)(()=>this.suspended,F=>{this.container&&(this.container.visible=!F)},V.pc),(0,V.wB)(()=>this.updateSuspended,F=>{this.view&&!F&&this.updateRequested&&this.view.requestUpdate()},V.pc),(0,V.wB)(()=>{var F,N;return null!==(F=null===(N=this.layer)||void 0===N?void 0:N.opacity)&&void 0!==F?F:1},F=>{this.container&&(this.container.opacity=F)},V.pc),(0,V.wB)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",F=>{this.container&&(this.container.blendMode=F)},V.pc),(0,V.wB)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,F=>{this.container&&(this.container.effect=F)},V.pc),(0,V.wB)(()=>this.highlightOptions,F=>this.container.highlightOptions=F,V.pc),(0,V.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},V.pc),(0,V.wB)(()=>{var F;return{scale:null===(F=this.view)||void 0===F?void 0:F.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}},({scale:F})=>{const N=null!=F&&this.isVisibleAtScale(F);N!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",N)},V.pc)],"constructor"),null!==(J=this.view)&&void 0!==J&&J.whenLayerView?this.view.whenLayerView(this.layer).then(F=>{F===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){var R;const P=null===(R=this.view)||void 0===R?void 0:R.spatialReference;return null==P||this.supportsSpatialReference(P)}get updateSuspended(){return this.suspended}get updating(){var R;return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!(null===(R=this._updatingHandles)||void 0===R||!R.updating))}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(R){const P=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!P)return!0;const{minScale:z,maxScale:J}=P;return(0,o.zx)(R,z,J)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(R){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",R),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(R))):this.updateRequested=!1}hitTest(R,P){return Promise.resolve(null)}supportsSpatialReference(R){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const R=super.getSuspendInfo(),P=!this.spatialReferenceSupported,z=this.visibleAtCurrentScale;return P&&(R.spatialReferenceNotSupported=P),z&&(R.outsideScaleRange=z),R}addAttachHandles(R){this.addHandles(R,"attach")}};return(0,T._)([(0,$.MZ)()],L.prototype,"attached",void 0),(0,T._)([(0,$.MZ)({type:Q,set(R){const P=(0,k.V)(R,this._get("clips"),Q);this._set("clips",P)}})],L.prototype,"clips",void 0),(0,T._)([(0,$.MZ)()],L.prototype,"container",void 0),(0,T._)([(0,$.MZ)()],L.prototype,"moving",void 0),(0,T._)([(0,$.MZ)({readOnly:!0})],L.prototype,"spatialReferenceSupported",null),(0,T._)([(0,$.MZ)({readOnly:!0})],L.prototype,"updateParameters",void 0),(0,T._)([(0,$.MZ)()],L.prototype,"updateRequested",void 0),(0,T._)([(0,$.MZ)()],L.prototype,"updateSuspended",null),(0,T._)([(0,$.MZ)()],L.prototype,"updating",null),(0,T._)([(0,$.MZ)()],L.prototype,"view",void 0),(0,T._)([(0,$.MZ)({readOnly:!0})],L.prototype,"visibleAtCurrentScale",void 0),(0,T._)([(0,$.MZ)({type:y.A})],L.prototype,"highlightOptions",void 0),L=(0,T._)([(0,_.$)("esri.views.2d.layers.LayerView2D")],L),L}},90143:(lt,X,m)=>{m.r(X),m.d(X,{default:()=>Ve});var T=m(10467),W=m(8189),k=m(77806),O=m(35150),V=m(11432),$=m(56492),tt=m(85211),f=(m(3248),m(76576)),_=m(48237),o=m(13303),l=m(51995),y=m(58701),x=m(20904),g=m(45272),M=m(19284),D=m(68973);class b{constructor(t,s){this._width=0,this._height=0,this._free=[],this._width=t,this._height=s,this._free.push(new D.A(0,0,t,s))}get width(){return this._width}get height(){return this._height}allocate(t,s){if(t>this._width||s>this._height)return new D.A;let i=null,r=-1;for(let a=0;a<this._free.length;++a){const h=this._free[a];t<=h.width&&s<=h.height&&(null===i||h.y<=i.y&&h.x<=i.x)&&(i=h,r=a)}return null===i?new D.A:(this._free.splice(r,1),i.width<i.height?(i.width>t&&this._free.push(new D.A(i.x+t,i.y,i.width-t,s)),i.height>s&&this._free.push(new D.A(i.x,i.y+s,i.width,i.height-s))):(i.width>t&&this._free.push(new D.A(i.x+t,i.y,i.width-t,i.height)),i.height>s&&this._free.push(new D.A(i.x,i.y+s,t,i.height-s))),new D.A(i.x,i.y,t,s))}release(t){for(let s=0;s<this._free.length;++s){const i=this._free[s];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(s,1),this.release(t)}this._free.push(t)}}var A=m(50915),j=m(26136),Q=m(4931);class G{constructor(t,s,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=s,this._glyphSource=i,this._binPack=new b(t-4,s-4),this._glyphData.push(new Uint8Array(t*s)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,s){const i=[],r=this._glyphSource,a=new Set;for(const u of s){const p=Math.floor(.00390625*u);a.add(p)}const c=[];return a.forEach(u=>{const p=t+u;if(this._rangePromises.has(p))c.push(this._rangePromises.get(p));else{const v=r.getRange(t,u).then(()=>{this._rangePromises.delete(p)},()=>{this._rangePromises.delete(p)});this._rangePromises.set(p,v),c.push(v)}}),Promise.all(c).then(()=>{let u=this._glyphIndex[t];u||(u={},this._glyphIndex[t]=u);for(const p of s){const v=u[p];if(v){i[p]={sdf:!0,rect:v.rect,metrics:v.metrics,page:v.page,code:p};continue}const w=r.getGlyph(t,p);if(null==w||!w.metrics)continue;const I=w.metrics;let S;if(0===I.width)S=new D.A(0,0,0,0);else{const E=I.width+6,H=I.height+6;let B=E%4?4-E%4:4,Z=H%4?4-H%4:4;1===B&&(B=5),1===Z&&(Z=5),S=this._binPack.allocate(E+B,H+Z),S.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new b(this.width-4,this.height-4),S=this._binPack.allocate(E+B,H+Z));const q=this._glyphData[this._currentPage],nt=w.bitmap;let ut,rt;if(nt)for(let ot=0;ot<H;ot++){ut=E*ot,rt=this.width*(S.y+ot+1)+S.x;for(let yt=0;yt<E;yt++)q[rt+yt+1]=nt.at(ut+yt)}}u[p]={rect:S,metrics:I,tileIDs:null,page:this._currentPage},i[p]={sdf:!0,rect:S,metrics:I,page:this._currentPage,code:p},this._dirties[this._currentPage]=!0}return i})}removeGlyphs(t){for(const s in this._glyphIndex){const i=this._glyphIndex[s];if(!i)continue;let r;for(const a in i)if(r=i[a],r.tileIDs.delete(t),0===r.tileIDs.size){const h=this._glyphData[r.page],c=r.rect;let u,p;for(let v=0;v<c.height;v++)for(u=this.width*(c.y+v)+c.x,p=0;p<c.width;p++)h[u+p]=0;delete i[a],this._dirties[r.page]=!0}}}bind(t,s,i,r=0){if(!this._textures[i]){const h=new Q.R;h.pixelFormat=A.Ab.ALPHA,h.wrapMode=A.pF.CLAMP_TO_EDGE,h.width=this.width,h.height=this.height,this._textures[i]=new j.g(t,h,new Uint8Array(this.width*this.height))}const a=this._textures[i];a.setSamplingMode(s),this._dirties[i]&&a.setData(this._glyphData[i]),t.bindTexture(a,r),this._dirties[i]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}var Y=m(89563),L=m(55912);class R{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const s=new Map;let i=0;for(;t.next();)switch(t.tag()){case 1:{const u=t.getMessage();for(;u.next();)switch(u.tag()){case 3:{const p=u.getMessage();let v,w,I,S,C,E,H;for(;p.next();)switch(p.tag()){case 1:v=p.getUInt32();break;case 2:w=p.getBytes();break;case 3:I=p.getUInt32();break;case 4:S=p.getUInt32();break;case 5:C=p.getSInt32();break;case 6:E=p.getSInt32();break;case 7:H=p.getUInt32();break;default:p.skip()}if(p.release(),v){var r,a;const B=null!==(r=null===(a=w)||void 0===a?void 0:a.length)&&void 0!==r?r:0;this._metrics[v]={width:I,height:S,left:C,top:E,advance:H,startOffset:i,length:B},s.set(v,w),i+=B}break}default:u.skip()}u.release();break}default:t.skip()}const h=new Uint8Array(i),c=this._metrics;for(const[u,p]of s){const{startOffset:v,length:w}=c[u];if(p)for(let I=0;I<w;++I)h[v+I]=p[I]}this._allBitmaps=h}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const s=this._metrics[t];if(void 0===s)return;const{startOffset:i,length:r}=s;return 0!==r?new J(this._allBitmaps,i,r):void 0}}class P{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,s){this._ranges[t]=s}}class z{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,s){const i=this._getFontStack(t);if(i.getRange(s))return Promise.resolve();const r=256*s,a=r+255;if(this._baseURL){const h=this._baseURL.replace("{fontstack}",t).replace("{range}",r+"-"+a);return(0,Y.A)(h,{responseType:"array-buffer"}).then(c=>{i.addRange(s,new R(new L.A(new Uint8Array(c.data),new DataView(c.data))))}).catch(()=>{i.addRange(s,new R)})}return i.addRange(s,new R),Promise.resolve()}getGlyph(t,s){const i=this._getFontStack(t);if(!i)return;const r=Math.floor(s/256),a=i.getRange(r);return a?{metrics:a.getMetrics(s),bitmap:a.getBitmap(s)}:void 0}_getFontStack(t){let s=this._glyphInfo[t];return s||(s=this._glyphInfo[t]=new P),s}}class J{constructor(t,s,i){this._array=t,this._start=s,this.length=i}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}}var et=m(28685);class F{constructor(t,s,i=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||s<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=s,i>0&&(this._maxItemSize=i),this._binPack=new b(t-4,s-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new b(this._pageWidth-4,this._pageHeight-4);const s=Math.floor(this._pageWidth),i=Math.floor(this._pageHeight),r=new Uint32Array(s*i);this._mosaicsData[0]=r,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,s=!1){var i;let r,a,h=this._mosaicRects[t];if(h)return h;if(!this._sprites||"loaded"!==this._sprites.loadStatus||(t&&t.startsWith("dasharray-")?([r,a]=this._rasterizeDash(t),s=!0):r=this._sprites.getSpriteInfo(t),null===(i=r)||void 0===i||!i.width||!r.height||r.width<0||r.height<0))return null;const c=r.width,u=r.height,[p,v,w]=this._allocateImage(c,u);return p.width<=0?null:(this._copy(p,r,v,w,s,a),h={type:"sprite",rect:p,width:c,height:u,sdf:r.sdf,simplePattern:!1,rasterizationScale:r.pixelRatio,page:v},this._mosaicRects[t]=h,h)}getSpriteItems(t){const s={};for(const i of t)s[i.name]=this.getSpriteItem(i.name,i.repeat);return s}getMosaicItemPosition(t,s){const i=this.getSpriteItem(t,s),r=i&&i.rect;return r?(r.width=i.width,r.height=i.height,{tl:[r.x+2,r.y+2],br:[r.x+2+i.width,r.y+2+i.height],page:i.page}):null}bind(t,s,i=0,r=0){if(i>=this._size.length||i>=this._mosaicsData.length)return;if(!this._textures[i]){const h=new Q.R;h.wrapMode=A.pF.CLAMP_TO_EDGE,h.width=this._size[i][0],h.height=this._size[i][1],this._textures[i]=new j.g(t,h,new Uint8Array(this._mosaicsData[i].buffer))}const a=this._textures[i];a.setSamplingMode(s),this._dirties[i]&&a.setData(new Uint8Array(this._mosaicsData[i].buffer)),t.bindTexture(a,r),this._dirties[i]=!1}static _copyBits(t,s,i,r,a,h,c,u,p,v,w){let I=r*s+i,S=u*h+c;if(w){S-=h;for(let C=-1;C<=v;C++,I=((C+v)%v+r)*s+i,S+=h)for(let E=-1;E<=p;E++)a[S+E]=t[I+(E+p)%p]}else for(let C=0;C<v;C++){for(let E=0;E<p;E++)a[S+E]=t[I+E];I+=s,S+=h}}_copy(t,s,i,r,a,h){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;const c=new Uint32Array(h?h.buffer:this._sprites.image.buffer),u=this._mosaicsData[i];u&&c||console.error("Source or target images are uninitialized!"),F._copyBits(c,h?s.width:this._sprites.width,s.x,s.y,u,r[0],t.x+2,t.y+2,s.width,s.height,a),this._dirties[i]=!0}_allocateImage(t,s){t+=2,s+=2;const i=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<i){const c=new D.A(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[c,this._mosaicsData.length-1,[t,s]]}let r=t%4?4-t%4:4,a=s%4?4-s%4:4;1===r&&(r=5),1===a&&(a=5);const h=this._binPack.allocate(t+r,s+a);return h.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new b(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[h,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const i=t.match(/\[(.*?)\]/);if(!i)return null;const r=i[1].split(",").map(Number),a=t.slice(t.lastIndexOf("-")+1),[h,c,u]=(0,et.k)(r,a);return[{x:0,y:0,width:c,height:u,sdf:!0,pixelRatio:1},new Uint8Array(h.buffer)]}}var N=m(74847);class st{constructor(t,s,i,r){this._layer=t,this._styleRepository=s,this.devicePixelRatio=i,this._sourceDataMaxLOD=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){var t,s,i;null!==(t=this._connection)&&void 0!==t&&t.close(),this._connection=null,this._styleRepository=null,this._layer=null,null!==(s=this._spriteMosaic)&&void 0!==s&&s.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,V.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&null!==(i=this._startOptionsInputSignal)&&void 0!==i&&i.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}start(t){var s=this;return(0,T.A)(function*(){s._requestSprite(t);const i=s._layer.currentStyleInfo.glyphsUrl,r=new z(i?(0,g.a6)(i,{...s._layer.customParameters,token:s._layer.apiKey}):null);s._glyphMosaic=new G(1024,1024,r),s._broadcastPromise=(0,M.ho)("WorkerTileHandler",{client:s,schedule:t.schedule,signal:t.signal}).then(a=>{var h;if(s._layer&&(null!==(h=s._connection)&&void 0!==h&&h.close(),s._connection=a,s._layer&&!s._connection.closed)){const c=a.broadcast("setStyle",{style:s._layer.currentStyleInfo.style,sourceDataMaxLOD:s._sourceDataMaxLOD},t);Promise.all(c).catch(u=>(0,$.jH)(u))}})})()}_requestSprite(t){var s,i;null===(s=this._spriteSourceAbortController)||void 0===s||s.abort();const r=new AbortController;this._spriteSourceAbortController=r;const a=null==t?void 0:t.signal;this._inputSignalEventListener&&null!==(i=this._startOptionsInputSignal)&&void 0!==i&&i.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,a&&(this._inputSignalEventListener=function ht(d){return()=>d.abort()}(r),a.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:h}=r,c={...t,signal:h};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,c),this._spriteSourcePromise.then(u=>{(0,$.QP)(h),this._spriteMosaic=new F(1024,1024,250),this._spriteMosaic.setSpriteSource(u)})}updateStyle(t){var s=this;return(0,T.A)(function*(){return yield s._broadcastPromise,s._broadcastPromise=Promise.all(s._connection.broadcast("updateStyle",t)),s._broadcastPromise})()}setSpriteSource(t){const s=new F(1024,1024,250);return s.setSpriteSource(t),this._spriteMosaic=s,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,s}setStyle(t,s,i){var r=this;return(0,T.A)(function*(){yield r._broadcastPromise,r._styleRepository=t,r._sourceDataMaxLOD=i,r._requestSprite();const a=new z(r._layer.currentStyleInfo.glyphsUrl?(0,g.a6)(r._layer.currentStyleInfo.glyphsUrl,{...r._layer.customParameters,token:r._layer.apiKey}):null);return r._glyphMosaic=new G(1024,1024,a),r._broadcastPromise=Promise.all(r._connection.broadcast("setStyle",{style:s,sourceDataMaxLOD:r._sourceDataMaxLOD})),r._broadcastPromise})()}fetchTileData(t,s){var i=this;return(0,T.A)(function*(){const r=yield i._getRefKeys(t,s);return i._getSourcesData(Object.keys(i._layer.sourceNameToSource),r,s)})()}fetchTilePBFs(t){var s=this;return(0,T.A)(function*(){const i=Object.keys(s._layer.sourceNameToSource),r={},a=yield s._getRefKeys(t,r),h=[],c=[];for(let u=0;u<a.length;u++)if(null==a[u].value||null==i[u])c.push(null);else{const p=a[u].value,v=s._getTilePayload(p,i[u],r);v.then(w=>{h.push({...w,key:p})}),c.push(v)}return Promise.all(c).then(()=>h)})()}parseTileData(t,s){var i=this;return(0,T.A)(function*(){const r=t&&t.data;if(!r)return null;const{sourceName2DataAndRefKey:a,transferList:h}=r;return 0===Object.keys(a).length?null:i._broadcastPromise.then(()=>i._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:a,styleLayerUIDs:t.styleLayerUIDs},{...s,transferList:h}))})()}getSprites(t){var s=this;return(0,T.A)(function*(){return yield s._spriteSourcePromise,s._spriteMosaic.getSpriteItems(t)})()}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}_getTilePayload(t,s,i){var r=this;return(0,T.A)(function*(){const a=N.A.pool.acquire(t.id),h=r._layer.sourceNameToSource[s],{level:c,row:u,col:p}=a;N.A.pool.release(a);try{return{protobuff:yield h.requestTile(c,u,p,i),sourceName:s}}catch(v){if((0,$.zf)(v))throw v;return{protobuff:null,sourceName:s}}})()}_getRefKeys(t,s){var i=this;return(0,T.A)(function*(){const r=i._layer.sourceNameToSource,a=new Array;for(const h in r){const c=r[h].getRefKey(t,s);a.push(c)}return(0,$.Lx)(a)})()}_getSourcesData(t,s,i){const r=[];for(let a=0;a<s.length;a++)if(null==s[a].value||null==t[a])r.push(null);else{const c=this._getTilePayload(s[a].value,t[a],i);r.push(c)}return(0,$.Lx)(r).then(a=>{const h={},c=[];for(let u=0;u<a.length;u++){const p=a[u].value;p&&p.protobuff&&p.protobuff.byteLength>0&&(h[p.sourceName]={refKey:s[u].value.id,protobuff:p.protobuff},c.push(p.protobuff))}return{sourceName2DataAndRefKey:h,transferList:c}})}}var at=m(33087),pt=m(75324);const vt=(d,t)=>d+1/(1<<2*t);class Lt{constructor(t,s){this._tiles=new Map,this._tileCache=new at.q(40,i=>i.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=s}destroy(){for(const[t,s]of this._tiles)s.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const s=this.tileInfoView,i=s.getTileCoverage(t.state,0,!0,"smallest");if(!i)return!0;const{spans:r,lodInfo:a}=i,{level:h}=a,c=this._tiles,u=new Set,p=new Set;for(const{row:w,colFrom:I,colTo:S}of r)for(let C=I;C<=S;C++){const E=N.A.getId(h,w,a.normalizeCol(C),a.getWorldForColumn(C)),H=this._getOrAcquireTile(E);u.add(E),H.processed()?this._addToContainer(H):p.add(new N.A(E))}for(const[w,I]of c)I.isCoverage=u.has(w);for(const w of p)this._findPlaceholdersForMissingTiles(w,u);let v=!1;for(const[w,I]of c)I.neededForCoverage=u.has(w),I.neededForCoverage||I.isHoldingForFade&&s.intersects(i,I.key)&&u.add(w),I.isFading&&(v=!0);for(const[w,I]of this._tiles)u.has(w)||this._releaseTile(w);return pt.A.pool.release(i),!v}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(t,s,i,r,a){const h=[0,0],c=[0,0];r.toMap(h,t-i,s+i),r.toMap(c,t+i,s-i);const u=Math.min(h[0],c[0]),p=Math.min(h[1],c[1]),v=Math.max(h[0],c[0]),w=Math.max(h[1],c[1]),I=(0,l.fA)(u,p,v,w),S=(0,l.vt)(),C=[];for(const[E,H]of this._visibleTiles)this.tileInfoView.getTileBounds(S,H.key),(0,l.HY)(I,S)&&C.push(H);if(null!=a&&a.length>0){const E=new Set(C.map(B=>B.id)),H=a.filter(B=>!E.has(B.tileKey.id)).map(B=>this._visibleTiles.get(B.tileKey.id)).filter(B=>void 0!==B);C.push(...H)}return C}_findPlaceholdersForMissingTiles(t,s){const i=[];for(const[a,h]of this._tiles)this._addPlaceholderChild(i,h,t,s);const r=i.reduce(vt,0);Math.abs(1-r)<1e-6||this._addPlaceholderParent(t.id,s)}_addPlaceholderChild(t,s,i,r){s.key.level<=i.level||!s.hasData()||function te(d,t){const s=t.level-d.level;return d.row===t.row>>s&&d.col===t.col>>s&&d.world===t.world}(i,s.key)&&(this._addToContainer(s),r.add(s.id),t.push(s.key.level-i.level))}_addPlaceholderParent(t,s){const i=this._tiles;let r=t;for(;;){if(r=Xt(r),!r||s.has(r))return;const a=i.get(r);if(a&&a.hasData())return this._addToContainer(a),void s.add(a.id)}}_getOrAcquireTile(t){let s=this._tiles.get(t);return s||(s=this._tileCache.pop(t),s||(s=this.acquireTile(new N.A(t))),this._tiles.set(t,s),s)}_releaseTile(t){const s=this._tiles.get(t);this.releaseTile(s),this._removeFromContainer(s),this._tiles.delete(t),s.hasData()?this._tileCache.put(t,s,1):s.dispose()}_addToContainer(t){let s;const i=[],r=this._container;if(r.contains(t))return;const a=this._visibleTiles;for(const[h,c]of a)this._canConnectDirectly(t,c)&&i.push(c),null==s&&this._canConnectDirectly(c,t)&&(s=c);if(null!=s){for(const h of i)s.childrenTiles.delete(h),t.childrenTiles.add(h),h.parentTile=t;s.childrenTiles.add(t),t.parentTile=s}else for(const h of i)t.childrenTiles.add(h),h.parentTile=t;a.set(t.id,t),r.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),null!=t.parentTile){t.parentTile.childrenTiles.delete(t);for(const s of t.childrenTiles)null!=t.parentTile&&t.parentTile.childrenTiles.add(s)}for(const s of t.childrenTiles)s.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,s){const i=t.key;let{level:r,row:a,col:h,world:c}=s.key;const u=this._visibleTiles;for(;r>0;){if(r--,a>>=1,h>>=1,i.level===r&&i.row===a&&i.col===h&&i.world===c)return!0;if(u.has(`${r}/${a}/${h}/${c}`))return!1}return!1}_updateCacheSize(t){const s=t.state.size;if(s[0]===this._viewSize[0]&&s[1]===this._viewSize[1])return;const i=Math.ceil(s[0]/512)+1,r=Math.ceil(s[1]/512)+1;this._viewSize[0]=s[0],this._viewSize[1]=s[1],this._tileCache.maxSize=5*i*r}}function Xt(d){const[t,s,i,r]=d.split("/"),a=parseInt(t,10);return 0===a?null:`${a-1}/${parseInt(s,10)>>1}/${parseInt(i,10)>>1}/${parseInt(r,10)}`}var xt=m(31610),ft=m(12273),Ct=m(79139),ee=m(54290),Et=m(67347),Ot=(m(77031),m(4139));class se{constructor(t,s){this.sourceTile=s,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class ie{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function Ut(d,t,s,i,r,a){const h=s-r;if(h>=0)return(t>>h)+(i-(a<<h))*(d>>h);const c=-h;return t-(a-(i<<c))*(d>>c)<<c}class zt{constructor(t,s,i){this._rows=Math.ceil(s/i),this._columns=Math.ceil(t/i),this._cellSize=i,this.cells=new Array(this._rows);for(let r=0;r<this._rows;r++){this.cells[r]=new Array(this._columns);for(let a=0;a<this._columns;a++)this.cells[r][a]=[]}}getCell(t,s){const i=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(t,s,i,r){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function oe(d,t,s,i,r){const a=d.layerData.get(r);if(a.type===x.NP.SYMBOL){for(const h of i){const c=h.unique;let u;if(h.selectedForRendering){const p=c.parts[0],v=p.startOpacity,w=p.targetOpacity;d.allSymbolsFadingOut=d.allSymbolsFadingOut&&0===w;const I=s?Math.floor(127*v)|w<<7:w?255:0;u=I<<24|I<<16|I<<8|I}else u=0;for(const[p,v]of h.iconVertexRanges)for(let w=p;w<p+v;w+=4)a.iconOpacity[w/4]=u;if(h.selectedForRendering){const p=c.parts[1],v=p.startOpacity,w=p.targetOpacity;d.allSymbolsFadingOut=d.allSymbolsFadingOut&&0===w;const I=s?Math.floor(127*v)|w<<7:w?255:0;u=I<<24|I<<16|I<<8|I}else u=0;for(const[p,v]of h.textVertexRanges)for(let w=p;w<p+v;w+=4)a.textOpacity[w/4]=u}a.lastOpacityUpdate=t,a.opacityChanged=!0}}function le(d,t,s,i){const r=d.colliders;let a,h,c,u;for(const p of r)if(d.unique.show&&d.unique.parts[p.partIndex].show&&(a=p.xScreen-i[0]+p.dxScreen,h=p.yScreen-i[1]+p.dyScreen,c=a+p.width,u=h+p.height,(0,Ot.w4)(s,t.x,t.y,a,h,c,u)))return!0;return!1}var ct=m(32788),gt=m(45513);class bt{constructor(t,s){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let i=1;const r=new Uint32Array(t);this.layerUIDs=[];const a=r[i++];for(let h=0;h<a;h++)this.layerUIDs[h]=r[i++];this.bufferDataOffset=i,s&&(this.layer=s.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null)}}class ae extends bt{constructor(t,s){super(t,s),this.type=x.NP.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(t);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++];const a=i[r++];if(a>0){this.patternMap=new Map;for(let h=0;h<a;h++){const c=i[r++],u=i[r++],p=i[r++];this.patternMap.set(c,[u,p])}}this.bufferDataOffset=r}get memoryUsed(){var t,s,i,r;return(null!==(t=null===(s=this.data)||void 0===s?void 0:s.byteLength)&&void 0!==t?t:0)+(null!==(i=null===(r=this.vao)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,V.WD)(this.vao)}doPrepareForRendering(t,s,i){const r=new Uint32Array(s),a=new Int32Array(r.buffer),h=r[i++],c=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,h));i+=h;const u=r[i++],p=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,u));i+=u;const v=this.layer.lineMaterial;this.vao=new gt.Z(t,v.getAttributeLocations(),v.getLayoutInfo(),{geometry:c},p)}}class he extends bt{constructor(t,s){super(t,s),this.type=x.NP.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(t);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++];const a=i[r++];if(a>0){this.patternMap=new Map;for(let h=0;h<a;h++){const c=i[r++],u=i[r++],p=i[r++];this.patternMap.set(c,[u,p])}}this.bufferDataOffset=r}get memoryUsed(){var t,s,i,r,a,h;return(null!==(t=null===(s=this.data)||void 0===s?void 0:s.byteLength)&&void 0!==t?t:0)+(null!==(i=null===(r=this.fillVAO)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)+(null!==(a=null===(h=this.outlineVAO)||void 0===h?void 0:h.usedMemory)&&void 0!==a?a:0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,V.WD)(this.fillVAO),this.outlineVAO=(0,V.WD)(this.outlineVAO)}doPrepareForRendering(t,s,i){const r=new Uint32Array(s),a=new Int32Array(r.buffer),h=r[i++],c=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,h));i+=h;const u=r[i++],p=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,u));i+=u;const v=r[i++],w=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,v));i+=v;const I=r[i++],S=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,I));i+=I;const C=this.layer,E=C.fillMaterial,H=C.outlineMaterial;this.fillVAO=new gt.Z(t,E.getAttributeLocations(),E.getLayoutInfo(),{geometry:c},p),this.outlineVAO=new gt.Z(t,H.getAttributeLocations(),H.getLayoutInfo(),{geometry:w},S)}}class ce extends bt{constructor(t,s,i){super(t,s),this.type=x.NP.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(t),a=new Int32Array(t),h=new Float32Array(t);let c=this.bufferDataOffset;this.isIconSDF=!!r[c++];const u=r[c++],p=r[c++],v=r[c++],w=new N.A(u,p,v,0),I=r[c++];for(let H=0;H<I;H++){const B=r[c++],Z=r[c++],q=r[c++];this.iconPerPageElementsMap.set(B,[Z,q])}const S=r[c++];for(let H=0;H<S;H++){const B=r[c++],Z=r[c++],q=r[c++];this.glyphPerPageElementsMap.set(B,[Z,q])}const C=r[c++],E=r[c++];this.iconOpacity=new Int32Array(C),this.textOpacity=new Int32Array(E),c=function re(d,t,s,i,r,a,h){const c=t[i++];for(let u=0;u<c;u++){const p=new se(a,h);p.xTile=t[i++],p.yTile=t[i++],p.hash=t[i++],p.priority=t[i++],p.featureIndex=t[i++];const v=t[i++];for(let S=0;S<v;S++){const C=t[i++],E=t[i++],H=t[i++],B=t[i++],Z=!!t[i++],q=t[i++],nt=s[i++],ut=s[i++],rt=t[i++],ot=t[i++];p.colliders.push({xTile:C,yTile:E,dxPixels:H,dyPixels:B,hard:Z,partIndex:q,width:rt,height:ot,minLod:nt,maxLod:ut})}const w=d[i++];for(let S=0;S<w;S++)p.textVertexRanges.push([d[i++],d[i++]]);const I=d[i++];for(let S=0;S<I;S++)p.iconVertexRanges.push([d[i++],d[i++]]);r.push(p)}return i}(r,a,h,c,this.symbols,i,w),this.bufferDataOffset=c}get memoryUsed(){var t,s,i,r,a,h;return(null!==(t=null===(s=this.data)||void 0===s?void 0:s.byteLength)&&void 0!==t?t:0)+(null!==(i=null===(r=this.iconVAO)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)+(null!==(a=null===(h=this.textVAO)||void 0===h?void 0:h.usedMemory)&&void 0!==a?a:0)+(0,Ct.Ek)(this.iconOpacity)+(0,Ct.Ek)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[s,i]of this.iconPerPageElementsMap)t+=i[1];for(const[s,i]of this.glyphPerPageElementsMap)t+=i[1];return t/3}doDestroy(){this.iconVAO=(0,V.WD)(this.iconVAO),this.textVAO=(0,V.WD)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,s=this.iconVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===s.usedMemory&&s.setSubData(t,0,0,t.length);const i=this.textOpacity,r=this.textVAO.vertexBuffers.opacity;i.length>0&&i.byteLength===r.usedMemory&&r.setSubData(i,0,0,i.length)}doPrepareForRendering(t,s,i){const r=new Uint32Array(s),a=new Int32Array(r.buffer),h=r[i++],c=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,h));i+=h;const u=r[i++],p=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,u));i+=u;const v=r[i++],w=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,v));i+=v;const I=r[i++],S=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,I));i+=I;const C=ct.g.createVertex(t,A._U.STATIC_DRAW,this.iconOpacity.buffer),E=ct.g.createVertex(t,A._U.STATIC_DRAW,this.textOpacity.buffer),H=this.layer,B=H.iconMaterial,Z=H.textMaterial;this.iconVAO=new gt.Z(t,B.getAttributeLocations(),B.getLayoutInfo(),{geometry:c,opacity:C},p),this.textVAO=new gt.Z(t,Z.getAttributeLocations(),Z.getLayoutInfo(),{geometry:w,opacity:E},S)}}class ue extends bt{constructor(t,s){super(t,s),this.type=x.NP.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(t);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}get memoryUsed(){var t,s,i,r;return(null!==(t=null===(s=this.data)||void 0===s?void 0:s.byteLength)&&void 0!==t?t:0)+(null!==(i=null===(r=this.vao)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,V.WD)(this.vao)}doPrepareForRendering(t,s,i){const r=new Uint32Array(s),a=new Int32Array(r.buffer),h=r[i++],c=ct.g.createVertex(t,A._U.STATIC_DRAW,new Int32Array(a.buffer,4*i,h));i+=h;const u=r[i++],p=ct.g.createIndex(t,A._U.STATIC_DRAW,new Uint32Array(r.buffer,4*i,u));i+=u;const v=this.layer.circleMaterial;this.vao=new gt.Z(t,v.getAttributeLocations(),v.getLayoutInfo(),{geometry:c},p)}}var mt=m(24505),Vt=m(15442);class Dt extends Vt.Y{constructor(t,s,i,r,a,h,c,u=null){super(t,s,i,r,a,h,4096,4096),this.styleRepository=c,this._memCache=u,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this._referenced=1,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<mt.zk}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<mt.zk)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){var s,i;let r=!1;for(const a of t){const h=this.layerData.get(a);h&&(this._memoryUsedByLayerData-=h.memoryUsed,h.type===x.NP.SYMBOL&&this.symbols.delete(a)&&(r=!0),h.destroy(),this.layerData.delete(a))}null!==(s=this._memCache)&&void 0!==s&&s.updateSize(this.key.id,this,this._memoryUsedByLayerData),r&&(null!==(i=this.featureIndex)&&void 0!==i&&i.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(this.featureIndex=null,Bt.delete(this),Dt._destroyRenderBuckets(this.layerData),this.layerData.clear(),this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get usedMemory(){return this._memoryUsedByLayerData+256}changeDataImpl(t){var s;null===(s=this.featureIndex)||void 0===s||s.clear();let i=!1;if(t){var r;const{bucketsWithData:a,emptyBuckets:h}=t,c=this._createRenderBuckets(a);if(h&&h.byteLength>0){const u=new Uint32Array(h);for(const p of u)this._deleteLayerData(p)}for(const[u,p]of c)this._deleteLayerData(u),p.type===x.NP.SYMBOL&&(this.symbols.set(u,p.symbols),i=!0),this._memoryUsedByLayerData+=p.memoryUsed,this.layerData.set(u,p);null===(r=this._memCache)||void 0===r||r.updateSize(this.key.id,this,this.usedMemory)}this._hasSymbolBuckets=!1;for(const[a,h]of this.layerData)h.type===x.NP.SYMBOL&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(s){s.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);const s=this.resolution/(t.resolution*t.pixelRatio),i=this.width/this.rangeX*s,r=this.height/this.rangeY*s,a=[0,0];t.toScreen(a,[this.x,this.y]);const h=this.transforms.tileUnitsToPixels;(0,xt.D_)(h),(0,xt.Tl)(h,h,a),(0,xt.e$)(h,h,Math.PI*t.rotation/180),(0,xt.hs)(h,h,[i,r,1])}_createTransforms(){return{displayViewScreenMat3:(0,ft.vt)(),tileMat3:(0,ft.vt)(),tileUnitsToPixels:(0,ft.vt)()}}static _destroyRenderBuckets(t){if(!t)return;const s=new Set;for(const i of t.values())s.has(i)||(i.destroy(),s.add(i));t.clear()}_createRenderBuckets(t){const s=new Map,i=new Map;for(const r of t){const a=this._deserializeBucket(r,i);for(const h of a.layerUIDs)s.set(h,a)}return s}_deserializeBucket(t,s){let i=s.get(t);if(i)return i;switch(new Uint32Array(t)[0]){case x.NP.FILL:i=new he(t,this.styleRepository);break;case x.NP.LINE:i=new ae(t,this.styleRepository);break;case x.NP.SYMBOL:i=new ce(t,this.styleRepository,this);break;case x.NP.CIRCLE:i=new ue(t,this.styleRepository)}return s.set(t,i),i}_deleteLayerData(t){if(!this.layerData.has(t))return;const s=this.layerData.get(t);this._memoryUsedByLayerData-=s.memoryUsed,s.destroy(),this.layerData.delete(t)}}const Bt=new Map;var kt=m(11333),de=m(54029),it=m(54e3);function _e(d,t,s,i,r,a){const{iconRotationAlignment:h,textRotationAlignment:c,iconTranslate:u,iconTranslateAnchor:p,textTranslate:v,textTranslateAnchor:w}=i;let I=0;for(const S of d.colliders){const[C,E]=0===S.partIndex?u:v,H=0===S.partIndex?p:w,B=S.minLod<=a&&a<=S.maxLod;I+=B?0:1,S.enabled=B,S.xScreen=S.xTile*r[0]+S.yTile*r[3]+r[6],S.yScreen=S.xTile*r[1]+S.yTile*r[4]+r[7],H===it.Cq.MAP?(S.xScreen+=s*C-t*E,S.yScreen+=t*C+s*E):(S.xScreen+=C,S.yScreen+=E),it.I5.VIEWPORT===(0===S.partIndex?h:c)?(S.dxScreen=S.dxPixels,S.dyScreen=S.dyPixels):(S.dxScreen=s*(S.dxPixels+S.width/2)-t*(S.dyPixels+S.height/2)-S.width/2,S.dyScreen=t*(S.dxPixels+S.width/2)+s*(S.dyPixels+S.height/2)-S.height/2)}d.colliders.length>0&&I===d.colliders.length&&(d.unique.show=!1)}class ye{constructor(t,s,i,r,a,h){this._symbols=t,this._styleRepository=r,this._zoom=a,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new zt(s,i,mt.o2),this._si=Math.sin(Math.PI*h/180),this._co=Math.cos(Math.PI*h/180);for(const c of t)for(const u of c.symbols)this._allNeededMatrices.has(u.tile)||this._allNeededMatrices.set(u.tile,(0,ft.o8)(u.tile.transforms.tileUnitsToPixels))}work(t){const s=this._gridIndex;function i(a){const h=a.xScreen+a.dxScreen,c=a.yScreen+a.dyScreen,u=h+a.width,p=c+a.height,[v,w,I,S]=s.getCellSpan(h,c,u,p);for(let C=w;C<=S;C++)for(let E=v;E<=I;E++){const H=s.cells[C][E];for(const B of H){const Z=B.xScreen+B.dxScreen,q=B.yScreen+B.dyScreen;if(!(u<Z||h>Z+B.width||p<q||c>q+B.height))return!0}}return!1}const r=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const a=this._symbols[this._currentLayerCursor],h=this._getProperties(a.styleLayerUID);for(;this._currentSymbolCursor<a.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>t)return!1;const c=a.symbols[this._currentSymbolCursor];if(!c.unique.show)continue;_e(c,this._si,this._co,h,this._allNeededMatrices.get(c.tile),this._zoom);const u=c.unique;if(!u.show)continue;const{iconAllowOverlap:p,iconIgnorePlacement:v,textAllowOverlap:w,textIgnorePlacement:I}=h;for(const S of c.colliders){if(!S.enabled)continue;const C=u.parts[S.partIndex];C.show&&!(S.partIndex?w:p)&&i(S)&&(S.hard?u.show=!1:C.show=!1)}if(u.show)for(const S of c.colliders){if(!S.enabled||(S.partIndex?I:v)||!u.parts[S.partIndex].show)continue;const C=S.xScreen+S.dxScreen,E=S.yScreen+S.dyScreen,H=C+S.width,B=E+S.height,[Z,q,nt,ut]=this._gridIndex.getCellSpan(C,E,H,B);for(let rt=q;rt<=ut;rt++)for(let ot=Z;ot<=nt;ot++)this._gridIndex.cells[rt][ot].push(S)}}}return!0}_getProperties(t){const s=this._styleProps.get(t);if(s)return s;const i=this._zoom,r=this._styleRepository.getStyleLayerByUID(t),a=r.getLayoutValue("symbol-placement",i)!==it.kt.POINT;let h=r.getLayoutValue("icon-rotation-alignment",i);h===it.I5.AUTO&&(h=a?it.I5.MAP:it.I5.VIEWPORT);let c=r.getLayoutValue("text-rotation-alignment",i);c===it.I5.AUTO&&(c=a?it.I5.MAP:it.I5.VIEWPORT);const u=r.getPaintValue("icon-translate",i),p=r.getPaintValue("icon-translate-anchor",i),v=r.getPaintValue("text-translate",i),w=r.getPaintValue("text-translate-anchor",i),I={iconAllowOverlap:r.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:r.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:r.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:r.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:h,textRotationAlignment:c,iconTranslateAnchor:p,iconTranslate:u,textTranslateAnchor:w,textTranslate:v};return this._styleProps.set(t,I),I}}function pe(d,t){if(d.priority-t.priority)return d.priority-t.priority;const s=d.tile.key,i=t.tile.key;return s.world-i.world?s.world-i.world:s.level-i.level?s.level-i.level:s.row-i.row?s.row-i.row:s.col-i.col?s.col-i.col:d.xTile-t.xTile?d.xTile-t.xTile:d.yTile-t.yTile}class fe{get running(){return this._running}constructor(t,s,i,r,a,h){this._visibleTiles=t,this._symbolRepository=s,this._createCollisionJob=i,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=a,this._isLayerVisible=h,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(t,s){this._screenWidth===t&&this._screenHeight===s||this.restart(),this._screenWidth=t,this._screenHeight=s}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(t){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const s=performance.now();if(!this._selectionJob.work(t)||(this._selectionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const s=performance.now();if(!this._collisionJob.work(t)||(this._collisionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const s=performance.now();if(!this._opacityJob.work(t)||(this._opacityJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}return this._running=!1,!0}_createSelectionJob(){const t=this._symbolRepository.uniqueSymbols;for(let u=0;u<t.length;u++){const p=t[u];for(let v=0;v<p.uniqueSymbols.length;v++){const w=p.uniqueSymbols[v];for(const I of w.tileSymbols)I.selectedForRendering=!1}}const s=[];let i=0,r=0;const a=this._isLayerVisible,c=this._symbolLayerSorter;return{work:function h(u){let p;const v=performance.now();for(;r<t.length;r++,i=0){const w=t[r],I=w.styleLayerUID;if(!a(I)){s[r]||(s[r]={styleLayerUID:I,symbols:[]});continue}s[r]=s[r]||{styleLayerUID:I,symbols:[]};const S=s[r];for(;i<w.uniqueSymbols.length;i++){if(p=w.uniqueSymbols[i],i%100==99&&performance.now()-v>u)return!1;let C=null,E=!1,H=!1;for(const B of p.tileSymbols)if(!H||!E){const Z=B.tile;(!C||Z.isCoverage||Z.neededForCoverage&&!E)&&(C=B,(Z.neededForCoverage||Z.isCoverage)&&(H=!0),Z.isCoverage&&(E=!0))}if(C.selectedForRendering=!0,H){S.symbols.push(C),p.show=!0;for(const B of p.parts)B.show=!0}else p.show=!1}}for(const w of s)w.symbols.sort(pe);return!0},get sortedSymbols(){return s.sort(c)}}}_createOpacityJob(){const t=this._assignTileSymbolsOpacity,s=this._visibleTiles;let i=0;function r(a,h){const c=a.symbols;for(const[u,p]of c)ge(p,h);t(a,h);for(const u of a.childrenTiles)r(u,h)}return{work(a){const h=performance.now();for(;i<s.length;i++){if(performance.now()-h>a)return!1;const c=s[i];null==c.parentTile&&r(c,performance.now())}return!0}}}}function ge(d,t){for(const s of d){const i=s.unique;for(const r of i.parts)r.startOpacity+=(t-r.startTime)/mt.zk*(r.targetOpacity>.5?1:-1),r.startOpacity=Math.min(Math.max(r.startOpacity,0),1),r.startTime=t,r.targetOpacity=i.show&&r.show?1:0}}class be{constructor(t,s,i){this.tileCoordRange=t,this._visibleTiles=s,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(t,s){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(t.id);i||(i={symbols:new Map},this._tiles.set(t.id,i));const r=new Map;if(s)for(const c of s)i.symbols.has(c)&&(r.set(c,i.symbols.get(c)),i.symbols.delete(c));else for(const[c,u]of t.layerData)i.symbols.has(c)&&(r.set(c,i.symbols.get(c)),i.symbols.delete(c));this._removeSymbols(r);const a=t.symbols,h=new Map;for(const[c,u]of a){let p=u.length;if(p>=32){let v=this.tileCoordRange;do{v/=2,p/=4}while(p>8&&v>64);const w=new zt(this.tileCoordRange,this.tileCoordRange,v);h.set(c,{flat:u,index:w}),i.symbols.set(c,{flat:u,index:w});for(const I of u)w.getCell(I.xTile,I.yTile).push(I)}else h.set(c,{flat:u}),i.symbols.set(c,{flat:u})}this._addSymbols(t.key,a)}deleteStyleLayers(t){this._uniqueSymbolLayerArray=null;for(const[s,i]of this._tiles){const r=new Map;for(const a of t)i.symbols.has(a)&&(r.set(a,i.symbols.get(a)),i.symbols.delete(a));this._removeSymbols(r),0===i.symbols.size&&this._tiles.delete(s)}}removeTile(t){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(t.id);if(!s)return;const i=new Map;for(const[r,a]of t.symbols)s.symbols.has(r)&&(i.set(r,s.symbols.get(r)),s.symbols.delete(r));this._removeSymbols(i),0===s.symbols.size&&this._tiles.delete(t.id)}querySymbols(t,s,i,r){const a=[],h=this.uniqueSymbols;for(const c of h){const u=c.styleLayerUID,p=c.uniqueSymbols;for(const v of p){const w=v.tileSymbols.find(I=>I.selectedForRendering);w&&le(w,t,s*(window.devicePixelRatio||1),i)&&a.push({vtlSymbol:w,styleLayerUID:u,tileKey:w.tile.key})}}return a}_removeSymbols(t){for(const[s,{flat:i}]of t)for(const r of i){const a=r.unique,h=a.tileSymbols,c=h.length-1;for(let u=0;u<c;u++)if(h[u]===r){h[u]=h[c];break}if(h.length=c,0===c){const u=this._uniqueSymbolsReferences.get(s);u.delete(a),0===u.size&&this._uniqueSymbolsReferences.delete(s)}r.unique=null}}_addSymbols(t,s){if(0===s.size)return;const i=this._visibleTiles;for(const r of i)r.parentTile||r.key.world!==t.world||r.key.level===t.level&&!r.key.equals(t)||this._matchSymbols(r,t,s);for(const[r,a]of s)for(const h of a)if(null==h.unique){const c=this._createUnique();h.unique=c,c.tileSymbols.push(h);let u=this._uniqueSymbolsReferences.get(r);u||(u=new Set,this._uniqueSymbolsReferences.set(r,u)),u.add(c)}}_matchSymbols(t,s,i){if(t.key.level>s.level){const a=t.key.level-s.level;if(t.key.row>>a!==s.row||t.key.col>>a!==s.col)return}if(s.level>t.key.level){const a=s.level-t.key.level;if(s.row>>a!==t.key.row||s.col>>a!==t.key.col)return}if(s.equals(t.key)){for(const a of t.childrenTiles)this._matchSymbols(a,s,i);return}const r=new Map;for(const[a,h]of i){const c=[];for(const w of h){const I=Ut(this.tileCoordRange,w.xTile,s.level,s.col,t.key.level,t.key.col),S=Ut(this.tileCoordRange,w.yTile,s.level,s.row,t.key.level,t.key.row);I>=0&&I<this.tileCoordRange&&S>=0&&S<this.tileCoordRange&&c.push({symbol:w,xTransformed:I,yTransformed:S})}const u=[],p=t.key.level<s.level?1:1<<t.key.level-s.level,v=this._tiles.get(t.id).symbols.get(a);if(v){const w=v.flat;for(const I of c){let S,C=!1;const E=I.xTransformed,H=I.yTransformed;S=null!=v.index?v.index.getCell(E,H):w;const B=I.symbol,Z=B.hash;for(const q of S)if(Z===q.hash&&Math.abs(E-q.xTile)<=p&&Math.abs(H-q.yTile)<=p){const nt=q.unique;B.unique=nt,nt.tileSymbols.push(B),C=!0;break}C||u.push(B)}}u.length>0&&r.set(a,u)}for(const a of t.childrenTiles)this._matchSymbols(a,s,r)}_createUniqueSymbolLayerArray(){const t=this._uniqueSymbolsReferences,s=new Array(t.size);let i,r=0;for(const[a,h]of t){const c=new Array(h.size);i=0;for(const u of h)c[i++]=u;s[r]={styleLayerUID:a,uniqueSymbols:c},r++}return s}}class we{constructor(t,s){this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=(0,de.v)(!1),this._symbolRepository=new be(4096,s,()=>new ie),this._symbolDeclutterer=new fe(s,this._symbolRepository,(i,r,a)=>this._createCollisionJob(i,r,a),(i,r)=>{i.allSymbolsFadingOut=!0,i.lastOpacityUpdate=r,function ne(d,t,s){for(const[i,r]of d.symbols)oe(d,t,s,r,i)}(i,r,!0),i.decluttered=!0,i.requestRender()},(i,r)=>this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(r.styleLayerUID).z,i=>{const r=this.styleRepository.getStyleLayerByUID(i);if(this._zoom+1e-6<r.minzoom||this._zoom-1e-6>=r.maxzoom)return!1;const a=r.getLayoutProperty("visibility");return!a||a.getValue()!==it.bv.NONE})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(t,s,i){return this.updateDecluttererViewState(),new ye(t,s,i,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",()=>{this._symbolRepository.add(t),this.restartDeclutter()})),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const s=this._tileToHandle.get(t);s&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(t))}update(t,s){this._zoom=t,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]};const i=[0,0];s.toScreen(i,s.center);const r=[0,0];return s.toScreen(r,this._declutterViewState.center),this._offsetFromScreenCenter[0]=i[0]-r[0],this._offsetFromScreenCenter[1]=i[1]-r[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(t=>t.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(mt.av),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*mt.zk)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}var St=m(69473);class Ie extends Vt.Y{_createTransforms(){return{displayViewScreenMat3:(0,ft.vt)(),tileMat3:(0,ft.vt)()}}}var Ae=m(37188);const wt=1e-6;function Ht(d,t){if(d){const s=d.getLayoutProperty("visibility");if(!s||s.getValue()!==it.bv.NONE&&(void 0===d.minzoom||d.minzoom<t+wt)&&(void 0===d.maxzoom||d.maxzoom>=t-wt))return!0}return!1}class Me extends Ae.A{constructor(t){super(t),this._backgroundTiles=[],this._computeDisplayInfoView(t)}destroy(){var t,s;this.removeAllChildren(),null!==(t=this._spriteMosaic)&&void 0!==t&&t.dispose(),this._spriteMosaic=null,null!==(s=this._glyphMosaic)&&void 0!==s&&s.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){var t,s;return null!==(t=null===(s=this._symbolFader)||void 0===s?void 0:s.fading)&&void 0!==t&&t}get symbolFader(){return this._symbolFader}get symbolRepository(){var t;return null===(t=this._symbolFader)||void 0===t?void 0:t.symbolRepository}setStyleResources(t,s,i,r){this._spriteMosaic=t,this._glyphMosaic=s,this._styleRepository=i,this._tileInfoView=r,this._computeDisplayInfoView(r),null==this._symbolFader&&(this._symbolFader=new we(this._styleRepository,this.children)),this._symbolFader.styleRepository=i}setSpriteMosaic(t){var s;null!==(s=this._spriteMosaic)&&void 0!==s&&s.dispose(),this._spriteMosaic=t}deleteStyleLayers(t){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(t)}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==St.S5.MAP&&t.drawPhase!==St.S5.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),null!=this._symbolFader?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return null!=this._symbolFader&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:s}=t;s!==St.S5.DEBUG?this._doRender(t):super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const s=this.children[t];null!=this._symbolFader&&this._symbolFader.removeTile(s),s.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(t=>t.neededForCoverage&&t.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:s,state:i}=t,r=this._styleRepository;if(!r)return;const a=r.layers,h=this._displayInfo.scaleToZoom(i.scale);r.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,r.backgroundBucketIds,h)),super.renderChildren(t),t.drawPhase===St.S5.MAP&&this._fade(h,i);const c=this.children.filter(u=>u.visible&&u.hasData());if(!c||0===c.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const u of c)u.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(A.eA.KEEP,A.eA.KEEP,A.eA.REPLACE),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(A.MT.LEQUAL),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let u=a.length-1;u>=0;u--)this._renderStyleLayer(a[u],t,c);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(A.dn.ONE,A.dn.ONE_MINUS_SRC_ALPHA,A.dn.ONE,A.dn.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let u=0;u<a.length;u++)this._renderStyleLayer(a[u],t,c);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0);for(const u of c)u.debugInfo.display.triangleCount=u.triangleCount}_fade(t,s){null!=this._symbolFader&&(this._symbolFader.update(t,s)||this.requestRender())}_renderStyleLayer(t,s,i){const{displayLevel:r,painter:a,renderPass:h}=s;if(void 0===t)return;const c=t.getLayoutProperty("visibility");if(c&&c.getValue()===it.bv.NONE)return;let u;switch(t.type){case it.Dc.BACKGROUND:return;case it.Dc.FILL:if("opaque"!==h&&"translucent"!==s.renderPass)return;u="vtlFill";break;case it.Dc.LINE:if("translucent"!==h)return;u="vtlLine";break;case it.Dc.CIRCLE:if("translucent"!==h)return;u="vtlCircle";break;case it.Dc.SYMBOL:if("translucent"!==h)return;u="vtlSymbol"}if(i=i.filter(t.type===it.Dc.SYMBOL?v=>v.decluttered:v=>v.neededForCoverage),"vtlSymbol"!==u&&(0===i.length||void 0!==t.minzoom&&t.minzoom>=r+wt||void 0!==t.maxzoom&&t.maxzoom<r-wt))return;const p=t.uid;s.styleLayerUID=p,s.styleLayer=t;for(const v of i)if(v.layerData.has(p)){a.renderObjects(s,i,u);break}}_renderBackgroundLayers(t,s,i){const{context:r,painter:a,state:h}=t,c=this._styleRepository;let u=!1;for(const q of s)if(c.getLayerById(q).type===it.Dc.BACKGROUND&&Ht(c.getLayerById(q),i)){u=!0;break}if(!u)return;const p=this._tileInfoView,v=p.getTileCoverage(t.state,0,!0,"smallest"),{spans:w,lodInfo:I}=v,{level:S}=I,C=(0,l.vt)(),E=[];if(this._renderPasses){const q=this._renderPasses[0];null!=this._clippingInfos&&(q.brushes[0].prepareState(t),q.brushes[0].drawMany(t,this._clippingInfos))}const H=this._backgroundTiles;let B,Z=0;for(const{row:q,colFrom:nt,colTo:ut}of w)for(let rt=nt;rt<=ut;rt++){if(Z<H.length)B=H[Z],B.key.set(S,q,I.normalizeCol(rt),I.getWorldForColumn(rt)),p.getTileBounds(C,B.key,!1),B.x=C[0],B.y=C[3],B.resolution=p.getTileResolution(S);else{const ot=new N.A(S,q,I.normalizeCol(rt),I.getWorldForColumn(rt)),yt=p.getTileBounds((0,l.vt)(),ot),At=p.getTileResolution(S);B=new Ie(ot,At,yt[0],yt[3],512,512,4096,4096),H.push(B)}B.setTransform(h),E.push(B),Z++}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(A.eA.KEEP,A.eA.KEEP,A.eA.REPLACE),r.setStencilFunction(A.MT.EQUAL,0,255),r.setStencilTestEnabled(!0);for(const q of s){const nt=c.getLayerById(q);nt.type===it.Dc.BACKGROUND&&Ht(nt,i)&&(t.styleLayerUID=nt.uid,t.styleLayer=nt,a.renderObjects(t,E,"vtlBackground"))}pt.A.pool.release(v)}_computeDisplayInfoView(t){let s=t.tileInfo.lods[0].scale;const i=Math.max(25,t.tileInfo.lods.length),r=[];for(let a=0;a<=i;a++)r.push(s),s/=2;this._displayInfo=kt.A.create({scales:r,size:512,spatialReference:t.spatialReference,numLODs:i})}}var Wt=m(81098),Te=m(60797),De=m(3567),$t=m(20788),Nt=m(97944),Pe=m(53220);const Ce=(d,t)=>{const s=d.vtlSymbol.sourceTile,i=t.vtlSymbol.sourceTile;return s.level!==i.level?s.level-i.level:s.row!==i.row?s.row-i.row:s.col!==i.col?s.col-i.col:d.styleLayerUID-t.styleLayerUID};class Pt{constructor(t,s,i,r,a){this.tileKey=t,this._index=null,this._styleRepository=null,this._tileHandler=null,this._tileKeyToPBF=new Map,this._tileLayerData=s,this._styleRepository=i,this._tileHandler=r,this._parentLayer=a}static create(t,s,i,r,a){return new Pt(t,s,i,r,a)}clear(){var t;null!==(t=this._index)&&void 0!==t&&t.clear(),this._tileKeyToPBF.clear()}queryAttributes(t,s,i,r,a){var h=this;return(0,T.A)(function*(){if(0===h._tileLayerData.size||!h._styleRepository||!h._tileHandler)return[];null===h._index&&(h._index=new De.w(100,Ee),yield h._indexLayers());const c=[];return h._queryIndex(c,t,s,i,h.tileKey.level,r),a&&(null==a?void 0:a.length)>0&&(yield h._getSymbolsAttributes(c,a)),c})()}_indexLayers(){var t=this;return(0,T.A)(function*(){const s=t.tileKey,i=t._styleRepository.layers,r=yield t._getTilePayload(s);for(const[a,h]of t._tileLayerData){const c=i[a],u=r.find(w=>w.sourceName===c.source);if(!u)continue;const{protobuff:p,key:v}=u;if(h.type!==x.NP.SYMBOL){const w=1<<s.level-v.level;t._indexLayer(c,p,s.level,w,s.row-v.row*w,s.col-v.col*w)}}})()}_indexLayer(t,s,i,r,a,h){const c=t.sourceLayer,u=t.getFeatureFilter(),p=i,v=i+1,w=(0,Ot.IU)(p),I=new L.A(new Uint8Array(s),new DataView(s));for(;I.next();)switch(I.tag()){case 3:{const S=I.getMessage(),C=new Nt.A(S);if(S.release(),C.name!==c)continue;const E=C.getData(),H=C.extent/r,B=H*h-w,Z=H*a-w,q=B+H+2*w,nt=Z+H+2*w,ut=H/512,rt=4096/H,ot=H*h,yt=H*a;for(;E.nextTag(2);){const At=E.getMessage(),Mt=new $t.A(At,C);if(At.release(),u&&!u.filter(Mt,i))continue;const Jt=Mt.values||{},Yt=Jt._minzoom,qt=Jt._maxzoom;if(Yt&&Yt>=10*v||qt&&qt<=10*p)continue;const dt=t.getFeatureInflatedBounds(Mt,p,C.extent,ut);null==dt||dt[0]>q||dt[1]>nt||dt[2]<B||dt[3]<Z||(dt[0]=(dt[0]-ot)*rt,dt[1]=(dt[1]-yt)*rt,dt[2]=(dt[2]-ot)*rt,dt[3]=(dt[3]-yt)*rt,this._index.insert(new Pe.e4(t,Mt,dt,rt,ot,yt)))}break}default:I.skip()}}_getSymbolsAttributes(t,s){var i=this;return(0,T.A)(function*(){if(!s||0===s.length)return t;const r=[];s.sort(Ce);let a=s[0].styleLayerUID,h=0;for(let v=0;v<s.length;v++)a!==s[v].styleLayerUID&&(r.push({from:h,to:v,styleLayerUID:a,sourceTileKey:s[v].vtlSymbol.sourceTile}),h=v,a=s[v].styleLayerUID);r.push({from:h,to:s.length,styleLayerUID:a,sourceTileKey:s[s.length-1].vtlSymbol.sourceTile});const c=i._styleRepository.layers;let u,p=null;for(const v of r){const w=yield i._getTilePayload(v.sourceTileKey);u=c[v.styleLayerUID],p=!!u&&w.find(I=>I.sourceName===u.source),p&&i._addSymbolsAttributes(t,s.slice(v.from,v.to).map(I=>I.vtlSymbol),a,p)}return t})()}_addSymbolsAttributes(t,s,i,r){const a=this._styleRepository.layers,h=r.key,c=this.tileKey,u=1<<c.level-h.level;this._getSymbolAttributes(r.protobuff,s,i,u,c.row-h.row*u,c.col-h.col*u).forEach(w=>{const{attributes:I,tilePoint:S}=w;t.push({layerId:a[i].id,layerIndex:i,graphic:new Wt.A({attributes:I,origin:{type:"vector-tile",layerId:a[i].id,layerIndex:i,layer:this._parentLayer}}),tilePoint:S})})}_getSymbolAttributes(t,s,i,r,a,h){const c=[],u=this._styleRepository.layers;let p=0;s.sort((w,I)=>w.featureIndex-I.featureIndex);const v=new L.A(new Uint8Array(t),new DataView(t));for(;v.next();)switch(v.tag()){case 3:{const w=v.getMessage(),I=new Nt.A(w);if(w.release(),I.name!==u[i].sourceLayer)continue;const S=I.getData(),C=I.extent/r,E=4096/C,H=C*h,B=C*a;let Z=0;for(;S.nextTag(2);){const q=S.getMessage();if(Z++===s[p].featureIndex){const nt=new $t.A(q,I),ut=nt.values,rt=nt.getGeometry();c.push({attributes:ut,tilePoint:null!=rt?[E*(rt[0][0].x-H),E*(rt[0][0].y-B)]:null}),p++}if(q.release(),p===s.length)return c}break}default:v.skip()}return c}_queryIndex(t,s,i,r,a,h){var c;const u=8*r*(window.devicePixelRatio||1);return null!==(c=this._index)&&void 0!==c&&c.search({minX:s-u,minY:i-u,maxX:s+u,maxY:i+u},p=>{const{layer:v,feature:w}=p;v.isIntersectingFeature(s,i,r,w,a,h,p)&&t.push({layerId:v.id,layerIndex:v.uid,tilePoint:null,graphic:new Wt.A({attributes:w.values,origin:{type:"vector-tile",layerId:p.layer.id,layerIndex:p.layer.uid,layer:this._parentLayer}})})}),t}_getTilePayload(t){var s=this;return(0,T.A)(function*(){return(0,Te.tE)(s._tileKeyToPBF,t.id,()=>s._tileHandler.fetchTilePBFs(t)).then(i=>i)})()}}const Ee=d=>({minX:d.bounds[0],minY:d.bounds[1],maxX:d.bounds[2],maxY:d.bounds[3]});var Kt=m(6517),Oe=m(29459);class Gt extends ee.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const s=N.A.pool.acquire(t),i=0===s.level?null:N.A.getId(s.level-1,s.row>>1,s.col>>1,s.world);return N.A.pool.release(s),i}getTileCoverage(t,s,i=!0,r){const a=super.getTileCoverage(t,s,i,r);if(!a)return a;const h=1<<a.lodInfo.level;return a.spans=a.spans.filter(c=>c.row>=0&&c.row<h),a}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const s=this._fullCacheLodInfos;if(t>s[0].scale)return s[0].level;let i,r;for(let a=0;a<s.length-1;a++)if(r=s[a+1],t>r.scale)return i=s[a],i.level+(i.scale-t)/(i.scale-r.scale);return s[s.length-1].level}}_initializeFullCacheLODs(t){let s;s=0===t[0].level?t.map(i=>({level:i.level,resolution:i.resolution,scale:i.scale})):kt.A.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map(a=>({level:a.level,resolution:a.resolution,scale:a.scale}));for(let i=0;i<s.length;i++)this._levelByScale[s[i].scale]=s[i].level;this._fullCacheLodInfos=s}}var Ue=m(41474);let It=class extends((0,Oe.e)(Ue.A)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1}get fading(){var d,t;return null!==(d=null===(t=this._vectorTileContainer)||void 0===t?void 0:t.fading)&&void 0!==d&&d}hitTest(d,t){var s=this;return(0,T.A)(function*(){var i,r,a;const h=s._tileHandlerPromise,c=null===(i=s._vectorTileContainer)||void 0===i?void 0:i.symbolFader;if(!h||!s._isTileHandlerReady||!c)return;yield h;let u=null;const p=null===(r=s._vectorTileContainer)||void 0===r?void 0:r.symbolRepository;p&&(u=p.querySymbols(t,2,c.decluttererOffset,{}));const w=s._tileManager.getIntersectingTiles(t.x,t.y,2,s.view.state,u);if((!w||0===w.length)&&0===(null===(a=u)||void 0===a?void 0:a.length))return null;d=d.clone().normalize();const I=[],S=[];for(const E of w){var C;I.push(s._queryTile(S,d,2,s.view.state.rotation,E,null===(C=u)||void 0===C?void 0:C.filter(H=>H.tileKey.id===E.id)))}return yield Promise.all(I),S})()}update(d){if(this._tileHandlerPromise&&this._isTileHandlerReady)return d.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=d.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=d.state,this._parseQueue.state=d.state,this._tileManager.update(d)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:d}=this.layer.currentStyleInfo;this._styleRepository=new Kt.A(d),this._tileInfoView=new Gt(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Me(this._tileInfoView),this._tileHandler=new st(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",t=>{if(t.isDataDriven)this._styleChanges.push({type:x.$q.PAINTER_CHANGED,data:t}),this.requestUpdate();else{var s,i;const r=this._styleRepository,a=r.getLayerById(t.layer);if(!a)return;const h=a.type===it.Dc.SYMBOL;r.setPaintProperties(t.layer,t.paint),h&&null!==(s=this._vectorTileContainer)&&void 0!==s&&s.restartDeclutter(),null===(i=this._vectorTileContainer)||void 0===i||i.requestRender()}}),this.layer.on("layout-change",t=>{const s=this._styleRepository,i=s.getLayerById(t.layer);if(!i)return;const r=(0,_.Ui)(i.layout,t.layout);if(null!=r){var a,h;if((0,_.EB)(r,"visibility")&&1===function ze(d){if(null==d)return 0;switch(d.type){case"partial":return Object.keys(d.diff).length;case"complete":return Math.max(Object.keys(d.oldValue).length,Object.keys(d.newValue).length);case"collection":return Object.keys(d.added).length+Object.keys(d.changed).length+Object.keys(d.removed).length}}(r))return s.setLayoutProperties(t.layer,t.layout),i.type===it.Dc.SYMBOL&&null!==(a=this._vectorTileContainer)&&void 0!==a&&a.restartDeclutter(),void(null===(h=this._vectorTileContainer)||void 0===h||h.requestRender());this._styleChanges.push({type:x.$q.LAYOUT_CHANGED,data:t}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",t=>{var s,i;const r=this._styleRepository,a=r.getLayerById(t.layer);a&&(r.setStyleLayerVisibility(t.layer,t.visibility),a.type===it.Dc.SYMBOL&&null!==(s=this._vectorTileContainer)&&void 0!==s&&s.restartDeclutter(),null===(i=this._vectorTileContainer)||void 0===i||i.requestRender())}),this.layer.on("style-layer-change",t=>{this._styleChanges.push({type:x.$q.LAYER_CHANGED,data:t}),this.requestUpdate()}),this.layer.on("delete-style-layer",t=>{this._styleChanges.push({type:x.$q.LAYER_REMOVED,data:t}),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",t=>{this._styleChanges.push({type:x.$q.SPRITES_CHANGED,data:t});const s=this._styleRepository.layers;for(const i of s)switch(i.type){case it.Dc.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:x.$q.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case it.Dc.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:x.$q.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case it.Dc.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:x.$q.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,V.pR)(this._vectorTileContainer),this._tileHandler=(0,V.pR)(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(d){var t;return(0,y.aI)(null===(t=this.layer.tileInfo)||void 0===t?void 0:t.spatialReference,d)}canResume(){let d=super.canResume();const{currentStyleInfo:t}=this.layer;if(d&&null!=t&&t.layerDefinition){const s=this.view.scale,{minScale:i,maxScale:r}=t.layerDefinition;null!=t&&t.layerDefinition&&(i&&i<s&&(d=!1),r&&r>s&&(d=!1))}return d}isUpdating(){return this.fading}acquireTile(d){const t=this._createVectorTile(d);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(s=>this._parseQueue.push({key:t.key,data:s})).then(s=>{t.once("attach",()=>this.requestUpdate()),t.setData(s),this.requestUpdate()}).catch(s=>{(0,$.zf)(s)||O.A.getLogger(this).error(s)})),t}releaseTile(d){const t=d.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new Lt({acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const d=new AbortController,t=this._tileHandler.start({signal:d.signal}).then(()=>{this._fetchQueue=new Et.A({tileInfoView:this._tileInfoView,process:(s,i)=>this._getTileData(s,i),concurrency:15}),this._parseQueue=new Et.A({tileInfoView:this._tileInfoView,process:(s,i)=>this._parseTileData(s,i),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(s=>{this._vectorTileContainer.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=d,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const d=this._tileHandlerAbortController;d&&d.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,V.pR)(this._fetchQueue),this._parseQueue=(0,V.pR)(this._parseQueue),this._tileManager=(0,V.pR)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(d,t){var s=this;return(0,T.A)(function*(){return s._tileHandler.fetchTileData(d,t)})()}_parseTileData(d,t){var s=this;return(0,T.A)(function*(){return s._tileHandler.parseTileData(d,t)})()}_applyStyleChanges(){var d=this;return(0,T.A)(function*(){d._isTileHandlerReady=!1,d._fetchQueue.pause(),d._parseQueue.pause(),d._fetchQueue.clear(),d._parseQueue.clear(),d._tileManager.clearCache();const t=d._styleChanges;try{yield d._tileHandler.updateStyle(t)}catch(h){O.A.getLogger(d).error("error applying vector-tiles style update",h.message),d._fetchQueue.resume(),d._parseQueue.resume(),d._isTileHandlerReady=!0}const s=d._styleRepository,i=new Set;t.forEach(h=>{if(h.type!==x.$q.LAYER_REMOVED)return;const u=s.getLayerById(h.data.layer);u&&i.add(u.uid)});const r=new Set;t.forEach(h=>{let c;switch(h.type){case x.$q.PAINTER_CHANGED:s.setPaintProperties(h.data.layer,h.data.paint),c=h.data.layer;break;case x.$q.LAYOUT_CHANGED:s.setLayoutProperties(h.data.layer,h.data.layout),c=h.data.layer;break;case x.$q.LAYER_REMOVED:return void s.deleteStyleLayer(h.data.layer);case x.$q.LAYER_CHANGED:s.setStyleLayer(h.data.layer,h.data.index),c=h.data.layer.id;break;case x.$q.SPRITES_CHANGED:d._vectorTileContainer.setSpriteMosaic(d._tileHandler.setSpriteSource(h.data.spriteSource))}if(c){const u=s.getLayerById(c);u&&r.add(u.uid)}});const a=d._vectorTileContainer.children;if(i.size>0){const h=Array.from(i);d._vectorTileContainer.deleteStyleLayers(h);for(const c of a)c.deleteLayerData(h)}if(d._fetchQueue.resume(),d._parseQueue.resume(),r.size>0){const h=Array.from(r),c=[];for(const u of a){const p=d._updatingHandles.addPromise(d._fetchQueue.push(u.key).then(v=>d._parseQueue.push({key:u.key,data:v,styleLayerUIDs:h})).then(v=>u.setData(v)));c.push(p)}yield Promise.all(c)}d._styleChanges=[],d._isTileHandlerReady=!0,d.requestUpdate()})()}_loadStyle(){var d=this;return(0,T.A)(function*(){const{style:t}=d.layer.currentStyleInfo,s=(0,k.o8)(t);d._isTileHandlerReady=!1,d._fetchQueue.pause(),d._parseQueue.pause(),d._fetchQueue.clear(),d._parseQueue.clear(),d._styleRepository=new Kt.A(s),d._vectorTileContainer.destroy(),d._tileManager.clear(),d._tileHandlerAbortController.abort(),d._tileHandlerAbortController=new AbortController;const{signal:i}=d._tileHandlerAbortController;try{d._tileHandlerPromise=d._tileHandler.setStyle(d._styleRepository,s,d.layer.tileInfo.lods.length-1),yield d._tileHandlerPromise}catch(h){if(!(0,$.zf)(h))throw h}if(i.aborted)return d._fetchQueue.resume(),d._parseQueue.resume(),d._isTileHandlerReady=!0,void d.requestUpdate();const r=yield d._tileHandler.spriteMosaic,a=d._vectorTileContainer;d._tileInfoView=new Gt(d.layer.tileInfo,d.layer.fullExtent),a.setStyleResources(r,d._tileHandler.glyphMosaic,d._styleRepository,d._tileInfoView),d._tileManager=new Lt({acquireTile:h=>d.acquireTile(h),releaseTile:h=>d.releaseTile(h),tileInfoView:d._tileInfoView},d._vectorTileContainer),d._fetchQueue.resume(),d._parseQueue.resume(),d._isTileHandlerReady=!0,d.requestUpdate()})()}_createVectorTile(d){const t=this._tileInfoView.getTileBounds((0,l.vt)(),d),s=this._tileInfoView.getTileResolution(d.level);return new Dt(d,s,t[0],t[3],512,512,this._styleRepository)}_queryTile(d,t,s,i,r,a){var h=this;return(0,T.A)(function*(){if(0===r.layerData.size)return;const c=h._ensureTileIndex(r),u=h._tileInfoView.getTileBounds((0,l.vt)(),r.key,!0),p=(t.x-u[0])/(u[2]-u[0])*4096,v=4096*(1-(t.y-u[1])/(u[3]-u[1])),w=yield c.queryAttributes(p,v,s,i,a);for(const I of w)I.graphic.geometry=h._tileToMapPoint(I.tilePoint,r.transforms.tileUnitsToPixels),d.push({type:"graphic",layer:h.layer,graphic:I.graphic,mapPoint:t.clone()});d.sort((I,S)=>S.graphic.origin.layerIndex-I.graphic.origin.layerIndex)})()}_tileToMapPoint(d,t){if(!d)return null;const r=this.view.state,a=[0,0];return r.toMap(a,[d[0]*t[0]+d[1]*t[3]+t[6],d[0]*t[1]+d[1]*t[4]+t[7]]),new o.A({x:a[0],y:a[1],spatialReference:r.spatialReference})}_ensureTileIndex(d){let t=d.featureIndex;return t||(t=Pt.create(d.key,d.layerData,this._styleRepository,this._tileHandler,this.layer),d.featureIndex=t),t}};(0,W._)([(0,tt.MZ)()],It.prototype,"_isTileHandlerReady",void 0),It=(0,W._)([(0,f.$)("esri.views.2d.layers.VectorTileLayerView2D")],It);const Ve=It},41474:(lt,X,m)=>{m.d(X,{A:()=>x});var T=m(8189),W=m(98877),k=m(42425),O=m(3046),V=m(35150),$=m(11432),tt=m(64261),U=m(85211),o=(m(3248),m(40707),m(76576)),l=m(56985);let y=class extends((0,O.sA)((0,tt.g)(k.A.EventedMixin(W.A)))){constructor(g){super(g),this._updatingHandles=new l.U,this.layer=null,this.parent=null}initialize(){this.when().catch(g=>{if("layerview:create-error"!==g.name){var M;const D=this.layer&&this.layer.id||"no id",b=(null===(M=this.layer)||void 0===M?void 0:M.title)||"no title";V.A.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${b}', id: '${D}')`,g)}})}destroy(){this._updatingHandles=(0,$.pR)(this._updatingHandles)}get fullOpacity(){var g,M,D,b;return(null!==(g=null===(M=this.layer)||void 0===M?void 0:M.opacity)&&void 0!==g?g:1)*(null!==(D=null===(b=this.parent)||void 0===b?void 0:b.fullOpacity)&&void 0!==D?D:1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){var g;return!this.suspended&&!0===(null===(g=this.layer)||void 0===g?void 0:g.legendEnabled)}get updating(){var g;return!!(null!==(g=this._updatingHandles)&&void 0!==g&&g.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var g;return!0===(null===(g=this.layer)||void 0===g?void 0:g.visible)}set visible(g){this._overrideIfSome("visible",g)}canResume(){var g,M,D;return this.visible&&(null===(g=this.layer)||void 0===g?void 0:g.loaded)&&!(null!==(M=this.parent)&&void 0!==M&&M.suspended)&&(null===(D=this.view)||void 0===D?void 0:D.ready)||!1}getSuspendInfo(){var g,M;const D=null!==(g=this.parent)&&void 0!==g&&g.suspended?this.parent.suspendInfo:{};return null!==(M=this.view)&&void 0!==M&&M.ready||(D.viewNotReady=!0),this.layer&&this.layer.loaded||(D.layerNotLoaded=!0),this.visible||(D.layerInvisible=!0),D}isUpdating(){return!1}};(0,T._)([(0,U.MZ)()],y.prototype,"fullOpacity",null),(0,T._)([(0,U.MZ)()],y.prototype,"layer",void 0),(0,T._)([(0,U.MZ)()],y.prototype,"parent",void 0),(0,T._)([(0,U.MZ)({readOnly:!0})],y.prototype,"suspended",null),(0,T._)([(0,U.MZ)({readOnly:!0})],y.prototype,"suspendInfo",null),(0,T._)([(0,U.MZ)({readOnly:!0})],y.prototype,"legendEnabled",null),(0,T._)([(0,U.MZ)({type:Boolean,readOnly:!0})],y.prototype,"updating",null),(0,T._)([(0,U.MZ)({readOnly:!0})],y.prototype,"updatingProgress",null),(0,T._)([(0,U.MZ)()],y.prototype,"visible",null),(0,T._)([(0,U.MZ)()],y.prototype,"view",void 0),y=(0,T._)([(0,o.$)("esri.views.layers.LayerView")],y);const x=y},66727:(lt,X,m)=>{m.d(X,{A:()=>f});var T=m(8189),W=m(71065),k=m(85211),tt=(m(3248),m(35150),m(40707),m(76576));let U=class extends W.oY{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,T._)([(0,k.MZ)({readOnly:!0})],U.prototype,"version",null),U=(0,T._)([(0,tt.$)("esri.views.layers.support.ClipArea")],U);const f=U},75644:(lt,X,m)=>{m.d(X,{A:()=>M});var y,T=m(8189),k=(m(21152),m(85211)),tt=(m(3248),m(35150),m(40707),m(76576)),U=m(68643),f=m(61320),_=m(66727),o=m(28067),l=m(55861);const x={base:U.A,key:"type",typeMap:{extent:o.A,polygon:l.A}};let g=y=class extends _.A{constructor(D){super(D),this.type="geometry",this.geometry=null}clone(){var D,b;return new y({geometry:null!==(D=null===(b=this.geometry)||void 0===b?void 0:b.clone())&&void 0!==D?D:null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,T._)([(0,k.MZ)({types:x,json:{read:f.rS,write:!0}})],g.prototype,"geometry",void 0),g=y=(0,T._)([(0,tt.$)("esri.views.layers.support.Geometry")],g);const M=g}}]);