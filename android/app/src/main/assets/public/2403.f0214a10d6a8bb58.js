"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2403],{22403:(Ve,K,p)=>{p.r(K),p.d(K,{uploadAssets:()=>Te});var u=p(10467),f=p(89563),$=p(3248),oe=p(35150),c=p(56492),x=p(82595),m=p(45272),ae=p(43085),A=p(33019),g=p(63758);const b={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};var ie=p(68438),le=p(17715),ue=p(60797);function T(s,t=(n=>{}),e){return new pe(s,t,e)}class pe{constructor(t,e=(r=>{}),n){if(this.onProgress=e,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof t){this._weights={};for(let r=0;r<t;r++){const o=r;this._weights[o]=1/t,this._progressMap.set(o,0)}}else this._weights=t;this.emitProgress()}emitProgress(){let t=0;for(const[r,o]of this._progressMap.entries())t+=o*this._weights[r];if(1===t&&(0,$.A)("enable-feature:esri-3dofl-upload-timings")){var e;const r=Math.round(performance.now()-(null!==(e=this._startTime)&&void 0!==e?e:0))/1e3;console.log(`${this.taskName} done in ${r} sec`);for(const[o,a]of this._timingsMap){var n;const i=Math.round(a.end-a.start)/1e3,l=Math.round(i/r*100);console.log(null!==(n=this.taskName)&&void 0!==n?n:"Task",{stepKey:o,stepTime:i,relativeTime:l})}}this.onProgress(t)}setProgress(t,e){if(this._progressMap.set(t,e),(0,$.A)("enable-feature:esri-3dofl-upload-timings")){var n;const r=performance.now();null!==(n=this._startTime)&&void 0!==n||(this._startTime=r);const o=(0,ue.tE)(this._timingsMap,t,()=>({start:r,end:0}));1===e&&(o.end=r)}this.emitProgress()}simulate(t,e){return J(n=>this.setProgress(t,n),e)}makeOnProgress(t){return e=>this.setProgress(t,e)}}function J(s=(e=>{}),t=he){const e=performance.now();s(0);const n=setInterval(()=>{const r=performance.now()-e,o=1-Math.exp(-r/t);s(o)},ge);return(0,le.hA)(()=>{clearInterval(n),s(1)})}function ce(s,t=fe){return(0,x.gr)((0,x.Kp)(s*Q/t))}const fe=10,me=10,Q=8e-6,ge=(0,x.l5)(50),he=(0,x.l5)(1e3),k=1e6,Y=20*k,ye=2e9,ve=3;function E(){return E=(0,u.A)(function*({data:s,name:t,description:e},n,r){let o=null;try{const a=(0,m.fj)(n,"uploads"),i=(0,m.fj)(a,"info"),{data:l}=yield(0,f.A)(i,{query:{f:"json"},responseType:"json"});(0,c.Te)(r);const h=(0,ie.Wo)(n),d=l.maxUploadFileSize*k,v=h?ye:d,G=h?Math.min(Y,d):Y;if(s.size>v)throw new Error("Data too large");const We=(0,m.fj)(a,"register"),{data:ee}=yield(0,f.A)(We,{query:{f:"json",itemName:Ae(t),description:e},responseType:"json",method:"post"});if((0,c.Te)(r),!ee.success)throw new Error("Registration failed");const{itemID:Ge}=ee.item;o=(0,m.fj)(a,Ge);const Ke=(0,m.fj)(o,"uploadPart"),te=Math.ceil(s.size/G),j=new Array;for(let y=0;y<te;++y)j.push(s.slice(y*G,Math.min((y+1)*G,s.size)));const M=j.slice().reverse(),se=new Array,$e=T(te,null==r?void 0:r.onProgress,"uploadItem"),Je=function(){var y=(0,u.A)(function*(){for(;0!==M.length;){const P=j.length-M.length,re=M.pop(),F=new FormData,ke=$e.simulate(P,ce(re.size));try{F.append("f","json"),F.append("file",re),F.append("partId",`${P}`);const{data:Ye}=yield(0,f.A)(Ke,{timeout:0,body:F,responseType:"json",method:"post"});if((0,c.Te)(r),!Ye.success)throw new Error("Part upload failed")}finally{ke.remove()}}});return function(){return y.apply(this,arguments)}}();for(let y=0;y<ve&&0!==M.length;++y)se.push(Je());yield Promise.all(se);const Qe=(0,m.fj)(o,"commit"),{data:ne}=yield(0,f.A)(Qe,{query:{f:"json",parts:j.map((y,P)=>P).join(",")},responseType:"json",method:"post"});if((0,c.Te)(r),!ne.success)throw new Error("Commit failed");return ne.item}catch(a){if(null!=o){const i=(0,m.fj)(o,"delete");yield(0,f.A)(i,{query:{f:"json"},responseType:"json",method:"post"})}throw a}}),E.apply(this,arguments)}function Ae(s){return s.replaceAll("/","_").replaceAll("\\","_")}var w=p(6829);function Te(s,t,e){return U.apply(this,arguments)}function U(){return U=(0,u.A)(function*(s,t,e){var n;const r=s.length;if(!r)return null!=e&&null!==(n=e.onProgress)&&void 0!==n&&n.call(e,1),[];const o=T(r,null==e?void 0:e.onProgress,"uploadAssets");return Promise.all(s.map((a,i)=>function Pe(s,t,e){return S.apply(this,arguments)}(a,t,{...e,onProgress:o.makeOnProgress(i)})))}),U.apply(this,arguments)}function S(){return S=(0,u.A)(function*(s,{layer:t,ongoingUploads:e},n){var r;const o=e.get(s);if(o)return o;if(!function Le(s){return!!s.infoFor3D&&!!s.url}(t))throw new g.Wt;if(function we(s,t){const{parsedUrl:e}=t;return null!=e&&s.metadata.externalSources.some(n=>(0,A.eN)(n,e))}(s,t))return null!=n&&null!==(r=n.onProgress)&&void 0!==r&&r.call(n,1),s;const a=function je(s,t,e){return I.apply(this,arguments)}(s,t,n);e.set(s,a);try{yield a}finally{e.delete(s)}return s}),S.apply(this,arguments)}function I(){return I=(0,u.A)(function*(s,t,e){const{metadata:n}=s,{displaySource:r}=n,o=V(null==r?void 0:r.source,t),i=n.externalSources.length>0,l=o?function Me(s,t,e){return N.apply(this,arguments)}(o,t,e):i?function Fe(s,t,e){return _.apply(this,arguments)}(s,t,e):function be(s,t,e){return B.apply(this,arguments)}(s,t,e),h=yield l;return(0,c.Te)(e),s.addExternalSources([h]),s}),I.apply(this,arguments)}function N(){return(N=(0,u.A)(function*(s,t,e){return{source:yield X(s,t,e),original:!0}})).apply(this,arguments)}function _(){return(_=(0,u.A)(function*(s,t,e){const n=q(t),{externalSources:r}=s.metadata,o=function Ue(s,t){for(const e of s){const n=V(e.source,t);if(n)return n}return null}(r,t);if(!o)throw new g.xY;const a=T(b.uploadConvertibleSource,null==e?void 0:e.onProgress,"uploadConvertibleSource"),i=yield X(o,t,{onProgress:a.makeOnProgress("uploadEditSource")});s.addExternalSources([{source:i,original:!0}]);const l=o.reduce((d,{asset:v})=>v instanceof File?d+v.size:d,0),h=a.simulate("serviceAssetsToGlb",function de(s,t=me){return(0,x.gr)((0,x.Kp)(s*Q/t))}(l));try{return{source:yield Ce(i,t,n)}}finally{h.remove()}})).apply(this,arguments)}function B(){return B=(0,u.A)(function*(s,t,e){const n=T(b.uploadLocalMesh,null==e?void 0:e.onProgress,"uploadLocalMesh"),r=function Ee(s,t,e){return D.apply(this,arguments)}(s,t,{...e,onProgress:n.makeOnProgress("meshToAssetBlob")});return{source:yield Z([r],t,{...e,onProgress:n.makeOnProgress("uploadAssetBlobs")}),extent:s.extent.clone(),original:!0}}),B.apply(this,arguments)}function D(){return(D=(0,u.A)(function*(s,t,e){const n=q(t),r=yield s.load(e),o=yield r.toBinaryGLTF({ignoreLocalTransform:!0});(0,c.Te)(e);const a=yield o.buffer();return(0,c.Te)(e),{blob:new Blob([a.data],{type:a.type}),assetName:`${(0,ae.yS)()}.glb`,assetType:n}})).apply(this,arguments)}function V(s,t){if(!s)return null;const{infoFor3D:{supportedFormats:e,editFormats:n}}=t,r=(0,A.WN)(s),o=new Array;let a=!1;for(let i=0;i<r.length;++i){const l=Se(r[i],e);if(!l)return null;n.includes(l.assetType)&&(a=!0),o.push(l)}return a?o:null}function Se(s,t){const e=(0,A.fH)(s,t);return e?{asset:s,assetType:e}:null}function X(s,t,e){return C.apply(this,arguments)}function C(){return C=(0,u.A)(function*(s,t,e){return Z(s.map(n=>function Ie(s,t){return R.apply(this,arguments)}(n,e)),t,e)}),C.apply(this,arguments)}function Z(s,t,e){return O.apply(this,arguments)}function O(){return O=(0,u.A)(function*(s,t,e){const n=T(b.uploadAssetBlobs,null==e?void 0:e.onProgress,"uploadAssetBlobs"),r=yield function _e(s,t,e){const n=T(s.length,null==e?void 0:e.onProgress,"prepareAssetItems");return Promise.all(s.map(function(){var r=(0,u.A)(function*(o,a){const i=function Ne(s,t,e){return L.apply(this,arguments)}(yield o,t,{...e,onProgress:n.makeOnProgress(a)});return(0,c.Te)(e),i});return function(o,a){return r.apply(this,arguments)}}()))}(s,t,{...e,onProgress:n.makeOnProgress("prepareAssetItems")});(0,c.Te)(e);const o=r.map(({item:i})=>i),{uploadResults:a}=yield function Be(s,t,e){return z.apply(this,arguments)}(o,t,{...e,onProgress:n.makeOnProgress("uploadAssetItems")});return(0,c.Te)(e),s.map((i,l)=>function De(s,t,e){const{success:n}=t;if(!n){const{error:h}=t;throw new g.hK(s.assetName,h)}const{assetHash:r}=t,{assetName:o,item:{assetType:a}}=s,{infoFor3D:{supportedFormats:i}}=e,l=(0,w.Fm)(a,i);if(!l)throw new g.H2(a);return new A.Qp(o,l,[new A.Bq(`${e.parsedUrl.path}/assets/${r}`,r)])}(r[l],a[l],t))}),O.apply(this,arguments)}function R(){return(R=(0,u.A)(function*(s,t){const{asset:e,assetType:n}=s;if(e instanceof File)return{blob:e,assetName:e.name,assetType:n};const r=yield e.toBlob(t);return(0,c.Te)(t),{blob:r,assetName:e.assetName,assetType:n}})).apply(this,arguments)}function L(){return L=(0,u.A)(function*(s,t,e){const{blob:n,assetType:r,assetName:o}=s;let a=null;try{const i=yield function xe(s,t,e){return E.apply(this,arguments)}({data:n,name:o},t.url,e);(0,c.Te)(e),a={assetType:r,assetUploadId:i.itemID}}catch(i){(0,c.QP)(i),function ze(){return oe.A.getLogger("esri.layers.graphics.sources.support.uploadAssets")}().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!a){const i=yield(0,m._0)(n);if((0,c.Te)(e),!i.isBase64)throw new g.$1;a={assetType:r,assetData:i.data}}if(!a)throw new g.WF;return{item:a,assetName:o}}),L.apply(this,arguments)}function z(){return(z=(0,u.A)(function*(s,t,e){const n=J(null==e?void 0:e.onProgress);try{const r=yield(0,f.A)((0,m.fj)(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(s)},method:"post",responseType:"json"});if((0,c.Te)(e),r.data.uploadResults.length!==s.length)throw new g.nS(s.length,r.data.uploadResults.length);return r.data}finally{n.remove()}})).apply(this,arguments)}function Ce(s,t,e){return H.apply(this,arguments)}function H(){return(H=(0,u.A)(function*(s,t,e){var n;const r=s.map(({assetName:d,parts:v})=>({assetName:d,assetHash:v[0].partHash})),o=null===(n=t.capabilities)||void 0===n?void 0:n.operations.supportsAsyncConvert3D,a={f:"json",assets:JSON.stringify(r),transportType:"esriTransportTypeUrl",targetFormat:e,async:o},i=(0,m.fj)(t.parsedUrl.path,"convert3D");let l;try{l=(yield(o?Re:Oe)(i,{query:a,responseType:"json",timeout:0})).data}catch{throw new g.MT}const{supportedFormats:h}=t.infoFor3D;return l.assets.map(d=>{const v=(0,w.R_)(d.contentType,h);if(!v)throw new g.H2(v);return new A.Qp(d.assetName,d.contentType,[new A.Bq(d.assetURL,d.assetHash)])})})).apply(this,arguments)}function Oe(s,t){return(0,f.A)(s,t)}function Re(s,t){return W.apply(this,arguments)}function W(){return(W=(0,u.A)(function*(s,t){const e=(yield(0,f.A)(s,t)).data.statusUrl;for(;;){const n=(yield(0,f.A)(e,{query:{f:"json"},responseType:"json"})).data;switch(n.status){case"Completed":return(0,f.A)(n.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(n.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield(0,c.Pl)(He)}})).apply(this,arguments)}function q(s){var t;const{infoFor3D:e}=s,n=null!==(t=(0,w.R_)("model/gltf-binary",e.supportedFormats))&&void 0!==t?t:(0,w.E1)("glb",e.supportedFormats);if(!n)throw new g.uh;return n}const He=(0,x.l5)(1e3)}}]);