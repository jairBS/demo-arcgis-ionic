"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[652],{15590:(qe,N,f)=>{f.d(N,{A:()=>_});class _{constructor(x){this.size=0,this._start=0,this.maxSize=x,this._buffer=new Array(x)}get entries(){return this._buffer}enqueue(x){if(this.size===this.maxSize){const y=this._buffer[this._start];return this._buffer[this._start]=x,this._start=(this._start+1)%this.maxSize,y}return this._buffer[(this._start+this.size++)%this.maxSize]=x,null}dequeue(){if(0===this.size)return null;const x=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,x}peek(){return 0===this.size?null:this._buffer[this._start]}find(x){if(0===this.size)return null;for(const y of this._buffer)if(null!=y&&x(y))return y;return null}clear(x){let y=this.dequeue();for(;null!=y;)x&&x(y),y=this.dequeue()}}},65374:(qe,N,f)=>{var _,R,x,y,Q,m,q,D,Z,Se,ce,xe,Ye,He,F,Ae,Y,Ce,$,K,Fe,je,he,_e,ee,Te,we,te,ne,ae,fe,ge,Me,ke,Oe,pe,Pe,Ne,W,j,ye,se,me,oe,X,ve,ue,le,Ie,We,Re,Ze,Ee,de,H,G,Xe,De,T,z,be,i;f.d(N,{$2:()=>Q,C1:()=>x,JO:()=>R,M1:()=>je,O$:()=>Xe,Q1:()=>ve,TZ:()=>Ae,WE:()=>te,Y:()=>q,YI:()=>le,bj:()=>D,e_:()=>X,f0:()=>G,fu:()=>ce,g7:()=>Z,ip:()=>ue,mU:()=>ne,oF:()=>K,uQ:()=>Fe,uT:()=>pe,vG:()=>T,wd:()=>j,xR:()=>_,xn:()=>Y,xw:()=>ee,yS:()=>Pe}),(i=_||(_={}))[i.BUTT=0]="BUTT",i[i.ROUND=1]="ROUND",i[i.SQUARE=2]="SQUARE",i[i.UNKNOWN=4]="UNKNOWN",function(i){i[i.BEVEL=0]="BEVEL",i[i.ROUND=1]="ROUND",i[i.MITER=2]="MITER",i[i.UNKNOWN=4]="UNKNOWN"}(R||(R={})),function(i){i[i.SCREEN=0]="SCREEN",i[i.MAP=1]="MAP"}(x||(x={})),function(i){i[i.Tint=0]="Tint",i[i.Ignore=1]="Ignore",i[i.Multiply=99]="Multiply"}(y||(y={})),function(i){i.Both="Both",i.JustBegin="JustBegin",i.JustEnd="JustEnd",i.None="None"}(Q||(Q={})),function(i){i[i.Mosaic=0]="Mosaic",i[i.Centered=1]="Centered"}(m||(m={})),function(i){i[i.Normal=0]="Normal",i[i.Superscript=1]="Superscript",i[i.Subscript=2]="Subscript"}(q||(q={})),function(i){i[i.MSSymbol=0]="MSSymbol",i[i.Unicode=1]="Unicode"}(D||(D={})),function(i){i[i.Unspecified=0]="Unspecified",i[i.TrueType=1]="TrueType",i[i.PSOpenType=2]="PSOpenType",i[i.TTOpenType=3]="TTOpenType",i[i.Type1=4]="Type1"}(Z||(Z={})),function(i){i[i.Display=0]="Display",i[i.Map=1]="Map"}(Se||(Se={})),function(i){i.None="None",i.Loop="Loop",i.Oscillate="Oscillate"}(ce||(ce={})),function(i){i[i.Z=0]="Z",i[i.X=1]="X",i[i.Y=2]="Y"}(xe||(xe={})),function(i){i[i.XYZ=0]="XYZ",i[i.ZXY=1]="ZXY",i[i.YXZ=2]="YXZ"}(Ye||(Ye={})),function(i){i[i.Rectangle=0]="Rectangle",i[i.RoundedRectangle=1]="RoundedRectangle",i[i.Oval=2]="Oval"}(He||(He={})),function(i){i[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.Screen=2]="Screen",i[i.Multiply=3]="Multiply",i[i.Add=4]="Add"}(F||(F={})),function(i){i[i.TTB=0]="TTB",i[i.RTL=1]="RTL",i[i.BTT=2]="BTT"}(Ae||(Ae={})),function(i){i[i.None=0]="None",i[i.SignPost=1]="SignPost",i[i.FaceNearPlane=2]="FaceNearPlane"}(Y||(Y={})),function(i){i[i.Float=0]="Float",i[i.String=1]="String",i[i.Boolean=2]="Boolean"}(Ce||(Ce={})),function(i){i[i.Intersect=0]="Intersect",i[i.Subtract=1]="Subtract"}($||($={})),function(i){i.OpenEnded="OpenEnded",i.Block="Block",i.Crossed="Crossed"}(K||(K={})),function(i){i.FullGeometry="FullGeometry",i.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",i.ReversedFirstSegment="ReversedFirstSegment",i.PerpendicularToSecondSegment="PerpendicularToSecondSegment",i.SecondSegmentWithTicks="SecondSegmentWithTicks",i.DoublePerpendicular="DoublePerpendicular",i.OppositeToFirstSegment="OppositeToFirstSegment",i.TriplePerpendicular="TriplePerpendicular",i.HalfCircleFirstSegment="HalfCircleFirstSegment",i.HalfCircleSecondSegment="HalfCircleSecondSegment",i.HalfCircleExtended="HalfCircleExtended",i.OpenCircle="OpenCircle",i.CoverageEdgesWithTicks="CoverageEdgesWithTicks",i.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",i.GapExtentMidline="GapExtentMidline",i.Chevron="Chevron",i.PerpendicularWithArc="PerpendicularWithArc",i.ClosedHalfCircle="ClosedHalfCircle",i.TripleParallelExtended="TripleParallelExtended",i.ParallelWithTicks="ParallelWithTicks",i.Parallel="Parallel",i.PerpendicularToFirstSegment="PerpendicularToFirstSegment",i.ParallelOffset="ParallelOffset",i.OffsetOpposite="OffsetOpposite",i.OffsetSame="OffsetSame",i.CircleWithArc="CircleWithArc",i.DoubleJog="DoubleJog",i.PerpendicularOffset="PerpendicularOffset",i.LineExcludingLastSegment="LineExcludingLastSegment",i.MultivertexArrow="MultivertexArrow",i.CrossedArrow="CrossedArrow",i.ChevronArrow="ChevronArrow",i.ChevronArrowOffset="ChevronArrowOffset",i.PartialFirstSegment="PartialFirstSegment",i.Arch="Arch",i.CurvedParallelTicks="CurvedParallelTicks",i.Arc90Degrees="Arc90Degrees"}(Fe||(Fe={})),function(i){i.Mitered="Mitered",i.Bevelled="Bevelled",i.Rounded="Rounded",i.Square="Square",i.TrueBuffer="TrueBuffer"}(je||(je={})),function(i){i.ClosePath="ClosePath",i.ConvexHull="ConvexHull",i.RectangularBox="RectangularBox"}(he||(he={})),function(i){i.BeginningOfLine="BeginningOfLine",i.EndOfLine="EndOfLine"}(_e||(_e={})),function(i){i.Mitered="Mitered",i.Bevelled="Bevelled",i.Rounded="Rounded",i.Square="Square"}(ee||(ee={})),function(i){i.Fast="Fast",i.Accurate="Accurate"}(Te||(Te={})),function(i){i.BeginningOfLine="BeginningOfLine",i.EndOfLine="EndOfLine"}(we||(we={})),function(i){i.Sinus="Sinus",i.Square="Square",i.Triangle="Triangle",i.Random="Random"}(te||(te={})),function(i){i[i.None=0]="None",i[i.Default=1]="Default",i[i.Force=2]="Force"}(ne||(ne={})),function(i){i[i.Buffered=0]="Buffered",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.AlongLine=3]="AlongLine"}(ae||(ae={})),function(i){i[i.Linear=0]="Linear",i[i.Rectangular=1]="Rectangular",i[i.Circular=2]="Circular",i[i.Buffered=3]="Buffered"}(fe||(fe={})),function(i){i[i.Discrete=0]="Discrete",i[i.Continuous=1]="Continuous"}(ge||(ge={})),function(i){i[i.AcrossLine=0]="AcrossLine",i[i.AloneLine=1]="AloneLine"}(Me||(Me={})),function(i){i[i.Left=0]="Left",i[i.Right=1]="Right",i[i.Center=2]="Center",i[i.Justify=3]="Justify"}(ke||(ke={})),function(i){i[i.Base=0]="Base",i[i.MidPoint=1]="MidPoint",i[i.ThreePoint=2]="ThreePoint",i[i.FourPoint=3]="FourPoint",i[i.Underline=4]="Underline",i[i.CircularCW=5]="CircularCW",i[i.CircularCCW=6]="CircularCCW"}(Oe||(Oe={})),function(i){i.Butt="Butt",i.Round="Round",i.Square="Square"}(pe||(pe={})),function(i){i.NoConstraint="NoConstraint",i.HalfPattern="HalfPattern",i.HalfGap="HalfGap",i.FullPattern="FullPattern",i.FullGap="FullGap",i.Custom="Custom"}(Pe||(Pe={})),function(i){i[i.None=-1]="None",i[i.Custom=0]="Custom",i[i.Circle=1]="Circle",i[i.OpenArrow=2]="OpenArrow",i[i.ClosedArrow=3]="ClosedArrow",i[i.Diamond=4]="Diamond"}(Ne||(Ne={})),function(i){i[i.ExtraLeading=0]="ExtraLeading",i[i.Multiple=1]="Multiple",i[i.Exact=2]="Exact"}(W||(W={})),function(i){i.Bevel="Bevel",i.Round="Round",i.Miter="Miter"}(j||(j={})),function(i){i[i.Default=0]="Default",i[i.String=1]="String",i[i.Numeric=2]="Numeric"}(ye||(ye={})),function(i){i[i.InsidePolygon=0]="InsidePolygon",i[i.PolygonCenter=1]="PolygonCenter",i[i.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(se||(se={})),function(i){i[i.Tint=0]="Tint",i[i.Replace=1]="Replace",i[i.Multiply=2]="Multiply"}(me||(me={})),function(i){i[i.ClipAtBoundary=0]="ClipAtBoundary",i[i.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",i[i.DoNotTouchBoundary=2]="DoNotTouchBoundary",i[i.DoNotClip=3]="DoNotClip"}(oe||(oe={})),function(i){i.NoConstraint="NoConstraint",i.WithMarkers="WithMarkers",i.WithFullGap="WithFullGap",i.WithHalfGap="WithHalfGap",i.Custom="Custom"}(X||(X={})),function(i){i.Fixed="Fixed",i.Random="Random",i.RandomFixedQuantity="RandomFixedQuantity"}(ve||(ve={})),function(i){i.LineMiddle="LineMiddle",i.LineBeginning="LineBeginning",i.LineEnd="LineEnd",i.SegmentMidpoint="SegmentMidpoint"}(ue||(ue={})),function(i){i.OnPolygon="OnPolygon",i.CenterOfMass="CenterOfMass",i.BoundingBoxCenter="BoundingBoxCenter"}(le||(le={})),function(i){i[i.Low=0]="Low",i[i.Medium=1]="Medium",i[i.High=2]="High"}(Ie||(Ie={})),function(i){i[i.MarkerCenter=0]="MarkerCenter",i[i.MarkerBounds=1]="MarkerBounds"}(We||(We={})),function(i){i[i.None=0]="None",i[i.PropUniform=1]="PropUniform",i[i.PropNonuniform=2]="PropNonuniform",i[i.DifUniform=3]="DifUniform",i[i.DifNonuniform=4]="DifNonuniform"}(Re||(Re={})),function(i){i.Tube="Tube",i.Strip="Strip",i.Wall="Wall"}(Ze||(Ze={})),function(i){i[i.Random=0]="Random",i[i.Increasing=1]="Increasing",i[i.Decreasing=2]="Decreasing",i[i.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(Ee||(Ee={})),function(i){i[i.Relative=0]="Relative",i[i.Absolute=1]="Absolute"}(de||(de={})),function(i){i[i.Normal=0]="Normal",i[i.LowerCase=1]="LowerCase",i[i.Allcaps=2]="Allcaps"}(H||(H={})),function(i){i[i.LTR=0]="LTR",i[i.RTL=1]="RTL"}(G||(G={})),function(i){i.Draft="Draft",i.Picture="Picture",i.Text="Text"}(Xe||(Xe={})),function(i){i[i.Top=0]="Top",i[i.Center=1]="Center",i[i.Baseline=2]="Baseline",i[i.Bottom=3]="Bottom"}(De||(De={})),function(i){i[i.Right=0]="Right",i[i.Upright=1]="Upright"}(T||(T={})),function(i){i[i.Small=0]="Small",i[i.Medium=1]="Medium",i[i.Large=2]="Large"}(z||(z={})),function(i){i[i.Calm=0]="Calm",i[i.Rippled=1]="Rippled",i[i.Slight=2]="Slight",i[i.Moderate=3]="Moderate"}(be||(be={}))},25735:(qe,N,f)=>{f.d(N,{$r:()=>y,M$:()=>Q,mF:()=>x});var _=f(68677),R=f(60746);const x={selection:m=>new R.A({color:new _.A([m.color.r/2,m.color.g/2,m.color.b/2,m.color.a])}),highlight:m=>m,popup:m=>new R.A({color:new _.A([m.color.g,m.color.b,m.color.r,m.color.a])})};function y(m){if(!m)return 0;let q=1;for(const D in x){if(D===m)break;q<<=1}return q}const Q=Object.keys(x)},47669:(qe,N,f)=>{f.d(N,{$U:()=>Ie,C2:()=>ee,CQ:()=>m,CR:()=>W,C_:()=>Re,Cp:()=>j,DY:()=>Ae,Gh:()=>ue,LY:()=>oe,O5:()=>ht,Pq:()=>te,Qb:()=>ct,Sr:()=>Pe,TB:()=>At,Tv:()=>Se,Vl:()=>et,Xh:()=>xt,YS:()=>ae,YV:()=>ce,_j:()=>de,_x:()=>Ke,bg:()=>Z,c5:()=>le,dV:()=>se,eG:()=>_e,eI:()=>k,fq:()=>z,g0:()=>X,hM:()=>Ee,ju:()=>He,lL:()=>ke,mg:()=>We,n9:()=>pe,nM:()=>Me,nW:()=>H,qM:()=>x,r1:()=>Je,sn:()=>Oe,uM:()=>fe,ue:()=>ne,vN:()=>ye,vd:()=>Ne,yv:()=>be,z2:()=>ge});const x=1e-30,m=512,Z=128,Se=511,ce=16777216,He=8,Ae=29,_e=24,ee=4,te=0,ne=0,ae=0,fe=1,ge=2,Me=3,ke=4,Oe=5,pe=6,Pe=12,Ne=5,W=6,j=5,ye=6;var se,U;(U=se||(se={}))[U.FilterFlags=0]="FilterFlags",U[U.Animation=1]="Animation",U[U.GPGPU=2]="GPGPU",U[U.VV=3]="VV",U[U.DD0=4]="DD0",U[U.DD1=5]="DD1",U[U.DD2=6]="DD2";const oe=8,X=oe<<1,ue=1.05,le=1,Ie=5,We=6,Re=1.15,Ee=2,de=128-2*Ee,H=2,z=10,be=1024,ct=128,Je=4,ht=1,Ke=1<<20,k=.75,xt=10,et=.75,At=256},92917:(qe,N,f)=>{f.r(N),f.d(N,{default:()=>dr});var _=f(10467),R=f(5922),x=f(17715),y=f(3248),Q=f(64662),m=f(56492),q=f(40707),D=f(48900),Z=f(67685),Se=f(11333),ce=f(54290),xe=f(74847),F=(f(67347),f(77031),f(47669));class Ae{constructor(e){this._client=e,this.layerView=this._client.createInvokeProxy("",{ignoreConnectionErrors:!0}),this.container=this._client.createInvokeProxy("container",{ignoreConnectionErrors:!0}),this.eventLog=this._client.createInvokeProxy("eventLog",{ignoreConnectionErrors:!0})}}var Y=f(19495),Ce=f(11432),$=f(48237),K=f(32034),Fe=f(6690),je=f(36952);function fe(l){switch(l){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case 128:return 1}}function ge(l){switch(l){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case 128:return 1}}class Pe{constructor(e,t,s,r=0){this.tileKey=e,this._bufferingEnabled=t,this._sizeHint=r,this._meshes={self:new Fe.U(this.id,this._sizeHint),neighbors:new Array},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0,this._copyBufferedDataIntoSelf=s&&this._bufferingEnabled&&0===e.level}get id(){return this.tileKey.id}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(e){this._meshes.self.indexEnsureSize(e)}entityStart(e,t=e){this._currentEntityOverlaps=0,this._meshes.self.entityStart(e,t)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let e=0;e<8;e++)this._currentEntityOverlaps&1<<e&&this._meshes.neighbors[e].entityEnd()}}recordStart(e,t,s){this._currentRecordOverlaps=0,this._meshes.self.recordStart(e,t,s)}recordEnd(e=0){const t=this._meshes.self.recordEnd(this._currentRecordOverlaps);return t&&0!==this._currentRecordOverlaps?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):t}recordBounds(e,t,s,r){this._bufferingEnabled&&this._addOverlap(e,t,s,r)}recordCount(){return this._meshes.self.recordCount()}metricStart(e){this._meshes.self.metricStart(e)}metricBoxWrite(e){this._meshes.self.metricBoxWrite(e)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(e){this._meshes.self.vertexWrite(e)}vertexWriteF32(e){this._meshes.self.vertexWriteF32(e)}vertexWriteRegion(e){this._meshes.self.vertexWriteRegion(e)}indexWrite(e){this._meshes.self.indexWrite(e)}serialize(e){const t={message:[],transferList:[]},s=this._meshes.self.serialize();return t.message.push({tileId:this.tileKey.id,...s.message}),t.transferList.push(...s.transferList),this._meshes.neighbors.forEach((r,n)=>{const a=r.serialize(),o=1<<n,u=fe(o),c=ge(o),d=(0,je.K)(new xe.A(this.tileKey),u,c,e);t.message.push({tileId:d.id,...a.message}),t.transferList.push(...a.transferList)}),t}_addOverlap(e,t,s,r){const n=Math.min(F.CQ/2,s),a=Math.min(F.CQ/2,r);this._currentRecordOverlaps|=255^((e<0+n?148:e>=F.CQ-n?41:189)|(t<0+a?224:t>=F.CQ-a?7:231))}_copyIntoNeighbors(){for(let e=0;e<8;e++){const t=1<<e;if(this._currentRecordOverlaps&t){if(this._copyBufferedDataIntoSelf){const a=-fe(t)*F.CQ,o=-ge(t)*F.CQ;this._meshes.self.copyLast(a,o);continue}if(!this._meshes.neighbors[e]){const a=Math.floor(this._sizeHint/16);this._meshes.neighbors[e]=new Fe.U(t,a)}const s=this._meshes.neighbors[e],r=-fe(t)*F.CQ,n=-ge(t)*F.CQ;s.copyLastFrom(this._meshes.self,r,n)}}}}class Ne{}var W=f(77190);class j{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static from(e,t,s,r){return(0,_.A)(function*(){const n=new j;return n.setDefault(yield(0,W.PZ)(e,t,s.meshes,r)),n})()}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(e){this._backgroundFillResult=e}match(e,t){const s=this.doMatch(e,t)||this.getDefault();if(s&&s.length>0){const r=this.getBackgroundFill();if(r)return[...r,...s]}return s}getSortKey(e,t){return 0}doMatch(e,t){return null}fetchResources(e,t){return(0,_.A)(function*(){})()}}class ye extends j{static fromDictionaryRenderer(e,t,s){return(0,_.A)(function*(){return new ye(e,t,s)})()}constructor(e,t,s){super(),this._storage=e,this._schema=t,this._viewParams=s,this._hashToGroup=new Map}get fieldMap(){return this._schema.fieldMap}fetchResources(e,t){var s=this;return(0,_.A)(function*(){const r=t.getCursor(),n=[];for(;r.next();)n.push(s._updateMeshWriterGroup(e,r));yield Promise.all(n)})()}match(e,t){const s=e.getAttributeHash();return this._hashToGroup.get(s)}_updateMeshWriterGroup(e,t){var s=this;return(0,_.A)(function*(){const r=t.readLegacyFeatureForDisplay(),n=t.getAttributeHash();if(s._hashToGroup.has(n))return;s._hashToGroup.set(n,null);const a=yield e.fetchDictionaryResourceImmediate({type:"dictionary-request",feature:r});if(!a)return;const o=yield(0,W.PZ)(s._storage,e,a.meshes,s._viewParams);s._hashToGroup.set(n,o)})()}}class se extends j{constructor(e,t){super(),this._intervals=[],this._isMaxInclusive=t,this._field=e}static fromIntervalSchema(e,t,s,r){return(0,_.A)(function*(){const n=yield e.createComputedField(s),a=new se(n,s.isMaxInclusive);yield Promise.all(s.intervals.map(function(){var c=(0,_.A)(function*(d){const h=yield(0,W.PZ)(e,t,d.meshes,r);a.add(d,h)});return function(d){return c.apply(this,arguments)}}()));const o=yield(0,W.PZ)(e,t,s.defaultSymbol,r);a.setDefault(o);const u=yield(0,W.PZ)(e,t,s.backgroundFill,r);return a.setBackgroundFill(u),a})()}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((s,r)=>s.interval.min-r.interval.min)}size(){return super.size()+this._intervals.length}doMatch(e,t){var s;const r=null===(s=this._field)||void 0===s?void 0:s.read(e,t);if(null==r||isNaN(r)||r===1/0||r===-1/0)return null;for(let n=0;n<this._intervals.length;n++){const{interval:a,result:o}=this._intervals[n];if(r>=a.min&&(this._isMaxInclusive?r<=a.max:r<a.max))return o}return null}}class me extends j{static fromLabelSchema(e,t,s,r){return(0,_.A)(function*(){const n=s.classes.map(function(){var o=(0,_.A)(function*(u){const c=yield(0,W.PZ)(e,t,u.meshes,r);return{minScale:u.minScale,maxScale:u.maxScale,meshes:c,expression:null,where:yield e.createWhereClause(u.where)}});return function(u){return o.apply(this,arguments)}}()),a=yield Promise.all(n);return new me(a)})()}constructor(e){super(),this._labels=e}match(e,t){if(!this._labels.length)return null;const s=this._getLabels(t.$view.scale),r=[];for(const n of s)n.where&&!n.where(e)||r.push(...n.meshes);return r}_getLabels(e){return this._labels.filter(t=>this._validForTileScale(t,e))}_validForTileScale(e,t){return(!e.minScale||e.minScale>=t-t/4)&&(!e.maxScale||e.maxScale<=t+t/2)}}class oe extends j{constructor(e,t){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=e,this._separator=t||""}static fromMatcherSchema(e,t,s,r){return(0,_.A)(function*(){const n=s.expression?[e.createComputedField({expression:s.expression})]:[s.field?e.createComputedField({field:s.field}):null,s.field2?e.createComputedField({field:s.field2}):null,s.field3?e.createComputedField({field:s.field3}):null],a=(yield Promise.all(n)).filter(d=>!!d),o=new oe(a,s.fieldDelimiter),u=yield(0,W.PZ)(e,t,s.defaultSymbol,r);o.setDefault(u);const c=yield(0,W.PZ)(e,t,s.backgroundFill,r);return o.setBackgroundFill(c),yield Promise.all(s.map.map(function(){var d=(0,_.A)(function*(h,g){const v=yield(0,W.PZ)(e,t,h.symbol,r);"<Null>"===h.value?o.setNullResult(v):o.add(h.value,v,g+1)});return function(h,g){return d.apply(this,arguments)}}())),o})()}setNullResult(e){this._nullResult=e}getSortKey(e,t){const s=this._getValueFromFields(e,t);if(null==s||""===s||"<Null>"===s)return 0;const r=this._resultsMap.get(s.toString());return r?r.sortKey:this._defaultSymbolSortKey}add(e,t,s){this._resultsMap.set(e.toString(),{meshWriters:t,sortKey:s}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,s+1)}size(){return super.size()+this._resultsMap.size}doMatch(e,t){var s;const r=this._getValueFromFields(e,t);if(null!==this._nullResult&&(null==r||""===r||"<Null>"===r))return this._nullResult;if(null==r)return null;const n=r.toString();return null===(s=this._resultsMap.get(n))||void 0===s?void 0:s.meshWriters}_getValueFromFields(e,t){const s=[];for(const r of this._fields){const n=r.read(e,t);s.push(null==n||""===n?"<Null>":n)}return s.join(this._separator)}}function X(l,e,t,s){return ve.apply(this,arguments)}function ve(){return(ve=(0,_.A)(function*(l,e,t,s){switch(t.type){case"simple":case"heatmap":case"dot-density":case"pie-chart":return j.from(l,e,t,s);case"interval":return se.fromIntervalSchema(l,e,t,s);case"dictionary":return ye.fromDictionaryRenderer(l,t,s);case"label":return me.fromLabelSchema(l,e,t,s);case"map":return oe.fromMatcherSchema(l,e,t,s);case"subtype":return ue.fromSubtypes(l,e,t,s);case"cluster":return le.fromClusterSchema(l,e,t,s);default:throw new Error("Impl")}})).apply(this,arguments)}class ue extends j{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static fromSubtypes(e,t,s,r){return(0,_.A)(function*(){const n=new Map,a=[];for(const o in s.renderers){const u=parseInt(o,10),c=X(e,t,s.renderers[o],r).then(d=>n.set(u,d));a.push(c)}return yield Promise.all(a),new ue(n,s.subtypeField)})()}match(e,t){const s=e.readAttribute(this._subtypeField),r=this._subMatchers.get(s);return r?r.match(e,t):null}}class le extends j{static fromClusterSchema(e,t,s,r){return(0,_.A)(function*(){const[n,a]=yield Promise.all([X(e,t,s.feature,r),X(e,t,s.cluster,r)]);return new le(n,a)})()}constructor(e,t){super(),this._featureMatcher=e,this._clusterMatcher=t}match(e,t){return 1===e.readAttribute("cluster_count")?this._featureMatcher.match(e,t):this._clusterMatcher.match(e,t)}}class Ie extends Ne{static create(e,t,s,r){return(0,_.A)(function*(){const n=yield X(e,t,s.symbology,r),a=s.labels?yield X(e,t,s.labels,r):null;return new Ie(n,a)})()}constructor(e,t){super(),this._symbology=e,this._labels=t}destroy(){}enqueueMatcherRequests(e,t){var s=this;return(0,_.A)(function*(){var r;yield Promise.all([s._symbology.fetchResources(e,t),null===(r=s._labels)||void 0===r?void 0:r.fetchResources(e,t)])})()}enqueueWriterRequests(e,t,s){const r=this._symbology.match(t,s);if(r){for(const n of r)n.enqueueRequest(e,t,s);if(this._labels){const n=this._labels.match(t,s);if(!n)return;for(const a of n)a.enqueueRequest(e,t,s)}}}write(e,t,s,r,n){const a=this._symbology.match(s,r);if(a){for(const o of a)o.write(e,t,s,r,n);if(e.entityRecordCount()>=1&&this._labels){const o=this._labels.match(s,r);if(!o)return;for(const u of o)u.setReferences(a),u.write(e,t,s,r,n)}}}getSortKey(e,t){return this._symbology.getSortKey(e,t)}}var We=f(86220),Re=f(56330);class Ze{constructor(e){this._outstandingMessages=[],this._queue=new Re.e({concurrency:e.concurrency,process:t=>e.process(t)})}push(e){var t=this;return(0,_.A)(function*(){if(e.end)return yield Promise.all(t._outstandingMessages),yield t._queue.push(e),void(t._outstandingMessages=[]);const s=t._queue.push(e);return t._outstandingMessages.push(s),s})()}}var Ee=f(27106);function de(l){var e={},t=!1;function s(r,n){return t=!0,n=new Promise(function(a){a(l[r](n))}),{done:!1,value:new Ee.A(n,1)}}return e[typeof Symbol<"u"&&Symbol.iterator||"@@iterator"]=function(){return this},e.next=function(r){return t?(t=!1,r):s("next",r)},"function"==typeof l.throw&&(e.throw=function(r){if(t)throw t=!1,r;return s("throw",r)}),"function"==typeof l.return&&(e.return=function(r){return t?(t=!1,r):s("return",r)}),e}var H=f(56218),G=f(56698),De=(f(21152),f(19412)),T=f(31732),z=f(42086),be=f(88840),i=f(9908);class Ge{static create(e,t){return(0,_.A)(function*(){var s;if("count"===t.statisticType){const n=new i.G(1);return new Ge(t.name,t.alias,t.type,t.statisticType,n)}const r=yield e.createComputedField({expression:null===(s=t.onStatisticExpression)||void 0===s?void 0:s.expression,field:t.onStatisticField});return new Ge(t.name,t.alias,t.type,t.statisticType,r)})()}constructor(e,t,s,r,n){this.name=e,this.alias=t,this.type=s,this.statisticType=r,this.computed=n}}var nt=f(42425),at=f(2296),jt=f(50690),It=f(40753);class ot{constructor(e){this.subscription=e,this.handledChunks=new Set}destroy(){}}class bt{constructor(e,t){this._source=e,this._attributeStore=t,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}onSubscribe(e){const t=this.createState(e);this._sendStates.set(e.key.id,t),this.updateChunks()}onUnsubscribe(e){var t;null!==(t=this._sendStates.get(e.key.id))&&void 0!==t&&t.destroy(),this._sendStates.delete(e.key.id)}invalidate(){const e=Array.from(this._sendStates.values());this._sendStates.clear();for(const t of e)t.destroy(),this.onSubscribe(t.subscription)}invalidateAttributeData(){}getFeatureObjectIdsForAggregate(e){throw new Error("InternalError: AggregateId lookup not supported")}getDisplayIds(e){return this.displayMap(e,t=>t,t=>t)}getDisplayAndObjectIds(e){return this.displayMap(e,t=>t,(t,s,r)=>[t,r])}afterUpdateChunks(){}}class St extends bt{constructor(e,t,s,r){super(e,t),this.spatialReference=s,this.aggregateFields=r,this.events=new nt.A,this.featureAdapter=jt.T}get aggregateQueryEngine(){return this._aggregateQueryEngine||(this._aggregateQueryEngine=new It.d({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,objectIdField:this._metadata.objectIdField,spatialReference:this.spatialReference})),this._aggregateQueryEngine}removeChunks(e){}forEach(e){return this.forEachAggregateWorldSpace(e)}forEachInBounds(e,t){}forEachBounds(e,t){const s=(0,at.vt)();for(const r of e){const n=(0,T.jQ)(s,r.geometry,!1,!1);n&&t(n)}}}class ut{constructor(e,t,s,r,n){this.subscription=e,this.reader=t,this.clear=s,this.end=r,this.debugInfo=n,this.type="append"}get id(){return this.subscription.tile.id}createMessage(e,t,s){return{type:"append",clear:this.clear,id:this.id,append:e,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:t,attributeEpoch:s}}}class lt{constructor(e,t,s,r,n){this.subscription=e,this.reader=t,this.remove=s,this.end=r,this.debugInfo=n,this.type="update"}get id(){return this.subscription.tile.id}createMessage(e,t,s){return{type:"update",id:this.id,modify:e,debugInfo:this.debugInfo,remove:this.remove,version:t,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:s}}}var dt=f(85452),ct=f(83897),Je=f(34650),ht=f(73258),Ke=f(27420);class k extends Ke.Y{static fromFeatures(e,t){const{objectIdField:s,geometryType:r}=t,n=(0,T.Di)([],e,r,!1,!1,s);for(let a=0;a<n.length;a++)n[a].displayId=e[a].displayId;return k.fromOptimizedFeatures(n,t)}static fromFeatureSet(e,t){const s=(0,T.q3)(e,t.objectIdField);return k.fromOptimizedFeatureSet(s,t)}static fromOptimizedFeatureSet(e,t){const s=k.fromOptimizedFeatures(e.features,t);return s._exceededTransferLimit=e.exceededTransferLimit,s._transform=e.transform,s._fieldsIndex=new ht.A(e.fields),s}static fromOptimizedFeatures(e,t,s){const r=new k(e,t);return r._fieldsIndex=t.fieldsIndex,r._transform=s,r}static empty(e){return new k([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}removeIds(e){const t=new Set(e);this._features=this._features.filter(s=>!(null!=s.objectId&&t.has(s.objectId)))}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){var e;return null===(e=this._current)||void 0===e?void 0:e.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){const e=new k(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return(0,z.N3)(this._current)?(0,T.Rk)(this._current.geometry,2):0}_readX(){return(0,z.N3)(this._current)?this._current.geometry.coords[0]:0}_readY(){return(0,z.N3)(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){var e;return(0,z.N3)(this._current)&&null!==(e=this._current.geometry)&&void 0!==e?e:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){var s;if(!this._fieldsIndex){const a=this._current.attributes[e];if(void 0!==a)return a;const o=e.toLowerCase();for(const u in this._current.attributes)if(u.toLowerCase()===o)return this._current.attributes[u];return}const r=this._fieldsIndex.get(e);if(!r)return;let n=this._current.attributes[r.name];return null==n?n:("esriFieldTypeTimestampOffset"===(null===(s=this.fields.get(e))||void 0===s?void 0:s.type)&&(n=this.parseTimestampOffset(n)),t&&this.fields.isDateField(e)?new Date(n):n)}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}}class xt extends ot{constructor(e,t){super(e),this.bins=new Map,this.done=!1,this._store=t}reset(){this.destroy(),this.bins.clear(),this.done=!1,this.handledChunks.clear()}destroy(){const e=this.subscription.tile.key.level;for(const s of this.bins.values()){var t;const r=null===(t=s.cachedFeature)||void 0===t?void 0:t.objectId;null!=r&&this._store.releaseDisplayIdForObjectId(`${r}.${e}`)}}*featuresWorldSpace(){for(const e of this.bins.values()){const t=e.cachedFeature;if(t){const s=t.clone();s.geometry&&(0,T.Ch)(s.geometry,s.geometry,!1,!1,this.subscription.tile.transform),yield s}}}getGeohashBounds(e,t){const s=this.subscription.tile;return(0,De.V2)(s.extent,s.resolution,t,e)}}class et extends St{static create(e,t,s,r,n){return(0,_.A)(function*(){const a=new dt.l({spatialReference:t}),o=e.fixedBinLevel,u=yield Promise.all(e.fields.map(function(){var d=(0,_.A)(function*(h){return Ge.create(a,h)});return function(h){return d.apply(this,arguments)}}())),c=e.featureFilter?yield ct.A.create({geometryType:s.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:s.metadata.timeInfo,fieldsIndex:s.metadata.fieldsIndex,spatialReference:t,filterJSON:e.featureFilter}):null;return yield(0,be.Nk)(t,K.A.WGS84),new et({fields:u,geohashLevel:o,spatialReference:t,featureFilter:c,timeZone:n},e.fields,s,r)})()}constructor(e,t,s,r){super(s,r,e.spatialReference,e.fields),this._indexOptions=e,this._metadata=new Je.i({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fields:t,globalIdField:null,spatialReference:s.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}createState(e){return new xt(e,this._attributeStore)}applyOverride(e){var t=this;return(0,G.A)(function*(){for(const s of t._sendStates.values())s.reset(),yield new ut(s.subscription,k.empty(t._source.metadata),!0,!1,{})})()}displayMap(e,t,s){const r=new Map(e.map(a=>[t(a),a])),n=[];for(const a of this._sendStates.values())for(const o of a.featuresWorldSpace()){const{objectId:u,displayId:c}=o,d=r.get(u);if(null!=d){const h=s(c,d,u);n.push(h),r.delete(u)}}return n}getDisplayFeatures(e){const t=new Set(e),s=new Set,r=[];for(const n of this._sendStates.values())for(const a of n.featuresWorldSpace())t.has(a.displayId)&&!s.has(a.objectId)&&(a.geometry&&r.push({...(0,T.oN)(a,this._metadata.geometryType,!1,!1),displayId:a.displayId}),s.add(a.objectId));return{features:[],aggregates:r}}getFeatureObjectIdsForAggregate(e){for(const t of this._sendStates.values())for(const s of t.bins.values())if(s.id===e)return Array.from(s.objectIds);return[]}updateChunks(){var e=this;return(0,G.A)(function*(){if(e._source.chunks().length)for(const t of e._sendStates.values())yield*de((0,Y.A)(e._update(t,e._source)))})()}forEachAggregateWorldSpace(e){for(const t of this._sendStates.values())for(const s of t.featuresWorldSpace())e(s)}_update(e,t){var s=this;return(0,G.A)(function*(){const{handledChunks:r,subscription:n,bins:a}=e,{spatialReference:o,geohashLevel:u}=s._indexOptions,c=n.tile;if(e.done)return;for(const I of t.chunks()){if(r.has(I.chunkId))continue;r.add(I.chunkId);const b=I.queryInfo;if("tileId"in b){const M=new xe.A(b.tileId);if(M.level!==c.level||M.world!==c.key.world)continue}const w=I.getGeohashIndex(s._indexOptions),C=e.getGeohashBounds(o,u);null!=C&&w.putBins(a,C)}const d=[],h=n.tile.transform,g=n.tile.key.level;for(const I of a.values()){if(I.cachedFeature)I.cachedFeature.attributes=I.getAttributes();else{const b=I.getGeometry(s.spatialReference,h),w=new z.Om(b,I.getAttributes(),null);b||(w.centroid=I.getGeometryCentroid(s.spatialReference,h)),w.objectId=I.id,w.displayId=s._attributeStore.createDisplayIdForObjectId(`${w.objectId}.${g}`),I.cachedFeature=w}d.push(I.cachedFeature)}s.events.emit("changed"),e.done=!t.updateTracking.updating;const v=k.fromOptimizedFeatures(d,s._metadata,h),p=v.getCursor(),A=e.subscription.tile.createArcadeEvaluationOptions(s._indexOptions.timeZone);for(;p.next();)s._attributeStore.setAttributeData(p.getDisplayId(),p,A);yield new lt(e.subscription,v,[],e.done,{})})()}}var B=f(13682),At=f(45219);const U=Math.PI/180;class tt{static create(e){return new tt(e.map(t=>function us(l){switch(l.statisticType){case"min":return new Ct(l);case"max":return new Ft(l);case"avg":return new wt(l);case"avg_angle":return new Mt(l);case"sum":case"count":return new Tt(l);case"mode":return new kt(l)}}(t)))}constructor(e){this._statistics=e}values(){return this._statistics.values()}insert(e,t){for(const s of this._statistics)s.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){const s=this._statistics[t],r=e._statistics[t];if(s.field.name!==r.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");s.merge(r)}}clone(){return new tt(this._statistics.map(e=>e.clone()))}}class ze{constructor(e){this.field=e}insert(e,t){if(!this.field.computed)return;const s=this.field.computed.read(e,t);(0,At.rZ)(s)||this._insertValue(s)}}class Ct extends ze{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){const e=new Ct(this.field);return e.value=this.value,e}}class Ft extends ze{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){const e=new Ft(this.field);return e.value=this.value,e}}class Tt extends ze{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){const e=new Tt(this.field);return e.value=this.value,e}}class wt extends ze{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){const e=new wt(this.field);return e._total=this._total,e._count=this._count,e}}class Mt extends ze{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const s=180/Math.PI;return Math.atan2(this._y/this._count,this._x/this._count)*s}_insertValue(e){this._x=this._x+Math.cos(e*U),this._y=this._y+Math.sin(e*U),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){const e=new Mt(this.field);return e._x=this._x,e._y=this._y,e._count=this._count,e}}class kt extends ze{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(const[s,r]of this._frequencies.entries())r>t&&(t=r,e=s);return e}_insertValue(e){const t=this._frequencies.get(e);this._frequencies.set(e,null!=t?t+1:1)}merge(e){for(const[t,s]of e._frequencies.entries()){const r=this._frequencies.get(t);this._frequencies.set(t,null!=r?r+s:s)}}clone(){const e=new kt(this.field);return e._frequencies=new Map(this._frequencies),e}}class Le{static createId(e,t){return`${e}.${t}`}static create(e,t,s,r){return new Le(e,t,tt.create(s),r)}constructor(e,t,s,r){this.gridX=e,this.gridY=t,this._statistics=s,this._worldUnitsPerCell=r,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return Le.createId(this.gridX,this.gridY)}get count(){return this._count}get statistics(){return this._statistics}get objectIds(){return this._objectIds}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}clone(){const e=new Le(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._firstFeatureAttributes=this._firstFeatureAttributes,e._objectIds=new Set(this._objectIds),e}insert(e,t,s,r){this._firstFeatureAttributes=0===this._count?e.readAttributes():null,this._count+=1,this._xWorldTotal+=s,this._yWorldTotal+=r,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return null==e?this.centroidXWorld:(0,T.IE)(e,this.centroidXWorld)}getCentroidY(e){return null==e?this.centroidYWorld:(0,T.B2)(e,this.centroidYWorld)}getCentroid(e){const t=new B.A([],[this.centroidXWorld,this.centroidYWorld]);if(null!=e){const s=new B.A;return(0,T.Nl)(s,t,!1,!1,"esriGeometryPoint",e)}return t}getGeometricCentroid(e){const r=new B.A([],[this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell]);if(null!=e){const n=new B.A;return(0,T.Nl)(n,r,!1,!1,"esriGeometryPoint",e)}return r}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return null!=this._firstFeatureAttributes?{...e,...this._firstFeatureAttributes}:e}}var Nt=f(82663);function Ot(l,e){return(0,Nt.GA)(l)*Nt.dy*96/e}class ds{constructor(e){this._options=e,this._cells=new Map,this._pixelsPerMapUnit=Ot(e.spatialReference,e.scale)}insert(e,t){const s=e.getCursor(),r={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;s.next();)this._insertFeature(s,r,t)}putCellsInBounds(e,t){const[s,r,n,a]=t,o=Math.floor(s*this._pixelsPerMapUnit/this._options.cellSize),u=Math.floor(r*this._pixelsPerMapUnit/this._options.cellSize),c=Math.ceil(n*this._pixelsPerMapUnit/this._options.cellSize),d=Math.ceil(a*this._pixelsPerMapUnit/this._options.cellSize);for(let h=u;h<=d;h++)for(let g=o;g<=c;g++){const p=this._cells.get(`${g}.${h}`);if(!p)continue;const A=e.get(p.id);A?p&&!e.has(p.id)&&A.merge(p):e.set(p.id,p.clone())}}putCells(e){for(const t of this._cells.values()){const s=e.get(t.id);s?s.merge(t):e.set(t.id,t.clone())}}_insertFeature(e,t,s){const{featureFilter:r}=this._options;if(null!==r&&!r.check(e))return;let n=0,a=0;if("esriGeometryPoint"===e.geometryType)n=e.readXWorldSpace(),a=e.readYWorldSpace();else{if(s){const g=e.readCentroidForDisplay();if(null==g)return;const[v,p]=g.coords;if(v<0||v>F.CQ||p<0||p>F.CQ)return}const h=e.readCentroidWorldSpace();if(null==h)return;n=h.coords[0],a=h.coords[1]}const u=a*this._pixelsPerMapUnit,c=Math.floor(n*this._pixelsPerMapUnit/this._options.cellSize),d=Math.floor(u/this._options.cellSize);this._getCellOrCreate(c,d).insert(e,t,n,a)}_getCellOrCreate(e,t){const s=Le.createId(e,t);let r=this._cells.get(s);return r||(r=Le.create(e,t,this._options.fields,1*this._options.cellSize/this._pixelsPerMapUnit),this._cells.set(s,r)),r}}class cs{constructor(e,t){this.inner=e,this.displayId=t}}class hs extends ot{constructor(e){super(e),this.didSend=!1,this.done=!1}}class _s{constructor(e,t,s,r,n){this._level=e,this._scale=t,this._indexOptions=s,this._clusterRadius=r,this._store=n,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(const e of this._clusters.values())this._store.releaseDisplayIdForObjectId(e.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(const e of this._clusters.values()){const t=e.inner.getCentroid(null),s=new z.Om(t,e.inner.getAttributes(),null);s.objectId=e.inner.id,s.displayId=e.displayId,yield s}}clusters(){return this._clusters.values()}updateChunks(e,t){let s=!1;for(const o of e){const u=o.queryInfo;"tileId"in u&&new xe.A(u.tileId).level!==this._level||this._handledChunks.has(o.normalizedChunkId)||(this._handledChunks.add(o.normalizedChunkId),s=!0,o.getGridIndex({...this._indexOptions,scale:this._scale}).putCells(this._cells))}const r={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},n=Ot(this._indexOptions.spatialReference,this._scale),a=this._indexOptions.cellSize;for(const{subscription:o}of t){const u=o.tile.bounds,c=Math.floor(u[0]*n/a),d=Math.floor(u[1]*n/a),h=Math.ceil(u[2]*n/a),g=Math.ceil(u[3]*n/a);r.xMin=Math.min(r.xMin,c),r.yMin=Math.min(r.yMin,d),r.xMax=Math.max(r.xMax,h),r.yMax=Math.max(r.yMax,g)}return null!=this._lastCellBounds&&r.xMin===this._lastCellBounds.xMin&&r.yMin===this._lastCellBounds.yMin&&r.yMin===this._lastCellBounds.yMin&&r.yMax===this._lastCellBounds.yMax||(s=!0,this._lastCellBounds=r),s&&this._clusterCells(r),s}updateStatistics(e){var t=this;return(0,_.A)(function*(){let s=!1;for(const r of t._clusters.values())r.inner.count>1&&(s=t._updateAggregateStatistics(t._statistics,r.inner)||s);if(s){const r=Array.from(t._statistics.entries()).map(([n,a])=>({fieldName:n,minValue:a.minValue,maxValue:a.maxValue}));yield e.container.updateStatistics(t._level,r)}})()}createAggregateFeatures(e,t){const s=e.subscription,r=[],n=s.tile.transform;for(const a of this._clusters.values()){let o=a.inner.getCentroidX(n);const u=a.inner.getCentroidY(n),c=s.tile.lod,d=c.wrap?c.worldSize[0]:null,h=1===a.inner.count?a.inner.firstObjectId:a.inner.id,g=a.displayId;if(null!=d)if(1===d){const v=new B.A([],[o,u]),p=new z.Om(v,a.inner.getAttributes(),null);p.geometry.coords[0]-=F.CQ,p.objectId=h,p.displayId=g,r.push(p);const A=new B.A([],[o,u]),S=new z.Om(A,a.inner.getAttributes(),null);S.geometry.coords[0]+=F.CQ,S.objectId=h,S.displayId=g,r.push(S)}else o>F.CQ+F.CQ/2?o-=d*F.CQ:o<-F.CQ/2&&(o+=d*F.CQ);if(o<F.CQ+128&&o>=-128&&u<F.CQ+128&&u>=-128){const v=new B.A([],[o,u]),p=new z.Om(v,a.inner.getAttributes(),null);p.objectId=h,p.displayId=g,r.push(p)}}return k.fromOptimizedFeatures(r,t,s.tile.transform)}_clusterCells(e){let t=Array.from(this._cells.values());t=t.sort((o,u)=>u.count-o.count);const s=[];for(const o of this._clusters.values())s.push(o.inner.id);this._clusters.clear();const r=this._clusterRadius*(1/Ot(this._indexOptions.spatialReference,this._scale)),n=1+this._clusterRadius/this._indexOptions.cellSize,a=new Set;for(const o of t){if(a.has(o.id)||o.gridX<e.xMin||o.gridX>e.xMax||o.gridY<e.yMin||o.gridY>e.yMax)continue;const u=this._store.createDisplayIdForObjectId(o.id),c=new cs(o.clone(),u);a.add(o.id),this._clusters.set(o.id,c);const d=o.centroidXWorld,h=o.centroidYWorld;for(let g=o.gridY-n;g<=o.gridY+n;g++)for(let v=o.gridX-n;v<=o.gridX+n;v++){if(g===o.gridY&&v===o.gridX)continue;const p=this._cells.get(Le.createId(v,g));if(!p||a.has(p.id))continue;const A=Math.abs(p.centroidXWorld-d),S=Math.abs(p.centroidYWorld-h);A<r&&S<r&&(c.inner.merge(p),a.add(p.id))}}for(const o of s)this._store.releaseDisplayIdForObjectId(o)}_updateAggregateStatistics(e,t){let s=!1;for(const r of t.statistics.values()){if("esriFieldTypeString"===r.field.type)continue;const n=r.value,a=r.field,o=e.get(a.name);if(o){const{minValue:u,maxValue:c}=o,d=Math.min(o.minValue,n),h=Math.max(o.maxValue,n);u===d&&c===h||(o.minValue=d,o.maxValue=h,s=!0)}else e.set(a.name,{minValue:n,maxValue:n}),s=!0}return s}}class Pt extends St{static create(e,t,s,r,n,a){return(0,_.A)(function*(){const o=new dt.l({spatialReference:s}),u={fields:yield Promise.all(t.fields.map(function(){var c=(0,_.A)(function*(d){return Ge.create(o,d)});return function(d){return c.apply(this,arguments)}}())),spatialReference:s,featureFilter:t.featureFilter?yield ct.A.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:s,filterJSON:t.featureFilter}):null,cellSize:t.clusterRadius/4,timeZone:a};return new Pt(e,t.clusterRadius,u,t.fields,r,n)})()}constructor(e,t,s,r,n,a){super(n,a,s.spatialReference,s.fields),this._connection=e,this._clusterRadius=t,this._indexOptions=s,this._cellsPerScale=new Map,this._metadata=new Je.i({geometryType:"esriGeometryPoint",objectIdField:"aggregateId",fields:[...r,...this._source.metadata.fieldsIndex.fields,{name:"aggregateId",alias:"aggregateId",type:"esriFieldTypeOID"}],globalIdField:null,spatialReference:n.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(const e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear()}onSubscribe(e){super.onSubscribe(e),this._requiredLevel=e.tile.level,this._requiredScale=e.tile.scale}createState(e){return new hs(e)}applyOverride(e){var t=this;return(0,G.A)(function*(){for(const s of t._cellsPerScale.values())s.destroy();t._cellsPerScale.clear();for(const s of t._sendStates.values())s.done=!1})()}displayMap(e,t,s){const r=new Map(e.map(o=>[t(o),o])),n=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of a.clusters()){const u=r.get(o.inner.id);if(null==u){if(1===o.inner.count){const c=r.get(o.inner.firstObjectId);if(null!=c){const d=s(o.displayId,c,o.inner.firstObjectId);n.push(d),r.delete(o.inner.firstObjectId)}}}else{const c=s(o.displayId,u,o.inner.id);n.push(c),r.delete(o.inner.id)}}return n}getDisplayFeatures(e){const t=new Set(e),s=new Set,r=[],n=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of a.aggregatesWorldSpace())if(t.has(o.displayId)&&!s.has(o.displayId)){const u=(0,T.oN)(o,this._metadata.geometryType,!1,!1);if(s.add(o.displayId),1===u.attributes.cluster_count){r.push({...u,displayId:o.displayId});continue}n.push({...u,displayId:o.displayId})}return{features:r,aggregates:n}}getFeatureObjectIdsForAggregate(e){const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const s of t.clusters())if(s.inner.id===e)return Array.from(s.inner.objectIds);return[]}updateChunks(){var e=this;return(0,G.A)(function*(){const t=e._source.chunks();if(!t.length)return;const s=e._getClusterState(e._requiredLevel,e._requiredScale),r=Array.from(e._sendStates.values()).filter(o=>o.subscription.tile.level===e._requiredLevel);if(s.updateChunks(t,r)||!e._source.updateTracking.updating)for(const o of r)o.subscription.tile.level===e._requiredLevel&&(o.didSend=!1,o.done=!1);const n=Array.from(e._sendStates.values()).filter(o=>o.done).map(o=>o.subscription.tile.key),a=new Set(n);for(const o of e._sendStates.values())e._source.updateTracking.updating&&(n.some(u=>u.containsChild(o.subscription.tile.key))||o.subscription.tile.key.getChildKeys().every(u=>a.has(u)))||o.didSend||o.subscription.tile.level!==e._requiredLevel||(o.didSend=!0,yield*de((0,Y.A)(e._update(o,s,e._source))));yield(0,H.A)(s.updateStatistics(e._connection))})()}forEachAggregateWorldSpace(e){if(null==this._requiredLevel||null==this._requiredScale)return;const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const s of t.aggregatesWorldSpace())e(s)}_getClusterState(e,t){if(null==e||null==t)throw new Error("InternalError: Level and scale must be defined");let s=this._cellsPerScale.get(t);return s||(s=new _s(e,t,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(t,s)),s}_update(e,t,s){var r=this;return(0,G.A)(function*(){if(e.done)return;const n=t.createAggregateFeatures(e,r._metadata);r.events.emit("changed"),e.done=!s.updateTracking.updating;const a=n.getCursor(),o=e.subscription.tile.createArcadeEvaluationOptions(r._indexOptions.timeZone);for(;a.next();)r._attributeStore.setAttributeData(a.getDisplayId(),a,o);yield new ut(e.subscription,n,!0,e.done,{})})()}}var fs=f(77413);class Rt{static fromReader(e){const t=[],s=e.copy(),r=(0,at.vt)();for(;s.next();)s.getBounds(r)&&t.push(s.getIndex());const n=(0,fs.r)(9,a=>(s.setIndex(a),{minX:s.getBoundsXMin(),minY:s.getBoundsYMin(),maxX:s.getBoundsXMax(),maxY:s.getBoundsYMax()}));return n.load(t),new Rt(n)}constructor(e){this._index=e}search(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}}class st{static create(e,t,s,r){const n=tt.create(e),a=new Array(32);for(let o=0;o<a.length;o++)a[o]=null;return new st(n,t,s,r,a)}constructor(e,t,s,r,n){this._statistics=e,this.xNode=t,this.yNode=s,this.depth=r,this.children=n,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return`${this.xNode}.${this.yNode}`}get objectIds(){return this._objectIds}clone(){const e=new st(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._xGeohashTotal=this._xGeohashTotal,e._yGeohashTotal=this._yGeohashTotal,e.next=this.next,e.cachedFeature=this.cachedFeature,e._objectIds=new Set(this._objectIds),e}insert(e,t,s,r,n,a){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=s,this._xGeohashTotal+=r,this._yGeohashTotal+=n,this._statistics.insert(e,a),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getGeometry(e,t){const s=this._getLngLatBounds(),[r,n,a,o]=s,u=(0,be.Cv)({rings:[[[r,n],[r,o],[a,o],[a,n],[r,n]]]},K.A.WGS84,e),c=(0,T.Ye)(new B.A,u,!1,!1);return null!=t?(0,T.Nl)(new B.A,c,!1,!1,"esriGeometryPolygon",t,!1,!1):c}getGeometryCentroid(e,t){const s=this._getLngLatBounds(),[r,n,a,o]=s,u=(0,be.Cv)({x:(r+a)/2,y:(n+o)/2},K.A.WGS84,e),c=(0,T.qN)(new B.A,u);return null!=t?(0,T.Nl)(new B.A,c,!1,!1,"esriGeometryPoint",t,!1,!1):c}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}_getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),s=Math.floor(e/2);return(0,De.Hq)({geohashX:this.xNode<<30-(3*t+2*s),geohashY:this.yNode<<30-(2*t+3*s)},this.depth)}}class gs{constructor(e){this._fields=e,this._root=st.create(this._fields,0,0,0)}destroy(){}insert(e,t,s,r,n,a,o){let u=this._root,c=0,d=0,h=0;for(;null!==u;){if(u.insert(e,t,s,r,n,o),c>=a)return;const g=Math.ceil((c+1)/2),v=Math.floor((c+1)/2),p=1-c%2,A=30-(3*g+2*v),S=30-(2*g+3*v),I=(r&7*p+3*(1-p)<<A)>>A,b=(n&3*p+7*(1-p)<<S)>>S,w=I+b*(8*p+4*(1-p));d=d<<3*p+2*(1-p)|I,h=h<<2*p+3*(1-p)|b,null==u.children[w]&&(u.children[w]=st.create(this._fields,d,h,c+1)),c+=1,u=u.children[w]}}putBins(e,t){for(const s of this.getNodes(t)){const r=e.get(s.id);r?r.merge(s):e.set(s.id,s.clone())}}getNodes(e){const t=[],{geohashBounds:s,level:r}=e;let n=this._root;for(;null!==n;){const a=n.depth,o=n.xNode,u=n.yNode;if(a>=r){t.push(n),n=n.next;continue}const c=Math.ceil((a+1)/2),d=Math.floor((a+1)/2),h=1-a%2,g=30-(3*c+2*d),v=30-(2*c+3*d),p=~((1<<g)-1),A=~((1<<v)-1),I=(s.yLL&A)>>v,b=(s.xTR&p)>>g,w=(s.yTR&A)>>v,C=o<<3*h+2*(1-h),M=u<<2*h+3*(1-h),O=C+8*h+4*(1-h),P=M+4*h+8*(1-h),V=Math.max(C,(s.xLL&p)>>g),E=Math.max(M,I),J=Math.min(O,b),re=Math.min(P,w);let L=null,ie=null;for(let Be=E;Be<=re;Be++)for(let Ue=V;Ue<=J;Ue++){const it=n.children[Ue-C+(Be-M)*(8*h+4*(1-h))];it&&(L||(L=it,L.next=n.next),ie&&(ie.next=it),ie=it,it.next=n.next)}n=L||n.next}return t}}class ps{constructor(e){this._options=e,this._tree=new gs(e.fields)}insert(e,t){const s=e.getCursor(),r={$view:{scale:0,timeZone:this._options.timeZone}};for(;s.next();)this._insertFeature(s,r,t)}putBins(e,t){this._tree.putBins(e,t)}_insertFeature(e,t,s){const{featureFilter:r,geohashLevel:n,spatialReference:a}=this._options;if(null!==r&&!r.check(e))return;let o=0,u=0;if("esriGeometryPoint"===e.geometryType)o=e.readXWorldSpace(),u=e.readYWorldSpace();else{if(s){const h=e.readCentroidForDisplay();if(null==h)return;const[g,v]=h.coords;if(g<0||g>F.CQ||v<0||v>F.CQ)return}const d=e.readCentroidWorldSpace();if(null==d)return;o=d.coords[0],u=d.coords[1]}const c=(0,De.m_)(o,u,n,a);c&&this._tree.insert(e,o,u,c[0],c[1],n,t)}}class ft extends Ke.Y{static from(e,t){return new ft(e.copy(),t)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTranslationX=0,this._displayTranslationY=0,this._displayScaleX=1,this._displayScaleY=1,this._reader=e,this._indices=t,this._isPoint="esriGeometryPoint"===e.geometryType}setTransformForDisplay(e){const t=this._reader.getInTransform();if(null==t){const[h,g]=e.scale,[v,p]=e.translate;return this._displayTranslationX=-v/h,this._displayScaleX=1/h,this._displayTranslationY=p/g,this._displayScaleY=1/-g,void(this._displayTransform=e)}const[s,r]=t.scale,[n,a]=t.translate,[o,u]=e.scale,[c,d]=e.translate;if(this._displayScaleX=s/o,this._displayTranslationX=(n-c)/o,this._displayScaleY=r/u,this._displayTranslationY=(-a+d)/u,!this._isPoint&&t)throw new Error("InternalError: Relative transformations not supported for non-point features");this._displayTransform=e}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new ft(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e._displayTransform=this._displayTransform,e._displayTranslationX=this._displayTranslationX,e._displayTranslationY=this._displayTranslationY,e._displayScaleX=this._displayScaleX,e._displayScaleY=this._displayScaleY,e}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._reader.readXForDisplay()*this._displayScaleX+this._displayTranslationX}readYForDisplay(){return this._reader.readYForDisplay()*this._displayScaleY+this._displayTranslationY}readGeometryForDisplay(){const e=this._reader.readGeometryForDisplay();if(!this._displayTransform)return e;const t=new B.A;return(0,T.Nl)(t,e,this.hasZ,this.hasM,this.geometryType,this._displayTransform),t.deltaDecode()}readCentroidForDisplay(){var e;const t=null===(e=this._reader.readCentroidForDisplay())||void 0===e?void 0:e.clone();if(t){const[s,r]=t.coords;t.coords[0]=s*this._displayScaleX+this._displayTranslationX,t.coords[1]=r*this._displayScaleY+this._displayTranslationY}return t}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e,t=!1){return this._reader.readAttribute(e,t)}readAttributes(){return this._reader.readAttributes()}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){var e;const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return(0,T.zv)(e,this.geometryType,!1,!1)}readGeometryArea(){return this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this.readAttribute(e,!0)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(e=!1){return this._reader.castToText(e)}}class rt{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._geohashIndex=null,this._geohashIndexHash=null,this._spatialIndex=null,this._gridIndex=null,this._gridIndexHash=null}queryFeaturesInBounds(e){const t=this._getSpatialIndex().search(e);return ft.from(this.reader,t)}getGeohashIndex(e){const t=JSON.stringify(e);return t!==this._geohashIndexHash&&(this._geohashIndexHash=t,this._geohashIndex=new ps(e),this._geohashIndex.insert(this.reader,this.isTiled)),this._geohashIndex}getGridIndex(e){const t=JSON.stringify(e);return t!==this._gridIndexHash&&(this._gridIndexHash=t,this._gridIndex=new ds(e),this._gridIndex.insert(this.reader,this.isTiled)),this._gridIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=Rt.fromReader(this.reader)),this._spatialIndex}}class Wt extends rt{constructor(e){super(),this.metadata=e,this.chunkId="override",this.normalizedChunkId="override",this.removed=new Set,this.overridenIds=new Set,this._features=[]}get reader(){return k.fromOptimizedFeatures(this._features,this.metadata)}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}applyOverrides(e){super.invalidate();const{reader:t,removed:s}=e,r=[],n=new Set,a=t.getCursor(),o=new Set(s);for(this.overridenIds.clear();a.next();){const u=a.readOptimizedFeatureWorldSpace(),c=u.objectId;r.push(u),n.add(c),this.overridenIds.add(c),this.removed.delete(c)}for(const u of this._features){const c=u.objectId;o.has(c)||n.has(c)||(r.push(u),this.overridenIds.add(c))}this._features=r;for(const u of n.values())this.removed.delete(u);for(const u of s)this.removed.add(u),this.overridenIds.add(u)}getTileReader(e){if(!this._features.length)return null;const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class ys extends ot{}class ms extends bt{constructor(e,t,s){super(e,t),this._timeZone=s,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(const e of this._source.chunks())this._cleanupChunkIds(e)}invalidateAttributeData(){this.handledChunksForAttributeData.clear()}onSubscribe(e){super.onSubscribe(e),this._evalOptions=e.tile.createArcadeEvaluationOptions(this._timeZone)}createState(e){return new ys(e)}get aggregateQueryEngine(){return null}displayMap(e,t,s){const r=new Map(e.map(a=>[t(a),a])),n=[];for(const a of this._source.chunks()){const o=a.reader.getCursor();for(;o.next();){const u=o.getObjectId(),c=o.getDisplayId(),d=r.get(u);if(null!=d){const h=s(c,d,u);n.push(h),r.delete(u)}}}return n}getDisplayFeatures(e){const t=new Set(e),s=new Set,r=[];for(const n of this._source.chunks()){const a=n.reader.getCursor();for(;a.next();){const o=a.getObjectId(),u=a.getDisplayId();t.has(u)&&!s.has(o)&&(r.push({...a.readLegacyFeatureWorldSpace(),displayId:u}),s.add(o))}}return{features:r,aggregates:[]}}applyOverride(e){var t=this;return(0,G.A)(function*(){const s=[],r=e.reader.getCursor();for(;r.next();){const u=r.getObjectId();s.push(u);const c=t._attributeStore.createDisplayIdForObjectId(u);r.setDisplayId(c),t._attributeStore.setAttributeData(c,r,t._evalOptions)}const n=t.getDisplayIds(s),a=t.getDisplayIds(e.removed),o=new Wt(t._source.metadata);o.applyOverrides(e),t.handledChunks.add(o.chunkId),t.handledChunksForAttributeData.add(o.chunkId),t.handledChunksForIdCreation.add(o.chunkId);for(const u of t._sendStates.values())u.handledChunks.add(o.chunkId),yield new lt(u.subscription,null,n,!1,o.queryInfo);for(const u of t._sendStates.values()){const c=o.getTileReader(u.subscription.tile);yield new lt(u.subscription,c,a,!1,o.queryInfo)}for(const u of e.removed)t._attributeStore.releaseDisplayIdForObjectId(u)})()}updateChunks(){var e=this;return(0,G.A)(function*(){if(e._source.chunks().length){yield(0,H.A)(e._updateAttributeData());for(const t of e._sendStates.values())yield*de((0,Y.A)(e._update(t)))}})()}removeChunks(e){for(const t of e)this.handledChunks.delete(t.chunkId),this.handledChunksForAttributeData.delete(t.chunkId),this._cleanupChunkIds(t)}afterUpdateChunks(){for(const e of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(e);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(e){if(this.handledChunksForIdCreation.has(e.chunkId)){const t=e.reader.getCursor();for(;t.next();){const s=t.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(s):this._attributeStore.releaseDisplayIdForObjectId(s)}this.handledChunksForIdCreation.delete(e.chunkId)}}_updateAttributeData(){var e=this;return(0,_.A)(function*(){for(const t of e._source.chunks()){const{chunkId:s,reader:r}=t;if(!e.handledChunksForIdCreation.has(s)){e.handledChunksForIdCreation.add(s);const n=r.getCursor();for(;n.next();){const a=e._attributeStore.createDisplayIdForObjectId(n.getObjectId());n.setDisplayId(a)}}}for(const t of e._source.chunks())if(!e.handledChunksForAttributeData.has(t.chunkId)){e.handledChunksForAttributeData.add(t.chunkId);const s=t.reader.getCursor();for(;s.next();){const r=s.getDisplayId();e._attributeStore.setAttributeData(r,s,e._evalOptions)}}})()}*_update(e){const{subscription:t,handledChunks:s}=e;for(const r of this._source.chunks()){const{chunkId:n}=r;if(s.has(n))continue;s.add(n);const a=r.getTileReader(t.tile);a&&(yield new ut(e.subscription,a,!1,r.end,r.queryInfo))}}}var vs=f(10903);class Is{constructor(e,t){this._connection=e,this._source=t,this._version=1,this._proxy=new We.J({fetch:(s,r)=>this._connection.layerView.fetch(s,r),fetchDictionary:(s,r)=>this._connection.layerView.fetchDictionary(s,r)}),this._attributeStore=new vs.K({isLocal:!1,update:s=>(0,m.QZ)(this._connection.container.updateAttributeView(s))})}destroy(){var e;this._proxy.destory(),null!==(e=this._strategy)&&void 0!==e&&e.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){var e;return null===(e=this._strategy)||void 0===e?void 0:e.aggregateQueryEngine}getDisplayFeatures(e){return this._strategy?this._strategy.getDisplayFeatures(e):{features:[],aggregates:[]}}getFeatureObjectIdsForAggregate(e){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(e):[]}onSubscribe(e){var t;null===(t=this._strategy)||void 0===t||t.onSubscribe(e)}onUnsubscribe(e){var t;null===(t=this._strategy)||void 0===t||t.onUnsubscribe(e)}update(e,t,s,r,n){var a=this;return(0,_.A)(function*(){var o;const u=e.processor,c=(0,$.Ui)(a._schema,u);if(!c&&!r)return;(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${a._version}] SymbolProcessor.update`,{changes:c,schema:u}),a._schema=u;const d=K.A.fromJSON(e.source.mutable.dataFilter.outSpatialReference),h=new dt.l({fields:a._source.metadata.fieldsIndex,spatialReference:d});return yield a._attributeStore.update(u.storage,h,a._source.metadata,d,t),null!==(o=a._strategy)&&void 0!==o&&o.invalidateAttributeData(),r||(0,$.EB)(c,"mesh")?((0,$.EB)(c,"mesh.strategy")&&(yield a._updateStrategy(u.mesh.strategy,d,n,u.mesh.timeZone)),a._updateSortKey(h,"sortKey"in u.mesh?u.mesh.sortKey:null),((0,$.EB)(c,"mesh.factory")||"dictionary"===u.mesh.factory.symbology.type)&&(a._factory=yield Ie.create(h,a._proxy,u.mesh.factory,s)),a._invalidate(),a._version=t,a._connection.container.updateRenderState(a._version)):void 0})()}applyOverride(e){var t=this;return(0,_.A)(function*(){if(!t._strategy)return;const s=t._strategy.applyOverride(e);var a,r=!1,n=!1;try{for(var u,o=(0,Y.A)(s);r=!(u=yield o.next()).done;r=!1){const c=u.value;try{yield t._process(c)}catch{}}}catch(c){n=!0,a=c}finally{try{r&&null!=o.return&&(yield o.return())}finally{if(n)throw a}}t._source.applyOverride(e)})()}updateChunks(){var e=this;return(0,_.A)(function*(){var t;yield e._doUpdateChunks(),null===(t=e._strategy)||void 0===t||t.afterUpdateChunks()})()}removeChunks(e){var t=this;return(0,_.A)(function*(){var s;null!==(s=t._strategy)&&void 0!==s&&s.removeChunks(e),t._attributeStore.incrementDisplayIdGeneration()})()}updateHighlight({highlights:e}){if(!this._strategy)return void this._attributeStore.setHighlight(e.map(({objectId:s,highlightFlags:r})=>({objectId:s,highlightFlags:r,displayId:-1})),e);const t=this._strategy.displayMap(e,({objectId:s})=>s,(s,{highlightFlags:r},n)=>({objectId:n,displayId:s,highlightFlags:r}));this._attributeStore.setHighlight(t,e)}_doUpdateChunks(){var e=this;return(0,_.A)(function*(){if(!e._strategy)return;const t=e._strategy.updateChunks(),s=[],r=new Map;var o,n=!1,a=!1;try{for(var c,u=(0,Y.A)(t);n=!(c=yield u.next()).done;n=!1){const d=c.value;{let h=r.get(d.id);null==h&&(h=new Ze({concurrency:16,process:v=>e._process(v)}),r.set(d.id,h));const g=h.push(d).catch(v=>(0,m.jH)(v));s.push(g)}}}catch(d){a=!0,o=d}finally{try{n&&null!=u.return&&(yield u.return())}finally{if(a)throw o}}try{yield Promise.all(s)}catch{}(0,y.A)("esri-2d-update-debug")&&console.log("SendUpdates"),yield e._attributeStore.sendUpdates(),(0,y.A)("esri-2d-update-debug")&&console.log("SendUpdates.await")})()}_updateStrategy(e,t,s,r){var n=this;return(0,_.A)(function*(){var a;switch(null!==(a=n._strategy)&&void 0!==a&&a.destroy(),e.type){case"feature":n._strategy=new ms(n._source,n._attributeStore,r);break;case"binning":n._strategy=yield et.create(e,t,n._source,n._attributeStore,r);break;case"cluster":n._strategy=yield Pt.create(n._connection,e,t,n._source,n._attributeStore,r)}for(const o of s)n._strategy.onSubscribe(o)})()}_updateSortKey(e,t){var s=this;return(0,_.A)(function*(){var r;if(s._sortInfo=(0,Ce.pR)(null===(r=s._sortInfo)||void 0===r?void 0:r.computed),null!=t){const n=t.byRenderer?null:yield e.createComputedField(t);s._sortInfo={...t,computed:n}}})()}_invalidate(){this._strategy&&this._strategy.invalidate()}_process(e){var t=this;return(0,_.A)(function*(){const s=e.subscription;(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${t._version}] Tile[${s.tile.key.id}, end=${e.end}] Processor._process`),yield t._fetchResources(e),(0,m.Te)(s.signal);const r=yield t._write(e,s.tile.createArcadeEvaluationOptions(t._schema.mesh.timeZone)),n=s.tile.tileInfoView.tileInfo.isWrappable,{message:a,transferList:o}=r.serialize(n),u=e.createMessage(a,t._version,t._attributeStore.epoch);(0,m.Te)(s.signal),t._connection.container.onMessage(u,{signal:s.signal,transferList:o}),t._attributeStore.sendUpdates(),(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${t._version}] Tile[${s.tile.key.id}, end=${e.end}] Processor._process.await`)})()}_fetchResources(e){var t=this;return(0,_.A)(function*(){yield t._fetchMatcherResources(e),yield t._fetchWriterResources(e)})()}_fetchMatcherResources(e){var t=this;return(0,_.A)(function*(){if(e.reader)return t._factory.enqueueMatcherRequests(t._proxy,e.reader)})()}_fetchWriterResources(e){var t=this;return(0,_.A)(function*(){if(!e.reader)return;const s=e.reader.getCursor(),r=e.subscription.tile.createArcadeEvaluationOptions(t._schema.mesh.timeZone);for(;s.next();)t._factory.enqueueWriterRequests(t._proxy,s,r);yield t._proxy.fetchEnqueuedResources()})()}_write(e,t){var s=this;return(0,_.A)(function*(){var r,n;const a=e.subscription.tile,o=null===(r=e.reader)||void 0===r?void 0:r.getCursor(),u=null!==(n=null==o?void 0:o.getSize())&&void 0!==n?n:0,d=new Pe(a.key,s._strategy.enablePixelBuffering,a.tileInfoView.tileInfo.isWrappable,u);if(!o)return d;const h=a.createArcadeEvaluationOptions(s._schema.mesh.timeZone);for(;o.next();){const g=s._getSortKeyValue(o,t);d.entityStart(o.getDisplayId(),g),s._factory.write(d,s._proxy,o,h,a.level),d.entityEnd()}return d})()}_getSortKeyValue(e,t){if(!this._sortInfo)return 0;const{computed:s,order:r,byRenderer:n}=this._sortInfo,a=n?this._factory.getSortKey(e,t):null==s?void 0:s.read(e,t);return null==a||isNaN(a)?0:a*("asc"===r?-1:1)}}var bs=f(89563),gt=f(1277);class Et{static from(e){let t=0,s=0,r=0;return e.forEach(n=>{const a=n._readGeometry();a&&(s+=a.isPoint?1:a.lengths.reduce((o,u)=>o+u,0),r+=a.isPoint?1:a.lengths.length,t+=1)}),new Et(t,s,r)}constructor(e,t,s){this.featureCount=e,this.vertexCount=t,this.ringCount=s}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}}var Ss=f(12849),xs=f(68438),Gt=f(87086);class Lt{static fromSchema(e,t){return new Lt(function As(l,e){var t,s,r;const{service:n}=l,a=null!==(t=n.orderByFields)&&void 0!==t?t:e.objectIdField+" ASC",o=n.source,u={returnCentroid:!(null!==o&&"object"==typeof o&&"path"in o&&(0,xs.Wo)(o.path))&&"esriGeometryPolygon"===e.geometryType,returnGeometry:!0,timeReferenceUnknownClient:null!==(s=e.timeReferenceUnknownClient)&&void 0!==s?s:void 0,outSpatialReference:K.A.fromJSON(l.mutable.dataFilter.outSpatialReference),orderByFields:[a],where:null!==(r=l.mutable.dataFilter.definitionExpression)&&void 0!==r?r:"1=1",outFields:l.mutable.availableFields};if("feature"===l.type){const{gdbVersion:c,historicMoment:d,timeExtent:h}=l.mutable.dataFilter;return{...u,gdbVersion:c,historicMoment:d?new Date(d):null,timeExtent:h?Ss.A.fromJSON(h):null,outFields:l.mutable.availableFields}}return u}(e,t),e.mutable.dataFilter.customParameters,t.geometryType,e.service.queryMetadata.capabilities)}constructor(e,t,s,r){this._queryParams=e,this._customParameters=t,this._geometryType=s,this._capabilities=r}get pageSize(){var e;if(null==this._capabilities)throw new Error("InternalError: Service does not support paged queries");const{query:t}=this._capabilities,s=t.supportsMaxRecordCountFactor?4:null,r=(null!==(e=t.maxRecordCount)&&void 0!==e?e:8e3)*(null!=s?s:1);return Math.min(8e3,r)}updateFields(e){this._queryParams.outFields=e}createPatchFieldsQuery(e,t){const s=e.clone();if("*"===this._queryParams.outFields[0]){var r;if("*"===(null!==(r=s.outFields)&&void 0!==r?r:[])[0])return null;s.outFields=this._queryParams.outFields}else{const n=new Set(this._queryParams.outFields),a=[];for(const o of n)t.hasField(o)||a.push(o);if(0===a.length)return null;s.outFields=a}return s.returnGeometry=!1,s.returnCentroid=!1,s.quantizationParameters=null,s.cacheHint=!0,{inner:s,customParameters:this._customParameters}}createQuery(e={}){if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new Gt.A({...this._queryParams,...e}),customParameters:this._customParameters}}createTileQuery(e,t){var s;if(null==this._capabilities)throw new Error("InternalError: Service does not support tile queries");const r=this.createQuery(t),n=r.inner;return n.quantizationParameters=null!==(s=t.quantizationParameters)&&void 0!==s?s:e.getQuantizationParameters(),n.resultType="tile",n.geometry=e.extent,this._capabilities.query.supportsQuantization?"esriGeometryPolyline"===this._geometryType&&(n.maxAllowableOffset=e.resolution*(0,y.A)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==this._geometryType&&"esriGeometryPolygon"!==this._geometryType||(n.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===this._geometryType&&(n.maxAllowableOffset*=(0,y.A)("feature-polyline-generalization-factor"))),n.defaultSpatialReferenceEnabled=this._capabilities.query.supportsDefaultSpatialReference,n.compactGeometryEnabled=this._capabilities.query.supportsCompactGeometry,this._capabilities.query.supportsMaxRecordCountFactor&&(n.maxRecordCountFactor=4),r}createPagedTileQuery(e,t){const s=this.pageSize;return this.createTileQuery(e,{start:s*t,num:s,returnExceededLimitFeatures:!0})}createPagedQuery(e){const t=this.pageSize;return this.createQuery({start:t*e,num:t,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}var $e=f(8189),zt=f(98877),pt=f(85211),Cs=f(35150),$t=f(76576);let yt=class extends zt.A{constructor(l){super(),this._connection=l,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this.addHandles([(0,D.wB)(()=>{var e,t;return null!==(e=null===(t=this._strategy)||void 0===t?void 0:t.connectionStatus)&&void 0!==e?e:"disconnected"},e=>{this._layerView.setProperty({propertyName:"pipelineConnectionStatus",value:e})},{initial:!0}),(0,D.wB)(()=>{var e;return(null===(e=this._strategy)||void 0===e?void 0:e.errorString)||null},e=>this._layerView.setProperty({propertyName:"pipelineErrorString",value:e}),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(l){null==this._strategy&&this._resetUpdateInfo(performance.now());const e="event-handles";this.removeHandles(e),null!=l&&this.addHandles([l.events.on("data-received",t=>this._onFeature(t)),l.events.on("message-received",t=>this._onWebSocketMessage(t)),l.events.on("features-updated",t=>this._onUpdate(t)),l.events.on("tick",()=>this._onTick())],e),this._strategy=l}updateCustomParameters(l){var e;null!=l&&(null===(e=this._strategy)||void 0===e||e.updateCustomParameters(l))}sendMessageToSocket(l){var e;null===(e=this._strategy)||void 0===e||e.sendMessageToSocket(l)}sendMessageToClient(l){var e;null===(e=this._strategy)||void 0===e||e.sendMessageToClient(l)}enableEvent(l,e){e?this._enabledEventTypes.add(l):this._enabledEventTypes.delete(l)}disconnect(){var l;null===(l=this._strategy)||void 0===l||l.disconnect()}connect(){var l;null===(l=this._strategy)||void 0===l||l.connect()}clear(){var l;null===(l=this._strategy)||void 0===l||l.clear()}_onWebSocketMessage(l){this._enabledEventTypes.has("message-received")&&this._layerView.emitEvent({name:"message-received",event:l})}_onFeature(l){this._updateInfo.websocket++,this._enabledEventTypes.has("data-received")&&this._layerView.emitEvent({name:"data-received",event:{attributes:l.attributes,centroid:l.centroid,geometry:l.geometry}})}_onUpdate(l){this._updateInfo.client+=l}_onTick(){const l=performance.now(),e=l-this._lastTime;if(e>2500){const t=Math.round(this._updateInfo.client/(e/1e3)),s=Math.round(this._updateInfo.websocket/(e/1e3));this._resetUpdateInfo(l),this._layerView.emitEvent({name:"update-rate",event:{client:t,websocket:s}})}}_resetUpdateInfo(l){this._lastTime=l,this._updateInfo.client=0,this._updateInfo.websocket=0}};(0,$e._)([(0,pt.MZ)()],yt.prototype,"_strategy",void 0),yt=(0,$e._)([(0,$t.$)("esri.views.2d.layers.features.sources.StreamMessenger")],yt);class Vt{constructor(e){this._store=e,this._controller=new AbortController}destroy(){this._controller.abort()}get _options(){return{signal:this._controller.signal}}queryOverride(e){return(0,_.A)(function*(){throw new Error("InternalError: LoadStrategy does not support fetching")})()}}var Ts=f(88718),Qt=f(721),Yt=f(55225),ws=f(55912),Ms=f(54977),Ht=f(98455);const Bt=268435455;class ks{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}const Zt=268435455,Ve={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function Kt(l){return l<=Ve.small.delta.length?Ve.small:(l<=Ve.large.delta.length||(Ve.large.delta=new Int32Array(Math.round(1.25*l)),Ve.large.decoded=new Int32Array(Math.round(1.25*l))),Ve.large)}function Es(l){for(;l.next();){if(1===l.tag())return l.getMessage();l.skip()}return null}function Ls(l,e,t,s,r,n){return.5*Math.abs(l*s+t*n+r*e-l*n-t*e-r*s)}function Ut(l,e,t,s){return l*s-t*e==0&&l*t+e*s>0}class mt extends Ke.Y{static fromBuffer(e,t,s=!1){const r=t.geometryType,n=function Rs(l){try{const t=new ws.A(new Uint8Array(l),new DataView(l));for(;t.next();){if(2===t.tag())return Es(t.getMessage());t.skip()}}catch(e){const t=new R.A("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});Cs.A.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(t)}return null}(e),a=function Os(l,e,t=!1){var s;const d=l.asUnsafe(),h=d.pos(),g=new ks;let v=0,p=0,w=null,C=null,M=null,O=!1;const P=[];for(;d.next();)switch(d.tag()){case 1:w=d.getString();break;case 3:C=d.getString();break;case 12:M=d.processMessage(Ht.ae);break;case 9:if(g.exceededTransferLimit=d.getBool(),g.exceededTransferLimit){g.offsets.geometry=t?new Float64Array(8e3):new Int32Array(8e3),g.centroid=t?new Float64Array(16e3):new Int32Array(16e3);for(let E=0;E<g.centroid.length;E++)g.centroid[E]=Bt}break;case 13:{const E=d.processMessage(Ht.cn);E.index=v++,P.push(E);break}case 15:{const E=d.getLength(),J=d.pos()+E;if(!g.exceededTransferLimit){const ie=g.centroid;g.offsets.geometry.push(0),ie.push(Bt),ie.push(Bt)}!O&&g.exceededTransferLimit&&(O=!0,g.offsets.attributes=t?new Float64Array(8e3*v):new Uint32Array(8e3*v));let re=p*v;for(;d.pos()<J&&d.next();)switch(d.tag()){case 1:{O?g.offsets.attributes[re++]=d.pos():g.offsets.attributes.push(d.pos());const L=d.getLength();d.skipLen(L);break}case 2:if(e){const L=d.getLength(),ie=d.pos()+L;for(;d.pos()<ie&&d.next();)switch(d.tag()){case 3:{d.getUInt32();const Be=d.getSInt64(),Ue=d.getSInt64();g.centroid[2*p]=Be,g.centroid[2*p+1]=Ue;break}default:d.skip()}}else{g.offsets.geometry[p]=d.pos();const L=d.getLength();g.vertexCount+=L,d.skipLen(L)}break;case 4:{const L=d.getLength(),ie=d.pos()+L;for(;d.pos()<ie&&d.next();)switch(d.tag()){case 3:{d.getUInt32();const Be=d.getSInt64(),Ue=d.getSInt64();g.centroid[2*p]=Be,g.centroid[2*p+1]=Ue;break}default:d.skip()}break}default:d.skip()}p++,g.hasFeatures=!0;break}default:d.skip()}const V=w||C;if(!V)throw new R.A("FeatureSet has no objectId or globalId field name");return g.fields=new ht.A(P),g.featureCount=p,g.fieldCount=v,g.objectIdFieldIndex=null===(s=g.fields.get(V))||void 0===s?void 0:s.index,g.transform=M,g.displayIds=new Uint32Array(g.featureCount),g.groupIds=new Uint16Array(g.featureCount),d.move(h),g}(n,"esriGeometryPoint"===r,s);return new mt(n,a,t)}constructor(e,t,s){super(s),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._parseCaches=new Array,this._geometryType=s.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints="esriGeometryPoint"===s.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";for(const t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+".";return e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const e=this._reader.clone(),t=new mt(e,this._header,this.metadata);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const e=this._header.centroid[2*this._featureIndex];return e===Zt?null:new B.A([],[e,this._header.centroid[2*this._featureIndex+1]])}_readGeometry(e=!1){if(void 0===this._cache.geometry){var t;let s=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Zt)return null;s=new B.A([],[this._header.centroid[2*this._featureIndex],this._header.centroid[2*this._featureIndex+1]])}else{const r=this._header.offsets.geometry[this._featureIndex],n=this._reader;if(0===r)return null;n.move(r);try{s=e?this._parseGeometryForDisplay(n):this._parseGeometry(n)}catch(a){return console.error("Failed to parse geometry!",a),null}}return 0===(null===(t=s)||void 0===t?void 0:t.coords.length)&&(s=null),this._cache.geometry=s,s}return this._cache.geometry}_readAttribute(e,t){var s;const r=this._header.fields.get(e);if(null==r)return;let n=this._readAttributeAtIndex(r.index);"esriFieldTypeTimestampOffset"===(null===(s=this.fields.get(e))||void 0===s?void 0:s.type)&&(n=this.parseTimestampOffset(n));const a=this._header.fields.isDateField(r.name);return t?null==n?n:a?new Date(n):n:n}_readAttributes(){const e={};for(const t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new Ms.P(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);const r=this._reader;r.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e]);const n=function Ds(l){const d=l.getLength(),h=l.pos()+d;for(;l.pos()<h&&l.next();)switch(l.tag()){case 1:return l.getString();case 2:return l.getFloat();case 3:return l.getDouble();case 4:return l.getSInt32();case 5:return l.getUInt32();case 6:return l.getInt64();case 7:return l.getUInt64();case 8:return l.getSInt64();case 9:return l.getBool();default:return l.skip(),null}return null}(r);return t.set(this._featureIndex,n),n}_readGeometryDeltaDecoded(e=!1){if(void 0===this._cache.unquantGeometry){const t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;const s=Kt(t.coords.length).decoded,r=t.clone(s),n=r.coords;let a=0;for(const o of r.lengths){for(let u=1;u<o;u++){const c=2*(a+u),d=2*(a+u-1);n[c]+=n[d],n[c+1]+=n[d+1]}a+=o}return this._cache.unquantGeometry=r,r}return this._cache.unquantGeometry}_parseGeometry(e){const r=e.asUnsafe(),n=r.getLength(),a=r.pos()+n,o=[],u=[];for(;r.pos()<a&&r.next();)switch(r.tag()){case 2:{const c=r.getUInt32(),d=r.pos()+c;for(;r.pos()<d;)u.push(r.getUInt32());break}case 3:{const c=r.getUInt32(),d=r.pos()+c;for(o.push(r.getSInt64()),o.push(r.getSInt64()),this.hasZ&&r.getSInt64(),this.hasM&&r.getSInt64();r.pos()<d;)o.push(r.getSInt64()),o.push(r.getSInt64()),this.hasZ&&r.getSInt64(),this.hasM&&r.getSInt64();break}default:r.skip()}return new B.A(u,o)}_parseGeometryForDisplay(e){const r=e.asUnsafe(),n=r.getLength(),a=r.pos()+n,o=[],u=[];let c=0,d=0,h=null,g=0;const v="esriGeometryPolygon"===this.geometryType;for(;r.pos()<a&&r.next();)switch(r.tag()){case 2:{const p=r.getUInt32(),A=r.pos()+p;for(;r.pos()<A;){const S=r.getUInt32();o.push(S),c+=S}h=Kt(2*c).delta;break}case 3:{r.getUInt32();const p=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,Ce.Lw)(h);for(const A of o)if(d+p*A>h.length)for(let S=0;S<A;S++)r.getSInt32(),r.getSInt32(),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();else if(v){const S=this.getAreaSimplificationThreshold(A,this._header.vertexCount);let I=2,b=1;const w=!1;let C=r.getSInt32(),M=r.getSInt32();h[d++]=C,h[d++]=M,this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();let O=r.getSInt32(),P=r.getSInt32();for(this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();I<A;){let V=r.getSInt32(),E=r.getSInt32();this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();const J=C+O,re=M+P;Ls(C,M,J,re,J+V,re+E)>=S?(g+=-.5*(J-C)*(re+M),b>1&&Ut(h[d-2],h[d-1],O,P)?(h[d-2]+=O,h[d-1]+=P):(h[d++]=O,h[d++]=P,b++),C=J,M=re):(V+=O,E+=P),O=V,P=E,I++}b<3||w?d-=2*b:(g+=-.5*(C+O-C)*(M+P+M),Ut(h[d-2],h[d-1],O,P)?(h[d-2]+=O,h[d-1]+=P,u.push(b)):(h[d++]=O,h[d++]=P,u.push(++b)))}else{let S=0,I=r.getSInt32(),b=r.getSInt32();this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32(),h[d++]=I,h[d++]=b,S+=1;for(let w=1;w<A;w++){const C=r.getSInt32(),M=r.getSInt32(),O=I+C,P=b+M;g+=-.5*(O-I)*(P+b),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32(),w>2&&Ut(h[d-2],h[d-1],C,M)?(h[d-2]+=C,h[d-1]+=M):(h[d++]=C,h[d++]=M,S+=1),I=O,b=P}u.push(S)}break}default:r.skip()}return this._cache.area=g,u.length?new B.A(u,h):null}}class vt{constructor(e,t){this.service=e,this._metadata=t}destroy(){}}function qt(){return(qt=(0,_.A)(function*(l){const e=new Ts.A;return yield e.open(l,{}),e})).apply(this,arguments)}class qs extends vt{constructor(e,t){super(e,t),this._portsOpen=function Us(l){return qt.apply(this,arguments)}(e.source).then(s=>this.client=s)}destroy(){this.client.close(),this.client=null}executeQuery(e,t){var s=this;return(0,_.A)(function*(){yield s._portsOpen;const r=yield s.client.invoke("queryFeatures",e.toJSON(),t);return k.fromFeatureSet(r,s._metadata)})()}}class js extends vt{executeQuery(e,t){var s=this;return(0,_.A)(function*(){const{data:r}=yield(0,gt.kS)(s.service.source,e,t);return mt.fromBuffer(r,s._metadata,!e.quantizationParameters)})()}}class Ns extends vt{executeQuery(e,t){var s=this;return(0,_.A)(function*(){var r;const{source:n,queryMetadata:a}=s.service;if(null!=e.quantizationParameters&&!a.capabilities.query.supportsQuantization){const c=e.clone(),d=(0,Qt.VV)(c.quantizationParameters);c.quantizationParameters=null;const{data:h}=yield(0,gt.eW)(n,c,s._metadata.spatialReference,t),g=(0,T.q3)(h,s._metadata.objectIdField);return(0,T.jH)(d,g),k.fromOptimizedFeatureSet(g,s._metadata)}const{data:u}=yield(0,gt.eW)(n,e,s._metadata.spatialReference,t);return"esriGeometryPoint"===s._metadata.geometryType&&(u.features=null===(r=u.features)||void 0===r?void 0:r.filter(c=>{if(null!=c.geometry){const d=c.geometry;return Number.isFinite(d.x)&&Number.isFinite(d.y)}return!0})),k.fromFeatureSet(u,s._metadata)})()}}class Ws extends vt{executeQuery(e,t){var s=this;return(0,_.A)(function*(){const{capabilities:r}=s.service.queryMetadata;if(e.quantizationParameters&&!r.query.supportsQuantization){const a=e.clone(),o=(0,Qt.VV)(a.quantizationParameters);a.quantizationParameters=null;const u=yield(0,Yt.I)(s.service.source,e,t);return(0,T.jH)(o,u),k.fromOptimizedFeatureSet(u,s._metadata)}const n=yield(0,Yt.I)(s.service.source,e,t);return k.fromOptimizedFeatureSet(n,s._metadata)})()}}class es extends Vt{constructor(e,t,s,r,n){var a,o;super(s),a=this,this._serviceInfo=e,this._queryInfo=t,this._metadata=r,this._eventLog=n,this._queue=new Re.e({concurrency:16,process:(o=(0,_.A)(function*(u){var c;const d={signal:null===(c=u.options)||void 0===c?void 0:c.signal,query:u.query.customParameters};return a._adapter.executeQuery(u.query.inner,d)}),function(c){return o.apply(this,arguments)})}),this._adapter=function Bs(l,e){switch(l.type){case"memory":return new qs(l,e);case"ogc":return new Ws(l,e);case"feature-service":return l.queryMetadata.capabilities.query.supportsFormatPBF&&(0,y.A)("featurelayer-pbf")?new js(l,e):new Ns(l,e)}}(e,r)}updateFields(e){var t=this;return(0,_.A)(function*(){t._queryInfo.updateFields(e);const s=Array.from(t._store.chunks()).map(function(){var n=(0,_.A)(function*(a){const o=Gt.A.fromJSON(a.queryInfo.queryJSON);if(o)try{return yield t._tryUpdateFields(a.reader,o),null}catch(u){return u}});return function(a){return n.apply(this,arguments)}}()),r=(yield Promise.all(s)).filter(n=>n);if(r.length)throw new R.A("featurelayer-query","Encountered errors when downloading fields",{errors:r})})()}queryOverride({edits:e}){var t=this;return(0,_.A)(function*(){const s=[],r=[];for(const o of e.removed)null!=o.objectId&&-1!==o.objectId?s.push(o.objectId):r.push(o.globalId);r.length&&s.push(...t._mapGlobalIdsToObjectIds(r));const n=e.addOrModified.map(({objectId:o})=>o);let a;if(n.length){const o=t._queryInfo.createQuery({objectIds:n});a=yield t._fetch(o)}else a=k.empty(t._metadata);return{reader:a,removed:s}})()}_mapGlobalIdsToObjectIds(e){const t=new Set(e),s=this._metadata.globalIdField;if(null==s)throw new Error("InternalError: Recieved an edit with globalIds, but not supported by the service");const r=[];return this._store.forEachUnsafe(n=>{const a=n.readAttribute(s);t.has(a)&&r.push(n.getObjectId())}),r}_fetch(e,t){var s=this;return(0,_.A)(function*(){const r=yield s._enqueue(e,t);return yield s._tryUpdateFields(r,e.inner),r})()}_tryUpdateFields(e,t){var s=this;return(0,_.A)(function*(){const r=s._queryInfo.createPatchFieldsQuery(t,e);if(!r)return;const n=yield s._enqueue(r,s._options);e.joinAttributes(n)})()}_enqueue(e,t){var s=this;return(0,_.A)(function*(){return s._eventLog.onEvent({type:"fetchStart"}),s._queue.push({query:e,options:t}).finally(()=>{s._eventLog.onEvent({type:"fetchEnd",done:0===s._queue.length})})})()}}class ts extends es{constructor(){super(...arguments),this._chunksById=new Map}unload(e){this._removeChunks(e.tile)}_addChunk(e){const t=e.tile.id;this._chunksById.has(t)||this._chunksById.set(t,[]);const s=e.size();(s||e.first||e.end)&&((0,y.A)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] ATileLoadStrategy.addChunk [count=${s}]`),this._chunksById.get(t).push(e),this._store.insert(e))}_removeChunks(e){var t;const s=null!==(t=this._chunksById.get(e.key.id))&&void 0!==t?t:[];for(const r of s)(0,y.A)("esri-2d-update-debug")&&console.debug(`Tile[${e.key.id}] Chunk[${r.chunkId}] ATileLoadStrategy.removeChunk`),this._store.remove(r);this._chunksById.delete(e.key.id)}}class ss extends rt{constructor(e,t,s,r,n,a){var o,u;super(),this._reader=e,this._queryJSON=t,this._tile=s,this._sourceTile=r,this._sourceTileDepth=n,this._end=a,this.chunkId=`${this._tile.key.id}.${null===(o=this._sourceTile)||void 0===o?void 0:o.key.id}${this._end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${null===(u=this._sourceTile)||void 0===u?void 0:u.key.normalizedId}${this._end?"e":""}`}get queryInfo(){var e;return{type:"drill-down-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:null===(e=this._sourceTile)||void 0===e?void 0:e.key.id,size:this.size(),end:this.end}}get first(){return 0===this._sourceTileDepth}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class Gs{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,(0,m.u7)(e.options,()=>this._controller.abort()),(0,m.u7)(t,()=>this._controller.abort())}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}}class zs extends ts{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}load(e){var t=this;return(0,_.A)(function*(){t._loadStates.has(e.key.id)||t._loadStates.set(e.key.id,new Gs(e,t._options));const s=t._loadStates.get(e.key.id);let r;try{var o,n=!1,a=!1;try{for(var c,u=(0,Y.A)(t._fetchChunkInfos(s,e.tile,0));n=!(c=yield u.next()).done;n=!1){const h=c.value;{const{queryJSON:g,reader:v,sourceTile:p,sourceTileDepth:A,tile:S}=h,I=new ss(v,g,S,p,A,!1);(0,m.Te)(e.options),t._addChunk(I)}}}catch(h){a=!0,o=h}finally{try{n&&null!=u.return&&(yield u.return())}finally{if(a)throw o}}}catch(h){r=h}const d=new ss(k.empty(t._metadata),null,e.tile,null,-1,!0);if(t._addChunk(d),r)throw r})()}unload(e){super.unload(e),this._loadStates.delete(e.key.id)}_fetchChunkInfos(e,t,s){var r=this;return(0,G.A)(function*(){let n=e.get(t.id);const a=!!n;if(n||(n=yield(0,H.A)(r._fetchChunkInfo(e,t,s)),e.set(t.id,n)),n.reader.exceededTransferLimit&&s<(0,y.A)("featurelayer-query-max-depth"))for(const o of t.createChildTiles())yield*de((0,Y.A)(r._fetchChunkInfos(e,o,s+1)));else a||(yield n)})()}_fetchChunkInfo(e,t,s){var r=this;return(0,_.A)(function*(){const n=e.subscription.tile.getQuantizationParameters(),a=r._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:!1,quantizationParameters:n});return{reader:yield r._fetch(a,e.subscription.options),queryJSON:a.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:s}})()}}class rs extends rt{constructor(e,t,s,r,n){super(),this._reader=e,this._queryJSON=t,this._tile=s,this._page=r,this._end=n,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?"e":""}`}get queryInfo(){return{type:"paged-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class $s{constructor(e,t){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,(0,m.u7)(e.options,()=>this._controller.abort()),(0,m.u7)(t,()=>this._controller.abort())}resetAbortController(){this._controller=new AbortController}get pageStart(){let e=-1;for(const t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}}class Vs extends ts{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}load(e){var t=this;return(0,_.A)(function*(){t._loadStates.has(e.key.id)||t._loadStates.set(e.key.id,new $s(e,t._options));const s=t._loadStates.get(e.key.id);let r;s.resetAbortController();try{yield t._fetchPages(s)}catch(a){r=a}const n=new rs(k.empty(t._metadata),null,e.tile,-1,!0);if((0,m.G4)(s.options)||t._addChunk(n),r)throw r})()}unload(e){super.unload(e),this._loadStates.delete(e.key.id)}_fetchPages(e){var t=this;return(0,_.A)(function*(){let n=0,a=e.pageStart,o=1;for(;n<20&&!e.done;){const u=[];for(let d=0;d<o;d++)u.push(t._fetchChunk(e,a++));const c=yield Promise.all(u);for(const d of c)(0!==d.size()||d.first)&&(e.add(d.page,!d.reader.exceededTransferLimit),(0,m.Te)(e.options),t._addChunk(d));n++,o=Math.min(o+1,4)}})()}_fetchChunk(e,t){var s=this;return(0,_.A)(function*(){const r=e.subscription.tile,n=s._queryInfo.createPagedTileQuery(r,t),a=yield s._fetch(n,e.options);return new rs(a,n.inner.toJSON(),r,t,!1)})()}}class is extends rt{constructor(e,t,s,r){super(),this._reader=e,this._queryJSON=t,this._page=s,this._end=r,this.chunkId=`${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class Qs extends es{constructor(e,t,s,r,n,a){super(e,t,s,n,a),this._random=new q.A(1e3),this._featureCount=r}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(e){}_downloadPages(e){var t=this;return(0,_.A)(function*(){const s=Math.ceil(e/t._queryInfo.pageSize),r=Array.from({length:s},(u,c)=>c).sort((u,c)=>t._random.getInt()-t._random.getInt()),n=yield Promise.all(r.map(u=>t._downloadPage(u))),a=new is(k.empty(t._metadata),null,-1,!0);t._store.insert(a);const o=n.filter(u=>u);if(o.length)throw new R.A("featurelayer-query","Encountered errors when downloading data",{errors:o})})()}_downloadPage(e){var t=this;return(0,_.A)(function*(){try{const s=t._queryInfo.createPagedQuery(e),r=yield t._fetch(s,t._options),n=new is(r,s.inner.toJSON(),e,!1);return(0,m.Te)(t._options),t._store.insert(n),null}catch(s){return s}})()}}var ns=f(15590),Ys=f(69287);const as="__esri_timestamp__";class Zs{constructor(e,t,s,r,n=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=r,this.store=e,this.objectIdField=t,this.purgeInterval=n,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}removeById(e){this._removed.push(e)}removeByTrackId(e){const t=this._trackIdToObservations.get(e);if(t)for(const s of t.entries)this._removed.push(s)}add(e){if(this._useGeneratedIds){const o=this._nextId();e.attributes[this.objectIdField]=o,e.objectId=o}else e.objectId=e.attributes[this.objectIdField];const t=e.objectId;if(this._addOrUpdated.set(t,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return null==this._trackIdLessObservations&&(this._trackIdLessObservations=new ns.A(1e5)),void this._trackIdLessObservations.enqueue(t);const s=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){var r;const o=null!=(null===(r=this._purgeOptions)||void 0===r?void 0:r.maxObservations)?this._purgeOptions.maxObservations:1e3,u=(0,Ys.qE)(o,0,1e3);this._trackIdToObservations.set(s,new ns.A(u))}const n=this._trackIdToObservations.get(s),a=null==n?void 0:n.enqueue(t);null!=a&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const r=[];if(null!=t)for(const a of t){const o=this.store.removeById(a);null!=o&&r.push(o)}const n=[];if(null!=e){const a=new Set(null!=t?t:[]);for(const o of e)a.has(o.objectId)||(o.attributes[as]=s,this.store.add(o),n.push(o))}return!!(n.length||null!=r&&r.length)&&(this.store.update(n,r),!0)}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach(s=>e[t++]=s),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;null!=t&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(t>e.displayCount&&s.size){const r=s.dequeue();this._removed.push(r),t--}if(null!=this._trackIdLessObservations){let s=t-e.displayCount;for(;s-- >0;){const r=this._trackIdLessObservations.dequeue();null!=r&&this._removed.push(r)}}}}_purgeByAge(e){var t;const s=null===(t=this._timeInfo)||void 0===t?void 0:t.startTimeField;if(!e.age||!s)return;const n=this._maxAge-60*e.age*1e3;this.store.forEach(a=>{a.attributes[s]<n&&this._removed.push(a.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const s=e-60*t.ageReceived*1e3;this.store.forEach(r=>{r.attributes[as]<s&&this._removed.push(r.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)})}}var Xs=f(69809);let Qe=class extends zt.A{constructor(l){super(l)}get connectionStatus(){var l;return null===(l=this.connection)||void 0===l?void 0:l.connectionStatus}get errorString(){var l;return null===(l=this.connection)||void 0===l?void 0:l.errorString}};(0,$e._)([(0,pt.MZ)()],Qe.prototype,"connection",void 0),(0,$e._)([(0,pt.MZ)()],Qe.prototype,"connectionStatus",null),(0,$e._)([(0,pt.MZ)()],Qe.prototype,"errorString",null),Qe=(0,$e._)([(0,$t.$)("esri.views.2d.layers.features.sources.StreamConnectionState")],Qe);class Js{constructor(e,t){this._metadata=e,this._onUpdate=t,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return k.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(e){this._objectIdToFeature.set(e.objectId,e)}forEach(e){this._objectIdToFeature.forEach(e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),t):null}clear(){this._objectIdToFeature=new Map}update(e,t){var s;this._onUpdate(null!==(s=null==e?void 0:e.length)&&void 0!==s?s:0)}}class Ks extends rt{constructor(e){super(),this._reader=e,this.chunkId="stream-chunk",this.normalizedChunkId="stream-chunk"}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:"stream",chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class er extends Vt{constructor(e,t,s,r,n){super(s),this._service=e,this._dataFilter=t,this._streamOptions=r,this._metadata=n,this._connectionState=new Qe,this._forceRefresh=!1,this.events=new nt.A;const{objectIdField:a,timeInfo:o}=this._metadata,{purgeOptions:u}=t;this._stagingStore=new Js(this._metadata,c=>this.events.emit("features-updated",c)),this._manager=new Zs(this._stagingStore,a,o,u),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){var e;return null===(e=this._connectionState)||void 0===e?void 0:e.errorString}refresh(){var e=this;return(0,_.A)(function*(){const t=null!=e._chunk;(e._manager.checkForUpdates()||!t||e._forceRefresh)&&(e._chunk&&e._store.remove(e._chunk),e._forceRefresh=!1,e._chunk=new Ks(e._stagingStore.reader),e._store.insert(e._chunk)),e.events.emit("tick")})()}updateFields(e){return(0,_.A)(function*(){throw new Error("Updating available fields not supported for StreamLayer")})()}load(e){return(0,_.A)(function*(){})()}unload(e){}disconnect(){var e;this._connection=(0,Ce.pR)(this._connection),this._connectionState.connection=null,null===(e=this._handlesGroup)||void 0===e||e.remove()}connect(){if(null!=this._connection)return;const{geometryType:e,spatialReference:t}=this._metadata,{maxReconnectionAttempts:s,maxReconnectionInterval:r,geometryDefinition:n,definitionExpression:a,customParameters:o}=this._dataFilter;this._connection=(0,Xs.createConnection)(this._service.source,t,this._streamOptions.outSR,e,a,n,s,r,o),this._handlesGroup=(0,x.vE)([this._connection.on("data-received",u=>this._onFeature(u)),this._connection.on("message-received",u=>this._onWebSocketMessage(u))]),this._connectionState.connection=this._connection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(e){var t;null===(t=this._connection)||void 0===t||t.updateCustomParameters(e)}sendMessageToSocket(e){var t;null===(t=this._connection)||void 0===t||t.sendMessageToSocket(e)}sendMessageToClient(e){var t;null===(t=this._connection)||void 0===t||t.sendMessageToClient(e)}_onWebSocketMessage(e){if("type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this.clear()}this.events.emit("message-received",e)}_onFeature(e){try{this._manager.add(e),this.events.emit("data-received",e)}catch{}}}var tr=f(54661);class sr{constructor(e){this._onChange=e,this._chunks=new Map,this._chunksToRemove=[],this.events=new nt.A,this.featureAdapter=new tr.Z}destroy(){this.clear()}clear(){for(const e of this._chunks.values())this._chunksToRemove.push(e);this._chunks.clear(),null!=this._overrideChunk&&this._chunksToRemove.push(this._overrideChunk),this._overrideChunk=null}*chunks(){this._overrideChunk&&(yield this._overrideChunk),yield*this._chunks.values()}insert(e){var t;(0,y.A)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.insert`),null!==(t=this._overrideChunk)&&void 0!==t&&t.overridenIds.size&&e.reader.removeIds(this._overrideChunk.overridenIds),this._chunks.set(e.chunkId,e),this.events.emit("changed"),this._onChange()}remove(e){(0,y.A)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.remove`),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}cleanupRemovedChunks(){const e=this._chunksToRemove;return this._chunksToRemove=[],e}applyOverrides(e,t){null==this._overrideChunk&&(this._overrideChunk=new Wt(t)),this._overrideChunk.applyOverrides(e);for(const s of this._chunks.values())s.reader.removeIds(this._overrideChunk.overridenIds),s.invalidate()}forEach(e){const t=new Set;for(const s of this.chunks()){const r=s.reader.getCursor();for(;r.next();){const n=r.getObjectId();t.has(n)||(e(r.copy()),t.add(n))}}}forEachUnsafe(e){const t=new Set;for(const s of this.chunks()){const r=s.reader.getCursor();for(;r.next();){const n=r.getObjectId();t.has(n)||(e(r),t.add(n))}}}forEachInBounds(e,t){const s=new Set;for(const r of this.chunks()){const n=r.queryFeaturesInBounds(e);for(;n.next();){const a=n.getObjectId();s.has(a)||(t(n.copy()),s.add(a))}}}forEachBounds(e,t){const s=(0,at.vt)();for(const r of e)r.getBounds(s)&&t(s)}}var rr=f(35547);class ir{constructor(e,t,s,r){this._aggregateAdapter=e,this._subscriptions=t,this._onChange=s,this._connection=r,this._updateTracking=new rr.F({debugName:"FeatureSource"}),this._didInvalidateData=!1,this._store=new sr(this._onChange)}destroy(){var e,t;null!==(e=this._strategy)&&void 0!==e&&e.destroy(),this._store.destroy(),null===(t=this._streamMessenger)||void 0===t||t.destroy()}get _eventLog(){return this._connection.eventLog}get metadata(){if(!this._metadata)throw new Error("InternalError: Metadata not defined. Was update called?");return this._metadata}get service(){return this._schema.service}get store(){return this._store}get streamMessenger(){return null==this._streamMessenger&&this._initStreamMessenger(),this._streamMessenger}get statistics(){return Et.from(this._store)}get updateTracking(){return this._updateTracking}get queryEngine(){if(!this._queryEngine){if(!this._schema)return null;const{dataFilter:e}=this._schema.mutable,s=this._metadata;this._queryEngine=new It.d({featureStore:this._store,fieldsIndex:s.fieldsIndex,geometryType:s.geometryType,objectIdField:s.objectIdField,hasM:!1,hasZ:!1,spatialReference:e.outSpatialReference,cacheSpatialQueries:!0,aggregateAdapter:this._aggregateAdapter,timeInfo:s.timeInfo,definitionExpression:e.definitionExpression,availableFields:this._schema.mutable.availableFields})}return this._queryEngine}get isStream(){return"stream"===this._schema.type}chunks(){return Array.from(this._store.chunks())}cleanupRemovedChunks(){return this._store.cleanupRemovedChunks()}onSubscribe(e){var t;this._eventLog.onEvent({type:"subscribe",tile:e.tile.id});const s=null===(t=this._strategy)||void 0===t?void 0:t.load(e);s&&(s.then(()=>this._eventLog.onEvent({type:"loaded",tile:e.tile.id})).catch(r=>this._eventLog.onEvent({type:"error",tile:e.tile.id,error:r})),this._updateTracking.addPromise(s))}onResume(e){var t;this._updateTracking.addPromise((0,m.QZ)(null===(t=this._strategy)||void 0===t?void 0:t.load(e)))}onUnsubscribe(e){var t;this._eventLog.onEvent({type:"unsubscribe",tile:e.tile.id}),null===(t=this._strategy)||void 0===t||t.unload(e)}getOverride(e){return this._updateTracking.addPromise(this._doGetOverride(e))}applyOverride(e){this._didInvalidateData=!0,this._store.applyOverrides(e,this.metadata)}update(e,t){var s=this;return(0,_.A)(function*(){var r,n,a;const o=e.source,u=(0,$.Ui)(null===(r=s._schema)||void 0===r?void 0:r.mutable,o.mutable);if(!u)return!1;if((0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${t}] FeatureSource.update`,{changes:u}),s._schema=o,s._metadata=new Je.i(s._schema.service.metadata),null!==(n=s._queryEngine)&&void 0!==n&&n.destroy(),s._queryEngine=null,"feature"===s._schema.type&&null!=s._schema.service.queryMetadata.lastEditDate&&(s._lastEditDate=s._schema.service.queryMetadata.lastEditDate),null==s._streamMessenger&&"stream"===s._schema.type&&s._initStreamMessenger(),(0,$.w2)(u,"sourceRefreshVersion")&&null!==(a=s._strategy)&&void 0!==a&&a.refresh)return yield s._strategy.refresh(),!0;if("feature"===o.type&&(0,$.w2)(u,"availableFields")){if((yield s._queryLastEditDateChanged())||s._didInvalidateData)s._didInvalidateData=!1,yield s._updateStrategy(t);else{s._eventLog.onEvent({type:"updateFieldsStart"});try{yield s._strategy.updateFields(o.mutable.availableFields),s._eventLog.onEvent({type:"updateFieldsEnd"})}catch(c){s._eventLog.onEvent({type:"updateFieldsError",error:c})}}return!1}return!(!(0,$.Mj)(u,"dataFilter")&&!(0,$.Mj)(u,"sourceRefreshVersion")||(yield s._updateStrategy(t),0))})()}_initStreamMessenger(){null==this._streamMessenger&&(this._streamMessenger=new yt(this._connection))}_doGetOverride(e){var t=this;return(0,_.A)(function*(){return t._strategy.queryOverride(e)})()}_queryLastEditDateChanged(){var e=this;return(0,_.A)(function*(){if(null==e._lastEditDate)return!1;const t=e._schema.service.source,s={...t.query,f:"json"},r=(yield(0,bs.A)(t.path,{query:s,responseType:"json"})).data.editingInfo.lastEditDate;return r!==e._lastEditDate&&(e._lastEditDate=r,!0)})()}_createStrategy(){var e=this;return(0,_.A)(function*(){const t=e.service,s="isSourceHosted"in t&&t.isSourceHosted,r=Array.isArray(t.source),a=s||r||t.source&&"collection"in t.source;if("stream"===e._schema.type){const c=new er(e._schema.service,e._schema.mutable.dataFilter,e._store,{outSR:e._schema.mutable.dataFilter.outSpatialReference},e.metadata);return e._streamMessenger.strategy=c,c}const o=Lt.fromSchema(e._schema,e._metadata),u=yield e._supportSnapshotMode(e._schema,o);return u?new Qs(e._schema.service,o,e._store,u.featureCount,e.metadata,e._eventLog):a?new Vs(e._schema.service,o,e._store,e.metadata,e._eventLog):new zs(e._schema.service,o,e._store,e.metadata,e._eventLog)})()}_updateStrategy(e){var t=this;return(0,_.A)(function*(){var s;const r=yield t._createStrategy();t._eventLog.onEvent({type:"updateStrategyStart",about:r.about});const n=!!t._strategy;t._store.clear(),null!==(s=t._strategy)&&void 0!==s&&s.destroy(),t._strategy=r,(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureSource.updateStrategy`,{strategy:r});const a=Array.from(t._subscriptions.values());if(!a.length)return void t._eventLog.onEvent({type:"updateStrategyEnd"});const o=Promise.all(a.map(u=>t._strategy.load(u).then(()=>t._eventLog.onEvent({type:"loaded",tile:u.tile.id})).catch(c=>t._eventLog.onEvent({type:"error",tile:u.tile.id,error:c}))));t._updateTracking.addPromise(o);try{n&&(yield o)}catch(u){(0,m.jH)(u)}t._eventLog.onEvent({type:"updateStrategyEnd"}),(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureSource.updateStrategyEnd`,{strategy:r})})()}_supportSnapshotMode(e,t){return(0,_.A)(function*(){const{queryMetadata:s}=e.service,r=s.snapshotInfo;if(!r||!r.supportsSnapshotMinThreshold||!r.snapshotCountThresholds)return null;const n=e.service.source,a=t.createQuery();a.inner.orderByFields=[],a.inner.returnGeometry=!1;const o=(yield(0,gt.gW)(n,a.inner,{query:a.customParameters})).data.count,{min:u,max:c}=r.snapshotCountThresholds;return o<=u||r.supportsSnapshotMaxThreshold&&o<c?{featureCount:o}:null})()}}var nr=f(86807);class ar{constructor(e,t){this._handles=new nr.A,this._abortController=new AbortController,this._resolver=(0,m.Tw)(),this._isDone=!1,this._aborted=!1,this.tile=e,this._version=t,this._handles.add([])}destroy(){this.pause(),this._handles.destroy()}get key(){return this.tile.key}get version(){return this._version}set version(e){this._version=e}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}get paused(){return this._aborted}resume(){this._abortController=new AbortController,this._aborted=!1}pause(){this._aborted||(this._aborted=!0,this._abortController.abort())}}var or=f(97233);class ur{constructor(e){this.edit=e,this.resolver=(0,m.Tw)()}}class lr{constructor(e,t){this.schema=e,this.version=t,this.resolver=(0,m.Tw)()}}class dr{constructor(){this._aggregateAdapter={getFeatureObjectIds:e=>this._processor.getFeatureObjectIdsForAggregate(e)},this._subscriptions=new Map,this._updateRequested=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor.destroy(),this._source.destroy(),this._handles.remove(),this._editState=null,this._tileInfoView=null}onDetach(){this.destroy(),this._initialize(this._connection)}_initialize(e){this._source=new ir(this._aggregateAdapter,this._subscriptions,()=>this._requestUpdate(),e),this._processor=new Is(e,this._source),this._handles=(0,x.vE)([(0,D.wB)(()=>this._source.updateTracking.updating,()=>{this._requestUpdate(),this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})})])}set remoteClient(e){this._connection=new Ae(e),this._initialize(this._connection)}get features(){const e=this._source.queryEngine;if(!e)throw new R.A("no-queryEngine","No query engine defined");return e}get aggregates(){const e=this._processor.aggregateQueryEngine;if(!e)throw new R.A("no-queryEngine","No aggregate query engine defined");return e}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getDisplayFeatures(e){return this._processor.getDisplayFeatures(e)}updateSchema(e,t){var s=this;return(0,_.A)(function*(){return(0,y.A)("esri-2d-update-debug")&&s._updateSchemaState&&console.error("InternalError: Schema already updating"),s._updateSchemaState=new lr(e,t),s._requestUpdate(),s._updateSchemaState.resolver.promise})()}updateSubscriptions(e){this._updateSubscriptionRequests.push(e),this._requestUpdate()}updateHighlight(e){this._updateHighlightRequests.push(e),this._requestUpdate()}onEdits(e){var t=this;return(0,_.A)(function*(){if(null!=t._editState)throw new R.A("InternalError - Already processing an edit");t._editState=new ur(e);const s=t._editState.resolver.promise;return t._requestUpdate(),s})()}queryStatistics(){return this._source.statistics.toJSON()}queryVisibleFeatures(e,t){var s=this;return(0,_.A)(function*(){return s.features.executeQuery(e,t)})()}queryHeatmapStatistics(e){var t=this;return(0,_.A)(function*(){var s;const r=Math.round((0,Z.Lz)(e.radius));let n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const o="string"==typeof e.fieldOffset,u=null!==(s=e.fieldOffset)&&void 0!==s?s:0,c=Array.from(t._subscriptions.values()),d=t._source.chunks(),h=r**2,g=3/(Math.PI*h),v=2*r,p=Math.ceil(F.CQ/v);for(const A of c){const S=A.tile,I=new Float64Array(p*p);for(const b of d){const w=b.getTileReader(S);if(!w)continue;const C=w.getCursor();for(;C.next();){let M=1;if(null!=e.field){const L=C.readAttribute(e.field);M=o?-1*+L:+L+u}const O=C.readXForDisplay()/v,P=C.readYForDisplay()/v,V=Math.floor(O),E=Math.floor(P);if(V<0||E<0||V>=p||E>=p)continue;const J=((.5+V-O)*v)**2+((.5+E-P)*v)**2;J>h||(I[E+V*p]+=M*(g*(1-J/h)**2))}}for(let b=0;b<I.length;b++)n=Math.min(n,I[b]),a=Math.max(a,I[b])}return{max:a,min:n}})()}getSampleFeatures(e){var t=this;return(0,_.A)(function*(){const s=t._source.chunks();if(s.reduce((c,d)=>c+d.size(),0)<=e.minFeatureCount){if(!t._source.updateTracking.updating){const c=[];return t._source.store.forEachUnsafe(d=>c.push(d.readLegacyFeatureWorldSpace())),c}return null}const r=new Set,n=[],a=s.map(c=>c.reader.getCursor()),o=new q.A,u=3*e.sampleSize;for(let c=0;c<u&&n.length<e.sampleSize;c++){const d=a[o.getIntRange(0,s.length-1)];if(0===d.getSize())continue;const h=o.getIntRange(0,d.getSize()-1);d.setIndex(h);const g=d.getObjectId();r.has(g)||(r.add(g),n.push(d.readLegacyFeatureWorldSpace()))}return n.length>=e.sampleSize?n:null})()}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,(0,Q.d)(()=>this._scheduleNextUpdate()))}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=this._doUpdate().finally(()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()}),this._updateRequested=!1))}_subscribe(e){const t=e.tileId;if(this._subscriptions.has(t)){const n=this._subscriptions.get(t);return void(n.paused&&((0,y.A)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.resume`),n.resume(),n.version=e.version,this._source.onResume(n)))}(0,y.A)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.subscribe`);const s=new or.F(this._tileInfoView,t),r=new ar(s,e.version);this._subscriptions.set(t,r),this._source.onSubscribe(r),this._processor.onSubscribe(r)}_unsubscribe(e){const t=this._subscriptions.get(e);t&&((0,y.A)("esri-2d-update-debug")&&console.debug(`Tile[${e}] Pipeline.unsubscribe`),this._source.onUnsubscribe(t),this._processor.onUnsubscribe(t),this._subscriptions.delete(t.key.id),t.destroy())}_pauseSubscription(e){const t=this._subscriptions.get(e);t&&((0,y.A)("esri-2d-update-debug")&&console.debug(`Tile[${e}] Pipeline.pause`),t.pause())}_doUpdate(){var e=this;return(0,_.A)(function*(){if((0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateStart"),yield e._connection.layerView.setUpdating({data:e._source.updateTracking.updating,pipeline:!0}),e._updateSubscriptionRequests.length){const n=e._updateSubscriptionRequests;e._updateSubscriptionRequests=[];for(const a of n)e._doUpdateSubscriptions(a)}const t=e._updateSchemaState;if(e._updateSchemaState=null,null!=t){const{schema:n,version:a}=t;yield e._doUpdateSchema(n,a)}const s=e._editState;if(e._editState=null,null!=s){(0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline.applyEditOverride",s.edit);const n=yield e._source.getOverride(s.edit);yield e._processor.applyOverride(n),(0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline.endEditOverride",s.edit)}if(e._updateHighlightRequests.length){const n=e._updateHighlightRequests;e._updateHighlightRequests=[];for(const a of n)e._processor.updateHighlight(a)}const r=e._source.cleanupRemovedChunks();e._processor.removeChunks(r);try{e._subscriptions.size&&((0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksStart"),yield e._processor.updateChunks(),(0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksEnd"))}catch(n){(0,m.jH)(n)}null!=s&&s.resolver.resolve(),null!=t&&t.resolver.resolve(),e._updateRequested?((0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=true]"),yield e._connection.layerView.setUpdating({data:e._source.updateTracking.updating,pipeline:!0})):((0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=false, After flush]"),yield e._connection.layerView.setUpdating({data:e._source.updateTracking.updating,pipeline:e._updateRequested}))})()}_doUpdateSchema(e,t){var s=this;return(0,_.A)(function*(){var r;if((0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${t}] Pipeline.updateStart`,{schema:e}),!s._tileInfoView){const a=Se.A.fromJSON(e.source.tileInfoJSON);s._tileInfoView=new ce.A(a)}const n={tileInfo:null===(r=s._tileInfoView)||void 0===r?void 0:r.tileInfo};try{const a=yield s._source.update(e,t),o=Array.from(s._subscriptions.values());yield s._processor.update(e,t,n,a,o)}catch(a){console.error(a)}(0,y.A)("esri-2d-update-debug")&&console.debug(`Version[${t}] Pipeline.updateEnd`)})()}_doUpdateSubscriptions(e){if((0,y.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateSubscriptions",e),!this._tileInfoView){const t=Se.A.fromJSON(e.tileInfoJSON);this._tileInfoView=new ce.A(t)}for(const t of e.subscribe)this._subscribe(t);for(const t of e.unsubscribe)this._unsubscribe(t);if((0,y.A)("featurelayer-query-pausing-enabled"))for(const t of e.pause)this._pauseSubscription(t)}}},36952:(qe,N,f)=>{function _(R,x,y,Q){const m=R.clone(),q=1<<m.level,D=m.col+x,Z=m.row+y;return Q&&D<0?(m.col=D+q,m.world-=1):D>=q?(m.col=D-q,m.world+=1):m.col=D,m.row=Z,m}f.d(N,{K:()=>_})},30454:(qe,N,f)=>{f.d(N,{_:()=>_});class _{constructor(x,y,Q,m,q,D=!1,Z=0){this.name=x,this.count=y,this.type=Q,this.offset=m,this.stride=q,this.normalized=D,this.divisor=Z}}}}]);