"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2190],{69809:(J,R,i)=>{i.r(R),i.d(R,{createConnection:()=>o});var g=i(10467),m=i(8189),S=(i(21152),i(89563)),u=i(5922),y=i(35150),w=i(56492),k=i(45272),P=(i(3248),i(40707),i(76576)),F=i(85211),W=i(23743),j=i(42425);let M=class extends j.A.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new u.A("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,m._)([(0,F.MZ)({readOnly:!0})],M.prototype,"connectionError",null),M=(0,m._)([(0,P.$)("esri.layers.support.StreamConnection")],M);const N=M;var x,e;(e=x||(x={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let C=class extends N{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,W.N)(t,r,n),this._open()}normalizeCtorArgs(){return{}}_open(){var e=this;return(0,g.A)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case x.CONNECTING:case x.OPEN:return"connected";case x.CLOSING:case x.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}_tryCreateWebSocket(e=this._config.source.path,t=1e3,n=0){var r=this;return(0,g.A)(function*(){try{var l;if(r.destroyed)return;const c=(0,k.a6)(e,null!==(l=r._config.customParameters)&&void 0!==l?l:{});r._websocket=yield r._createWebSocket(c),r.notifyChange("connectionStatus")}catch(c){const f=t/1e3;return r._config.maxReconnectionAttempts&&n>=r._config.maxReconnectionAttempts?(y.A.getLogger(r).error(new u.A("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void r.destroy()):(y.A.getLogger(r).error(new u.A("websocket-connection",`Failed to connect. Attempting to reconnect in ${f}s`,c)),yield(0,w.Pl)(t),r._tryCreateWebSocket(e,Math.min(1.5*t,1e3*r._config.maxReconnectionInterval),n+1))}})()}_setWebSocketJSONParseHandler(e){e.onmessage=t=>{try{const n=JSON.parse(t.data);this._onMessage(n)}catch(n){return void y.A.getLogger(this).error(new u.A("websocket-connection","Failed to parse message, invalid JSON",{error:n}))}}}_createWebSocket(e){return new Promise((t,n)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=l=>this._onClose(l),r.onerror=l=>this._onError(l),this._setWebSocketJSONParseHandler(r),t(r)},r.onclose=l=>{r.onopen=r.onclose=null,n(l)}})}_handshake(e=1e4){var t=this;return(0,g.A)(function*(){const n=t._websocket;if(null==n)return;const r=(0,w.Tw)(),l=n.onmessage,{filter:c,outFields:f,spatialReference:p}=t._config;return r.timeout(e),n.onmessage=A=>{var E;let v=null;try{v=JSON.parse(A.data)}catch{}v&&"object"==typeof v||(y.A.getLogger(t).error(new u.A("websocket-connection","Protocol violation. Handshake failed - malformed message",A.data)),r.reject(),t.destroy()),(null===(E=v.spatialReference)||void 0===E?void 0:E.wkid)!==(null==p?void 0:p.wkid)&&(y.A.getLogger(t).error(new u.A("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${p.wkid}`,A.data)),r.reject(),t.destroy()),"json"!==v.format&&(y.A.getLogger(t).error(new u.A("websocket-connection","Protocol violation. Handshake failed - format is not set",A.data)),r.reject(),t.destroy()),c&&v.filter!==c&&y.A.getLogger(t).error(new u.A("websocket-connection","Tried to set filter, but server doesn't support it")),f&&v.outFields!==f&&y.A.getLogger(t).error(new u.A("websocket-connection","Tried to set outFields, but server doesn't support it")),n.onmessage=l;for(const D of t._outstandingMessages)n.send(JSON.stringify(D));t._outstandingMessages=[],r.resolve()},n.send(JSON.stringify({filter:c,outFields:f,format:"json",spatialReference:{wkid:p.wkid}})),r.promise})()}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),y.A.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&y.A.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,m._)([(0,F.MZ)()],C.prototype,"connectionStatus",null),(0,m._)([(0,F.MZ)()],C.prototype,"errorString",void 0),C=(0,m._)([(0,P.$)("esri.layers.graphics.sources.connections.WebSocketConnection")],C);var I=i(1277),$=i(87086),L=i(61320),b=i(32034);const B={maxQueryDepth:5,maxRecordCountFactor:3};let a=class extends C{constructor(e){super({...B,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}_open(){var e=this;return(0,g.A)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||y.A.getLogger(e).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const n=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(n);const{filter:r,outFields:l}=e._config;e.destroyed||e._setFilter(r,l)})()}_onMessage(e){if("attributes"in e){let t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(n){return void y.A.getLogger(this).error(new u.A("geoevent-connection","Failed to parse message",n))}this.onFeature(t)}else this.onMessage(e)}_fetchServiceDefinition(e){var t=this;return(0,g.A)(function*(){const n={f:"json",...t._config.customParameters},r=(0,S.A)(e.path,{query:n,responseType:"json"}),l=(yield r).data;return t._serviceDefinition=l,l})()}_fetchWebSocketUrl(e,t){const n=e[0],{urls:r,token:l}=n,c=this._inferWebSocketBaseUrl(r);return(0,k.a6)(`${c}/subscribe`,{outSR:""+t.wkid,token:l})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return y.A.getLogger(this).error(new u.A("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var n=this;return(0,g.A)(function*(){const r=n._websocket;if(null==r||null==e&&null==t)return;const l=JSON.stringify({filter:n._serializeFilter(e,t)});let c=!1;const f=(0,w.Tw)();return r.onmessage=E=>{const v=JSON.parse(E.data);v.filter&&(v.error&&(y.A.getLogger(n).error(new u.A("geoevent-connection","Failed to set service filter",v.error)),n._set("errorString",`Could not set service filter - ${v.error}`),f.reject(v.error)),n._setWebSocketJSONParseHandler(r),c=!0,f.resolve())},r.send(l),setTimeout(()=>{c||(n.destroyed||n._websocket!==r||y.A.getLogger(n).error(new u.A("geoevent-connection","Server timed out when setting filter")),f.reject())},1e4),f.promise})()}_serializeFilter(e,t){const n={};if(null==e&&null==t)return n;if(null!=e&&e.geometry)try{const r=(0,L.rS)(e.geometry);if("extent"!==r.type)throw new u.A(`Expected extent but found type ${r.type}`);n.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){y.A.getLogger(this).error(new u.A("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return null!=e&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(n.where=e.where),null!=t&&(n.outFields=t.join(",")),n}_enrich(e){if(!this._relatedFeatures)return e;const r=this._relatedFeatures.get(e.attributes[this._serviceDefinition.relatedFeatures.joinField]);if(!r)return y.A.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:l,geometry:c}=r;for(const f in l)e.attributes[f]=l[f];return c&&(e.geometry=c),e.geometry||e.centroid||y.A.getLogger(this).error(new u.A("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,g.A)(function*(){try{const{relatedFeatures:t,keepLatestArchive:n}=e._serviceDefinition,r=e._queryRelatedFeatures(t),l=e._queryArchive(n);yield r;const c=yield l;if(!c)return;for(const f of c.features)e.onFeature(e._enrich(f))}catch(t){y.A.getLogger(e).error(new u.A("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,g.A)(function*(){if(!e)return;const n=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(n)})()}_queryArchive(e){var t=this;return(0,g.A)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,g.A)(function*(){var n,r,l;const c=new((yield Promise.all([i.e(9845),i.e(6669),i.e(2248),i.e(5718),i.e(313),i.e(1495),i.e(1721),i.e(6440),i.e(6338),i.e(5940),i.e(2282)]).then(i.bind(i,35940))).default)({url:e}),{capabilities:f}=yield c.load(),p=f.query.supportsMaxRecordCountFactor,A=f.query.supportsPagination,E=f.query.supportsCentroid,v=t._config.maxRecordCountFactor,D=c.capabilities.query.maxRecordCount,G=p?D*v:D,O=new $.A;if(O.outFields=null!==(n=t._config.outFields)&&void 0!==n?n:["*"],O.where=null!==(r=null===(l=t._config.filter)||void 0===l?void 0:l.where)&&void 0!==r?r:"1=1",O.returnGeometry=!0,O.returnExceededLimitFeatures=!0,O.outSpatialReference=b.A.fromJSON(t._config.spatialReference),E&&(O.returnCentroid=!0),p&&(O.maxRecordCountFactor=v),A)return O.num=G,c.destroy(),t._queryPages(e,O);const Z=yield(0,I.eW)(e,O,t._config.sourceSpatialReference);return c.destroy(),Z.data})()}_queryPages(e,t,n=[],r=0){var l=this;return(0,g.A)(function*(){var c;t.start=null!=t.num?r*t.num:null;const{data:f}=yield(0,I.eW)(e,t,l._config.sourceSpatialReference);return f.exceededTransferLimit&&r<(null!==(c=l._config.maxQueryDepth)&&void 0!==c?c:0)?(f.features.forEach(p=>n.push(p)),l._queryPages(e,t,n,r+1)):(n.forEach(p=>f.features.push(p)),f)})()}_addRelatedFeatures(e){const t=new Map,n=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const l of n)t.set(l.attributes[r],l);this._relatedFeatures=t}};a=(0,m._)([(0,P.$)("esri.layers.graphics.sources.connections.GeoEventConnection")],a);const s=a;let d=class extends N{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._featureZScaler=(0,W.N)(t,r,n)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function h(e,t){if(null==e&&null==t)return null;const n={};return null!=t&&(n.geometry=t),null!=e&&(n.where=e),n}function o(e,t,n,r,l,c,f,p,A){const E={source:e,sourceSpatialReference:t,spatialReference:n,geometryType:r,filter:h(l,c),maxReconnectionAttempts:f,maxReconnectionInterval:p,customParameters:A};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new C(E):new s(E):new d(E)}(0,m._)([(0,F.MZ)()],d.prototype,"connectionStatus",void 0),(0,m._)([(0,F.MZ)()],d.prototype,"errorString",void 0),d=(0,m._)([(0,P.$)("esri.layers.support.ClientSideConnection")],d)},1832:(J,R,i)=>{function g(m){const _={};for(const S in m){if("declaredClass"===S)continue;const u=m[S];if(null!=u&&"function"!=typeof u)if(Array.isArray(u)){_[S]=[];for(let y=0;y<u.length;y++)_[S][y]=g(u[y])}else"object"==typeof u?u.toJSON&&(_[S]=JSON.stringify(u)):_[S]=u}return _}i.d(R,{z:()=>g})},1277:(J,R,i)=>{i.d(R,{IJ:()=>M,Jf:()=>$,Pk:()=>C,eW:()=>W,gW:()=>I,kS:()=>x});var g=i(10467),m=i(89563),_=i(45272),S=i(61320),u=i(77098),y=i(58701),w=i(1832),k=i(78304),z=i(98789);const U="Layer does not support extent calculation.";function F(a,s){var d;const h=a.geometry,o=a.toJSON();delete o.compactGeometryEnabled,delete o.defaultSpatialReferenceEnabled;const e=o;let t,n,r;if(null!=h&&(n=h.spatialReference,r=(0,y.YX)(n),e.geometryType=(0,S.$B)(h),e.geometry=function P(a,s){if(s&&"extent"===a.type)return`${a.xmin},${a.ymin},${a.xmax},${a.ymax}`;if(s&&"point"===a.type)return`${a.x},${a.y}`;const d=a.toJSON();return delete d.spatialReference,JSON.stringify(d)}(h,a.compactGeometryEnabled),e.inSR=r),o.groupByFieldsForStatistics&&(e.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(e.objectIds=o.objectIds.join(",")),o.orderByFields&&(e.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&(null!=s&&s.returnCountOnly||null!=s&&s.returnExtentOnly||null!=s&&s.returnIdsOnly)?delete e.outFields:e.outFields=o.outFields.includes("*")?"*":o.outFields.join(","),o.outSR?(e.outSR=(0,y.YX)(o.outSR),t=a.outSpatialReference):h&&(o.returnGeometry||o.returnCentroid)&&(e.outSR=e.inSR,t=n),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(e.outStatistics=JSON.stringify(o.outStatistics)),o.fullText&&(e.fullText=JSON.stringify(o.fullText)),o.pixelSize&&(e.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(a.defaultSpatialReferenceEnabled&&null!=n&&null!=(null===(d=a.quantizationParameters)||void 0===d?void 0:d.extent)&&n.equals(a.quantizationParameters.extent.spatialReference)&&delete o.quantizationParameters.extent.spatialReference,e.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(e.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(e.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(e.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const l=o.timeExtent,{start:c,end:f}=l;null==c&&null==f||(e.time=c===f?c:`${null!=c?c:"null"},${null!=f?f:"null"}`),delete o.timeExtent}return a.defaultSpatialReferenceEnabled&&null!=n&&null!=t&&n.equals(t)&&(e.defaultSR=e.inSR,delete e.inSR,delete e.outSR),e}function W(a,s,d,h){return j.apply(this,arguments)}function j(){return(j=(0,g.A)(function*(a,s,d,h){const o=null!=s.timeExtent&&s.timeExtent.isEmpty?{data:{features:[]}}:yield b(a,s,"json",h);return(0,z.q)(s,d,o.data),o})).apply(this,arguments)}function M(a,s,d,h){return N.apply(this,arguments)}function N(){return(N=(0,g.A)(function*(a,s,d,h){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:d.createFeatureResult()};const o=yield x(a,s,h),e=o;return e.data=(0,k.m)(o.data,d),e})).apply(this,arguments)}function x(a,s,d){return b(a,s,"pbf",d)}function C(a,s,d){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):b(a,s,"json",d,{returnIdsOnly:!0})}function I(a,s,d){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):b(a,s,"json",d,{returnIdsOnly:!0,returnCountOnly:!0})}function $(a,s,d){return L.apply(this,arguments)}function L(){return(L=(0,g.A)(function*(a,s,d){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:{count:0,extent:null}};const h=yield b(a,s,"json",d,{returnExtentOnly:!0,returnCountOnly:!0}),o=h.data;if(o.hasOwnProperty("extent"))return h;if(o.features)throw new Error(U);if(o.hasOwnProperty("count"))throw new Error(U);return h})).apply(this,arguments)}function b(a,s,d){return T.apply(this,arguments)}function T(){return(T=(0,g.A)(function*(a,s,d,h={},o={}){const e="string"==typeof a?(0,_.An)(a):a,t=s.geometry?[s.geometry]:[],n=yield(0,u.el)(t,null,{signal:h.signal}),r=null==n?void 0:n[0];null!=r&&((s=s.clone()).geometry=r);const l=(0,w.z)({...e.query,f:d,...o,...F(s,o)});return(0,m.A)((0,_.fj)(e.path,function B(a,s){return null!=a.formatOf3DObjects&&!(s.returnCountOnly||s.returnExtentOnly||s.returnIdsOnly)}(s,o)?"query3d":"query"),{...h,responseType:"pbf"===d?"array-buffer":"json",query:{...l,...h.query}})})).apply(this,arguments)}},98789:(J,R,i)=>{i.d(R,{q:()=>m});var g=i(23743);function m(_,S,u){if(null==u||!u.features||!u.hasZ)return;const y=(0,g.N)(u.geometryType,S,_.outSpatialReference);if(null!=y)for(const w of u.features)y(w.geometry)}}}]);