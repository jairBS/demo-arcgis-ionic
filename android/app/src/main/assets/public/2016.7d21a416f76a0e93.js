"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2016],{63583:(U,L,h)=>{var A,m;h.d(L,{u:()=>A}),(m=A||(A={}))[m.KILOBYTES=1024]="KILOBYTES",m[m.MEGABYTES=1048576]="MEGABYTES",m[m.GIGABYTES=1073741824]="GIGABYTES"},33087:(U,L,h)=>{h.d(L,{q:()=>m});var A=h(60611);class m{constructor(f,O){this._storage=new A.F,this.id="",this.name="",this.size=0,this._storage.maxSize=f,this._storage.register(this),O&&this._storage.registerRemoveFunc("",O)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(f,O,y=1){this._storage.put(this,f,O,y,1)}pop(f){return this._storage.pop(this,f)}get(f){return this._storage.get(this,f)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(f){this._storage.maxSize=f}resetHitRate(){}}},60611:(U,L,h)=>{h.d(L,{F:()=>y,Mn:()=>O});var f,b,A=h(12438);(b=f||(f={}))[b.ALL=0]="ALL",b[b.SOME=1]="SOME";class O{constructor(i,t,s){this.name=i,this._storage=t,this.id=T+++":",this.size=0,this.maxSize=-1,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),s&&(this._storage.registerRemoveFunc(this.id,s),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(i){return this._storage.getSize(this,i)}resetHitRate(){this._hit=this._miss=0}put(i,t,s,a=0){this._storage.put(this,i,t,s,a)}pop(i){const t=this._storage.pop(this,i);return void 0===t?++this._miss:++this._hit,t}get(i){const t=this._storage.get(this,i);return void 0===t?++this._miss:++this._hit,t}peek(i){return this._storage.peek(this,i)}updateSize(i,t,s){this._storage.updateSize(this,i,t,s)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}}class y{get size(){return this._size}constructor(i=10485760){this._maxSize=i,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new A.A,this._users=new A.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(i){this._users.push(i)}deregister(i){this._users.removeUnordered(i)}registerRemoveFunc(i,t){this._removeFuncs.push([i,t])}deregisterRemoveFunc(i){this._removeFuncs.filterInPlace(t=>t[0]!==i)}get maxSize(){return this._maxSize}set maxSize(i){this._maxSize=Math.max(i,-1),this._checkSize()}getSize(i,t){var s;const a=this._db.get(i.id+t);return null!==(s=null==a?void 0:a.size)&&void 0!==s?s:0}put(i,t,s,a,d){const o=this._db.get(t=i.id+t);if(o&&(this._size-=o.size,i.size-=o.size,this._db.delete(t),o.entry!==s&&this._notifyRemove(t,o.entry,o.size,f.ALL)),a>this._maxSize)return void this._notifyRemove(t,s,a,f.ALL);if(void 0===s)return void console.warn("Refusing to cache undefined entry ");if(!a||a<0)return console.warn(`Refusing to cache entry with size ${a} for key ${t}`),void this._notifyRemove(t,s,0,f.ALL);const g=1+Math.max(d,-4)- -3;this._db.set(t,new x(s,a,g)),this._size+=a,i.size+=a,this._checkSize()}updateSize(i,t,s,a){const d=this._db.get(t=i.id+t);if(d&&d.entry===s){for(this._size-=d.size,i.size-=d.size;a>this._maxSize;){const o=this._notifyRemove(t,s,a,f.SOME);if(!(null!=o&&o>0))return void this._db.delete(t);a=o}d.size=a,this._size+=a,i.size+=a,this._checkSize()}}pop(i,t){const s=this._db.get(t=i.id+t);if(s)return this._size-=s.size,i.size-=s.size,this._db.delete(t),++this._hit,s.entry;++this._miss}get(i,t){const s=this._db.get(t=i.id+t);if(void 0!==s)return this._db.delete(t),s.lives=s.lifetime,this._db.set(t,s),++this._hit,s.entry;++this._miss}peek(i,t){const s=this._db.get(i.id+t);return s?++this._hit:++this._miss,null==s?void 0:s.entry}get performanceInfo(){const i={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},s=new Array;this._db.forEach((o,g)=>{const P=o.lifetime;s[P]=(s[P]||0)+o.size,this._users.forAll(B=>{const{id:F,name:C}=B;g.startsWith(F)&&(t[C]=(t[C]||0)+o.size)})});const a={};this._users.forAll(o=>{const g=o.name;"hitRate"in o&&"number"==typeof o.hitRate&&!isNaN(o.hitRate)&&o.hitRate>0?(t[g]=t[g]||0,a[g]=Math.round(100*o.hitRate)+"%"):a[g]="0%"});const d=Object.keys(t);d.sort((o,g)=>t[g]-t[o]),d.forEach(o=>i[o]=Math.round(t[o]/2**20)+"MB / "+a[o]);for(let o=s.length-1;o>=0;--o){const g=s[o];g&&(i["Priority "+(o+-3-1)]=Math.round(g/this._size*100)+"%")}return i}resetStats(){this._hit=this._miss=0,this._users.forAll(i=>i.resetHitRate())}clear(i){const t=i.id;this._db.forEach((s,a)=>{a.startsWith(t)&&(this._size-=s.size,this._db.delete(a),this._notifyRemove(a,s.entry,s.size,f.ALL))}),i.size=0}clearAll(){this._db.forEach((i,t)=>this._notifyRemove(t,i.entry,i.size,f.ALL)),this._users.forAll(i=>i.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(i,t,s,a){let d;return this._removeFuncs.some(o=>{if(i.startsWith(o[0])){const g=o[1](t,a,s);return"number"==typeof g&&(d=g),!0}return!1}),d}_checkSize(){this._users.forAll(i=>this._checkSizeLimits(i)),this._checkSizeLimits()}_checkSizeLimits(i){const t=null!=i?i:this;if(t.maxSize<0||t.size<=t.maxSize)return;const s=null==i?void 0:i.id;let a=!0;for(;a;){a=!1;for(const[d,o]of this._db)if(0===o.lifetime&&(!s||d.startsWith(s))){if(this._purgeItem(d,o,i),t.size<=.9*t.maxSize)return;a||(a=this._db.has(d))}}for(const[d,o]of this._db)if((!s||d.startsWith(s))&&(this._purgeItem(d,o,i),t.size<=.9*t.maxSize))return}_purgeItem(i,t,s=this._users.find(a=>i.startsWith(a.id))){if(this._db.delete(i),t.lives<=1){this._size-=t.size,s&&(s.size-=t.size);const a=this._notifyRemove(i,t.entry,t.size,f.SOME);null!=a&&a>0&&(this._size+=a,s&&(s.size+=a),t.lives=t.lifetime,t.size=a,this._db.set(i,t))}else--t.lives,this._db.set(i,t)}}let T=0;class x{constructor(i,t,s){this.entry=i,this.size=t,this.lifetime=s,this.lives=s}}},25936:(U,L,h)=>{h.d(L,{b:()=>x});var A=h(8189),m=h(35150),w=h(85211),y=(h(3248),h(40707),h(76576)),T=h(68438);const x=b=>{let i=class extends b{get title(){if(this._get("title")&&"defaults"!==this.originOf("title"))return this._get("title");if(this.url){const t=(0,T.qg)(this.url);if(null!=t&&t.title)return t.title}return this._get("title")||""}set title(t){this._set("title",t)}set url(t){this._set("url",(0,T.Jf)(t,m.A.getLogger(this)))}};return(0,A._)([(0,w.MZ)()],i.prototype,"title",null),(0,A._)([(0,w.MZ)({type:String})],i.prototype,"url",null),i=(0,A._)([(0,y.$)("esri.layers.mixins.ArcGISService")],i),i}},77677:(U,L,h)=>{h.d(L,{d:()=>M});var D,A=h(10467),m=h(8189),w=h(89563),f=h(98877),O=h(63583),y=h(5922),T=h(17715),x=h(33087),b=h(12438),i=h(56492),t=h(48900),s=h(3804),a=h(45272),d=h(85211),B=(h(3248),h(35150),h(40707),h(76576)),F=h(25858),C=h(89952),j=h(77806),W=h(79139);class ${constructor(r){this._validateJSON(r);const{location:l,data:n}=r;this.location=Object.freeze((0,j.o8)(l));let v=!0,p=!0;const u=function N(e,r=!1){return e<=W.y9?r?new Array(e).fill(0):new Array(e):new Uint32Array(e)}(Math.ceil(this.location.width*this.location.height/32));let E=0;for(let z=0;z<n.length;z++){const R=z%32;n[z]?(p=!1,u[E]|=1<<R):v=!1,31===R&&++E}p?(this._availability="unavailable",this.byteSize=40):v?(this._availability="available",this.byteSize=40):(this._availability=u,this.byteSize=40+(0,W.Ek)(u))}getAvailability(r,l){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const n=(r-this.location.top)*this.location.width+(l-this.location.left),_=n>>5,v=this._availability;return _<0||_>v.length?"unknown":v[_]&1<<n%32?"available":"unavailable"}static fromDefinition(r,l){const n=r.service.request||w.A,{row:c,col:_,width:v,height:p}=r,S={query:{f:"json"}};return l=l?{...S,...l}:S,n(function Y(e){var r;let l;if(null!==(r=e.service.tileServers)&&void 0!==r&&r.length){const c=e.service.tileServers;l=`${c&&c.length?c[e.row%c.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else l=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;const n=e.service.query;return n&&(l=`${l}?${n}`),l}(r),l).then(u=>u.data).catch(u=>{if(u&&u.details&&422===u.details.httpStatus)return{location:{top:c,left:_,width:v,height:p},valid:!0,data:(0,C.dY)(v*p,0)};throw u}).then(u=>{if(u.location&&(u.location.top!==c||u.location.left!==_||u.location.width!==v||u.location.height!==p))throw new y.A("tilemap:location-mismatch","Tilemap response for different location than requested",{response:u,definition:{top:c,left:_,width:v,height:p}});return $.fromJSON(u)})}static fromJSON(r){return Object.freeze(new $(r))}_validateJSON(r){if(null==r||!r.location)throw new y.A("tilemap:missing-location","Location missing from tilemap response");if(!1===r.valid)throw new y.A("tilemap:invalid","Tilemap response was marked as invalid");if(!r.data)throw new y.A("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(r.data))throw new y.A("tilemap:data-mismatch","Data must be an array of numbers");if(r.data.length!==r.location.width*r.location.height)throw new y.A("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function G(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}let M=D=class extends f.A{constructor(e){super(e),this._pendingTilemapRequests={},this.request=w.A,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new x.q(2*O.u.MEGABYTES),this.addHandles((0,t.wB)(()=>{const{layer:e}=this;return[null==e?void 0:e.parsedUrl,null==e?void 0:e.tileServers,null==e?void 0:e.apiKey,null==e?void 0:e.customParameters]},()=>this._initializeTilemapDefinition(),t.Vh))}get effectiveMinLOD(){var e;return null!==(e=this.minLOD)&&void 0!==e?e:this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){var e;return null!==(e=this.maxLOD)&&void 0!==e?e:this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}fetchTilemap(e,r,l,n){var c;if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new y.A("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));const _=this._tmpTilemapDefinition,v=this._tilemapFromCache(e,r,l,_);if(v)return Promise.resolve(v);const p=null===(c=n)||void 0===c?void 0:c.signal;return n={...n,signal:null},new Promise((S,u)=>{(0,i.u7)(p,()=>u((0,i.NK)()));const E=G(_);let z=this._pendingTilemapRequests[E];if(!z){z=$.fromDefinition(_,n).then(I=>(this._tilemapCache.put(E,I,I.byteSize),I));const R=()=>{delete this._pendingTilemapRequests[E]};this._pendingTilemapRequests[E]=z,z.then(R,R)}z.then(S,u)})}getAvailability(e,r,l){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";const n=this._tilemapFromCache(e,r,l,this._tmpTilemapDefinition);return n?n.getAvailability(r,l):"unknown"}fetchAvailability(e,r,l,n){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(new y.A("tile-map:tile-unavailable","Tile is not available",{level:e,row:r,col:l})):this.fetchTilemap(e,r,l,n).catch(c=>c).then(c=>{if(c instanceof $){const _=c.getAvailability(r,l);if("unavailable"===_)throw new y.A("tile-map:tile-unavailable","Tile is not available",{level:e,row:r,col:l});return _}if((0,i.zf)(c))throw c;return"unknown"})}fetchAvailabilityUpsample(e,r,l,n,c){n.level=e,n.row=r,n.col=l;const _=this.layer.tileInfo;_.updateTileInfo(n);const v=this.fetchAvailability(e,r,l,c).catch(p=>{if((0,i.zf)(p))throw p;if(_.upsampleTile(n))return this.fetchAvailabilityUpsample(n.level,n.row,n.col,n,c);throw p});return this._fetchAvailabilityUpsamplePrefetch(n.id,e,r,l,c,v),v}_fetchAvailabilityUpsamplePrefetch(e,r,l,n,c,_){var v=this;return(0,A.A)(function*(){if(!v._prefetchingEnabled||null==e)return;const p=`prefetch-${e}`;if(v.hasHandles(p))return;const S=new AbortController;_.then(()=>S.abort(),()=>S.abort());let u=!1;const E=(0,T.hA)(()=>{u||(u=!0,S.abort())});if(v.addHandles(E,p),yield(0,s.md)(10,S.signal).catch(()=>{}),u||(u=!0,v.removeHandles(p)),(0,i.G4)(S))return;const z=new F.U(e,r,l,n),R={...c,signal:S.signal},I=v.layer.tileInfo;for(let Z=0;D._prefetches.length<D._maxPrefetch&&I.upsampleTile(z);++Z){const K=v.fetchAvailability(z.level,z.row,z.col,R);D._prefetches.push(K);const H=()=>{D._prefetches.removeUnordered(K)};K.then(H,H)}})()}_initializeTilemapDefinition(){var e;if(!this.layer.parsedUrl)return;const{parsedUrl:r,apiKey:l,customParameters:n}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:r.path,query:(0,a.x0)({...r.query,...n,token:null!=l?l:null===(e=r.query)||void 0===e?void 0:e.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,r,l,n){n.level=e,n.row=r-r%this.size,n.col=l-l%this.size;const c=G(n);return this._tilemapCache.get(c)}get test(){const e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(r){e._prefetchingEnabled=r},hasTilemap:(r,l,n)=>!!e._tilemapFromCache(r,l,n,e._tmpTilemapDefinition)}}};M._maxPrefetch=4,M._prefetches=new b.A({initialSize:D._maxPrefetch}),(0,m._)([(0,d.MZ)({constructOnly:!0})],M.prototype,"layer",void 0),(0,m._)([(0,d.MZ)({constructOnly:!0})],M.prototype,"minLOD",void 0),(0,m._)([(0,d.MZ)({constructOnly:!0})],M.prototype,"maxLOD",void 0),(0,m._)([(0,d.MZ)({constructOnly:!0})],M.prototype,"request",void 0),(0,m._)([(0,d.MZ)({constructOnly:!0})],M.prototype,"size",void 0),M=D=(0,m._)([(0,B.$)("esri.layers.support.TilemapCache")],M)}}]);