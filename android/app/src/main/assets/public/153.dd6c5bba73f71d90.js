"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[153],{20153:(Cn,rt,S)=>{S.r(rt),S.d(rt,{default:()=>Fn});var F=S(10467),w=S(8189),St=S(92165),wt=S(90660),k=S(5922),fe=S(35150),bt=S(39693),xe=S(56492),At=S(48900),A=S(85211),Oe=S(55739),Tt=(S(40707),S(3248)),Mt=S(15463),ee=S(76576),Ft=S(95478),Ct=S(25936),Pt=S(93410),Ot=S(23e3),He=(S(21152),S(75257)),st=S(89563),Dt=S(23159),Nt=S(17221),at=S(58701),ot=S(68438),$e=S(81687),We=S(52593),kt=S(70489),_e=S(49343),Bt=S(85889),se=S(11333),Jt=S(55861),Et=S(71065),zt=S(64261),lt=S(29598),Ae=S(61599),Y=S(20053),le=S(62619),ut=S(96115),ct=S(99263),ae=S(40275),z=S(40018),Ge=S(50444),Lt=S(56330),_=S(28067),W=S(13303),G=S(32034);let $t=0,Z=class extends((0,zt.g)(Et.oY)){constructor(){super(...arguments),this._tileFetchQueue=new Lt.e({concurrency:32,process:(n,e)=>this._fetchRawTile(n.pyramidLevel,n.row,n.col,{...n.options,signal:e})}),this.datasetName=null,this.datasetFormat=null,this.hasUniqueSourceStorageInfo=!0,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}init(){var n=this;return(0,F.A)(function*(){const e=(0,z.Hh)();n.addResolvingPromise(e),yield n.when()})()}normalizeCtorArgs(n){var e;return null!==(e=n)&&void 0!==e&&e.ioConfig&&(n={...n,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:se.A.create(),...n.ioConfig}}),n}get _isGlobalWrappableSource(){const{rasterInfo:n}=this,e=(0,z.FT)(n.spatialReference);return null!=e&&n.extent.width>=e/2}get _hasNoneOrGCSShiftTransform(){const{transform:n}=this.rasterInfo;return null==n||"gcs-shift"===n.type}set rasterJobHandler(n){var e;this._set("rasterJobHandler",n),"Function"===this.datasetFormat&&(null===(e=this.primaryRasters)||void 0===e||null===(e=e.rasters)||void 0===e||e.forEach(r=>r.rasterJobHandler=n))}get rasterId(){return this.url||"rasterId-"+$t++}set url(n){this._set("url",(0,ot.Jf)(n,fe.A.getLogger(this)))}open(n){return(0,F.A)(function*(){throw new k.A("BaseRaster:open-not-implemented","open() is not implemented")})()}fetchTile(n,e,r,t={}){var i=this;return(0,F.A)(function*(){const s=t.tileInfo||i.rasterInfo.storageInfo.tileInfo,a=i.getTileExtentFromTileInfo(n,e,r,s);return t={noClip:!0,...t},i.fetchPixels(a,s.size[0],s.size[1],t)})()}identify(n,e={}){var r=this;return(0,F.A)(function*(){var t,i;n=(0,Oe.PZ)(W.A,n).clone().normalize();const{multidimensionalDefinition:s,timeExtent:a}=e,{rasterInfo:o}=r,{hasMultidimensionalTranspose:u,multidimensionalInfo:l}=o;let{transposedVariableName:c}=e;const d=null!=l&&u&&(null!=a||(0,Y.DY)(s));var f;d&&!c&&(c=null!=s&&s.length>0?null!==(f=s[0].variableName)&&void 0!==f?f:void 0:l.variables[0].name,e={...e,transposedVariableName:c}),e=r._getRequestOptionsWithSliceId(e);const{spatialReference:p,extent:m}=o,{datumTransformation:g}=e;let y=(0,z._I)(n,p,g);if(!m.intersects(y))return{location:y,value:null};if(null!=o.transform){const J=o.transform.inverseTransform(y);if(!o.nativeExtent.intersects(J))return{location:J,value:null};y=J}let h=0;const v=null!=c&&null!=l&&o.hasMultidimensionalTranspose;if("Function"===r.datasetFormat){const J=r.primaryRasters.rasters[0];if(v)return J.identify(y,e);const{pixelSize:L}=o,E=3,U=L.x*E/2,Q=L.y*E/2,V=new _.A({xmin:y.x-U,xmax:y.x+U,ymin:y.y-Q,ymax:y.y+Q,spatialReference:p}),X={interpolation:"nearest",multidimensionalDefinition:s,sliceId:e.sliceId},{pixelBlock:H}=yield J.fetchPixels(V,E,E,X),{pixelBlock:oe}=yield r.fetchPixels(V,E,E,X);if(null==H)return{location:y,value:null};const q=Math.floor(E*E*.5),ie=!H.mask||H.mask[q]?H.pixels.map(be=>be[q]):null;let Le;return null!=oe&&(Le=!oe.mask||oe.mask[q]?oe.pixels.map(be=>be[q]):void 0),{location:y,value:ie,processedValue:Le,pyramidLevel:0}}if(!v)if(e.srcResolution)h=(0,z.t$)(e.srcResolution,o,r.ioConfig.sampling).pyramidLevel;else if(h=yield r.computeBestPyramidLevelForLocation(n,e),null==h)return{location:y,value:null};const x=r.identifyPixelLocation(y,h,null,v);if(null===x)return{location:y,value:null};const{row:I,col:R,rowOffset:T,colOffset:b,blockWidth:O}=x,P=null!==(t=c)&&void 0!==t?t:e.sliceId,C=(0,le.ph)(r.rasterId,P),D=`${h}/${I}/${R}`;let M=(0,le.gd)(C,null,D);null==M&&(M=r.fetchRawTile(h,I,R,e),(0,le.no)(C,null,D,M));const N=yield M;return null!=N&&null!==(i=N.pixels)&&void 0!==i&&i.length?r._processIdentifyResult(N,{srcLocation:y,position:T*O+b,pyramidLevel:h,useTransposedTile:!!v,requestSomeSlices:d,identifyOptions:e}):{location:y,value:null}})()}fetchPixels(n,e,r,t={}){var i=this;return(0,F.A)(function*(){n=(0,z.Ps)(n),t=i._getRequestOptionsWithSliceId(t);const{_hasNoneOrGCSShiftTransform:s}=i;if(t.requestRawData&&s)return i._fetchPixels(n,e,r,t);const a=(0,z.FT)(n.spatialReference),o=(0,z.OM)(n);if(null==a||0===o||1===o&&i._isGlobalWrappableSource&&s)return i._fetchPixels(n,e,r,t);if(o>=3)return{extent:n,pixelBlock:null};const u=[],{xmin:l,xmax:c}=n,d=Math.round(a/(c-l)*e),f=d-Math.round((a/2-l)/(c-l)*e);let p=0;const m=[];for(let v=0;v<=o;v++){const x=new _.A({xmin:0===v?l:-a/2,xmax:v===o?c-a*v:a/2,ymin:n.ymin,ymax:n.ymax,spatialReference:n.spatialReference}),I=0===v?d-f:v===o?e-p:d;p+=I,m.push(I);const R=t.disableWrapAround&&v>0?null:i._fetchPixels(x,I,r,t);u.push(R)}const g=(yield Promise.all(u)).map(v=>null==v?void 0:v.pixelBlock);let y=null;const h={width:e,height:r};return y=i.rasterJobHandler?(yield i.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:g,srcMosaicSize:h,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:m},t)).pixelBlock:(0,ae.z7)(g,h,{blockWidths:m}),{extent:n,srcExtent:(0,z._l)(n,i.rasterInfo.spatialReference,t.datumTransformation),pixelBlock:y}})()}fetchRawPixels(n,e,r,t={}){var i=this;return(0,F.A)(function*(){e={x:Math.floor(e.x),y:Math.floor(e.y)};const s=yield i._fetchRawTiles(n,e,r,t),{nativeExtent:a,nativePixelSize:o,storageInfo:u}=i.rasterInfo,l=2**n,c=o.x*l,d=o.y*l,f=new _.A({xmin:a.xmin+c*e.x,xmax:a.xmin+c*(e.x+r.width-1),ymin:a.ymax-d*(e.y+r.height-1),ymax:a.ymax-d*e.y,spatialReference:a.spatialReference});if(!s)return{extent:f,srcExtent:f,pixelBlock:null};const{pixelBlocks:p,mosaicSize:m}=s;if(1===p.length&&null!=p[0]&&p[0].width===r.width&&p[0].height===r.height)return{extent:f,srcExtent:f,pixelBlock:s.pixelBlocks[0]};const h={x:e.x%(n>0?u.pyramidBlockWidth:u.blockWidth),y:e.y%(n>0?u.pyramidBlockHeight:u.blockHeight)};let v;return v=i.rasterJobHandler?(yield i.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:p,srcMosaicSize:m,destDimension:r,clipOffset:h,clipSize:r,coefs:null,sampleSpacing:null,interpolation:t.interpolation,alignmentInfo:null,blockWidths:null},t)).pixelBlock:(0,ae.z7)(p,m,{clipOffset:h,clipSize:r}),{extent:f,srcExtent:f,pixelBlock:v}})()}fetchRawTile(n,e,r,t){throw new k.A("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(n){return(0,z._l)(this.rasterInfo.extent,n)}decodePixelBlock(n,e){return!this.rasterJobHandler||e.useCanvas?(0,ct.D)(n,e):this.rasterJobHandler.decode({data:n,options:e})}request(n,e,r=0){var t=this;return(0,F.A)(function*(){var i,s;const{customFetchParameters:a}=t.ioConfig,{range:o,query:u,headers:l}=e;r=null!==(i=null!==(s=r)&&void 0!==s?s:e.retryCount)&&void 0!==i?i:t.ioConfig.retryCount;const c=o?{Range:`bytes=${o.from}-${o.to}`}:null;try{return yield(0,st.A)(n,{...e,query:{...u,...a},headers:{...l,...c}})}catch(d){if(r>0)return r--,t.request(n,e,r);throw d}})()}getSliceIndex(n){const{multidimensionalInfo:e}=this.rasterInfo;return null==e||null==n||0===n.length?null:(0,Y.NG)(n,e)}getTileExtentFromTileInfo(n,e,r,t){const i=t.lodAt(n);return this.getTileExtent({x:i.resolution,y:i.resolution},e,r,t.origin,t.spatialReference,t.size)}updateTileInfo(){const{storageInfo:n,spatialReference:e,extent:r,pixelSize:t}=this.rasterInfo;if(!n.tileInfo){const i=[],s=n.maximumPyramidLevel||0;let a=Math.max(t.x,t.y),o=1/.0254*96*a;for(let l=0;l<=s;l++)i.unshift(new lt.A({level:s-l,resolution:a,scale:o})),a*=2,o*=2;const u=new W.A({x:r.xmin,y:r.ymax,spatialReference:e});n.tileInfo=new se.A({origin:u,size:[n.blockWidth,n.blockHeight],spatialReference:e,lods:i}),n.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(n,e=512,r=512,t){const{width:i,height:s,nativeExtent:a,pixelSize:o,spatialReference:u}=n,l=new W.A({x:a.xmin,y:a.ymax,spatialReference:u});null==t&&(t=Math.max(0,Math.round(Math.log(Math.max(i,s))/Math.LN2-8)));const c=this.computeBlockBoundary(a,512,512,{x:a.xmin,y:a.ymax},[o],t);n.storageInfo=new Ae.A({blockWidth:e,blockHeight:r,pyramidBlockWidth:e,pyramidBlockHeight:r,origin:l,firstPyramidLevel:1,maximumPyramidLevel:t,blockBoundary:c})}computeBestPyramidLevelForLocation(n,e={}){return(0,F.A)(function*(){return 0})()}computeBlockBoundary(n,e,r,t,i,s=0,a=2){if(1===i.length&&s>0){i=[...i];let{x:c,y:d}=i[0];for(let f=0;f<s;f++)c*=a,d*=a,i.push({x:c,y:d})}const o=[],{x:u,y:l}=t;for(let c=0;c<i.length;c++){const{x:d,y:f}=i[c];o.push({minCol:Math.floor((n.xmin-u+.1*d)/e/d),maxCol:Math.floor((n.xmax-u-.1*d)/e/d),minRow:Math.floor((l-n.ymax+.1*f)/r/f),maxRow:Math.floor((l-n.ymin-.1*f)/r/f)})}return o}getPyramidPixelSize(n){const{nativePixelSize:e}=this.rasterInfo,{pyramidResolutions:r,pyramidScalingFactor:t}=this.rasterInfo.storageInfo;if(0===n)return e;if(null!=r&&r.length)return r[n-1];const i=t**n;return{x:e.x*i,y:e.y*i}}identifyPixelLocation(n,e,r,t){const{spatialReference:i,nativeExtent:s,storageInfo:a}=this.rasterInfo,{maximumPyramidLevel:o,origin:u,transposeInfo:l}=a,c=t&&null!=l?l.tileSize[0]:a.blockWidth,d=t&&null!=l?l.tileSize[1]:a.blockHeight,f=(0,z._I)(n,i,r);if(!s.intersects(f)||e<0||e>o)return null;const p=this.getPyramidPixelSize(e),{x:m,y:g}=p,y=(u.y-f.y)/g/d,h=(f.x-u.x)/m/c,v=Math.min(d-1,Math.floor((y-Math.floor(y))*d)),x=Math.min(c-1,Math.floor((h-Math.floor(h))*c));return{pyramidLevel:e,row:Math.floor(y),col:Math.floor(h),rowOffset:v,colOffset:x,blockWidth:c,srcLocation:f}}getTileExtent(n,e,r,t,i,s){const[a,o]=s,u=t.x+r*a*n.x,c=t.y-e*o*n.y;return new _.A({xmin:u,xmax:u+a*n.x,ymin:c-o*n.y,ymax:c,spatialReference:i})}getBlockWidthHeight(n){return{blockWidth:n>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:n>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(n,e,r){const t=this.rasterInfo.storageInfo.blockBoundary[n];return!t||t.maxRow<e||t.maxCol<r||t.minRow>e||t.minCol>r}updateImageSpaceRasterInfo(n){const{extent:e,pixelSize:r}=n;if(-.5===e.xmin&&.5===e.ymax&&1===r.x&&1===r.y&&null==n.transform)return;const{width:t,height:i}=n,s=G.A.WebMercator;n.spatialReference=s,n.extent=n.nativeExtent=new _.A({xmin:-.5,ymax:.5,xmax:t-.5,ymin:.5-i,spatialReference:s}),n.isPseudoSpatialReference=!0,n.transform=null,n.pixelSize=new W.A({x:1,y:1,spatialReference:s});const{extent:a,storageInfo:o}=n;if(o){o.origin=new W.A({x:a.xmin,y:a.ymax,spatialReference:s});const{tileInfo:u}=o;if(u){u.origin=o.origin;const l=(n.nativePixelSize.x+n.nativePixelSize.y)/2;u.lods.forEach((c,d)=>{c.resolution=l*2**d,c.scale=96*c.resolution/.0254})}}}_fetchPixels(n,e,r,t={}){var i=this;return(0,F.A)(function*(){let s=(0,z.OM)(n);if(s>=2)return{extent:n,pixelBlock:null};const a=i._getSourceDataInfo(n,e,r,t),{pyramidLevel:o,srcResolution:u,srcExtent:l,srcWidth:c,srcHeight:d,ul:f}=a;if(0===c||0===d)return{extent:n,srcExtent:l,pixelBlock:null};const{rasterInfo:p}=i,m=p.transform,g="gcs-shift"===(null==m?void 0:m.type),y=null!=(0,z.FT)(n.spatialReference);!g&&y||(s=(0,z.OM)(a.srcExtent,g));const h=yield i._fetchRawTiles(o,f,{width:c,height:d,wrapCount:s},t);if(!h)return{extent:n,srcExtent:l,pixelBlock:null};const v=p.storageInfo,x=o>0?v.pyramidBlockWidth:v.blockWidth,I=o>0?v.pyramidBlockHeight:v.blockHeight;let{x:R,y:T}=p.pixelSize;if(o>0){const{pyramidResolutions:ie,pyramidScalingFactor:Le}=v;if(null!=ie&&ie[o-1])({x:R,y:T}=ie[o-1]);else{const be=Le**o;R*=be,T*=be}}const b=p.spatialReference,O=new W.A({x:R,y:T,spatialReference:b}),P=x===c&&I===d&&f.x%x==0&&f.y%I==0,C=new W.A({x:(n.xmax-n.xmin)/e,y:(n.ymax-n.ymin)/r,spatialReference:n.spatialReference}),D=!n.spatialReference.equals(b),M=b.isGeographic?1e-9:1e-4,{datumTransformation:N}=t;if(!D&&P&&1===h.pixelBlocks.length&&x===e&&I===r&&i._isSameResolution(u,C,M))return{extent:n,srcExtent:l,srcTilePixelSize:O,pixelBlock:h.pixelBlocks[0]};const B=y&&null!=(0,z.FT)(l.spatialReference)&&i._hasNoneOrGCSShiftTransform,J=t.requestProjectedLocalDirections&&i.rasterInfo.dataType.startsWith("vector");J&&!i.rasterJobHandler&&(yield(0,z.Hh)());const L=i.rasterJobHandler?yield i.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:n,srcBufferExtent:h.extent,pixelSize:C.toJSON(),datumTransformation:N,rasterTransform:m,hasWrapAround:s>0||B,isAdaptive:!1!==i.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:J},t):(0,z.l0)({projectedExtent:n,srcBufferExtent:h.extent,pixelSize:C,datumTransformation:N,rasterTransform:m,hasWrapAround:s>0||B,isAdaptive:!1,includeGCSGrid:J});let E;const U=!t.requestRawData,Q={rows:L.spacing[0],cols:L.spacing[1]},V=i._hasNoneOrGCSShiftTransform?i._getRasterTileAlignmentInfo(o,h.extent.xmin):void 0,{pixelBlocks:X,mosaicSize:H,isPartiallyFilled:oe}=h;let q=null;if(i.rasterJobHandler)({pixelBlock:E,localNorthDirections:q}=yield i.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:X,srcMosaicSize:H,destDimension:U?{width:e,height:r}:null,coefs:U?L.coefficients:null,sampleSpacing:U?Q:null,projectDirections:J,gcsGrid:J?L.gcsGrid:null,isUV:"vector-uv"===i.rasterInfo.dataType,interpolation:t.interpolation,alignmentInfo:V,blockWidths:null},t));else{const ie=(0,ae.z7)(X,H,{alignmentInfo:V});E=U?(0,ae.$i)(ie,{width:e,height:r},L.coefficients,Q,t.interpolation):ie,J&&L.gcsGrid&&(q=(0,ae.QF)({width:e,height:r},L.gcsGrid),E=(0,Ge.Y2)(E,i.rasterInfo.dataType,q))}return t.requestRawData||J?{extent:n,srcExtent:l,srcTilePixelSize:O,pixelBlock:E,transformGrid:L,localNorthDirections:q,isPartiallyFilled:oe}:{extent:n,srcExtent:l,srcTilePixelSize:O,pixelBlock:E}})()}_fetchRawTiles(n,e,r,t){var i=this;return(0,F.A)(function*(){const{origin:s,blockBoundary:a}=i.rasterInfo.storageInfo,{blockWidth:o,blockHeight:u}=i.getBlockWidthHeight(n);let{x:l,y:c}=e,{width:d,height:f,wrapCount:p}=r;const m=i._getRasterTileAlignmentInfo(n,0);t.buffer&&(l-=t.buffer.cols,c-=t.buffer.rows,d+=2*t.buffer.cols,f+=2*t.buffer.rows);let g=0,y=0,h=0;p&&null!=m&&(({worldColumnCountFromOrigin:y,originColumnOffset:h,rightPadding:g}=m),y*m.blockWidth-g>=l+d&&(g=0));const v=Math.floor(l/o),x=Math.floor(c/u),I=Math.floor((l+d+g-1)/o),R=Math.floor((c+f+g-1)/u),T=a[n];if(!T)return null;const{minRow:b,minCol:O,maxCol:P,maxRow:C}=T;if(0===p&&(R<b||I<O||x>C||v>P))return null;const D=new Array;let M=!1;const N=null==i.ioConfig.allowPartialFill?t.allowPartialFill:i.ioConfig.allowPartialFill;for(let V=x;V<=R;V++)for(let X=v;X<=I;X++){let H=X;if(!t.disableWrapAround&&p&&null!=m&&y<=X&&(H=X-y-h),V>=b&&H>=O&&C>=V&&P>=H){const oe=i._tileFetchQueue.push({pyramidLevel:n,row:V,col:H,options:t},{signal:t.signal});D.push(N?new Promise(q=>{oe.then(ie=>q(ie)).catch(()=>{M=!0,q(null)})}):oe)}else D.push(Promise.resolve(null))}if(0===D.length)return null;const B=yield Promise.all(D),J={height:(R-x+1)*u,width:(I-v+1)*o},{spatialReference:L}=i.rasterInfo,E=i.getPyramidPixelSize(n),{x:U,y:Q}=E;return{extent:new _.A({xmin:s.x+v*o*U,xmax:s.x+(I+1)*o*U,ymin:s.y-(R+1)*u*Q,ymax:s.y-x*u*Q,spatialReference:L}),pixelBlocks:B,mosaicSize:J,isPartiallyFilled:M}})()}_isSameResolution(n,e,r){return Math.abs(n.x-e.x)<r&&Math.abs(n.y-e.y)<r}_fetchRawTile(n,e,r,t){const i=this.rasterInfo.storageInfo.blockBoundary[n];if(!i)return Promise.resolve(null);const{minRow:s,minCol:a,maxCol:o,maxRow:u}=i;if(e<s||r<a||e>u||r>o)return Promise.resolve(null);const l=(0,le.ph)(this.rasterId,t.sliceId),c=`${n}/${e}/${r}`;let d=(0,le.gd)(l,t.registryId,c);if(null==d){const f=new AbortController;d=this.fetchRawTile(n,e,r,{...t,signal:f.signal}),(0,le.no)(l,t.registryId,c,d,f),d.catch(()=>(0,le.zo)(l,t.registryId,c))}return t.signal&&(0,xe.u7)(t,()=>{(0,le.jX)(l,t.registryId,c)}),d}_computeMagDirValues(n){var e;const{bandCount:r,dataType:t}=this.rasterInfo;if((2!==r||"vector-magdir"!==t)&&"vector-uv"!==t||2!==(null==n?void 0:n.length)||null===(e=n[0])||void 0===e||!e.length)return null;const i=n[0].length;if("vector-magdir"===t){const l=n[1].map(c=>(c+360)%360);return[n[0],l]}const[s,a]=n,o=[],u=[];for(let l=0;l<i;l++){const[c,d]=(0,Ge.Lu)([s[l],a[l]]);o.push(c),u.push(d)}return[o,u]}_getRasterTileAlignmentInfo(n,e){return null==this._rasterTileAlignmentInfo&&(this._rasterTileAlignmentInfo=(0,z.DO)(this.rasterInfo)),null==this._rasterTileAlignmentInfo.pyramidsInfo?null:{startX:e,halfWorldWidth:this._rasterTileAlignmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlignmentInfo.hasGCSSShiftTransform,...this._rasterTileAlignmentInfo.pyramidsInfo[n]}}_getSourceDataInfo(n,e,r,t={}){const i={datumTransformation:t.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};t.srcResolution&&(i.srcResolution=t.srcResolution,this._updateSourceDataInfo(n,i));const s=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:a,srcHeight:o,pyramidLevel:u}=i,l=a/e,c=o/r,d=u<s&&l*c>=16,f=u===s&&this._requireTooManySrcTiles(a,o,e,r);if(d||f||0===a||0===o){const p=new W.A({x:(n.xmax-n.xmin)/e,y:(n.ymax-n.ymin)/r,spatialReference:n.spatialReference});let m=(0,z.Wo)(p,this.rasterInfo.spatialReference,n,i.datumTransformation);if(d&&t.srcResolution&&(!m||t.srcResolution&&m.x+m.y<t.srcResolution.x+t.srcResolution.y)){const y=Math.round(Math.log(Math.max(l,c))/Math.LN2)-1;if(s-u+3>=y){const h=2**y;m={x:t.srcResolution.x*h,y:t.srcResolution.y*h}}}m&&(i.srcResolution=m,this._updateSourceDataInfo(n,i))}return this._requireTooManySrcTiles(i.srcWidth,i.srcHeight,e,r)&&(i.srcWidth=0,i.srcHeight=0),i}_requireTooManySrcTiles(n,e,r,t){const{tileInfo:i}=this.rasterInfo.storageInfo,a=n/r,o=e/t;return Math.ceil(n/i.size[0])*Math.ceil(e/i.size[1])>=256*Math.max(1,(r+t)/1024)||a>8||o>8}_updateSourceDataInfo(n,e){e.srcWidth=0,e.srcHeight=0;const{rasterInfo:r}=this,t=r.spatialReference,{srcResolution:i,datumTransformation:s}=e,{pyramidLevel:a,pyramidResolution:o,excessiveReading:u}=(0,z.t$)(i,r,this.ioConfig.sampling);if(u)return;let l=e.srcExtent||(0,z._l)(n,t,s);if(null==l)return;const c=r.transform;c&&(l=c.inverseTransform(l)),e.srcExtent=l;const{x:d,y:f}=r.storageInfo.origin,p=Math.floor((l.xmin-d)/o.x+.1),m=Math.floor((f-l.ymax)/o.y+.1),g=Math.floor((l.xmax-d)/o.x-.1),y=Math.floor((f-l.ymin)/o.y-.1),h=l.width<.1*o.x?0:g-p+1,v=l.height<.1*o.y?0:y-m+1;e.pyramidLevel=a,e.pyramidResolution=o,e.srcWidth=h,e.srcHeight=v,e.ul={x:p,y:m}}_getRequestOptionsWithSliceId(n){return null!=this.rasterInfo.multidimensionalInfo&&null==n.sliceId&&(n={...n,sliceId:this.getSliceIndex(n.multidimensionalDefinition)}),n}_processIdentifyResult(n,e){const{srcLocation:r,position:t,pyramidLevel:i,useTransposedTile:s}=e,a=n.pixels[0].length/n.width/n.height;if(n.mask&&!n.mask[t])return{location:r,value:null};const{multidimensionalInfo:o}=this.rasterInfo;if(null==o||!s){const h=n.pixels.map(I=>I[t]),v={location:r,value:h,pyramidLevel:i},x=this._computeMagDirValues(h.map(I=>[I]));return null!=x&&x.length&&(v.magdirValue=x.map(I=>I[0])),v}let u=n.pixels.map(h=>h.slice(t*a,t*a+a)),l=this._computeMagDirValues(u);const{requestSomeSlices:c,identifyOptions:d}=e;let f=(0,Y.QW)(o,d.transposedVariableName);if(c){var p;const h=(0,Y.xx)(f,d.multidimensionalDefinition,d.timeExtent);u=u.map(v=>h.map(x=>v[x])),l=null===(p=l)||void 0===p?void 0:p.map(v=>h.map(x=>v[x])),f=h.map(v=>f[v])}const m=n.noDataValues||this.rasterInfo.noDataValue,g={pixels:u,pixelType:n.pixelType};let y;return null!=m&&((0,ut.Sp)(g,m),y=g.mask),{location:r,value:null,dataSeries:f.map((h,v)=>{var x,I;const R={value:0===(null===(x=y)||void 0===x?void 0:x[v])?null:u.map(T=>T[v]),multidimensionalDefinition:h.multidimensionalDefinition.map(T=>new We.A({...T,isSlice:!0}))};return null!==(I=l)&&void 0!==I&&I.length&&(R.magdirValue=[l[0][v],l[1][v]]),R}),pyramidLevel:i}}};(0,w._)([(0,A.MZ)()],Z.prototype,"_rasterTileAlignmentInfo",void 0),(0,w._)([(0,A.MZ)()],Z.prototype,"_tileFetchQueue",void 0),(0,w._)([(0,A.MZ)({readOnly:!0})],Z.prototype,"_isGlobalWrappableSource",null),(0,w._)([(0,A.MZ)({readOnly:!0})],Z.prototype,"_hasNoneOrGCSShiftTransform",null),(0,w._)([(0,A.MZ)()],Z.prototype,"rasterJobHandler",null),(0,w._)([(0,A.MZ)({readOnly:!0})],Z.prototype,"rasterId",null),(0,w._)([(0,A.MZ)($e.OZ)],Z.prototype,"url",null),(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Z.prototype,"datasetName",void 0),(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Z.prototype,"datasetFormat",void 0),(0,w._)([(0,A.MZ)()],Z.prototype,"hasUniqueSourceStorageInfo",void 0),(0,w._)([(0,A.MZ)()],Z.prototype,"rasterInfo",void 0),(0,w._)([(0,A.MZ)()],Z.prototype,"ioConfig",void 0),(0,w._)([(0,A.MZ)()],Z.prototype,"sourceJSON",void 0),Z=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.BaseRaster")],Z);const ue=Z;var ft=S(82663),te=S(66234);function Ue(n,e,r){return Ze.apply(this,arguments)}function Ze(){return(Ze=(0,F.A)(function*(n,e,r){if("extent"===r.type)return function Gt(n,e,r){const{width:t,height:i}=n,s=new Uint8Array(t*i),a=e.width/t,o=e.height/i;if(r.width/a<.5||r.height/o<.5)return new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,pixels:[...n.pixels]});const{xmin:u,xmax:l,ymin:c,ymax:d}=e,{xmin:f,xmax:p,ymin:m,ymax:g}=r,y=Math.max(u,f),h=Math.min(l,p),v=Math.max(c,m),x=Math.min(d,g),I=.5*a,R=.5*o;if(h-y<I||x-v<R||h<u+I||y>l-I||v>d-R||x<c+R)return new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,pixels:[...n.pixels]});const T=Math.max(0,(y-u)/a),b=Math.min(t,Math.max(0,(h-u)/a)),O=Math.max(0,(d-x)/o),P=Math.min(i,Math.max(0,(d-v)/o)),C=Math.round(T),D=Math.round(b)-1,M=Math.round(O),N=Math.round(P)-1;if(C===D&&T%1>.5&&b%1<.5||M===N&&O%1>.5&&P%1<.5)return new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,pixels:[...n.pixels]});if(0===C&&0===M&&D===t&&N===i)return n;const B=n.mask;for(let J=M;J<=N;J++)for(let L=C;L<=D;L++){const E=J*t+L;s[E]=B?B[E]:255}return new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,pixels:[...n.pixels]})}(n,e,r);const{width:t,height:i}=n,s=new Uint8Array(t*i),{contains:a,intersects:o}=yield Promise.all([S.e(3930),S.e(2076),S.e(6041)]).then(S.bind(S,46041));return o(e,r)?"polyline"===r.type?function Ut(n,e,r){const{width:t,height:i}=n,s=new Uint8Array(t*i),a=e.width/t,o=e.height/i,{xmin:u,ymax:l}=e,{paths:c}=r,d=n.mask;for(let f=0;f<c.length;f++){const p=c[f];for(let m=0;m<p.length-1;m++){const[g,y]=p[m],[h,v]=p[m+1];let x=Math.floor((l-y)/o),I=Math.floor((l-v)/o);if(I<x){const T=x;x=I,I=T}x=Math.max(0,x),I=Math.min(i-1,I);const R=(h-g)/(v-y);for(let T=x;T<=I;T++){const b=T===x?Math.max(y,v):(i+1-T)*o,O=T===I?Math.min(y,v):b-o;let P=Math.floor(v===y?(g-u)/a:(R*(b-y)+g-u)/a),C=Math.floor(v===y?(h-u)/a:(R*(O-y)+g-u)/a);if(C<P){const M=P;P=C,C=M}const D=T*t;P=Math.max(0,P),C=Math.min(t-1,C);for(let M=D+P;M<=D+C;M++)s[M]=d?d[M]:255}}}return new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,pixels:[...n.pixels]})}(n,e,r):a(r,e)?n:function _t(n,e,r){if(!n)return n;const{width:t,height:i}=n,s=e.width/t,a=e.height/i,{xmin:o,ymax:u}=e;let l;if("extent"===r.type){const y=(r.xmin-o)/s,h=(r.xmax-o)/s,v=(u-r.ymax)/a,x=(u-r.ymin)/a;l=[[[y,v],[y,x],[h,x],[h,v],[y,v]]]}else l=r.rings.map(y=>y.map(([h,v])=>[(h-o)/s,(u-v)/a]));const c=document.createElement("canvas");c.width=t,c.height=i;const d=c.getContext("2d");d.fillStyle="#f00",d.beginPath(),l.forEach(y=>{d.moveTo(y[0][0],y[0][1]);for(let h=0;h<y.length;h++)d.lineTo(y[h][0],y[h][1]);d.closePath()}),d.fill();const f=d.getImageData(0,0,t,i).data,p=n.mask,m=t*i,g=new Uint8Array(m);for(let y=0;y<m;y++)p&&!p[y]||(g[y]=f[4*y+3]>127?255:0);return new te.A({pixelType:n.pixelType,width:t,height:i,mask:g,maskIsAlpha:!1,pixels:[...n.pixels]})}(n,e,r):new te.A({pixelType:n.pixelType,width:t,height:i,mask:s,maskIsAlpha:!1,pixels:[...n.pixels]})})).apply(this,arguments)}var De=S(93327);let me=class extends ue{constructor(){super(...arguments),this.datasetFormat="Function",this.tileType="Raster",this.rasterFunction=null,this._clippingGeometry=new Map}open(n){var e=this;return(0,F.A)(function*(){var r,t,i,s;yield e.init();const{rasterFunction:a}=e;null!==(r=e.primaryRasters)&&void 0!==r&&null!==(r=r.rasters)&&void 0!==r&&r.length?a.sourceRasters=e.primaryRasters.rasters:(e.primaryRasters=a.getPrimaryRasters(),e.rasterJobHandler&&(null===(t=e.primaryRasters.rasters)||void 0===t||t.forEach(m=>m.rasterJobHandler=e.rasterJobHandler)));const{rasters:o,rasterIds:u}=e.primaryRasters,l=o.map(m=>m.rasterInfo?void 0:m.open(n));yield Promise.all(l);const c=o.map(({rasterInfo:m})=>m),d=a.bind({rasterInfos:c,rasterIds:u});if(a.rawSourceRasterInfos=c,!d.success||0===c.length)throw new k.A("raster-function:open",`cannot bind the function: ${null!==(i=d.error)&&void 0!==i?i:""}`);const f="Table"===a.functionName?a:null===(s=a.functionArguments)||void 0===s?void 0:s.raster;"Table"===(null==f?void 0:f.functionName)&&(a.rasterInfo.attributeTable=De.A.fromJSON(f.functionArguments.attributeTableAsRecordSet)),yield e.syncJobHandler();const p=c[0];e.hasUniqueSourceStorageInfo=1===c.length||c.slice(1).every(m=>e._hasSameStorageInfo(m,p)),e.set("sourceJSON",o[0].sourceJSON),e.set("rasterInfo",a.rasterInfo),yield e._updateClipGeometry()})()}syncJobHandler(){var n=this;return(0,F.A)(function*(){var e;return null===(e=n.rasterJobHandler)||void 0===e?void 0:e.updateRasterFunction(n.rasterFunction)})()}fetchPixels(n,e,r,t={}){var i=this;return(0,F.A)(function*(){var s,a,o;const{rasters:u,rasterIds:l}=i.primaryRasters;let c=!1;const{interpolation:d}=t,f=null===(s=i.rasterFunction.flatWebGLFunctionChain)||void 0===s?void 0:s.hasFocalFunction;!t.requestRawData&&f&&(c=1===u.length&&!t.skipRasterFunction,t={...t,interpolation:"bilinear",requestRawData:c});const p=u.map(b=>b.fetchPixels(n,e,r,t)),m=yield Promise.all(p),g=m.map(b=>b.pixelBlock),y=c||t.requestRawData?m.map(b=>b.srcTilePixelSize):null;if(t.skipRasterFunction||g.every(b=>null==b))return m[0];const h=null!==(a=null===(o=m.find(b=>null!=b.pixelBlock))||void 0===o?void 0:o.extent)&&void 0!==a?a:n;let v=i.rasterJobHandler?yield i.rasterJobHandler.process({extent:h,primaryPixelBlocks:g,primaryPixelSizes:y,primaryRasterIds:l}):i.rasterFunction.process({extent:h,primaryPixelBlocks:g,primaryPixelSizes:y,primaryRasterIds:l});const{transformGrid:x}=m[0];if(!c||null==v||null==x){const b=t.noClip?null:i.getClippingGeometry(h.spatialReference);return t.noClip||t.requestRawData||null==v||!b||(v=yield Ue(v,h,b)),{...m[0],pixelBlock:v}}const I={rows:x.spacing[0],cols:x.spacing[1]};let R;R=i.rasterJobHandler?(yield i.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[v],srcMosaicSize:{width:v.width,height:v.height},destDimension:{width:e,height:r},coefs:x.coefficients,sampleSpacing:I,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:d,alignmentInfo:void 0,blockWidths:null},t)).pixelBlock:(0,ae.$i)(v,{width:e,height:r},x.coefficients,I,d);const T=t.noClip?null:i.getClippingGeometry(n.spatialReference);return t.noClip||t.requestRawData||null==R||null==T||(R=yield Ue(R,n,T)),{extent:n,srcExtent:m[0].srcExtent,pixelBlock:R}})()}getClippingGeometry(n){const e=this._clippingGeometry.get("0");if(!n||!e)return e;const r=this._getSRKey(n);let t=this._clippingGeometry.get(r);return null!=t||(t=n.equals(e.spatialReference)?e:(0,z.uk)(e,n),this._clippingGeometry.set(r,t)),t}_hasSameStorageInfo(n,e){const{storageInfo:r,pixelSize:t,spatialReference:i,extent:s}=n,{storageInfo:a,pixelSize:o,spatialReference:u,extent:l}=e;return t.x===o.x&&t.y===o.y&&i.equals(u)&&s.equals(l)&&r.blockHeight===a.blockHeight&&r.blockWidth===a.blockWidth&&r.maximumPyramidLevel===a.maximumPyramidLevel}_updateClipGeometry(){var n=this;return(0,F.A)(function*(){const e=n.rasterFunction.getClippingGeometries()[0];let r=null==e?void 0:e.clippingGeometry;if(r&&"inside"===e.clippingType){const{extent:t}=n.rasterInfo,{difference:i,densify:s}=yield Promise.all([S.e(3930),S.e(2076),S.e(6041)]).then(S.bind(S,46041));let a=s(Jt.A.fromExtent(t),2*(t.width+t.height)/40);a=(0,z.uk)(a,r.spatialReference),r=i(a,r)}n._clippingGeometry.clear(),r&&n._clippingGeometry.set("0",r)})()}_getSRKey(n){var e,r;return String(null!==(e=null!==(r=n.wkid)&&void 0!==r?r:n.wkt)&&void 0!==e?e:n.wkt2)}};(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],me.prototype,"datasetFormat",void 0),(0,w._)([(0,A.MZ)()],me.prototype,"tileType",void 0),(0,w._)([(0,A.MZ)()],me.prototype,"rasterFunction",void 0),(0,w._)([(0,A.MZ)()],me.prototype,"primaryRasters",void 0),me=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.FunctionRaster")],me);const mt=me;var je=S(45901),pe=S(48104),ce=S(22151),Vt=S(54636),Xt=S(98464),Yt=S(91551);const Kt=n=>{let e=class extends n{constructor(...t){var i;super(...t),this._isConstructedFromFunctionRaster=!1,this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.interpolation="nearest",this.multidimensionalSubset=null,this.raster=null,this.serviceRasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.symbolizer=null,this._isConstructedFromFunctionRaster="Function"===(null===(i=t[0])||void 0===i||null===(i=i.raster)||void 0===i?void 0:i.datasetFormat)}get fullExtent(){var t;return null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.extent}set multidimensionalDefinition(t){this._set("multidimensionalDefinition",t),this.updateRenderer()}set rasterFunction(t){var i;"none"===(null===(i=t)||void 0===i||null===(i=i.functionName)||void 0===i?void 0:i.toLowerCase())&&(t=void 0),this._set("rasterFunction",t),this.updateRasterFunction()}get rasterInfo(){return(0,Dt.Lx)(fe.A.getLogger(this),"rasterInfo",{replacement:"serviceRasterInfo",version:"4.29",warnOnce:!0}),this._get("serviceRasterInfo")}set url(t){this._set("url",(0,ot.Jf)(t,fe.A.getLogger(this)))}set renderer(t){null==t&&null==this.rasterFunction?this._configDefaultRenderer("override"):(this._set("renderer",t),this.updateRenderer())}readRenderer(t,i,s){var a;const o=null==i||null===(a=i.layerDefinition)||void 0===a||null===(a=a.drawingInfo)||void 0===a?void 0:a.renderer;return(0,He.LF)(o,s)||void 0}convertVectorFieldData(t,i){var s=this;return(0,F.A)(function*(){const{serviceRasterInfo:a}=s;if(null==t||!a)return null;const o=s._rasterJobHandler.instance,u=a.dataType;return o?o.convertVectorFieldData({pixelBlock:t,dataType:u},i):(0,Ge.FI)(t,u)})()}computeStatisticsHistograms(t,i){var s=this;return(0,F.A)(function*(){var a;t=(0,Oe.PZ)(Xt.A,t).clone();const{serviceRasterInfo:o}=s,{geometry:u}=t;if(null==u)throw new k.A("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");let l=u;const{spatialReference:c}=o;u.spatialReference.equals(c)||(yield(0,z.Hh)(),l="extent"===u.type?(0,z._l)(u,c):(0,z.uk)(u,c));const d=null!==(a=t.pixelSize)&&void 0!==a?a:new W.A({x:o.pixelSize.x,y:o.pixelSize.y,spatialReference:c}),{extent:f,width:p,height:m}=function Zt(n,e,r,t=!0){const{spatialReference:i}=n,{x:s,y:a}=function Wt(n,e){if(n.spatialReference.equals(e))return n;const r=(0,ft.GA)(n.spatialReference),t=(0,ft.GA)(e);if(r===t)return n;const i=r/t;return{x:n.x*i,y:n.y*i}}(r,i);let o,u,l;const c="extent"===e.type?e:e.extent;let{xmin:d,xmax:f,ymax:p,ymin:m}=c;const{xmin:g,ymax:y}=n.extent;return t?(d=g+(d>g?s*Math.round((d-g)/s):0),p=y-(p<y?a*Math.round((y-p)/a):0),f=g+(f>g?s*Math.round((f-g)/s):0),m=y-(m<y?a*Math.round((y-m)/a):0),o=new _.A({xmin:d,ymax:p,xmax:f,ymin:m,spatialReference:i}),u=Math.round(o.width/s),l=Math.round(o.height/a)):(u=Math.floor((f-d)/s+.8),l=Math.floor((p-m)/a+.8),d=g+(d>g?s*Math.floor((d-g)/s+.1):0),p=y-(p<y?a*Math.floor((y-p)/a+.1):0),f=d+u*s,m=p-l*a,o=new _.A({xmin:d,ymax:p,xmax:f,ymin:m,spatialReference:i})),{extent:o,width:u,height:l}}(o,l,d),g=yield s.fetchPixels(f,p,m,{...i,interpolation:"nearest"});if(null==g.pixelBlock)throw new k.A("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");const y=yield Ue(g.pixelBlock,f,l),h=s._rasterJobHandler.instance;return h?h.computeStatisticsHistograms({pixelBlock:y},i):(0,pe.eH)(y)})()}createFlowMesh(t,i){var s=this;return(0,F.A)(function*(){const a=s._rasterJobHandler.instance;return a?a.createFlowMesh(t,i):(0,Yt.CW)(t.meshType,t.simulationSettings,t.flowData,null!=i.signal?i.signal:(new AbortController).signal)})()}normalizeRasterFetchOptions(t){var i,s;const{multidimensionalInfo:a}=null!==(i=this.serviceRasterInfo)&&void 0!==i?i:{};if(null==a)return t;let o=t.multidimensionalDefinition||this.multidimensionalDefinition;null!==(s=o)&&void 0!==s&&s.length||(o=(0,Y.fy)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));const u=t.timeExtent||this.timeExtent;if(null!=o&&null!=u&&(null!=u.start||null!=u.end)){var l;o=o.map(v=>v.clone());const c=null===(l=a.variables.find(({name:v})=>v===o[0].variableName))||void 0===l||null===(l=l.dimensions)||void 0===l?void 0:l.find(({name:v})=>"StdTime"===v),d=o.find(({dimensionName:v})=>"StdTime"===v);if(!c||!d)return{...t,multidimensionalDefinition:null};const{start:f,end:p}=u,m=null==f?null:f.getTime(),g=null==p?null:p.getTime(),y=null!=m?m:g,h=null!=g?g:m;if(null!=c.values){const v=c.values.filter(x=>Array.isArray(x)?y===h?x[0]<=y&&x[1]>=y:x[0]<=y&&x[1]>y||x[0]<h&&x[1]>=h||x[0]>=y&&x[1]<=h||x[0]<y&&x[1]>h:y===h?x===y:x>=y&&x<=h);if(v.length){const x=v.sort((I,R)=>{const T=Array.isArray(I)?I[0]:I,b=Array.isArray(I)?I[1]:I,O=Array.isArray(R)?R[0]:R,P=Array.isArray(R)?R[1]:R;return y===h?T-O:Math.abs(b-h)-Math.abs(P-h)})[0];d.values=[x]}else o=null}else if(c.hasRegularIntervals&&c.extent){const[v,x]=c.extent;y>x||h<v?o=null:d.values=y===h?[y]:[Math.max(v,y),Math.min(x,h)]}}return null!=o&&(0,Y.sx)(o,this.multidimensionalSubset)?{...t,multidimensionalDefinition:null}:{...t,multidimensionalDefinition:o}}updateRasterFunction(){var t=this;return(0,F.A)(function*(){if(!t.loaded||"imagery-tile"!==t.type||!t.rasterFunction&&!t._cachedRasterFunctionJson||JSON.stringify(t.rasterFunction)===JSON.stringify(t._cachedRasterFunctionJson))return;if(t._isConstructedFromFunctionRaster&&"Function"===t.raster.datasetFormat){var i;const g=t.raster.rasterFunction.toJSON();return!t.rasterFunction&&g&&t._set("rasterFunction",_e.A.fromJSON(g)),void(t._cachedRasterFunctionJson=null===(i=t.rasterFunction)||void 0===i?void 0:i.toJSON())}let s,a=t.raster,o=!1;"Function"===a.datasetFormat?(s=a.primaryRasters.rasters,a=s[0],o=!0):s=[a];const{rasterFunction:u}=t;if(u){var l,c,d;const g={raster:a};s.length>1&&s.forEach(v=>g[v.url]=v);const y=(0,je.vt)(null!==(l=null===(c=u.functionDefinition)||void 0===c?void 0:c.toJSON())&&void 0!==l?l:u.toJSON(),g),h=new mt({rasterFunction:y});h.rasterJobHandler=t._rasterJobHandler.instance,yield h.open(),t._cachedRasterFunctionJson=null===(d=t.rasterFunction)||void 0===d?void 0:d.toJSON(),t.raster=h}else t.raster=a,t._cachedRasterFunctionJson=null,yield a.when();if(t._cachedRendererJson=null,!o&&!u)return;const{bandIds:f}=t,{bandCount:p}=t.raster.rasterInfo,m=null!=f&&f.length?f.some(g=>g>=p):p>=3;f&&(m||t.renderer&&"raster-stretch"!==t.renderer.type)&&t._set("bandIds",null),t._configDefaultRenderer("auto")})()}updateRenderer(){var t=this;return(0,F.A)(function*(){const{loaded:i,symbolizer:s}=t;if(!i||!s||!t.renderer)return;const{rasterInfo:a}=t.raster,o=(0,Y.ct)(a,{multidimensionalDefinition:t.multidimensionalDefinition,multidimensionalSubset:t.multidimensionalSubset}),u=null==o?void 0:o.name,l=(0,ce.$P)({...t.renderer.toJSON(),variableName:u});if(JSON.stringify(t._cachedRendererJson)===JSON.stringify(l))return;const c=t._rasterJobHandler.instance;c&&(s.rasterInfo=(0,ce.m7)(a,u),s.rendererJSON=l,s.bind(),yield c.updateSymbolizer(s),t._cachedRendererJson=l)})()}applyRenderer(t,i){var s=this;return(0,F.A)(function*(){var a;const o=null==t?void 0:t.pixelBlock;if(!(null!=o&&o.pixels&&o.pixels.length>0))return null;let u;yield s.updateRenderer();const l=s._rasterJobHandler.instance,c=null!==(a=s.bandIds)&&void 0!==a?a:[];return u=l?yield l.symbolize({...t,simpleStretchParams:i,bandIds:c}):s.symbolizer.symbolize({...t,simpleStretchParams:i,bandIds:c}),u})()}getTileUrl(t,i,s){return"RasterTileServer"===this.raster.datasetFormat?`${this.url}/tile/${t}/${i}/${s}`:""}getCompatibleTileInfo(t,i,s=!1){if(!this.loaded||null==i)return null;if(s&&t.equals(this.spatialReference))return this.tileInfo;const a=(0,at.Vp)(t);return se.A.create({size:256,spatialReference:t,origin:a?{x:a.origin[0],y:a.origin[1]}:{x:i.xmin,y:i.ymax}})}getCompatibleFullExtent(t){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(t)||(this._compatibleFullExtent=this.raster.computeExtent(t)),this._compatibleFullExtent):null}fetchTile(t,i,s,a={}){var o=this;return(0,F.A)(function*(){var u;if(r(o),a.requestAsImageElement){const c=o.getTileUrl(t,i,s);return(0,st.A)(c,{responseType:"image",query:{...o.refreshParameters,...o.raster.ioConfig.customFetchParameters},signal:a.signal}).then(d=>d.data)}const{serviceRasterInfo:l}=o;return null!=l.multidimensionalInfo&&null==(a=o.normalizeRasterFetchOptions(a)).multidimensionalDefinition?{extent:o.raster.getTileExtentFromTileInfo(t,i,s,a.tileInfo||l.storageInfo.tileInfo),pixelBlock:null}:(yield o._initJobHandler(),yield o.updateRasterFunction(),"raster-shaded-relief"===(null===(u=o.renderer)||void 0===u?void 0:u.type)&&(a={...a,buffer:{cols:1,rows:1}}),o.raster.fetchTile(t,i,s,a))})()}fetchPixels(t,i,s,a={}){var o=this;return(0,F.A)(function*(){return null!=o.serviceRasterInfo.multidimensionalInfo&&null==(a=o.normalizeRasterFetchOptions(a)).multidimensionalDefinition?{extent:t,pixelBlock:null}:(yield o._initJobHandler(),yield o.updateRasterFunction(),i=Math.round(i),s=Math.round(s),o.raster.fetchPixels(t,i,s,a))})()}identify(t,i={}){var s=this;return(0,F.A)(function*(){var a;const{raster:o,serviceRasterInfo:u}=s;if(!(null==u.multidimensionalInfo||u.hasMultidimensionalTranspose&&((0,Y.DY)(i.multidimensionalDefinition)||i.transposedVariableName||i.timeExtent)||null!=(i=s.normalizeRasterFetchOptions(i)).multidimensionalDefinition))return{location:t,value:null};const l=null===(a=s.multidimensionalSubset)||void 0===a?void 0:a.areaOfInterest;if(l&&!l.contains(t))throw new k.A("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");return o.identify(t,i)})()}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}hasStandardTime(){var t,i,s;const a=null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.multidimensionalInfo;if(null==a||"standard-time"!==(null===(i=this.serviceRasterInfo)||void 0===i?void 0:i.dataType))return!1;const o=this.multidimensionalDefinition,u=null==o||null===(s=o[0])||void 0===s?void 0:s.variableName;return a.variables.some(l=>l.name===u&&(!(null!=o&&o[0].dimensionName)||l.dimensions.some(c=>"StdTime"===c.name)))}getStandardTimeValue(t){return new Date(24*(t-25569)*3600*1e3).toString()}getMultidimensionalSubsetVariables(t){var i;const s=null!=t?t:null===(i=this.serviceRasterInfo)||void 0===i?void 0:i.multidimensionalInfo;return(0,Y.z2)(this.multidimensionalSubset,s)}_configDefaultSettings(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,Y.fy)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&"Function"===this.raster.datasetFormat&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}_initJobHandler(){var t=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;const i=new Bt.A;return this._rasterJobHandler.connectionPromise=i.initialize().then((0,F.A)(function*(){r(t),t._rasterJobHandler.instance=i,t.raster.rasterJobHandler=i,"Function"===t.raster.datasetFormat&&t.raster.syncJobHandler(),t.rasterFunction&&(yield t.updateRasterFunction().catch(()=>{})),t.renderer&&t.updateRenderer()})).catch(()=>{}),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}_configDefaultInterpolation(){if(null==this.interpolation){var t;r(this);const{raster:i}=this,s=(0,ce.w6)(i.rasterInfo,i.tileType,null===(t=this.sourceJSON)||void 0===t?void 0:t.defaultResamplingMethod);this._set("interpolation",s)}}_configDefaultRenderer(t="no"){r(this);const{rasterInfo:i}=this.raster;!this.bandIds&&i.bandCount>1&&(this.bandIds=(0,ce.ci)(i));const s=(0,Y.ct)(i,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),a=null==s?void 0:s.name;if(!this.renderer||"override"===t){var o,u;const m=(0,ce.PD)(i,{bandIds:this.bandIds,variableName:a}),g=i.statistics,y=g&&g.length>0?g[0]:null,h=null!==(o=null==y?void 0:y.max)&&void 0!==o?o:0,v=null!==(u=null==y?void 0:y.min)&&void 0!==u?u:0;"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===m.type&&(h>1e24||v<-1e24)&&(m.dynamicRangeAdjustment=!0,m.statistics=null,"none"===m.stretchType&&(m.stretchType="min-max")),this.renderer=m}const l=(0,ce.$P)({...this.renderer.toJSON(),variableName:a}),c=(0,ce.m7)(i,a);this.symbolizer?(this.symbolizer.rendererJSON=l,this.symbolizer.rasterInfo=c):this.symbolizer=new Vt.A({rendererJSON:l,rasterInfo:c});const d=this.symbolizer.bind();if(d.success){if("auto"===t){const{colormap:m}=this.raster.rasterInfo,g=this.renderer;if(null!=m&&"raster-colormap"===g.type){const y=(0,ce.PD)(this.raster.rasterInfo);JSON.stringify(y)!==JSON.stringify(g)&&this._configDefaultRenderer("override")}else if("raster-stretch"===g.type){var f,p;const y=null===(f=this.bandIds)||void 0===f?void 0:f.length,h=null===(p=g.statistics)||void 0===p?void 0:p.length;!g.dynamicRangeAdjustment&&h&&y&&h!==y&&this._configDefaultRenderer("override")}}}else fe.A.getLogger(this).warn("imagery-tile-mixin",d.error||"The given renderer is not supported by the layer."),"auto"===t&&this._configDefaultRenderer("override")}};function r(t){if(!t.raster||!t.serviceRasterInfo)throw new k.A("imagery-tile","no raster")}return(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"_cachedRendererJson",void 0),(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"_cachedRasterFunctionJson",void 0),(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"_compatibleFullExtent",void 0),(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"_isConstructedFromFunctionRaster",void 0),(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"_rasterJobHandler",void 0),(0,w._)([(0,A.MZ)()],e.prototype,"bandIds",void 0),(0,w._)([(0,A.MZ)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],e.prototype,"copyright",void 0),(0,w._)([(0,A.MZ)({json:{read:!1}})],e.prototype,"fullExtent",null),(0,w._)([(0,A.MZ)()],e.prototype,"interpolation",void 0),(0,w._)([(0,A.MZ)()],e.prototype,"ioConfig",void 0),(0,w._)([(0,A.MZ)({type:[We.A],json:{write:!0}})],e.prototype,"multidimensionalDefinition",null),(0,w._)([(0,A.MZ)({type:kt.A,json:{write:!0}})],e.prototype,"multidimensionalSubset",void 0),(0,w._)([(0,A.MZ)()],e.prototype,"raster",void 0),(0,w._)([(0,A.MZ)({type:_e.A,json:{name:"renderingRule",write:!0}})],e.prototype,"rasterFunction",null),(0,w._)([(0,A.MZ)({readOnly:!0})],e.prototype,"rasterInfo",null),(0,w._)([(0,A.MZ)()],e.prototype,"serviceRasterInfo",void 0),(0,w._)([(0,A.MZ)()],e.prototype,"sourceJSON",void 0),(0,w._)([(0,A.MZ)({readOnly:!0,type:G.A,json:{read:!1}})],e.prototype,"spatialReference",void 0),(0,w._)([(0,A.MZ)({type:se.A})],e.prototype,"tileInfo",void 0),(0,w._)([(0,A.MZ)($e.OZ)],e.prototype,"url",null),(0,w._)([(0,A.MZ)({types:He.uy,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){var t;const i="raster-stretch"===(null===(t=this.renderer)||void 0===t?void 0:t.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!i}}},origins:{"web-scene":{types:He.Gj,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:t=>({enabled:t&&"vector-field"!==t.type&&"flow"!==t.type})}}}}})],e.prototype,"renderer",null),(0,w._)([(0,Nt.w)("renderer")],e.prototype,"readRenderer",null),(0,w._)([(0,A.MZ)({clonable:!1})],e.prototype,"symbolizer",void 0),e=(0,w._)([(0,ee.$)("esri.layers.ImageryTileMixin")],e),e};var Qt=S(17049),qt=S(85551),en=S(1151),tn=S(33036),nn=S(84311),Ie=S(29141),rn=S(9932),Te=S(83179),pt=S(38497);function sn(n){const e=n.fields,r=n.records,t=e.some(l=>"oid"===l.name.toLowerCase())?"OBJECTID":"OID",i=[{name:t,type:"esriFieldTypeOID",alias:"OID"}].concat(e.map(l=>({name:l.name,type:"esriFieldType"+l.typeName,alias:l.name}))),s=i.map(l=>l.name),a=[];let o=0,u=0;return r.forEach(l=>{const c={};for(c[t]=o++,u=1;u<s.length;u++)c[s[u]]=l[u-1];a.push({attributes:c})}),{displayFieldName:"",fields:i,features:a}}class ht{static get supportedVersions(){return[5]}static parse(e){const r=new DataView(e),t=3&r.getUint8(0);if(3!==t)return{header:{version:t},recordSet:null};const i=r.getUint32(4,!0),s=r.getUint16(8,!0),a=r.getUint16(10,!0),o={version:t,recordCount:i,headerByteCount:s,recordByteCount:a};let u=32;const l=[],c=[];let d;if(3===t){for(;13!==r.getUint8(u);)d=String.fromCharCode(r.getUint8(u+11)).trim(),l.push({name:(0,pt.w)(new Uint8Array(e,u,11)),type:d,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(d)],length:r.getUint8(u+16)}),u+=32;if(u+=1,l.length>0)for(;c.length<i&&e.byteLength-u>a;){const f=[];32===r.getUint8(u)?(u+=1,l.forEach(p=>{if("C"===p.type)f.push((0,pt.w)(new Uint8Array(e,u,p.length)).trim());else if("N"===p.type)f.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,u,p.length)).trim(),10));else if("F"===p.type)f.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,u,p.length)).trim()));else if("D"===p.type){const m=String.fromCharCode.apply(null,new Uint8Array(e,u,p.length)).trim();f.push(new Date(parseInt(m.substring(0,4),10),parseInt(m.substring(4,6),10)-1,parseInt(m.substring(6,8),10)))}u+=p.length}),c.push(f)):u+=a}}return{header:o,fields:l,records:c,recordSet:sn({fields:l,records:c})}}}var yt=S(30797);const he=new Map;he.set("int16","esriFieldTypeSmallInteger"),he.set("int32","esriFieldTypeInteger"),he.set("int64","esriFieldTypeInteger"),he.set("float32","esriFieldTypeSingle"),he.set("float64","esriFieldTypeDouble"),he.set("text","esriFieldTypeString");let Me=class extends ue{constructor(){super(...arguments),this.storageInfo=null,this.datasetFormat="CRF"}open(n){var e=this;return(0,F.A)(function*(){yield e.init();const{data:r}=yield e.request(e.url+"/conf.json",{signal:null==n?void 0:n.signal});if(!e._validateHeader(r))throw new k.A("cloudraster:open","Invalid or unsupported conf.json.");e.datasetName=e.url.slice(e.url.lastIndexOf("/")+1);const{storageInfo:t,rasterInfo:i}=e._parseHeader(r);if("thematic"===i.dataType){const s=yield e._fetchAuxiliaryInformation();i.attributeTable=s}e._set("storageInfo",t),e._set("rasterInfo",i),e.ioConfig.retryCount=e.ioConfig.retryCount||0})()}fetchRawTile(n,e,r,t={}){var i=this;return(0,F.A)(function*(){const{transposeInfo:s}=i.rasterInfo.storageInfo,{transposedVariableName:a}=t,o=!(!s||!a),u=o?0:i.rasterInfo.storageInfo.maximumPyramidLevel-n;if(u<0)return null;const l=i._buildCacheFilePath(u,e,r,t.multidimensionalDefinition,a),c=i._getIndexRecordFromBundle(e,r,o),d=yield i.request(l,{range:{from:0,to:i.storageInfo.headerSize-1},responseType:"array-buffer",signal:t.signal});if(!d)return null;const f=new Uint8Array(d.data),p=i._getTileEndAndContentType(f,c);if(0===p.recordSize)return null;const m=yield i.request(l,{range:{from:p.position,to:p.position+p.recordSize},responseType:"array-buffer",signal:t.signal});if(!m)return null;const[g,y]=i._getTileSize(o);return i.decodePixelBlock(m.data,{width:g,height:y,planes:null,pixelType:null,returnInterleaved:o})})()}_validateHeader(n){return n&&"RasterInfo"===n.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some(r=>!n[r])}_parseHeader(n){var e,r,t,i;const s=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][n.pixelType],{bandCount:a,colormap:o,blockWidth:u,blockHeight:l,firstPyramidLevel:c,maximumPyramidLevel:d}=n,f=null===(e=n.statistics)||void 0===e?void 0:e.map(H=>({min:H.min,max:H.max,avg:H.mean,stddev:H.standardDeviation,median:H.median,mode:H.mode})),p=null!==(r=n.histograms)&&void 0!==r&&null!==(r=r[0])&&void 0!==r&&null!==(r=r.counts)&&void 0!==r&&r.length?n.histograms:null,m=n.extent.spatialReference,g=null===(t=n.geodataXform)||void 0===t?void 0:t.spatialReference,y=new G.A(null!=m&&m.wkid||null!=m&&m.wkt||null!=m&&m.wkt2?m:g);let h=new _.A({xmin:n.extent.xmin,ymin:n.extent.ymin,xmax:n.extent.xmax,ymax:n.extent.ymax,spatialReference:y});const v=new W.A({x:n.pixelSizeX,y:n.pixelSizeY,spatialReference:y}),x=Math.round((h.xmax-h.xmin)/v.x),I=Math.round((h.ymax-h.ymin)/v.y),R=this._parseTransform(n.geodataXform),T=R?h:null;R&&(h=R.forwardTransform(h),v.x=(h.xmax-h.xmin)/x,v.y=(h.ymax-h.ymin)/I);const b=null!==(i=n.properties)&&void 0!==i?i:{},O=n.format.toLowerCase().replace("cache/",""),P=new W.A(n.origin.x,n.origin.y,y);let C,D,M,N;if(null!=o&&o.colors)for(C=[],D=0;D<o.colors.length;D++)M=o.colors[D],N=o.values?o.values[D]:D,C.push([N,255&M,M<<16>>>24,M<<8>>>24,M>>>24]);const B=n.LODInfos,J=[];for(D=0;D<B.levels.length;D++)J.push(new lt.A({level:B.levels[D],resolution:B.resolutions[D],scale:96/.0254*B.resolutions[D]}));const L=new se.A({dpi:96,lods:J,format:O,origin:P,size:[u,l],spatialReference:y}),E={recordSize:8,packetSize:n.packetSize,headerSize:n.packetSize*n.packetSize*8+64},U=[{maxCol:Math.ceil(x/u)-1,maxRow:Math.ceil(I/l)-1,minCol:0,minRow:0}];let Q=2;if(d>0)for(D=0;D<d;D++)U.push({maxCol:Math.ceil(x/Q/u)-1,maxRow:Math.ceil(I/Q/l)-1,minCol:0,minRow:0}),Q*=2;const V=n.mdInfo;let X=null;if(V&&b._yxs){const H=b._yxs;X={packetSize:H.PacketSize,tileSize:[H.TileXSize,H.TileYSize]}}return{storageInfo:E,rasterInfo:new Te.A({width:x,height:I,pixelType:s,bandCount:a,extent:h,nativeExtent:T,transform:R,spatialReference:y,pixelSize:v,keyProperties:b,statistics:f,histograms:p,multidimensionalInfo:V,colormap:C,storageInfo:new Ae.A({blockWidth:u,blockHeight:l,pyramidBlockWidth:u,pyramidBlockHeight:l,origin:P,tileInfo:L,transposeInfo:X,firstPyramidLevel:c,maximumPyramidLevel:d,blockBoundary:U})})}}_parseTransform(n){var e,r;if(!(0,yt.J)(n))throw new k.A("cloudraster:open","the data contains unsupported geodata transform types");const t=(0,yt.l)(n);if("identity"===t.type)return null;if("polynomial"!==t.type||null===(e=t.forwardCoefficients)||void 0===e||!e.length||null===(r=t.inverseCoefficients)||void 0===r||!r.length)throw new k.A("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return t}_fetchAuxiliaryInformation(n){var e=this;return(0,F.A)(function*(){const r=e.request(e.url+"/conf.vat.json",{signal:n}).then(a=>a.data).catch(()=>null),t=e.request(e.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:n}).then(a=>a.data).catch(()=>null),i=yield Promise.all([r,t]);let s;if(i[0]){let a=i[0].fields;const o=i[0].values;if(a&&o){a=a.map(l=>({type:"OID"===l.name?"esriFieldTypeOID":he.get(l.type),name:l.name,alias:l.alias||l.name}));const u=o.map(l=>({attributes:l}));a&&o&&(s={fields:a,features:u})}}return!s&&i[1]&&(s=ht.parse(i[1]).recordSet),De.A.fromJSON(s)})()}_buildCacheFilePath(n,e,r,t,i){const s=this._getPackageSize(!!i),a=Math.floor(e/s)*s,o=Math.floor(r/s)*s,u="R"+this._toHexString4(a)+"C"+this._toHexString4(o);let l="L";l+=n>=10?n.toString():"0"+n.toString();const{multidimensionalInfo:c}=this.rasterInfo,d=null==t?void 0:t[0];if(null==c||!d)return`${this.url}/_alllayers/${l}/${u}.bundle`;let f="_yxs";if(!i){f=c.variables.find(g=>g.name===d.variableName).dimensions[0].values.indexOf(d.values[0]).toString(16);const m=4-f.length;for(let g=0;g<m;g++)f="0"+f;f="S"+f}const p=this._getVariableFolderName(i||d.variableName);return`${this.url}/_alllayers/${p}/${f}/${l}/${u}.bundle`}_getPackageSize(n=!1){var e;const{transposeInfo:r}=this.rasterInfo.storageInfo;return n&&null!=r?null!==(e=r.packetSize)&&void 0!==e?e:0:this.storageInfo.packetSize}_getTileSize(n=!1){const{storageInfo:e}=this.rasterInfo,{transposeInfo:r}=e;return n&&null!=r?r.tileSize:e.tileInfo.size}_getVariableFolderName(n){return""===(n=n.trim())?"_v":n.replaceAll(/[\{|\}\-]/g,"_").replace("\\*","_v")}_getIndexRecordFromBundle(n,e,r=!1){const t=this._getPackageSize(r),i=t*(n%t)+e%t;if(i<0)throw new Error("Invalid level / row / col");return 20+i*this.storageInfo.recordSize+44}_getTileEndAndContentType(n,e){const r=n.subarray(e,e+8);let t,i=0;for(t=0;t<5;t++)i|=(255&r[t])<<8*t;const s=0xffffffffff&i;for(i=0,t=5;t<8;t++)i|=(255&r[t])<<8*(t-5);return{position:s,recordSize:0xffffffffff&i}}_toHexString4(n){let e=n.toString(16);if(4!==e.length){let r=4-e.length;for(;r-- >0;)e="0"+e}return e}};(0,w._)([(0,A.MZ)({readOnly:!0})],Me.prototype,"storageInfo",void 0),(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Me.prototype,"datasetFormat",void 0),Me=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.CloudRaster")],Me);const an=Me;var on=S(68677),ln=S(66615);function vt(n){return["x","e","east","long","longitude"].includes(n.toLowerCase())}function xt(n){return["y","n","west","lat","latitude"].includes(n.toLowerCase())}function Ve(n){var e;const r=(0,ln.Z0)();return r&&null!==(e=n[r])&&void 0!==e?e:Object.values(n)[0]}function Xe(){return Math.round(255*Math.random())}function dn(n){let e=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let t=0;t<n.length;t++){const i=n[t];null!=i&&(i<e&&(e=i),i>r&&(r=i))}return(0,ut.X1)(e,r)}function fn(n,e,r){const t=n.map((u,l)=>({name:u,count:e[l]})).sort((u,l)=>u.name>l.name?-1:1),i=(s=1,u=>s*=u.count);var s;const a=[...t.slice(1),{name:"",count:1}].reverse().map(i).reverse();let o=0;for(let u=n.length-1;u>=0;u--)o+=a[t.findIndex(({name:l})=>l===n[u])]*(r%e[u]),r=Math.floor(r/e[u]);return o}let Re=class extends ue{constructor(){super(...arguments),this.datasetFormat="MEMORY",this.source=null}get url(){return""}open(n){var e=this;return(0,F.A)(function*(){var r,t;yield e.init();const i=e.source,{pixelBlocks:s,attributeTable:a,statistics:o,histograms:u,name:l,nativeExtent:c,transform:d}=i,f=s[0],{width:p,height:m,pixelType:g}=f,y=null!==(r=i.extent)&&void 0!==r?r:new _.A({xmin:-.5,ymin:.5,xmax:p-.5,ymax:m-.5,spatialReference:new G.A({wkid:3857})}),h=null!==(t=i.isPseudoSpatialReference)&&void 0!==t?t:!i.extent,v={x:y.width/p,y:y.height/m},x={...i.keyProperties};a&&(x.DataType="Thematic");const I=new Te.A({width:p,height:m,pixelType:g,extent:y,nativeExtent:c,attributeTable:a,transform:d,pixelSize:v,spatialReference:y.spatialReference,bandCount:f.pixels.length,keyProperties:x,multidimensionalInfo:i.multidimensionalInfo,statistics:o,isPseudoSpatialReference:h,histograms:u});e.ioConfig.skipMapInfo&&e.updateImageSpaceRasterInfo(I),e.createRemoteDatasetStorageInfo(I,512,512),e._set("rasterInfo",I),e.updateTileInfo(),I.multidimensionalInfo?yield e._buildMDimStats(i.pixelBlocks,I.multidimensionalInfo):yield e._buildInMemoryRaster(f,{width:512,height:512},n),I.multidimensionalInfo||(e.source=null),e.datasetName=l})()}fetchRawTile(n,e,r,t={}){if(!this._pixelBlockTiles){const{rasterInfo:s}=this,[a,o]=s.storageInfo.tileInfo.size,{sliceId:u}=t,{pixelBlocks:l}=this.source,c={pixelBlock:null==u?l[0]:l[u],useBilinear:"thematic"!==s.dataType,tileSize:{width:a,height:o},level:n,row:e,col:r},d=this.rasterJobHandler?this.rasterJobHandler.clipTile(c,t):(0,ae.J$)(c);return Promise.resolve(d)}const i=this._pixelBlockTiles.get(`${n}/${e}/${r}`);return Promise.resolve(i)}_buildInMemoryRaster(n,e,r){var t=this;return(0,F.A)(function*(){var i,s,a;const{rasterInfo:o}=t,u=null!==(i=o.storageInfo.maximumPyramidLevel)&&void 0!==i?i:0,l="thematic"!==o.dataType,c=t.rasterJobHandler?t.rasterJobHandler.split({pixelBlock:n,tileSize:e,maximumPyramidLevel:u,useBilinear:l},r):Promise.resolve((0,ae.lD)(n,e,u,l)),d=null!=o.statistics,f=null!=o.histograms,p=t.ioConfig.skipStatistics||d?Promise.resolve({statistics:null,histograms:null}):t.rasterJobHandler?t.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:n},r):Promise.resolve((0,pe.f4)(n)),m=yield(0,xe.Lx)([c,p]);if(!m[0].value&&m[1].value)throw new k.A("inmemory-raster:open","failed to build in memory raster");t._pixelBlockTiles=m[0].value,d||(o.statistics=null===(s=m[1].value)||void 0===s?void 0:s.statistics),f||(o.histograms=null===(a=m[1].value)||void 0===a?void 0:a.histograms)})()}_buildMDimStats(n,e,r){var t=this;return(0,F.A)(function*(){for(let i=0;i<e.variables.length;i++){const s=e.variables[i];if(s.statistics)continue;const a=s.dimensions.map(c=>{var d,f,p;return new We.A({variableName:s.name,dimensionName:c.name,values:[null!==(d=null===(f=c.values)||void 0===f?void 0:f[0])&&void 0!==d?d:null===(p=c.extent)||void 0===p?void 0:p[0]],isSlice:!0})}),o=(0,Y.NG)(a,e),u=null==o?null:n[o];if(null==u)continue;const l=t.rasterJobHandler?yield t.rasterJobHandler.computeStatisticsHistograms({pixelBlock:u},r):(0,pe.eH)(u);s.statistics=l.statistics,s.histograms||(s.histograms=l.histograms)}})()}};(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Re.prototype,"datasetFormat",void 0),(0,w._)([(0,A.MZ)()],Re.prototype,"source",void 0),(0,w._)([(0,A.MZ)()],Re.prototype,"url",null),Re=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.InMemoryRaster")],Re);const Ye=Re;let Fe=class extends ue{constructor(){super(...arguments),this.datasetFormat="CovJSON"}open(n){var e=this;return(0,F.A)(function*(){yield e.init();const{extent:r,pixelBlocks:t,multidimensionalInfo:i,attributeTable:s,bandNames:a}=yield e._fetchData(n),{statistics:o,histograms:u}=(0,pe.eH)(t[0]),c={DataType:s?"Thematic":i?"Scientific":"Generic",BandProperties:null==a?void 0:a.map(p=>({BandName:p}))},d=new Ye({source:{extent:r,pixelBlocks:t,attributeTable:s?De.A.fromJSON(s):null,multidimensionalInfo:i,statistics:o,histograms:u,keyProperties:c,isPseudoSpatialReference:!1}});yield d.open(),e._inMemoryRaster=d;const f=e.source?"":e.url.slice(e.url.lastIndexOf("/")+1);e._set("datasetName",f.slice(0,f.indexOf("."))),e._set("rasterInfo",d.rasterInfo)})()}fetchRawTile(n,e,r,t={}){return this._inMemoryRaster.fetchRawTile(n,e,r,t)}_fetchData(n){var e=this;return(0,F.A)(function*(){var r,t,i,s;const a=null!==(r=e.source)&&void 0!==r?r:(yield e.request(e.url,{signal:null==n?void 0:n.signal})).data,o="imagery-tile-layer:open-coverage-json";if("coverage"!==(null===(t=a.type)||void 0===t?void 0:t.toLowerCase())||"grid"!==(null===(i=a.domain)||void 0===i||null===(i=i.domainType)||void 0===i?void 0:i.toLowerCase()))throw new k.A(o,"Only coverage with Grid domain type is supported");if(!a.ranges)throw new k.A(o,"Missing ranges in the grid coverage data");if(null===(s=a.domain.referencing)||void 0===s||!s.length)throw new k.A(o,"Missing domain referencing in the grid coverage data");const u=Object.values(a.ranges);for(let l=0;l<u.length;l++){const{axisNames:c,shape:d,type:f,values:p}=u[l];if(!("ndarray"===f.toLowerCase()&&null!=p&&p.length&&null!=c&&c.length&&null!=d&&d.length))throw new k.A(o,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!vt(c[c.length-1])||!xt(c[c.length-2]))throw new k.A(o,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return function mn(n){var e;const{width:r,height:t,extent:i,dimensions:s}=function un(n){const{axes:e}=n.domain,r=Object.keys(e),t=[],i=[];let s=-1,a=-1,o=[];for(let v=0;v<r.length;v++){const x=r[v];vt(x)?s=v:xt(x)&&(a=v);const I=e[x],R=[];if("values"in I){I.values.forEach(b=>R.push("string"==typeof b?new Date(b).getTime():b));const T=R[1]-R[0];t.push([R[0]-.5*T,R[R.length-1]+.5*T]),i.push(T)}else{const{start:T,stop:b,num:O}=I,P=(b-T)/(O-1);t.push([T-.5*P,b+.5*P]),i.push(P);for(let C=0;C<O;C++)R.push(T+P*C)}o.push({name:x,values:R,extent:[R[0],R[R.length-1]]})}s>-1&&-1===a?a=0===s?1:0:a>-1&&-1===s?s=0===a?1:0:-1===a&&-1===s&&(s=0,a=1),o=o.filter((v,x)=>!(x===s||x===a));const{referencing:u}=n.domain,l=u.find(v=>v.coordinates.includes(r[s])).system.id,c=null==l?void 0:l.slice(l.lastIndexOf("/")+1),d=null==c||"CRS84"===c?4326:Number(c),f=new G.A({wkid:d}),[p,m]=t[s],[g,y]=t[a],h=new _.A({xmin:p,xmax:m,ymin:g,ymax:y,spatialReference:f});return{width:Math.round(h.width/i[s]),height:Math.round(h.height/i[a]),extent:h,dimensions:o}}(n),{ranges:a}=n,o=Object.keys(a).sort((p,m)=>p<m?-1:1),u=[];for(let p=0;p<o.length;p++)null!=s&&s.length&&u.push({name:o[p],dimensions:s});const l=function cn(n){const e={},{parameters:r}=n;if(!r)return e;for(const[s,a]of Object.entries(r)){var t;const{type:o,description:u,unit:l,categoryEncoding:c,observedProperty:d}=a;if("Parameter"===o&&(e[s]={},u&&(e[s].description=Ve(u)),l&&(e[s].unit=l.label?Ve(l.label):null,e[s].symbol=null===(t=l.symbol)||void 0===t?void 0:t.value),c)){var i;const f=Object.entries(c).map((g,y)=>({OID:y,Value:Number(g[1]),ClassName:g[0].slice(g[0].lastIndexOf("/")+1),Count:1}));let p=!1;null!=d&&null!==(i=d.categories)&&void 0!==i&&i.length&&(d.categories.forEach(g=>{if(!g.id)return;const y=g.id.slice(g.id.lastIndexOf("/")+1),h=f.find(x=>x.ClassName===y);if(!h)return;const v=g.label?Ve(g.label):null;if(h.Label=v,g.preferredColor){const x=on.A.fromHex(g.preferredColor);x&&(p=!0,h.Red=x.r,h.Green=x.g,h.Blue=x.b)}}),p&&f.forEach(g=>{null==g.Red&&(g.Red=Xe(),g.Green=Xe(),g.Blue=Xe())}));const m={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:f.map(g=>({attributes:g}))};p&&m.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),e[s].attributeTable=m}}return e}(n);u.forEach(p=>l[p.name]&&Object.assign(p,l[p.name]));const c=u.length?{variables:u}:void 0,d=[];for(let p=0;p<o.length;p++){const m=o[p],{values:g,dataType:y,axisNames:h,shape:v}=a[m],x=v.length>2?p*v.slice(0,-2).reduce((P,C)=>P*C):0,I=h.slice(0,-2),R=v.slice(0,-2),T="float"===y?"f32":dn(g),b=r*t,O=g.length/b;for(let P=0;P<O;P++){const C=te.A.createEmptyBand(T,b),D=new Uint8Array(b).fill(255);let M=!1;const N=P*b;for(let B=0;B<b;B++){const J=g[N+B];null==J?(D[B]=0,M=!0):C[B]=J}if(0===p||null!=s&&s.length){const B=new te.A({width:r,height:t,mask:M?D:null,pixels:[C],pixelType:T});B.updateStatistics(),null!=s&&s.length?d[fn(I,R,P)+x]=B:d.push(B)}else{const B=d[P];B.pixels.push(C),M?B.mask&&(B.mask=te.A.combineBandMasks([B.mask,D])):B.mask=M?D:null}}}return{extent:i,pixelBlocks:d,multidimensionalInfo:c,attributeTable:null===(e=Object.values(l).find(p=>p.attributeTable))||void 0===e?void 0:e.attributeTable,bandNames:c?void 0:o}}(a)})()}};(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Fe.prototype,"datasetFormat",void 0),(0,w._)([(0,A.MZ)({constructOnly:!0})],Fe.prototype,"source",void 0),Fe=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.CovJSONRaster")],Fe);const pn=Fe;var Ke=S(89952);function Se(n,e){if(!n||!e)return[];let r=e;e.includes("/")?(r=e.slice(0,e.indexOf("/")),e=e.slice(e.indexOf("/")+1)):e="";const t=[];if(e){const s=Se(n,r);for(let a=0;a<s.length;a++)Se(s[a],e).forEach(o=>t.push(o));return t}const i=n.getElementsByTagNameNS("*",r);if(!i||0===i.length)return[];for(let s=0;s<i.length;s++)t.push(i[s]||i.item(s));return t}function K(n,e){if(!n||!e)return null;let r=e;e.includes("/")?(r=e.slice(0,e.indexOf("/")),e=e.slice(e.indexOf("/")+1)):e="";const t=Se(n,r);return t.length>0?e?K(t[0],e):t[0]:null}function ne(n,e=null){const r=e?K(n,e):n;let t;return r?(t=r.textContent||r.nodeValue,t?t.trim():null):null}function Ne(n,e){return function hn(n,e){const r=Se(n,e),t=[];let i;for(let s=0;s<r.length;s++)i=r[s].textContent||r[s].nodeValue,i&&(i=i.trim(),""!==i&&t.push(i));return t}(n,e).map(r=>Number(r))}function ye(n,e){const r=ne(n,e);return Number(r)}function Qe(n,e){var r;const t=null==n||null===(r=n.nodeName)||void 0===r?void 0:r.toLowerCase(),i=e.toLowerCase();return t.slice(t.lastIndexOf(":")+1)===i}var qe=S(47168);function It(n,e){if(!n||!e)return null;const r=[];for(let t=0;t<n.length;t++)r.push(n[t]),r.push(e[t]);return r}function ke(n){if(!n)return null;let e=Number(n);if(!isNaN(e)&&0!==e)return new G.A({wkid:e});if(n=String(n).trim(),(0,at.jp)(n))return new G.A({wkt2:n});const r=n.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;const t=r.indexOf("VERTCS"),i=r.indexOf("PROJCS"),s=i>-1?i:r.indexOf("GEOGCS");if(-1===s)return null;const a=n.slice(s,n.lastIndexOf("]",t)+1).trim(),o=n.slice(t,n.lastIndexOf("]")).trim();e=et(a);const u=new G.A(e?{wkid:e}:{wkt:a}),l=et(o);return l&&(u.vcsWkid=l),u}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(e=et(n),new G.A(0!==e?{wkid:e}:{wkt:n})):null}function et(n){var e;const r=n.replaceAll("]","[").replaceAll('"',"").split("[").map(s=>s.trim()).filter(s=>""!==s),t=r[r.length-1].split(","),i=null===(e=t[0])||void 0===e?void 0:e.toLowerCase();if(("epsg"===i||"esri"===i)&&n.endsWith('"]]')){const s=Number(t[1]);if(!isNaN(s)&&0!==s)return s}return 0}function tt(n){var e;if("pamdataset"!==(null==n||null===(e=n.documentElement.tagName)||void 0===e?void 0:e.toLowerCase()))return{};const r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};n.documentElement.childNodes.forEach(i=>{if(1===i.nodeType)if(Qe(i,"SRS")){if(!r.spatialReference){const s=ne(i);r.spatialReference=ke(s)}}else if(Qe(i,"Metadata"))if("xml:ESRI"===i.getAttribute("domain")){const{spatialReference:s,transform:a}=function yn(n){var e;const r=K(n,"GeodataXform"),t=ke(ye(r,"SpatialReference/WKID")||ne(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:t,transform:null};const i=null!==(e=ye(r,"PolynomialOrder"))&&void 0!==e?e:1,s=Ne(r,"CoeffX/Double"),a=Ne(r,"CoeffY/Double"),o=Ne(r,"InverseCoeffX/Double"),u=Ne(r,"InverseCoeffY/Double"),l=It(s,a),c=It(o,u);return{spatialReference:t,transform:l&&c&&l.length&&c.length?new qe.A({spatialReference:t,polynomialOrder:i,forwardCoefficients:l,inverseCoefficients:c}):null}}(i);r.transform=a,r.spatialReference||(r.spatialReference=s)}else Se(i,"MDI").forEach(s=>r.metadata[s.getAttribute("key")]=ne(s));else if(Qe(i,"PAMRasterBand")){const s=function gn(n){var e;const r=ye(n,"NoDataValue"),t=K(n,"Histograms/HistItem"),i=ye(t,"HistMin"),s=ye(t,"HistMax"),a=ye(t,"BucketCount"),o=null===(e=ne(t,"HistCounts"))||void 0===e?void 0:e.split("|").map(p=>Number(p));let u,l,c,d;Se(n,"Metadata/MDI").forEach(p=>{var m;const g=Number(null!==(m=p.textContent)&&void 0!==m?m:p.nodeValue);switch(p.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":u=g;break;case"STATISTICS_MAXIMUM":l=g;break;case"STATISTICS_MEAN":c=g;break;case"STATISTICS_STDDEV":d=g}});const f=ye(n,"Metadata/SourceBandIndex");return{noDataValue:r,histogram:null!=o&&o.length&&null!=i&&null!=s?{min:i,max:s,size:a||o.length,counts:o}:null,sourceBandIndex:f,statistics:null!=u&&null!=l?{min:u,max:l,avg:c,stddev:d}:null}}(i);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}});const t=r.rasterBands;return t.length&&(r.statistics=t[0].statistics?t.map(a=>a.statistics).filter(Ke.Ru):null,r.histograms=t[0].histogram?t.map(a=>a.histogram).filter(Ke.Ru):null),r}let Be=class extends ue{open(n){var e=this;return(0,F.A)(function*(){yield e.init();const r=yield e._fetchData(n);let{spatialReference:t,statistics:i,histograms:s,transform:a}=yield e._fetchAuxiliaryData(n);const o=!t;o&&(t=new G.A({wkid:3857})),null!=s&&s.length&&null==i&&(i=(0,pe.Pg)(s));const{width:u,height:l}=r;let c=new _.A({xmin:-.5,ymin:.5-l,xmax:u-.5,ymax:.5,spatialReference:t});const d=a?a.forwardTransform(c):c;let f=!0;if(a){const m=a.forwardCoefficients;f=m&&0===m[1]&&0===m[2],f&&(a=null,c=d)}const p=new Ye({source:{extent:d,nativeExtent:c,transform:a,pixelBlocks:[r],statistics:i,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:o},ioConfig:{sampling:"closest",skipStatistics:!0}});e.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),yield p.open(),p.source=null,e._set("rasterInfo",p.rasterInfo),e._inMemoryRaster=p})()}fetchRawTile(n,e,r,t={}){return this._inMemoryRaster.fetchRawTile(n,e,r,t)}_fetchData(n){var e=this;return(0,F.A)(function*(){const{data:r}=yield e.request(e.url,{responseType:"array-buffer",signal:null==n?void 0:n.signal}),t=(0,ct.g)(r).toUpperCase();if("JPG"!==t&&"PNG"!==t&&"GIF"!==t&&"BMP"!==t)throw new k.A("image-aux-raster:open","the data is not a supported format");e._set("datasetFormat",t);const i=t.toLowerCase(),s="gif"===i||"bmp"===i||!(0,Tt.A)("ios"),a=yield e.decodePixelBlock(r,{format:i,useCanvas:s,hasNoZlibMask:!0});if(null==a)throw new k.A("image-aux-raster:open","the data cannot be decoded");return a})()}_fetchAuxiliaryData(n){var e=this;return(0,F.A)(function*(){var r;const t=null==n?void 0:n.signal,{skipExtensions:i=[],skipMapInfo:s}=e.ioConfig,a=s||i.includes("aux.xml")?null:e.request(e.url+".aux.xml",{responseType:"xml",signal:t}),o=e.datasetFormat,u="JPG"===o?"jgw":"PNG"===o?"pgw":"BMP"===o?"bpw":null,l=u&&i.includes(u)?null:e.request(e.url.slice(0,e.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:t}),c=yield(0,xe.Lx)([a,l]);if(null!=t&&t.aborted)throw(0,xe.NK)();const d=tt(null===(r=c[0].value)||void 0===r?void 0:r.data);if(!d.transform){const f=c[1].value?c[1].value.data.split("\n").slice(0,6).map(p=>Number(p)):null;d.transform=6===(null==f?void 0:f.length)?new qe.A({forwardCoefficients:[f[4],f[5],f[0],-f[1],f[2],-f[3]]}):null}return d})()}};(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Be.prototype,"datasetFormat",void 0),Be=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Be);const Je=Be;var vn=S(11432),xn=S(45272),In=S(77677),Rn=S(39181),Rt=S(93091);let Ce=class extends ue{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}open(n){var e=this;return(0,F.A)(function*(){var r,t,i,s,a;yield e.init();const o=null==n?void 0:n.signal,u=e.sourceJSON?{data:e.sourceJSON}:yield e.request(e.url,{query:{f:"json"},signal:o});u.ssl&&(e.url=e.url.replace(/^http:/i,"https:"));const l=u.data;if(e.sourceJSON=l,!l)throw new k.A("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!l.tileInfo)throw new k.A("imageserverraster:open","use ImageryLayer to open non-tiled image services");e._fixScaleInServiceInfo(),e.tileType=l.cacheType,null==e.tileType&&(e.tileType=["jpg","jpeg","png","png8","png24","png32","mixed"].includes(l.tileInfo.format.toLowerCase())?"Map":"lerc"===l.tileInfo.format.toLowerCase()?"Elevation":"Raster"),e.datasetName=null!==(r=null===(t=l.name)||void 0===t?void 0:t.slice(l.name.indexOf("/")+1))&&void 0!==r?r:"";const d=yield e._fetchRasterInfo({signal:o});if(null==d)throw new k.A("image-server-raster:open","cannot initialize image service");(0,Rt.E9)(d,l);const f="Map"===e.tileType?function Sn(n,e){if(!n)return null;const{minScale:r,maxScale:t,minLOD:i,maxLOD:s}=e;if(null!=i&&null!=s)return se.A.fromJSON({...n,lods:n.lods.filter(({level:a})=>null!=a&&a>=i&&a<=s)});if(0!==r&&0!==t){const a=l=>Math.round(1e4*l)/1e4,o=r?a(r):1/0,u=t?a(t):-1/0;return se.A.fromJSON({...n,lods:n.lods.filter(l=>{const c=a(l.scale);return c<=o&&c>=u})})}return se.A.fromJSON(n)}(l.tileInfo,l):se.A.fromJSON(l.tileInfo);(0,vn.Lw)(f);const[p,m]=e._computeMinMaxLOD(d,f),{extent:g,pixelSize:y}=d,h=.5/d.width*y.x,v=Math.max(y.x,y.y),{lods:x}=f;("Map"!==e.tileType&&0!==l.maxScale||Math.abs(y.x-y.y)>h||!x.some(N=>Math.abs(N.resolution-v)<h))&&(y.x=y.y=p.resolution,d.width=Math.ceil((g.xmax-g.xmin)/y.x-.1),d.height=Math.ceil((g.ymax-g.ymin)/y.y-.1));const I=p.level-m.level,[R,T]=f.size,b=[],O=[];x.forEach((N,B)=>{N.level>=m.level&&N.level<=p.level&&b.push({x:N.resolution,y:N.resolution}),B<x.length-1&&O.push(Math.round(10*N.resolution/x[B+1].resolution)/10)}),b.sort((N,B)=>N.x-B.x);const P=e.computeBlockBoundary(g,R,T,f.origin,b,I),C=b.length>1?b.slice(1):null;let D;l.transposeInfo&&(D={tileSize:[l.transposeInfo.rows,l.transposeInfo.cols],packetSize:null!==(i=null===(s=d.keyProperties)||void 0===s?void 0:s._yxs.PacketSize)&&void 0!==i?i:0});const M=O.length<=1||O.length>=3&&O.slice(0,-1).every(N=>N===O[0])?null!==(a=O[0])&&void 0!==a?a:2:Math.round(10/(m.resolution/p.resolution)**(-1/I))/10;if(d.storageInfo=new Ae.A({blockWidth:f.size[0],blockHeight:f.size[1],pyramidBlockWidth:f.size[0],pyramidBlockHeight:f.size[1],pyramidResolutions:C,pyramidScalingFactor:M,compression:f.format,origin:f.origin,firstPyramidLevel:1,maximumPyramidLevel:I,tileInfo:f,transposeInfo:D,blockBoundary:P}),e._fixGCSShift(d),e._set("rasterInfo",d),l.capabilities.toLowerCase().includes("tilemap")){const N={tileInfo:d.storageInfo.tileInfo,parsedUrl:(0,xn.An)(e.url),url:e.url,tileServers:[]};e._tilemapCache=new In.d({layer:N})}})()}fetchRawTile(n,e,r,t={}){var i=this;return(0,F.A)(function*(){const{storageInfo:s,extent:a}=i.rasterInfo,{transposeInfo:o}=s,u=null!=o&&!!t.transposedVariableName;if(i._slices&&!u&&null==t.sliceId)return null;const c=`${i.url}/tile/${u?0:s.maximumPyramidLevel-n+i._levelOffset}/${e}/${r}`,d=i._slices?u?{variable:t.transposedVariableName}:{sliceId:t.sliceId||0}:null,{data:f}=yield i.request(c,{query:d,responseType:"array-buffer",signal:t.signal});if(!f)return null;const p=u?o.tileSize:s.tileInfo.size,m=yield i.decodePixelBlock(f,{width:p[0],height:p[1],planes:null,pixelType:null,isPoint:"Elevation"===i.tileType,returnInterleaved:u,noDataValue:i.rasterInfo.noDataValue});if(null==m)return null;const g=s.blockBoundary[n];if("jpg"!==s.compression||r>g.minCol&&r<g.maxCol&&e>g.minRow&&e<g.maxRow)return m;const{origin:y,blockWidth:h,blockHeight:v}=s,{x,y:I}=i.getPyramidPixelSize(n),R=Math.round((a.xmin-y.x)/x)%h,T=Math.round((a.xmax-y.x)/x)%h||h,b=Math.round((y.y-a.ymax)/I)%v,O=Math.round((y.y-a.ymin)/I)%v||v,P=r===g.minCol?R:0,C=e===g.minRow?b:0;return(0,ae.z$)(m,{x:P,y:C},{width:(r===g.maxCol?T:h)-P,height:(e===g.maxRow?O:v)-C}),m})()}getSliceIndex(n){if(!this._slices||null==n||0===n.length)return null;const e=n;for(let r=0;r<this._slices.length;r++){const t=this._slices[r].multidimensionalDefinition;if(t.length===e.length&&!t.some(i=>{const s=e.find(a=>i.variableName===a.variableName&&a.dimensionName===i.dimensionName);return!s||(Array.isArray(i.values[0])?`${i.values[0][0]}-${i.values[0][1]}`:i.values[0])!==(Array.isArray(s.values[0])?`${s.values[0][0]}-${s.values[0][1]}`:s.values[0])}))return r}return null}fetchVariableStatisticsHistograms(n,e){var r=this;return(0,F.A)(function*(){var t;const i=r.request(r.url+"/statistics",{query:{variable:n,f:"json"},signal:e}).then(o=>{var u;return null===(u=o.data)||void 0===u?void 0:u.statistics}),s=r.request(r.url+"/histograms",{query:{variable:n,f:"json"},signal:e}).then(o=>{var u;return null===(u=o.data)||void 0===u?void 0:u.histograms}),a=yield Promise.all([i,s]);return a[0]&&a[0].forEach(o=>{o.avg=o.mean,o.stddev=o.standardDeviation}),null!==(t=a[1])&&void 0!==t&&null!==(t=t[0])&&void 0!==t&&null!==(t=t.counts)&&void 0!==t&&t.length||(a[1]=null),{statistics:a[0]||null,histograms:a[1]||null}})()}computeBestPyramidLevelForLocation(n,e={}){var r=this;return(0,F.A)(function*(){if(!r._tilemapCache)return 0;let t=r.identifyPixelLocation(n,0,e.datumTransformation);if(null===t)return null;let i=0;const{maximumPyramidLevel:s}=r.rasterInfo.storageInfo;let a=s-i+r._levelOffset;const o=t.srcLocation;for(;a>=0;){try{if("available"===(yield r._tilemapCache.fetchAvailability(a,t.row,t.col,e)))break}catch{}if(a--,i++,t=r.identifyPixelLocation(o,i,e.datumTransformation),null===t)return null}return-1===a||null==t?null:i})()}_fetchRasterInfo(n){var e=this;return(0,F.A)(function*(){const r=e.sourceJSON;if("Map"===e.tileType){const o=r.fullExtent||r.extent,u=Math.ceil((o.xmax-o.xmin)/r.pixelSizeX-.1),l=Math.ceil((o.ymax-o.ymin)/r.pixelSizeY-.1),c=G.A.fromJSON(r.spatialReference||o.spatialReference),d=new W.A({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:c});return new Te.A({width:u,height:l,bandCount:3,extent:_.A.fromJSON(o),spatialReference:c,pixelSize:d,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}const{signal:t}=n,i=(0,Rt.Tw)(e.url,e.sourceJSON,{signal:t,query:e.ioConfig.customFetchParameters}),s=r.hasMultidimensions?e.request(`${e.url}/slices`,{query:{f:"json"},signal:t}).then(o=>{var u;return null===(u=o.data)||void 0===u?void 0:u.slices}).catch(()=>null):null,a=yield Promise.all([i,s]);return e._slices=a[1],a[0]})()}_fixScaleInServiceInfo(){const{sourceJSON:n}=this;n.minScale&&n.minScale<0&&(n.minScale=0),n.maxScale&&n.maxScale<0&&(n.maxScale=0)}_fixGCSShift(n){const{extent:e,spatialReference:r}=n;e.xmin>-1&&e.xmax>181&&null!=r&&r.wkid&&r.isGeographic&&(n.nativeExtent=n.extent,n.transform=new Rn.A,n.extent=n.transform.forwardTransform(e))}_computeMinMaxLOD(n,e){var r,t;const{pixelSize:i}=n,s=.5/n.width*i.x,{lods:a}=e,o=e.lodAt(Math.max.apply(null,a.map(g=>g.level))),u=e.lodAt(Math.min.apply(null,a.map(g=>g.level))),{tileType:l}=this;if("Map"===l)return this._levelOffset=a[0].level,[o,u];var c;if("Raster"===l)return[null!==(c=a.find(g=>g.resolution===i.x))&&void 0!==c?c:o,u];const{minScale:d,maxScale:f}=this.sourceJSON;let p=o;f>0&&(p=a.find(g=>Math.abs(g.scale-f)<s),p||(p=null!==(r=a.filter(g=>g.scale>f).sort((g,y)=>g.scale>y.scale?1:-1)[0])&&void 0!==r?r:o));let m=u;return d>0&&(m=null!==(t=a.find(g=>Math.abs(g.scale-d)<s))&&void 0!==t?t:u,this._levelOffset=m.level-u.level),[p,m]}};(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],Ce.prototype,"datasetFormat",void 0),(0,w._)([(0,A.MZ)()],Ce.prototype,"tileType",void 0),Ce=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.ImageServerRaster")],Ce);const wn=Ce;var bn=S(79892);const re=new Map;re.set("Int8","s8"),re.set("UInt8","u8"),re.set("Int16","s16"),re.set("UInt16","u16"),re.set("Int32","s32"),re.set("UInt32","u32"),re.set("Float32","f32"),re.set("Float64","f32"),re.set("Double64","f32");const de=new Map;de.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),de.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),de.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),de.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});let we=class extends ue{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}open(n){var e=this;return(0,F.A)(function*(){yield e.init(),e.datasetName=e.url.slice(e.url.lastIndexOf("/")+1);const r=n?n.signal:null,t=yield e.request(e.url,{responseType:"xml",signal:r}),{rasterInfo:i,files:s}=e._parseHeader(t.data),{skipMapInfo:a,skipExtensions:o=[]}=e.ioConfig;if(!o.includes("aux.xml")&&!a){var u;const x=yield e._fetchAuxiliaryData(n);null!=x&&(i.statistics=null!==(u=x.statistics)&&void 0!==u?u:i.statistics,i.histograms=x.histograms,x.histograms&&null==i.statistics&&(i.statistics=(0,pe.Pg)(x.histograms)))}a&&e.updateImageSpaceRasterInfo(i),e._set("rasterInfo",i),e._files=s;const l=yield e.request(s.index,{responseType:"array-buffer",signal:r});e._storageIndex=e._parseIndex(l.data);const{blockWidth:c,blockHeight:d}=e.rasterInfo.storageInfo,f=e.rasterInfo.storageInfo.pyramidScalingFactor,{width:p,height:m}=e.rasterInfo,g=[],y=e._getBandSegmentCount();let h=0,v=-1;for(;h<e._storageIndex.length;){v++;const x=Math.ceil(p/c/f**v)-1,I=Math.ceil(m/d/f**v)-1;h+=(x+1)*(I+1)*y*4,g.push({maxRow:I,maxCol:x,minCol:0,minRow:0})}e.rasterInfo.storageInfo.blockBoundary=g,v>0&&(e.rasterInfo.storageInfo.firstPyramidLevel=1,e.rasterInfo.storageInfo.maximumPyramidLevel=v),e.updateTileInfo()})()}fetchRawTile(n,e,r,t={}){var i=this;return(0,F.A)(function*(){const{blockWidth:s,blockHeight:a,blockBoundary:o}=i.rasterInfo.storageInfo,u=o[n];if(!u||u.maxRow<e||u.maxCol<r||u.minRow>e||u.minCol>r)return null;const{bandCount:l,pixelType:c}=i.rasterInfo,{ranges:d,actualTileWidth:f,actualTileHeight:p}=i._getTileLocation(n,e,r);if(!d||0===d.length)return null;if(0===d[0].from&&0===d[0].to){const M=new Uint8Array(s*a);return new te.A({width:s,height:a,pixels:null,mask:M,validPixelCount:0})}const{bandIds:m}=i.ioConfig,g=i._getBandSegmentCount(),y=[];let h=0;for(h=0;h<g;h++)m&&!m.includes(h)||y.push(i.request(i._files.data,{range:{from:d[h].from,to:d[h].to},responseType:"array-buffer",signal:t.signal}));const v=yield Promise.all(y),x=v.map(M=>M.data.byteLength).reduce((M,N)=>M+N),I=new Uint8Array(x),R=[];let T=0;for(h=0;h<g;h++)R.push(T),I.set(new Uint8Array(v[h].data),T),T+=v[h].data.byteLength;const b=de.get(i.rasterInfo.storageInfo.compression).decoderFormat,O=yield i.decodePixelBlock(I.buffer,{width:s,height:a,format:b,planes:(null==m?void 0:m.length)||l,offsets:R,pixelType:c});if(null==O)return null;let{noDataValue:P}=i.rasterInfo;if(null!=P&&"lerc"!==b&&!O.mask&&(P=P[0],null!=P)){const M=O.width*O.height,N=new Uint8Array(M);if(Math.abs(P)>1e24)for(h=0;h<M;h++)Math.abs((O.pixels[0][h]-P)/P)>1e-6&&(N[h]=1);else for(h=0;h<M;h++)O.pixels[0][h]!==P&&(N[h]=1);O.mask=N}let C=0,D=0;if(f!==s||p!==a){let M=O.mask;if(M)for(h=0;h<a;h++)if(D=h*s,h<p)for(C=f;C<s;C++)M[D+C]=0;else for(C=0;C<s;C++)M[D+C]=0;else for(M=new Uint8Array(s*a),O.mask=M,h=0;h<p;h++)for(D=h*s,C=0;C<f;C++)M[D+C]=1}return O})()}_parseIndex(n){if(n.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");let e,r,t,i,s,a;if(bn.Z){for(r=new Uint8Array(n),i=new ArrayBuffer(n.byteLength),t=new Uint8Array(i),s=0;s<n.byteLength/4;s++)for(a=0;a<4;a++)t[4*s+a]=r[4*s+3-a];e=new Uint32Array(i)}else e=new Uint32Array(n);return e}_getBandSegmentCount(){return de.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(n,e,r){const{blockWidth:t,blockHeight:i,pyramidScalingFactor:s}=this.rasterInfo.storageInfo,{width:a,height:o}=this.rasterInfo,u=this._getBandSegmentCount();let l,c,d,f=0,p=0;for(d=0;d<n;d++)p=s**d,l=Math.ceil(a/t/p),c=Math.ceil(o/i/p),f+=l*c;p=s**n,l=Math.ceil(a/t/p),c=Math.ceil(o/i/p),f+=e*l+r,f*=4*u;const m=this._storageIndex.subarray(f,f+4*u);let g=0,y=0;const h=[];for(let v=0;v<u;v++)g=m[4*v]*2**32+m[4*v+1],y=g+m[4*v+2]*2**32+m[4*v+3],h.push({from:g,to:y});return{ranges:h,actualTileWidth:r<l-1?t:Math.ceil(a/p)-t*(l-1),actualTileHeight:e<c-1?i:Math.ceil(o/p)-i*(c-1)}}_parseHeader(n){const e=K(n,"MRF_META/Raster");if(!e)throw new k.A("mrf:open","not a valid MRF format");const r=K(e,"Size"),t=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),s=parseInt(r.getAttribute("c"),10),a=(ne(e,"Compression")||"none").toLowerCase();if(!de.has(a))throw new k.A("mrf:open","currently does not support compression "+a);const o=ne(e,"DataType")||"UInt8",u=re.get(o);if(null==u)throw new k.A("mrf:open","currently does not support pixel type "+o);const l=K(e,"PageSize"),c=parseInt(l.getAttribute("x"),10),d=parseInt(l.getAttribute("y"),10),f=K(e,"DataValues");let p,m;if(f&&(m=f.getAttribute("NoData"),null!=m&&(p=m.trim().split(" ").map(M=>parseFloat(M)))),K(n,"MRF_META/CachedSource"))throw new k.A("mrf:open","currently does not support MRF referencing other data files");const g=K(n,"MRF_META/GeoTags"),y=K(g,"BoundingBox");let h,v=!1;if(null!=y){var x;const M=parseFloat(y.getAttribute("minx")),N=parseFloat(y.getAttribute("miny")),B=parseFloat(y.getAttribute("maxx")),J=parseFloat(y.getAttribute("maxy")),L=ne(g,"Projection")||"";let E=G.A.WGS84;if("LOCAL_CS[]"!==L)if(L.toLowerCase().startsWith("epsg:")){const U=Number(L.slice(5));isNaN(U)||0===U||(E=new G.A({wkid:U}))}else E=null!==(x=ke(L))&&void 0!==x?x:G.A.WGS84;else v=!0,E=new G.A({wkid:3857});h=new _.A(M,N,B,J),h.spatialReference=E}else v=!0,h=new _.A({xmin:-.5,ymin:.5-i,xmax:t-.5,ymax:.5,spatialReference:new G.A({wkid:3857})});const I=K(n,"MRF_META/Rsets"),R=parseInt((null==I?void 0:I.getAttribute("scale"))||"2",10),T=h.spatialReference,b=new Ae.A({origin:new W.A({x:h.xmin,y:h.ymax,spatialReference:T}),blockWidth:c,blockHeight:d,pyramidBlockWidth:c,pyramidBlockHeight:d,compression:a,pyramidScalingFactor:R}),O=new W.A({x:h.width/t,y:h.height/i,spatialReference:T}),P=new Te.A({width:t,height:i,extent:h,isPseudoSpatialReference:v,spatialReference:T,bandCount:s,pixelType:u,pixelSize:O,noDataValue:p,storageInfo:b}),C=ne(n,"datafile"),D=ne(n,"IndexFile");return{rasterInfo:P,files:{mrf:this.url,index:D||this.url.replace(".mrf",".idx"),data:C||this.url.replace(".mrf",de.get(a).blobExtension)}}}_fetchAuxiliaryData(n){var e=this;return(0,F.A)(function*(){try{const{data:r}=yield e.request(e.url+".aux.xml",{responseType:"xml",signal:null==n?void 0:n.signal});return tt(r)}catch{return null}})()}};(0,w._)([(0,A.MZ)()],we.prototype,"_files",void 0),(0,w._)([(0,A.MZ)()],we.prototype,"_storageIndex",void 0),(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],we.prototype,"datasetFormat",void 0),we=(0,w._)([(0,ee.$)("esri.layers.support.rasterIO.MRFRaster")],we);const An=we;var ge=S(59520),Ee=S(77835);const nt=(n,e)=>{var r;return null===(r=n.get(e))||void 0===r?void 0:r.values},Pe=(n,e)=>{var r;return null===(r=n.get(e))||void 0===r||null===(r=r.values)||void 0===r?void 0:r[0]};let ve=class extends ue{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}open(n){var e=this;return(0,F.A)(function*(){var r,t;yield e.init();const i=n?n.signal:null,{data:s}=yield e.request(e.url,{range:{from:0,to:e._bufferSize},responseType:"array-buffer",signal:i});if(!s)throw new k.A("tiffraster:open","failed to open url "+e.url);e.datasetName=e.url.slice(e.url.lastIndexOf("/")+1,e.url.lastIndexOf("."));const{littleEndian:a,firstIFDPos:o,isBigTiff:u}=(0,ge.uT)(s),l=[];yield e._readIFDs(l,s,a,o,0,u?8:4,i);const{imageInfo:c,rasterInfo:d}=e._parseIFDs(l),f=(0,ge.zS)(l),p=(0,ge.r9)(l);if(e._headerInfo={littleEndian:a,isBigTiff:u,ifds:l,pyramidIFDs:f,maskIFDs:p,...c},e._set("rasterInfo",d),!c.isSupported)throw new k.A("tiffraster:open","this tiff is not supported: "+c.message);if(!c.tileWidth)throw new k.A("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");d.isPseudoSpatialReference&&fe.A.getLogger(e).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.");const m=null===(r=l[0].get("PREDICTOR"))||void 0===r||null===(r=r.values)||void 0===r?void 0:r[0];if(3===(null===(t=l[0].get("SAMPLEFORMAT"))||void 0===t||null===(t=t.values)||void 0===t?void 0:t[0])&&2===m)throw new k.A("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");const{skipMapInfo:y,skipExtensions:h=[]}=e.ioConfig;if(!h.includes("aux.xml")&&!y){const v=yield e._fetchAuxiliaryMetaData(n);null!=v&&e._processPAMInfo(v,d)}h.includes("vat.dbf")||1!==d.bandCount||"u8"!==d.pixelType||y||(d.attributeTable=yield e._fetchAuxiliaryTable(n),null!=d.attributeTable&&(d.keyProperties.DataType="thematic")),y&&e.updateImageSpaceRasterInfo(d),e.updateTileInfo()})()}fetchRawTile(n,e,r,t={}){var i=this;return(0,F.A)(function*(){var s;if(null===(s=i._headerInfo)||void 0===s||!s.isSupported||i.isBlockOutside(n,e,r))return null;const a=yield i._fetchRawTiffTile(n,e,r,!1,t);if(null!=a&&i._headerInfo.hasMaskBand){const o=yield i._fetchRawTiffTile(n,e,r,!0,t);null!=o&&o.pixels[0]instanceof Uint8Array&&(a.mask=o.pixels[0])}return a})()}_parseIFDs(n){var e,r;const t=(0,ge.uc)(n),{width:i,height:s,tileWidth:a,tileHeight:o,planes:u,pixelType:l,compression:c,firstPyramidLevel:d,maximumPyramidLevel:f,pyramidBlockWidth:p,pyramidBlockHeight:m,tileBoundary:g,affine:y,metadata:h}=t;let x=ke((null===(e=t.extent.spatialReference)||void 0===e?void 0:e.wkt)||(null===(r=t.extent.spatialReference)||void 0===r?void 0:r.wkid)),I=!!t.isPseudoGeographic;null==x&&(I=!0,x=new G.A({wkid:3857}));const R=new _.A({...t.extent,spatialReference:x}),T=new W.A(R?{x:R.xmin,y:R.ymax,spatialReference:x}:{x:0,y:0}),b=new Ae.A({blockWidth:a,blockHeight:o,pyramidBlockWidth:p,pyramidBlockHeight:m,compression:c,origin:T,firstPyramidLevel:d,maximumPyramidLevel:f,blockBoundary:g}),O=new W.A({x:(R.xmax-R.xmin)/i,y:(R.ymax-R.ymin)/s,spatialReference:x}),P=h?{BandProperties:h.bandProperties,DataType:h.dataType}:{};let C=null;const D=Pe(n[0],"PHOTOMETRICINTERPRETATION"),M=nt(n[0],"COLORMAP");if(D<=3&&(null==M?void 0:M.length)>3&&M.length%3==0){C=[];const B=M.length/3;for(let J=0;J<B;J++)C.push([J,M[J]>>>8,M[J+B]>>>8,M[J+2*B]>>>8])}const N=new Te.A({width:i,height:s,bandCount:u,pixelType:l,pixelSize:O,storageInfo:b,spatialReference:x,isPseudoSpatialReference:I,keyProperties:P,extent:R,colormap:C,statistics:h?h.statistics:null});return null!=y&&y.length&&(N.nativeExtent=new _.A({xmin:-.5,ymin:.5-s,xmax:i-.5,ymax:.5,spatialReference:x}),N.transform=new qe.A({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),N.extent=N.transform.forwardTransform(N.nativeExtent),N.pixelSize=new W.A({x:(R.xmax-R.xmin)/i,y:(R.ymax-R.ymin)/s,spatialReference:x}),b.origin.x=-.5,b.origin.y=.5),{imageInfo:t,rasterInfo:N}}_processPAMInfo(n,e){var r;if(e.statistics=null!==(r=n.statistics)&&void 0!==r?r:e.statistics,e.histograms=n.histograms,n.histograms&&null==e.statistics&&(e.statistics=(0,pe.Pg)(n.histograms)),n.transform&&null==e.transform){e.transform=n.transform,e.nativeExtent=e.extent;const t=e.transform.forwardTransform(e.nativeExtent);e.pixelSize=new W.A({x:(t.xmax-t.xmin)/e.width,y:(t.ymax-t.ymin)/e.height,spatialReference:e.spatialReference}),e.extent=t}e.isPseudoSpatialReference&&n.spatialReference&&(e.spatialReference=n.spatialReference,e.extent.spatialReference=e.nativeExtent.spatialReference=e.storageInfo.origin.spatialReference=e.spatialReference)}_readIFDs(n,e,r,t,i,s=4,a){var o=this;return(0,F.A)(function*(){if(!t)return null;(t>=e.byteLength||t<0)&&(e=(yield o.request(o.url,{range:{from:t+i,to:t+i+o._bufferSize},responseType:"array-buffer",signal:a})).data,i=t+i,t=0);const u=yield o._readIFD(e,r,t,i,Ee.A.tiffTags,s,a);if(n.push(u.ifd),!u.nextIFD)return null;yield o._readIFDs(n,e,r,u.nextIFD-i,i,s,a)})()}_readIFD(n,e,r,t,i=Ee.A.tiffTags,s=4,a){var o=this;return(0,F.A)(function*(){if(!n)return null;const u=(0,ge.JM)(n,e,r,t,i,s);if(u.success){var l,c;const d=[];if(null!==(l=u.ifd)&&void 0!==l&&l.forEach(f=>{f.values||d.push(f)}),d.length>0){const f=d.map(m=>m.offlineOffsetSize).filter(Ke.Ru),p=Math.min.apply(null,f.map(m=>m[0]));if(Math.min.apply(null,f.map(m=>m[0]+m[1]))-p<=o._bufferSize){const{data:m}=yield o.request(o.url,{range:{from:p,to:p+o._bufferSize},responseType:"array-buffer",signal:a});n=m,t=p,d.forEach(g=>(0,ge.Cr)(n,e,g,t))}}if(null!==(c=u.ifd)&&void 0!==c&&c.has("GEOKEYDIRECTORY")){const f=u.ifd.get("GEOKEYDIRECTORY"),p=null==f?void 0:f.values;if(p&&p.length>4){const m=p[0]+"."+p[1]+"."+p[2],g=yield o._readIFD(n,e,f.valueOffset+6-t,t,Ee.A.geoKeys,2,a);f.data=g.ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[m]})}}return u}return u.requiredBufferSize&&u.requiredBufferSize!==n.byteLength?(n=(yield o.request(o.url,{range:{from:t,to:t+u.requiredBufferSize+4},responseType:"array-buffer",signal:a})).data).byteLength<u.requiredBufferSize?null:o._readIFD(n,e,0,t,Ee.A.tiffTags,4,a):void 0})()}_fetchRawTiffTile(n,e,r,t,i={}){var s=this;return(0,F.A)(function*(){const a=s._getTileLocation(n,e,r,t);if(!a)return null;const{ranges:o,actualTileWidth:u,actualTileHeight:l,ifd:c}=a,d=o.map(b=>s.request(s.url,{range:b,responseType:"array-buffer",signal:i.signal})),f=yield Promise.all(d),p=f.map(b=>b.data.byteLength).reduce((b,O)=>b+O),m=1===f.length?f[0].data:new ArrayBuffer(p),g=[0],y=[0];if(f.length>1){const b=new Uint8Array(m);for(let O=0,P=0;O<f.length;O++){const C=f[O].data;b.set(new Uint8Array(C),P),g[O]=P,P+=C.byteLength,y[O]=C.byteLength}}const{blockWidth:h,blockHeight:v}=s.getBlockWidthHeight(n),x=yield s.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:s._headerInfo,ifd:c,offsets:g,sizes:y},width:h,height:v,planes:null,pixelType:null});if(null==x)return null;let I,R,T;if(u!==h||l!==v){let b=x.mask;if(b)for(I=0;I<v;I++)if(T=I*h,I<l)for(R=u;R<h;R++)b[T+R]=0;else for(R=0;R<h;R++)b[T+R]=0;else for(b=new Uint8Array(h*v),x.mask=b,I=0;I<l;I++)for(T=I*h,R=0;R<u;R++)b[T+R]=1}return x})()}_getTileLocation(n,e,r,t=!1){const{firstPyramidLevel:i,blockBoundary:s}=this.rasterInfo.storageInfo,a=0===n?0:n-(i-1),{_headerInfo:o}=this;if(!o)return null;const u=t?o.maskIFDs[a]:0===a?null==o?void 0:o.ifds[0]:null==o?void 0:o.pyramidIFDs[a-1];if(!u)return null;const l=(0,ge.XO)(u,o),c=nt(u,"TILEOFFSETS");if(void 0===c)return null;const d=nt(u,"TILEBYTECOUNTS"),{minRow:f,minCol:p,maxRow:m,maxCol:g}=s[a];if(e>m||r>g||e<f||r<p)return null;const y=Pe(u,"IMAGEWIDTH"),h=Pe(u,"IMAGELENGTH"),v=Pe(u,"TILEWIDTH"),x=Pe(u,"TILELENGTH"),I=[];if(l){const{bandCount:R}=this.rasterInfo;for(let T=0;T<R;T++){const b=T*(m+1)*(g+1)+e*(g+1)+r;I[T]={from:c[b],to:c[b]+d[b]-1}}}else{const R=e*(g+1)+r;I.push({from:c[R],to:c[R]+d[R]-1})}for(let R=0;R<I.length;R++)if(null==I[R].from||!I[R].to||I[R].to<0)return null;return{ranges:I,ifd:u,actualTileWidth:r===g&&y%v||v,actualTileHeight:e===m&&h%x||x}}_fetchAuxiliaryMetaData(n){var e=this;return(0,F.A)(function*(){try{const{data:r}=yield e.request(e.url+".aux.xml",{responseType:"xml",signal:null==n?void 0:n.signal});return tt(r)}catch{return null}})()}_fetchAuxiliaryTable(n){var e=this;return(0,F.A)(function*(){try{const{data:r}=yield e.request(e.url+".vat.dbf",{responseType:"array-buffer",signal:null==n?void 0:n.signal}),t=ht.parse(r);return null!=t&&t.recordSet?De.A.fromJSON(t.recordSet):null}catch{return null}})()}};(0,w._)([(0,A.MZ)()],ve.prototype,"_files",void 0),(0,w._)([(0,A.MZ)()],ve.prototype,"_headerInfo",void 0),(0,w._)([(0,A.MZ)()],ve.prototype,"_bufferSize",void 0),(0,w._)([(0,A.MZ)({type:String,json:{write:!0}})],ve.prototype,"datasetFormat",void 0),ve=(0,w._)([(0,ee.$)("esri.layers.support.rasterDatasets.TIFFRaster")],ve);const Tn=ve,j=new Map;j.set("CRF",{desc:"Cloud Raster Format",constructor:an}),j.set("MRF",{desc:"Meta Raster Format",constructor:An}),j.set("TIFF",{desc:"GeoTIFF",constructor:Tn}),j.set("RasterTileServer",{desc:"Raster Tile Server",constructor:wn}),j.set("JPG",{desc:"JPG Raster Format",constructor:Je}),j.set("PNG",{desc:"PNG Raster Format",constructor:Je}),j.set("GIF",{desc:"GIF Raster Format",constructor:Je}),j.set("BMP",{desc:"BMP Raster Format",constructor:Je}),j.set("CovJSON",{desc:"COVJSON Raster Format",constructor:pn}),j.set("MEMORY",{desc:"In Memory Raster Format",constructor:Ye});class it{static get supportedFormats(){const e=new Set;return j.forEach((r,t)=>e.add(t)),e}static open(e){var r=this;return(0,F.A)(function*(){var t,i;const{url:s,ioConfig:a,source:o,sourceJSON:u}=e;let l=null!==(t=e.datasetFormat)&&void 0!==t?t:null==a?void 0:a.datasetFormat;null==l&&(s.includes(".")?l=s.slice(s.lastIndexOf(".")+1).toUpperCase():"coverage"===(null==o||null===(i=o.type)||void 0===i?void 0:i.toLowerCase())?l="CovJSON":null!=o&&o.extent&&o.pixelblocks&&(l="MEMORY")),"OVR"===l||"TIF"===l?l="TIFF":"JPG"===l||"JPEG"===l||"JFIF"===l?l="JPG":"COVJSON"===l&&(l="CovJSON"),s.toLowerCase().includes("/imageserver")&&!s.toLowerCase().includes("/wcsserver")&&(l="RasterTileServer");const c={url:s,source:o,sourceJSON:u,datasetFormat:l,ioConfig:null!=a?a:{bandIds:null,sampling:null}};if(Object.keys(c).forEach(m=>{null==c[m]&&delete c[m]}),l){if(!r.supportedFormats.has(l))throw new k.A("rasterfactory:open","not a supported format "+l);if("CRF"===l&&(null==a||!a.enableCRF))throw new k.A("rasterfactory:open",`cannot open raster: ${s}`);const m=new(j.get(l).constructor)(c);return yield m.open({signal:e.signal}),m}const d=Array.from(j.keys()).filter(m=>"CovJSON"!==m&&"Memory"!==m);let f=0;const p=()=>{if(l=d[f++],!l||"CRF"===l&&(null==a||!a.enableCRF))return null;const m=new(j.get(l).constructor)(c);return m.open({signal:e.signal}).then(()=>m).catch(()=>p())};return p()})()}static register(e,r,t){j.has(e.toUpperCase())||j.set(e.toUpperCase(),{desc:r,constructor:t})}}var Mn=S(41843),ze=S(71655);let $=class extends((0,Pt.d)((0,tn.j)((0,Qt.q)((0,qt.A)((0,Ot.d)(Kt((0,nn.e)((0,Ct.b)((0,en.J)((0,bt.P)((0,wt.O)(Ft.A)))))))))))){constructor(...n){var e;super(...n),e=this,this._primaryRasters=[],this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this.source=void 0,this._debouncedSaveOperations=(0,xe.sg)(function(){var r=(0,F.A)(function*(t,i,s){const{save:a,saveAs:o}=yield Promise.all([S.e(2076),S.e(4973)]).then(S.bind(S,23518));switch(t){case ze.X.SAVE:return a(e,i);case ze.X.SAVE_AS:return o(e,s,i)}});return function(t,i,s){return r.apply(this,arguments)}}())}normalizeCtorArgs(n,e){return"string"==typeof n?{url:n,...e}:n}load(n){const e=null!=n?n.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},n).catch(xe.QP).then(()=>this._openRaster(e))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const n=[new Ie.A({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new Ie.A({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],{serviceRasterInfo:e}=this,r=null==e?void 0:e.attributeTable,t=null!=r?r.fields:null;if(t){const u=t.filter(l=>"oid"!==l.type&&"value"!==l.name.toLowerCase()).map(l=>{const c=l.clone();return c.name="Raster."+l.name,c});n.push(...u)}const s=null==e?void 0:e.dataType,a=null==e?void 0:e.multidimensionalInfo;if(("vector-magdir"===s||"vector-uv"===s)&&null!=a){var o;const u=null===(o=a.variables[0].unit)||void 0===o?void 0:o.trim();n.push(new Ie.A({name:"Raster.Magnitude",alias:"Magnitude"+(u?` (${u})`:""),domain:null,editable:!1,type:"double"})),n.push(new Ie.A({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return n}createPopupTemplate(n){const{rasterFields:e}=this,r=new Set(e.map(({name:t})=>t).filter(t=>"raster.servicepixelvalue.raw"!==t.toLowerCase()));return(0,Mn.tn)({fields:e,title:this.title},{...n,visibleFieldNames:r})}generateRasterInfo(n,e){var r=this;return(0,F.A)(function*(){if(!(n=(0,Oe.PZ)(_e.A,n)))return r.serviceRasterInfo;try{const{rasterInfo:t}=yield r._openFunctionRaster(n,e);return t}catch(t){throw t instanceof k.A?t:new k.A("imagery-tile-layer","the given raster function is not supported")}})()}save(n){var e=this;return(0,F.A)(function*(){return e._debouncedSaveOperations(ze.X.SAVE,n)})()}saveAs(n,e){var r=this;return(0,F.A)(function*(){return r._debouncedSaveOperations(ze.X.SAVE_AS,e,n)})()}write(n,e){var r;const t=null!==(r=this._primaryRasters[0])&&void 0!==r?r:this.raster;return(this.loaded?"RasterTileServer"===t.datasetFormat&&("Raster"===t.tileType||"Map"===t.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))?super.write(n,e):(null!=e&&e.messages&&e.messages.push(new k.A("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e.origin}/${e.layerContainerType||"operational-layers"}'`,{layer:this})),null)}_openRaster(n){var e=this;return(0,F.A)(function*(){let r=!1;if(e.raster)yield e._openFromRaster(e.raster,n),r="Function"===e.raster.datasetFormat;else{const{url:i,rasterFunction:s,source:a}=e;if(!i&&!a)throw new k.A("imagery-tile-layer:open","missing url or source parameter");a?yield e._openFromSource(a,n):s?yield e._openFromUrlWithRasterFunction(i,s,n):yield e._openFromUrl(i,n)}const t=e.raster.rasterInfo;if(!t)throw new k.A("imagery-tile-layer:load","cannot load resources on "+e.url);if(e._set("serviceRasterInfo",r?t:e._primaryRasters[0].rasterInfo),e._set("spatialReference",t.spatialReference),e.sourceJSON=e.sourceJSON||e.raster.sourceJSON,null!=e.sourceJSON){const i="Map"===e.raster.tileType&&null!=e.sourceJSON.minLOD&&null!=e.sourceJSON.maxLOD?e.sourceJSON:{...e.sourceJSON,minScale:0,maxScale:0};e.read(i,{origin:"service"})}else e.read({tileInfo:e.serviceRasterInfo.storageInfo.tileInfo.toJSON()},{origin:"service"});e.title||(e.title=e.raster.datasetName),"Map"===e.raster.tileType&&(e.popupEnabled=!1),e._configDefaultSettings(),e.addHandles((0,At.wB)(()=>e.customParameters,i=>{e.raster&&(e.raster.ioConfig.customFetchParameters=i)}))})()}_openFromRaster(n,e){var r=this;return(0,F.A)(function*(){n.rasterInfo||(yield n.open({signal:e})),r._primaryRasters="Function"===n.datasetFormat?n.primaryRasters.rasters:[n],r.url||(r.url=r._primaryRasters[0].url)})()}_openFromUrlWithRasterFunction(n,e,r){var t=this;return(0,F.A)(function*(){const i=[n];e&&(0,je.UD)(e.toJSON(),i);const s=yield Promise.all(i.map(o=>it.open({url:o,sourceJSON:t.sourceJSON,ioConfig:{sampling:"closest",...t.ioConfig,customFetchParameters:t.customParameters},signal:r}))),a=s.findIndex(o=>null==o);if(a>-1)throw new k.A("imagery-tile-layer:open",`cannot open raster: ${i[a]}`);return t._primaryRasters=s,t._initializeWithFunctionRaster(e)})()}_openFromUrl(n,e){var r=this;return(0,F.A)(function*(){const t=yield it.open({url:n,sourceJSON:r.sourceJSON,ioConfig:{sampling:"closest",...r.ioConfig,customFetchParameters:r.customParameters},signal:e});if(null==t)throw new k.A("imagery-tile-layer:open",`cannot open raster: ${n}`);r._primaryRasters=[t],r.raster=t})()}_openFromSource(n,e){var r=this;return(0,F.A)(function*(){var t;const i="the tiled imagery data source is not supported",s="coverage"===(null===(t=n.type)||void 0===t?void 0:t.toLowerCase())?"CovJSON":n.extent&&n.pixelBlock?"MEMORY":null;if(!s)throw new k.A("imagery-tile-layer:open",i);"MEMORY"===s&&(n={extent:n.extent,pixelBlocks:[n.pixelBlock]});const a=yield it.open({url:"",source:n,datasetFormat:s,ioConfig:{sampling:"closest",...r.ioConfig,customFetchParameters:r.customParameters},signal:e});if(null==a)throw new k.A("imagery-tile-layer:open",i);r._primaryRasters=[a],r.rasterFunction?yield r._initializeWithFunctionRaster(r.rasterFunction):r.raster=a})()}_openFunctionRaster(n,e){var r=this;return(0,F.A)(function*(){var t,i;const s={raster:r._primaryRasters[0]};r._primaryRasters.length>1&&r._primaryRasters.forEach(u=>s[u.url]=u);const a=(0,je.vt)(null!==(t=null===(i=n.functionDefinition)||void 0===i?void 0:i.toJSON())&&void 0!==t?t:n.toJSON(),s),o=new mt({rasterFunction:a});return yield o.open(e),o})()}_initializeWithFunctionRaster(n,e){var r=this;return(0,F.A)(function*(){try{r.raster=yield r._openFunctionRaster(n,e)}catch(t){t instanceof k.A&&fe.A.getLogger(r).error("imagery-tile-layer:open",t.message),fe.A.getLogger(r).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),r._set("rasterFunction",null),r.raster=r._primaryRasters[0]}})()}};(0,w._)([(0,A.MZ)({clonable:!1})],$.prototype,"_primaryRasters",void 0),(0,w._)([(0,A.MZ)({type:[Oe.jz],json:{write:{overridePolicy(){var n;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(n=this.bandIds)||void 0===n?void 0:n.join(","))}}}}})],$.prototype,"bandIds",void 0),(0,w._)([(0,A.MZ)({json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,Mt.e)(rn.SZ)],$.prototype,"interpolation",void 0),(0,w._)([(0,A.MZ)($e.fV)],$.prototype,"legendEnabled",void 0),(0,w._)([(0,A.MZ)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],$.prototype,"isReference",void 0),(0,w._)([(0,A.MZ)({type:["show","hide"]})],$.prototype,"listMode",void 0),(0,w._)([(0,A.MZ)({json:{read:!0,write:!0}})],$.prototype,"blendMode",void 0),(0,w._)([(0,A.MZ)()],$.prototype,"sourceJSON",void 0),(0,w._)([(0,A.MZ)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],$.prototype,"version",void 0),(0,w._)([(0,A.MZ)({readOnly:!0,json:{read:!1}})],$.prototype,"type",void 0),(0,w._)([(0,A.MZ)({type:["ArcGISTiledImageServiceLayer"]})],$.prototype,"operationalLayerType",void 0),(0,w._)([(0,A.MZ)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(n,e)=>!e.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(n,e,r){e[r]=!n}}}})],$.prototype,"popupEnabled",void 0),(0,w._)([(0,A.MZ)({type:St.A,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],$.prototype,"popupTemplate",void 0),(0,w._)([(0,A.MZ)({readOnly:!0})],$.prototype,"defaultPopupTemplate",null),(0,w._)([(0,A.MZ)({readOnly:!0,type:[Ie.A]})],$.prototype,"fields",void 0),(0,w._)([(0,A.MZ)({readOnly:!0,type:[Ie.A]})],$.prototype,"rasterFields",null),(0,w._)([(0,A.MZ)({constructOnly:!0})],$.prototype,"source",void 0),$=(0,w._)([(0,ee.$)("esri.layers.ImageryTileLayer")],$);const Fn=$}}]);